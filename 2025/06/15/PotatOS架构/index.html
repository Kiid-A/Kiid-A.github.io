

<!DOCTYPE html>
<html lang="cn" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="PotatOSü•î[toc] ÂÜôÂú®ÂâçÈù¢ü•î‰ªÄ‰πàÊòØPotatOSPotatOSÊòØ‰∏Ä‰∏™Áî® Rust ÁºñÂÜôÁöÑÂü∫‰∫é 2024 Êò•Â§èÂ≠£ÂºÄÊ∫êÊìç‰ΩúÁ≥ªÁªüËÆ≠ÁªÉËê• rCore È°πÁõÆÁöÑ RISC-V Êû∂ÊûÑÁöÑÂÖºÂÆπ POSIX ÂçèËÆÆÁöÑÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÔºåÂÆûÁé∞‰∫ÜÂü∫Êú¨ÁöÑËøõÁ®ãÁÆ°ÁêÜ„ÄÅÂÜÖÂ≠òÁÆ°ÁêÜ„ÄÅÊñá‰ª∂Á≥ªÁªüÂíåËÆæÂ§áÈ©±Âä®„ÄÇ ÂºÄÂèëÁéØÂ¢É ‰∏ªÊú∫Ôºöx86_64 Ubuntu 22.04 LTS Â∑•ÂÖ∑ÈìæÔºöRust (nightly) + riscv64gc">
<meta property="og:type" content="article">
<meta property="og:title" content="PotatOSËÆæËÆ°ÊñáÊ°£">
<meta property="og:url" content="https://kiid-a.github.io/2025/06/15/PotatOS%E6%9E%B6%E6%9E%84/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="PotatOSü•î[toc] ÂÜôÂú®ÂâçÈù¢ü•î‰ªÄ‰πàÊòØPotatOSPotatOSÊòØ‰∏Ä‰∏™Áî® Rust ÁºñÂÜôÁöÑÂü∫‰∫é 2024 Êò•Â§èÂ≠£ÂºÄÊ∫êÊìç‰ΩúÁ≥ªÁªüËÆ≠ÁªÉËê• rCore È°πÁõÆÁöÑ RISC-V Êû∂ÊûÑÁöÑÂÖºÂÆπ POSIX ÂçèËÆÆÁöÑÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÔºåÂÆûÁé∞‰∫ÜÂü∫Êú¨ÁöÑËøõÁ®ãÁÆ°ÁêÜ„ÄÅÂÜÖÂ≠òÁÆ°ÁêÜ„ÄÅÊñá‰ª∂Á≥ªÁªüÂíåËÆæÂ§áÈ©±Âä®„ÄÇ ÂºÄÂèëÁéØÂ¢É ‰∏ªÊú∫Ôºöx86_64 Ubuntu 22.04 LTS Â∑•ÂÖ∑ÈìæÔºöRust (nightly) + riscv64gc">
<meta property="og:locale">
<meta property="og:image" content="c:\Users\Kid_A\AppData\Roaming\Typora\typora-user-images\image-20250530132531781.png">
<meta property="og:image" content="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/sv39-va-pa.png">
<meta property="og:image" content="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/sv39-pte.png">
<meta property="og:image" content="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/sv39-full.png">
<meta property="og:image" content="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/kernel-as-high.png">
<meta property="og:image" content="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/kernel-as-low.png">
<meta property="og:image" content="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/app-as-full.png">
<meta property="og:image" content="c:\Users\Kid_A\AppData\Roaming\Typora\typora-user-images\image-20250328175205292.png">
<meta property="article:published_time" content="2025-06-15T04:32:48.000Z">
<meta property="article:modified_time" content="2025-06-15T04:27:42.181Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Êìç‰ΩúÁ≥ªÁªü">
<meta property="article:tag" content="ËÆæËÆ°ÊñáÊ°£">
<meta property="article:tag" content="ËØæÁ®ãËÆæËÆ°">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="c:\Users\Kid_A\AppData\Roaming\Typora\typora-user-images\image-20250530132531781.png">
  
  
  
  <title>PotatOSËÆæËÆ°ÊñáÊ°£ - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ‰∏ªÈ¢ò‰æùËµñÁöÑÂõæÊ†áÂ∫ìÔºå‰∏çË¶ÅËá™Ë°å‰øÆÊîπ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"kiid-a.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>ÂÖãÈöÜ‰∫∫‰∏ÄÂè∑</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>È¶ñÈ°µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>ÂΩíÊ°£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>ÂàÜÁ±ª</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Ê†áÁ≠æ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>ÂÖ≥‰∫é</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="PotatOSËÆæËÆ°ÊñáÊ°£"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-06-15 12:32" pubdate>
          June 15, 2025 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          14k w√∂rter
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          120 minuten
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">PotatOSËÆæËÆ°ÊñáÊ°£</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="PotatOSü•î"><a href="#PotatOSü•î" class="headerlink" title="PotatOSü•î"></a>PotatOSü•î</h1><p>[toc]</p>
<h2 id="ÂÜôÂú®ÂâçÈù¢"><a href="#ÂÜôÂú®ÂâçÈù¢" class="headerlink" title="ÂÜôÂú®ÂâçÈù¢"></a>ÂÜôÂú®ÂâçÈù¢</h2><h3 id="ü•î‰ªÄ‰πàÊòØPotatOS"><a href="#ü•î‰ªÄ‰πàÊòØPotatOS" class="headerlink" title="ü•î‰ªÄ‰πàÊòØPotatOS"></a>ü•î‰ªÄ‰πàÊòØPotatOS</h3><p>PotatOSÊòØ‰∏Ä‰∏™Áî® Rust ÁºñÂÜôÁöÑÂü∫‰∫é <a target="_blank" rel="noopener" href="https://github.com/bosswnx/2024s-rcore-bosswnx">2024 Êò•Â§èÂ≠£ÂºÄÊ∫êÊìç‰ΩúÁ≥ªÁªüËÆ≠ÁªÉËê• rCore È°πÁõÆ</a>ÁöÑ RISC-V Êû∂ÊûÑÁöÑÂÖºÂÆπ POSIX ÂçèËÆÆÁöÑÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÔºåÂÆûÁé∞‰∫ÜÂü∫Êú¨ÁöÑËøõÁ®ãÁÆ°ÁêÜ„ÄÅÂÜÖÂ≠òÁÆ°ÁêÜ„ÄÅÊñá‰ª∂Á≥ªÁªüÂíåËÆæÂ§áÈ©±Âä®„ÄÇ</p>
<h3 id="ÂºÄÂèëÁéØÂ¢É"><a href="#ÂºÄÂèëÁéØÂ¢É" class="headerlink" title="ÂºÄÂèëÁéØÂ¢É"></a>ÂºÄÂèëÁéØÂ¢É</h3><ul>
<li>‰∏ªÊú∫Ôºöx86_64 Ubuntu 22.04 LTS</li>
<li>Â∑•ÂÖ∑ÈìæÔºöRust (nightly) + riscv64gc-unknown-elf-gcc</li>
<li>Ë∞ÉËØïÔºöQEMU + GDB + VSCode (rust-analyzer)</li>
</ul>
<h3 id="Êñá‰ª∂ÁªìÊûÑ"><a href="#Êñá‰ª∂ÁªìÊûÑ" class="headerlink" title="Êñá‰ª∂ÁªìÊûÑ"></a>Êñá‰ª∂ÁªìÊûÑ</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">.<br>‚îú‚îÄ‚îÄ bootloader<br>‚îú‚îÄ‚îÄ easy-fs<br>‚îú‚îÄ‚îÄ easy-fs-fuse<br>‚îú‚îÄ‚îÄ Makefile<br>‚îú‚îÄ‚îÄ os<br>‚îú‚îÄ‚îÄ qemu-7.0.0<br>‚îú‚îÄ‚îÄ rust-toolchain.toml<br>‚îú‚îÄ‚îÄ setenv.sh<br>‚îî‚îÄ‚îÄ user<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>bootloader</strong>ÔºöQemu Ê®°ÊãüÂô®ÂêØÂä®Êó∂ÁöÑÂºïÂØºÂä†ËΩΩÁ®ãÂ∫è„ÄÇÂÆÉË¥üË¥£Âú®Á≥ªÁªüÂêØÂä®Êó∂ÂàùÂßãÂåñÁ°¨‰ª∂ÔºåÂπ∂Â∞ÜÊéßÂà∂ÊùÉ‰∫§ÁªôÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏„ÄÇ</li>
<li><strong>easy-fs</strong>Ôºöeasy file systemÔºåÊòØÊú¨Á≥ªÁªüÈááÁî®ÁöÑÁÆÄÂåñÊñá‰ª∂Á≥ªÁªüÔºåË¥üË¥£Êñá‰ª∂ÁöÑÂ≠òÂÇ®ÂíåÁÆ°ÁêÜ„ÄÇ</li>
<li><strong>easy-fs-fuse</strong>Ôºöefs filesystem in userspaceÔºåÁî®‰∫éÊµãËØï efsÔºåÂπ∂‰∏îËÉΩÂ§üÊääÂÜÖÊ†∏ÂºÄÂèëÁöÑÂ∫îÁî®ÊâìÂåÖÊàê‰∏Ä‰∏™ efs Ê†ºÂºèÁöÑÊñá‰ª∂Á≥ªÁªüÈïúÂÉèÔºåÊñπ‰æøÂú®Ê®°ÊãüÂô®‰∏≠‰ΩøÁî®„ÄÇ</li>
<li><strong>Makefile</strong>ÔºöÂåÖÂê´‰∫Ü‰∏ÄÁ≥ªÂàóÁºñËØëÂíåËøêË°åÁöÑËßÑÂàôÔºåÈÄöËøá<code>make</code>ÂëΩ‰ª§ÂèØ‰ª•Êñπ‰æøÂú∞ÁºñËØëÂíåËøêË°åÊìç‰ΩúÁ≥ªÁªü„ÄÇ</li>
<li><strong>os</strong>ÔºöÂÜÖÊ†∏Êñá‰ª∂Â§πÔºåÂ≠òÊîæÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÁöÑÊ∫ê‰ª£Á†Å„ÄÇ</li>
<li><strong>qemu-7.0.0</strong>ÔºöQemu Êñá‰ª∂Â§πÔºåÂåÖÂê´‰∫Ü Qemu Ê®°ÊãüÂô®ÁöÑÁõ∏ÂÖ≥Êñá‰ª∂„ÄÇ</li>
<li><strong>rust-toolchain.toml</strong>Ôºörust Â∑•ÂÖ∑ÈìæÊèèËø∞Êñá‰ª∂ÔºåÊåáÂÆö‰∫Ü‰ΩøÁî®ÁöÑ Rust ÁâàÊú¨ÂíåÁõ∏ÂÖ≥ÈÖçÁΩÆ„ÄÇ</li>
<li><strong>setenv.sh</strong>ÔºöËÆæÁΩÆÂºÄÂèëÁéØÂ¢ÉÁöÑËÑöÊú¨ÔºåËøêË°åËØ•ËÑöÊú¨ÂèØ‰ª•ÈÖçÁΩÆÂøÖË¶ÅÁöÑÁéØÂ¢ÉÂèòÈáè„ÄÇ</li>
<li><strong>user</strong>ÔºöÁî®Êà∑Á©∫Èó¥Êñá‰ª∂Â§πÔºåÂ≠òÊîæÁî®Êà∑Â∫îÁî®Á®ãÂ∫èÁöÑÊ∫ê‰ª£Á†Å„ÄÇ</li>
</ul>
<h2 id="ÊâßË°åÁéØÂ¢É‰∏éÂπ≥Âè∞"><a href="#ÊâßË°åÁéØÂ¢É‰∏éÂπ≥Âè∞" class="headerlink" title="ÊâßË°åÁéØÂ¢É‰∏éÂπ≥Âè∞"></a>ÊâßË°åÁéØÂ¢É‰∏éÂπ≥Âè∞</h2><ul>
<li><p><strong>Êû∂ÊûÑ</strong>ÔºöRISC-V RV64GCÔºàÁâπÊùÉÊ®°ÂºèÔºöS-modeÔºâ</p>
</li>
<li><p><strong>QEMU ÈÖçÁΩÆ</strong>Ôºö</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-system-riscv64 \<br>  -machine virt \<br>  -nographic \<br>  -bios none \<br>  -kernel target/riscv64gc-unknown-none-elf/debug/potatos \<br>  -device virtio-blk-device,drive=disk0 \<br>  -drive file=fs.img,format=raw,<span class="hljs-built_in">id</span>=disk0<br></code></pre></td></tr></table></figure>

<ul>
<li><code>-machine virt</code>ÔºöÊåáÂÆö‰ΩøÁî® QEMU ÁöÑËôöÊãüÁ°¨‰ª∂Ê®°Âûã„ÄÇ</li>
<li><code>-nographic</code>Ôºö‰∏ç‰ΩøÁî®ÂõæÂΩ¢ÁïåÈù¢Ôºå‰ª•ÊñáÊú¨Ê®°ÂºèËøêË°å„ÄÇÂ¶ÇÊûúÈúÄË¶ÅÂõæÂΩ¢ÂåñÁïåÈù¢ÔºåÂèØ‰ª•ÂéªÊéâËØ•ÈÄâÈ°π„ÄÇ</li>
<li><code>-bios none</code>Ôºö‰∏ç‰ΩøÁî® BIOS„ÄÇ</li>
<li><code>-kernel target/riscv64gc-unknown-none-elf/debug/potatos</code>ÔºöÊåáÂÆöË¶ÅÂä†ËΩΩÁöÑÂÜÖÊ†∏‰∫åËøõÂà∂Êñá‰ª∂„ÄÇ</li>
<li><code>-device virtio-blk-device,drive=disk0</code>ÔºöÊ∑ªÂä†‰∏Ä‰∏™ Virtio ÂùóËÆæÂ§á„ÄÇ</li>
<li><code>-drive file=fs.img,format=raw,id=disk0</code>ÔºöÊåáÂÆö‰ΩøÁî®ÁöÑÁ£ÅÁõòÈïúÂÉèÊñá‰ª∂„ÄÇ</li>
</ul>
</li>
</ul>
<h3 id="RustSbi"><a href="#RustSbi" class="headerlink" title="RustSbi"></a>RustSbi</h3><p><code>SBI</code>ÊòØRISC-VÂÆö‰πâÁöÑ‰∏ÄÁªÑÊé•Âè£ËßÑËåÉÔºåÁî®‰∫éÊìç‰ΩúÁ≥ªÁªü‰∏éÁ°¨‰ª∂Èó¥ÁöÑÊ≤üÈÄö„ÄÇ<code>RustSbi</code>ÊòØËøûÊé•ËØ•Êìç‰ΩúÁ≥ªÁªü‰∏éÂ∫ïÂ±ÇÁ°¨‰ª∂ÁöÑÊ°•Ê¢ÅÔºå‰∏ªË¶ÅÊúâ‰ª•‰∏ãÂäüËÉΩÔºö</p>
<ul>
<li><strong>Á°¨‰ª∂ÊäΩË±°</strong>ÔºöÂ∞ÜÁ°¨‰ª∂ËÆøÈóÆÊäΩË±°ÊàêÊé•Âè£Ôºå‰ΩøÂæóÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÂèØ‰ª•ÈÄöËøáÁªü‰∏ÄÁöÑÊé•Âè£ËÆøÈóÆ‰∏çÂêåÁöÑÁ°¨‰ª∂ËÆæÂ§áÔºåÊèêÈ´ò‰∫Ü‰ª£Á†ÅÁöÑÂèØÁßªÊ§çÊÄß„ÄÇ</li>
<li><strong>Á≥ªÁªüÂêØÂä®</strong>Ôºö‰∏äÁîµÊó∂ Sbi Ë¥üË¥£ÂàùÂßãÂåñÁ°¨‰ª∂ÔºåÁÑ∂Âêé‰ªéÂ≠òÂÇ®‰∏≠Âä†ËΩΩÂà∞Êìç‰ΩúÁ≥ªÁªü„ÄÇÂÆÉ‰ºöÂÆåÊàê‰∏Ä‰∫õÂøÖË¶ÅÁöÑÁ°¨‰ª∂ÂàùÂßãÂåñÂ∑•‰ΩúÔºåÂ¶ÇËÆæÁΩÆÂÜÖÂ≠òÊò†Â∞Ñ„ÄÅÂàùÂßãÂåñ‰∏≠Êñ≠ÊéßÂà∂Âô®Á≠âÔºå‰∏∫Êìç‰ΩúÁ≥ªÁªüÁöÑÂêØÂä®ÂÅöÂ•ΩÂáÜÂ§á„ÄÇ</li>
<li><strong>ÂºÇÂ∏∏Âíå‰∏≠Êñ≠Â§ÑÁêÜ</strong>ÔºöÂΩìÂèëÁîüÂºÇÂ∏∏Êàñ‰∏≠Êñ≠Êó∂ÔºåÊìç‰ΩúÁ≥ªÁªüÊääÁ°¨‰ª∂ÊéßÂà∂ÊùÉ‰∫§Áªô SbiÔºåSbi Âú®Â∫ïÂ±ÇÂÆåÊàêÂ§ÑÁêÜÂêé‰∫§ËøòÊéßÂà∂ÊùÉ„ÄÇSbi ÂèØ‰ª•Â§ÑÁêÜ‰∏Ä‰∫õÂ∫ïÂ±ÇÁöÑÂºÇÂ∏∏Âíå‰∏≠Êñ≠ÔºåÂ¶ÇÂÆöÊó∂Âô®‰∏≠Êñ≠„ÄÅÂ§ñÈÉ®ËÆæÂ§á‰∏≠Êñ≠Á≠âÔºåÂáèËΩª‰∫ÜÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÁöÑË¥üÊãÖ„ÄÇ</li>
</ul>
<h2 id="Boot"><a href="#Boot" class="headerlink" title="Boot"></a>Boot</h2><p>ÈÄöËøáQemuÂêØÂä®</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs makefile">QEMU_ARGS := -machine virt \<br>			 -bios <span class="hljs-variable">$(BOOTLOADER)</span> \<br>			 -serial stdio \<br>			 <span class="hljs-variable">$(GUI_OPTION)</span> \<br>			 -device loader,file=<span class="hljs-variable">$(KERNEL_BIN)</span>,addr=<span class="hljs-variable">$(KERNEL_ENTRY_PA)</span> \<br>			 -drive file=<span class="hljs-variable">$(FS_IMG)</span>,if=none,format=raw,id=x0 \<br>			 -device virtio-blk-device,drive=x0 \<br>			 -device virtio-gpu-device \<br>			 -device virtio-keyboard-device \<br>			 -device virtio-mouse-device \<br>			 -device virtio-net-device,netdev=net0 \<br>			 -netdev user,id=net0,hostfwd=udp::6200-:2000,hostfwd=tcp::6201-:80<br></code></pre></td></tr></table></figure>

<p>Â∞ÜÁºñËØëÂ•ΩÁöÑkernel‰∫åËøõÂà∂Êñá‰ª∂Âä†ËΩΩÂà∞ÂØπÂ∫îÁöÑÂêØÂä®‰ΩçÁΩÆÔºåËøôÈáåÊòØ<code>0x80200000</code></p>
<h2 id="‰∏≠Êñ≠-ÁâπÊùÉÁ∫ßÊú∫Âà∂"><a href="#‰∏≠Êñ≠-ÁâπÊùÉÁ∫ßÊú∫Âà∂" class="headerlink" title="‰∏≠Êñ≠&#x2F;ÁâπÊùÉÁ∫ßÊú∫Âà∂"></a>‰∏≠Êñ≠&#x2F;ÁâπÊùÉÁ∫ßÊú∫Âà∂</h2><p>RISC-V‰∏∫‰∫ÜÁªôÊìç‰ΩúÁ≥ªÁªü‰∏Ä‰∏™Á®≥ÂÆöÁöÑËøêË°åÁéØÂ¢ÉÔºå‰∏ç‰ºöË¢´Â∫îÁî®ÊâÄÂπ≤Êâ∞ÔºåËÆæËÆ°‰∫Ü‰∏Ä‰∏™ÁâπÊùÉÁ∫ßÊú∫Âà∂„ÄÇËøôÈáåÊàë‰ª¨‰∏ªË¶ÅÊòØÂÆûÁé∞Ëøô‰∏ÄÈÉ®ÂàÜÁöÑÂäüËÉΩ„ÄÇ</p>
<h3 id="ÂàáÊç¢"><a href="#ÂàáÊç¢" class="headerlink" title="ÂàáÊç¢"></a>ÂàáÊç¢</h3><ol>
<li><strong>Áî®Êà∑Á®ãÂ∫èÊâßË°åËß¶Âèë Trap</strong>ÔºöÂΩìÁî®Êà∑Á®ãÂ∫èÊâßË°åÊüê‰∫õÁâπÊÆäÊåá‰ª§ÊàñÂèëÁîüÂºÇÂ∏∏Êó∂Ôºå‰ºöËß¶Âèë Trap Êú∫Âà∂ÔºåÂ∞ÜÊéßÂà∂ÊùÉËΩ¨ÁßªÂà∞Êìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏„ÄÇ</li>
<li><strong>Á°¨‰ª∂Ëá™Âä®‰øùÂ≠ò <code>sepc</code>„ÄÅ<code>sstatus</code> Á≠âÂØÑÂ≠òÂô®Âà∞ÂÜÖÊ†∏Á©∫Èó¥ÁöÑ <code>TrapContext</code></strong>Ôºö<code>sepc</code> ‰øùÂ≠ò‰∫Ü Trap ÂèëÁîüÊó∂ÁöÑÁ®ãÂ∫èËÆ°Êï∞Âô®Ôºå<code>sstatus</code> ‰øùÂ≠ò‰∫ÜÂΩìÂâçÁöÑÁä∂ÊÄÅ‰ø°ÊÅØ„ÄÇÁ°¨‰ª∂‰ºöËá™Âä®Â∞ÜËøô‰∫õÂØÑÂ≠òÂô®ÁöÑÂÄº‰øùÂ≠òÂà∞ÂÜÖÊ†∏Á©∫Èó¥ÁöÑ <code>TrapContext</code> ‰∏≠Ôºå‰ª•‰æøÂêéÁª≠ÊÅ¢Â§ç„ÄÇ</li>
<li><strong>ÂÜÖÊ†∏ËØªÂèñ <code>TrapContext</code>ÔºåÊâßË°å <code>trap_handler</code> Â§ÑÁêÜÈÄªËæëÔºàÂ¶ÇÁ≥ªÁªüË∞ÉÁî®ÊúçÂä°Ôºâ</strong>ÔºöÂÜÖÊ†∏‰ªé <code>TrapContext</code> ‰∏≠ËØªÂèñÁõ∏ÂÖ≥‰ø°ÊÅØÔºåÊ†πÊçÆ‰∏çÂêåÁöÑ Trap ÂéüÂõ†ÊâßË°åÁõ∏Â∫îÁöÑÂ§ÑÁêÜÈÄªËæëÔºåÂ¶ÇÂ§ÑÁêÜÁ≥ªÁªüË∞ÉÁî®„ÄÅÂºÇÂ∏∏Â§ÑÁêÜÁ≠â„ÄÇ</li>
<li><strong>Â§ÑÁêÜÂÆåÊØïÂêéÔºå‰ªé <code>TrapContext</code> ÊÅ¢Â§çÁî®Êà∑ÂØÑÂ≠òÂô®Ôºà<code>x</code>„ÄÅ<code>sstatus</code>ÔºâÔºåÈÄöËøá <code>sret</code> Êåá‰ª§Ë∑≥Âõû <code>sepc</code> ÁªßÁª≠ÊâßË°åÁî®Êà∑Á®ãÂ∫è</strong>ÔºöÂ§ÑÁêÜÂÆå Trap ÂêéÔºåÂÜÖÊ†∏Â∞ÜÁî®Êà∑ÂØÑÂ≠òÂô®ÁöÑÂÄº‰ªé <code>TrapContext</code> ‰∏≠ÊÅ¢Â§çÔºåÂπ∂ÈÄöËøá <code>sret</code> Êåá‰ª§Â∞ÜÊéßÂà∂ÊùÉ‰∫§ËøòÁªôÁî®Êà∑Á®ãÂ∫èÔºåÁªßÁª≠ÊâßË°åÂêéÁª≠ÁöÑÊåá‰ª§„ÄÇ</li>
</ol>
<h4 id="Áî®Êà∑Ê†à-ÂÜÖÊ†∏Ê†à"><a href="#Áî®Êà∑Ê†à-ÂÜÖÊ†∏Ê†à" class="headerlink" title="Áî®Êà∑Ê†à&#x2F;ÂÜÖÊ†∏Ê†à"></a>Áî®Êà∑Ê†à&#x2F;ÂÜÖÊ†∏Ê†à</h4><p>Âå∫ÂàÜ‰∏§‰∏™Ê†àÊòØ‰∏∫‰∫ÜÂ∫îÁî®Á®ãÂ∫è‰∏ç‰ºöÈÄöËøáÊ†à‰ø°ÊÅØËØªÂèñÂà∞ÂÜÖÊ†∏ÁöÑÊéßÂà∂ÊµÅÔºå‰ªéËÄåÈÅøÂÖç‰∫Ü‰∏ÄÂÆöÁöÑÂÆâÂÖ®ÈöêÊÇ£„ÄÇ</p>
<p>‰ΩÜÂú®PotatOSÈáåÔºåÁî®Êà∑Ê†àË¢´ÁÆÄÂçïÂú∞ÊäΩË±°Êàê‰∫Ü<strong>Â∫îÁî®Ê†à</strong></p>
<p>ÂÜÖÊ†∏Ê†à‰∏éËøõÁ®ãÁªëÂÆöÔºåÊäΩË±°Êàê‰∫ÜËøõÁ®ãÁã¨Á´ã‰∏îÈöîÁ¶ªÁöÑ<strong>ËøõÁ®ãÊ†à</strong></p>
<h4 id="‰∏ä‰∏ãÊñáÂàáÊç¢-ÊÅ¢Â§ç"><a href="#‰∏ä‰∏ãÊñáÂàáÊç¢-ÊÅ¢Â§ç" class="headerlink" title="‰∏ä‰∏ãÊñáÂàáÊç¢&#x2F;ÊÅ¢Â§ç"></a>‰∏ä‰∏ãÊñáÂàáÊç¢&#x2F;ÊÅ¢Â§ç</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TrapContext</span> &#123;<br>    <span class="hljs-keyword">pub</span> x: [<span class="hljs-type">usize</span>; <span class="hljs-number">32</span>],<br>    <span class="hljs-keyword">pub</span> sstatus: Sstatus,<br>    <span class="hljs-keyword">pub</span> sepc: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> kernel_satp: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> kernel_sp: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> trap_handler: <span class="hljs-type">usize</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>x</code>Ôºö‰øùÂ≠ò32‰∏™ÈÄöÁî®ÂØÑÂ≠òÂô®ÁöÑÂÄºÔºåÊöÇÂ≠òÁî®Êà∑Á©∫Èó¥ÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅÔºå‰ª•‰æøÈô∑Èò±Â§ÑÁêÜÂÆåÊØïÂêéÊÅ¢Â§çÊâßË°å</li>
<li><code>sstatus</code>Ôºö‰øùÂ≠òË∂ÖÁ∫ßÁî®Êà∑Áä∂ÊÄÅÂØÑÂ≠òÂô®(Sstatus)ÁöÑÂÄºÔºåËÆ∞ÂΩïÂΩìÂâçÁâπÊùÉÁ∫ßÔºå‰∏≠Êñ≠‰ΩøËÉΩÔºåÁä∂ÊÄÅÊ†áÂøóÔºåÁî®‰∫éÁä∂ÊÄÅÊÅ¢Â§ç</li>
<li><code>sepc</code>Ôºö‰øùÂ≠òË∂ÖÁ∫ßÁî®Êà∑ÂºÇÂ∏∏Á®ãÂ∫èËÆ°Êï∞Âô®(SEPC)ÁöÑÂÄºÔºåËÆ∞ÂΩïtrapÂèëÁîüÊó∂ÁöÑÂú∞ÂùÄ</li>
<li><code>kernel_satp</code> ÔºöÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥ÁöÑ token ÔºåÂç≥ÂÜÖÊ†∏È°µË°®ÁöÑËµ∑ÂßãÁâ©ÁêÜÂú∞ÂùÄ</li>
<li><code>kernel_sp</code> ÔºöÂΩìÂâçÂ∫îÁî®Âú®ÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥‰∏≠ÁöÑÂÜÖÊ†∏Ê†àÊ†àÈ°∂ÁöÑËôöÊãüÂú∞ÂùÄ</li>
<li><code>trap_handler</code> ÔºöÂÜÖÊ†∏‰∏≠ trap handler ÂÖ•Âè£ÁÇπÁöÑËôöÊãüÂú∞ÂùÄ</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.altmacro<br>.macro SAVE_GP n<br>    sd x\n, \n*8(sp)<br>.endm<br>.macro LOAD_GP n<br>    ld x\n, \n*8(sp)<br>.endm<br>    .section .text.trampoline<br>    .globl __alltraps<br>    .globl __restore<br>    .globl __alltraps_k<br>    .globl __restore_k<br>    .align 2<br>__alltraps:<br>    csrrw sp, sscratch, sp<br>    # now sp-&gt;*TrapContext in user space, sscratch-&gt;user stack<br>    # save other general purpose registers<br>    sd x1, 1*8(sp)<br>    # skip sp(x2), we will save it later<br>    sd x3, 3*8(sp)<br>    # skip tp(x4), application does not use it<br>    # save x5~x31<br>    .set n, 5<br>    .rept 27<br>        SAVE_GP %n<br>        .set n, n+1<br>    .endr<br>    # we can use t0/t1/t2 freely, because they have been saved in TrapContext<br>    csrr t0, sstatus<br>    csrr t1, sepc<br>    sd t0, 32*8(sp)<br>    sd t1, 33*8(sp)<br>    # read user stack from sscratch and save it in TrapContext<br>    csrr t2, sscratch<br>    sd t2, 2*8(sp)<br>    # load kernel_satp into t0<br>    ld t0, 34*8(sp)<br>    # load trap_handler into t1<br>    ld t1, 36*8(sp)<br>    # move to kernel_sp<br>    ld sp, 35*8(sp)<br>    # switch to kernel space<br>    csrw satp, t0<br>    sfence.vma<br>    # jump to trap_handler<br>    jr t1<br><br>__restore:<br>    # a0: *TrapContext in user space(Constant); a1: user space token<br>    # switch to user space<br>    csrw satp, a1<br>    sfence.vma<br>    csrw sscratch, a0<br>    mv sp, a0<br>    # now sp points to TrapContext in user space, start restoring based on it<br>    # restore sstatus/sepc<br>    ld t0, 32*8(sp)<br>    ld t1, 33*8(sp)<br>    csrw sstatus, t0<br>    csrw sepc, t1<br>    # restore general purpose registers except x0/sp/tp<br>    ld x1, 1*8(sp)<br>    ld x3, 3*8(sp)<br>    .set n, 5<br>    .rept 27<br>        LOAD_GP %n<br>        .set n, n+1<br>    .endr<br>    # back to user stack<br>    ld sp, 2*8(sp)<br>    sret<br><br>    .align 2<br></code></pre></td></tr></table></figure>

<ul>
<li><code>__alltraps</code>Ôºö‰øùÂ≠ò trap ‰∏ä‰∏ãÊñáËá≥ÂÜÖÊ†∏Ê†à„ÄÇÂú®ÂèëÁîü Trap Êó∂ÔºåËØ•ÂáΩÊï∞‰ºöÂ∞ÜÁî®Êà∑Á©∫Èó¥ÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅ‰øùÂ≠òÂà∞ÂÜÖÊ†∏Ê†àÁöÑ <code>TrapContext</code> ‰∏≠ÔºåÂπ∂ÂàáÊç¢Âà∞ÂÜÖÊ†∏Á©∫Èó¥„ÄÇ</li>
<li><code>__restore</code>ÔºöÊÅ¢Â§ç trap ‰∏ä‰∏ãÊñá„ÄÇÂú®Â§ÑÁêÜÂÆå Trap ÂêéÔºåËØ•ÂáΩÊï∞‰ºö‰ªé <code>TrapContext</code> ‰∏≠ÊÅ¢Â§çÁî®Êà∑ÂØÑÂ≠òÂô®ÁöÑÂÄºÔºåÂπ∂ÂàáÊç¢ÂõûÁî®Êà∑Á©∫Èó¥ÔºåÁªßÁª≠ÊâßË°åÁî®Êà∑Á®ãÂ∫è„ÄÇ</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">trap_return</span>() <span class="hljs-punctuation">-&gt;</span> ! &#123;<br>    <span class="hljs-title function_ invoke__">current_task</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">inner_exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">user_time_start</span>();<br><br>    <span class="hljs-title function_ invoke__">disable_supervisor_interrupt</span>();<br>    <span class="hljs-title function_ invoke__">set_user_trap_entry</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">trap_cx_user_va</span> = <span class="hljs-title function_ invoke__">current_trap_cx_user_va</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">user_satp</span> = <span class="hljs-title function_ invoke__">current_user_token</span>();<br>    <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123;<br>        <span class="hljs-keyword">fn</span> <span class="hljs-title function_">__alltraps</span>();<br>        <span class="hljs-keyword">fn</span> <span class="hljs-title function_">__restore</span>();<br>    &#125;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">restore_va</span> = __restore <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> - __alltraps <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> + TRAMPOLINE;<br>    <span class="hljs-comment">//println!(&quot;before return&quot;);</span><br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        asm!(<br>            <span class="hljs-string">&quot;fence.i&quot;</span>,<br>            <span class="hljs-string">&quot;jr &#123;restore_va&#125;&quot;</span>,<br>            restore_va = <span class="hljs-title function_ invoke__">in</span>(reg) restore_va,<br>            <span class="hljs-title function_ invoke__">in</span>(<span class="hljs-string">&quot;a0&quot;</span>) trap_cx_user_va,<br>            <span class="hljs-title function_ invoke__">in</span>(<span class="hljs-string">&quot;a1&quot;</span>) user_satp,<br>            <span class="hljs-title function_ invoke__">options</span>(noreturn)<br>        );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Âú®trapÊÅ¢Â§çÊó∂Ë∞ÉÁî®‰∏äÈù¢ÁöÑÂáΩÊï∞ÂõûÂà∞Ê≠£Á°ÆÁöÑÊ†àÁ©∫Èó¥ÂÜÖ„ÄÇ</p>
<h4 id="trapÂ§ÑÁêÜ"><a href="#trapÂ§ÑÁêÜ" class="headerlink" title="trapÂ§ÑÁêÜ"></a>trapÂ§ÑÁêÜ</h4><p>ÂΩìÂèëÁîü Trap Êó∂ÔºåÊìç‰ΩúÁ≥ªÁªü‰ºöÊ†πÊçÆ Trap ÁöÑÂéüÂõ†ÊâßË°åÁõ∏Â∫îÁöÑÂ§ÑÁêÜÈÄªËæë„ÄÇÂ∏∏ËßÅÁöÑ Trap ÂéüÂõ†ÂåÖÊã¨Á≥ªÁªüË∞ÉÁî®„ÄÅÂºÇÂ∏∏Âíå‰∏≠Êñ≠Á≠â„ÄÇÂú® <code>trap_handler</code> ÂáΩÊï∞‰∏≠Ôºå‰ºöÊ†πÊçÆ‰∏çÂêåÁöÑ Trap ÂéüÂõ†ËøõË°åÂàÜÁ±ªÂ§ÑÁêÜÔºåÂ¶ÇÂ§ÑÁêÜÁ≥ªÁªüË∞ÉÁî®Êó∂‰ºöÊ†πÊçÆÁ≥ªÁªüË∞ÉÁî®Âè∑ÊâßË°åÁõ∏Â∫îÁöÑÊúçÂä°ÂáΩÊï∞ÔºåÂ§ÑÁêÜÂºÇÂ∏∏Êó∂‰ºöËøõË°åÈîôËØØÂ§ÑÁêÜÂíåÊÅ¢Â§çÔºåÂ§ÑÁêÜ‰∏≠Êñ≠Êó∂‰ºöË∞ÉÁî®Áõ∏Â∫îÁöÑ‰∏≠Êñ≠Â§ÑÁêÜÂáΩÊï∞„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">trap_handler</span>() <span class="hljs-punctuation">-&gt;</span> ! &#123;<br>    <span class="hljs-title function_ invoke__">set_kernel_trap_entry</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">scause</span> = scause::<span class="hljs-title function_ invoke__">read</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">stval</span> = stval::<span class="hljs-title function_ invoke__">read</span>();<br>    <span class="hljs-comment">// println!(&quot;into &#123;:?&#125;&quot;, scause.cause());</span><br>    <span class="hljs-keyword">match</span> scause.<span class="hljs-title function_ invoke__">cause</span>() &#123;<br>        Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::UserEnvCall) =&gt; &#123;<br>            <span class="hljs-title function_ invoke__">current_task</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">inner_exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">user_time_end</span>();<br>            <br>            <span class="hljs-comment">// jump to next instruction anyway</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cx</span> = <span class="hljs-title function_ invoke__">current_trap_cx</span>();<br>            cx.sepc += <span class="hljs-number">4</span>;<br><br>            <span class="hljs-title function_ invoke__">enable_supervisor_interrupt</span>();<br><br>            <span class="hljs-comment">// get system call return value</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">syscall</span>(cx.x[<span class="hljs-number">17</span>], [cx.x[<span class="hljs-number">10</span>], cx.x[<span class="hljs-number">11</span>], cx.x[<span class="hljs-number">12</span>]]);<br>            <span class="hljs-comment">// cx is changed during sys_exec, so we have to call it again</span><br>            cx = <span class="hljs-title function_ invoke__">current_trap_cx</span>();<br>            cx.x[<span class="hljs-number">10</span>] = result <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>;<br>        &#125;<br>        Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::StoreFault)<br>        | Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::StorePageFault)<br>        | Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::InstructionFault)<br>        | Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::InstructionPageFault)<br>        | Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::LoadFault)<br>        | Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::LoadPageFault) =&gt; &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            println!(</span><br><span class="hljs-comment">                &quot;[kernel] &#123;:?&#125; in application, bad addr = &#123;:#x&#125;, bad instruction = &#123;:#x&#125;, kernel killed it.&quot;,</span><br><span class="hljs-comment">                scause.cause(),</span><br><span class="hljs-comment">                stval,</span><br><span class="hljs-comment">                current_trap_cx().sepc,</span><br><span class="hljs-comment">            );</span><br><span class="hljs-comment">            */</span><br>            <span class="hljs-title function_ invoke__">current_add_signal</span>(SignalFlags::SIGSEGV);<br>        &#125;<br>        Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::IllegalInstruction) =&gt; &#123;<br>            <span class="hljs-title function_ invoke__">current_add_signal</span>(SignalFlags::SIGILL);<br>        &#125;<br>        Trap::<span class="hljs-title function_ invoke__">Interrupt</span>(Interrupt::SupervisorTimer) =&gt; &#123;<br>            <span class="hljs-title function_ invoke__">set_next_trigger</span>();<br>            <span class="hljs-title function_ invoke__">check_timer</span>();<br>            <span class="hljs-title function_ invoke__">suspend_current_and_run_next</span>();<br>        &#125;<br>        Trap::<span class="hljs-title function_ invoke__">Interrupt</span>(Interrupt::SupervisorExternal) =&gt; &#123;<br>            crate::board::<span class="hljs-title function_ invoke__">irq_handler</span>();<br>        &#125;<br>        _ =&gt; &#123;<br>            <span class="hljs-built_in">panic!</span>(<br>                <span class="hljs-string">&quot;Unsupported trap &#123;:?&#125;, stval = &#123;:#x&#125;!&quot;</span>,<br>                scause.<span class="hljs-title function_ invoke__">cause</span>(),<br>                stval<br>            );<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// check signals</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>((errno, msg)) = <span class="hljs-title function_ invoke__">check_signals_of_current</span>() &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[kernel] &#123;&#125;&quot;</span>, msg);<br>        <span class="hljs-title function_ invoke__">exit_current_and_run_next</span>(errno);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">trap_return</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ËøôÈáåÈÄöËøá<code>match</code>ËØ≠Âè•ÂÆûÁé∞‰∏≠Êñ≠ÂêëÈáèÊü•Êâæ-ÂåπÈÖç-Â§ÑÁêÜ„ÄÇ</p>
<h3 id="Ë∑≥Êùø-Trampoline"><a href="#Ë∑≥Êùø-Trampoline" class="headerlink" title="Ë∑≥Êùø(Trampoline)"></a>Ë∑≥Êùø(Trampoline)</h3><p>Âú®‰º†ÁªüÁöÑOS‰∏≠Ôºå‰∏Ä‰∏™Â∫îÁî®ÁöÑÁî®Êà∑ÂíåÂÜÖÊ†∏ÊÄÅÈÄöÂ∏∏ÂàÜÈÖçÂú®Âêå‰∏Ä‰∏™Âú∞ÂùÄÁ©∫Èó¥ÁöÑÈ´ò‰ΩçÂíå‰Ωé‰ΩçÔºåËøôÊ†∑ÂèØ‰ª•Êñπ‰æøÂú∞‰ΩøÁî®Ê†àÂØÑÂ≠òÂô®ËøõË°åË∑≥ËΩ¨„ÄÇ‰ΩÜÊòØÔºåËøôÊ†∑ÂÅö‰ºöÊúâÂÜÖÊ†∏Â∑•‰ΩúÊµÅÊ≥ÑÈú≤ÁöÑÈ£éÈô©„ÄÇÊâÄ‰ª•ÈúÄË¶Å‰∏Ä‰∏™Ë∑≥ÊùøÊù•‰øùÂ≠òÂ∑•‰ΩúÊµÅË∞ÉÁî®ËÆøÈóÆÈìæÊù°„ÄÇ</p>
<img src="C:\Users\Kid_A\AppData\Roaming\Typora\typora-user-images\image-20250530132531781.png" srcset="/img/loading.gif" lazyload alt="image-20250530132531781" style="zoom: 50%;" />

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/mm/memory_set.rs</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">map_trampoline</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>    <span class="hljs-keyword">self</span>.page_table.<span class="hljs-title function_ invoke__">map</span>(<br>        VirtAddr::<span class="hljs-title function_ invoke__">from</span>(TRAMPOLINE).<span class="hljs-title function_ invoke__">into</span>(),<br>        PhysAddr::<span class="hljs-title function_ invoke__">from</span>(strampoline <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>        PTEFlags::R | PTEFlags::X,<br>    );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ËøôÈáåÊääËôöÊãüÂú∞ÂùÄÁöÑÈ´ò‰ΩçÈÉΩÂõ∫ÂÆöÊò†Â∞ÑÂà∞<code>trampoline</code>„ÄÇ</p>
<h3 id="Á≥ªÁªüË∞ÉÁî®"><a href="#Á≥ªÁªüË∞ÉÁî®" class="headerlink" title="Á≥ªÁªüË∞ÉÁî®"></a>Á≥ªÁªüË∞ÉÁî®</h3><p>Âú®<strong>RISC-V</strong>ÈáåÔºåÁ≥ªÁªüË∞ÉÁî®‰∏ªË¶ÅÁî±<code>ecall</code>ÂÆûÁé∞„ÄÇÂΩìÁî®Êà∑Á®ãÂ∫èÈúÄË¶ÅÊâßË°åÁâπÊùÉÊìç‰ΩúÔºåÂ¶ÇÊñá‰ª∂ËØªÂÜô„ÄÅËøõÁ®ãÂàõÂª∫„ÄÅÂÜÖÂ≠òÁÆ°ÁêÜÁ≠âÊó∂ÔºåÊó†Ê≥ïÁõ¥Êé•ËÆøÈóÆÁ°¨‰ª∂ËµÑÊ∫êÔºåÂøÖÈ°ªÈÄöËøá <code>ecall</code> Êåá‰ª§ËØ∑Ê±ÇÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏Êèê‰æõÊúçÂä°„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// usr/src/syscall.rs</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">syscall</span>(id: <span class="hljs-type">usize</span>, args: [<span class="hljs-type">usize</span>; <span class="hljs-number">3</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ret</span>: <span class="hljs-type">isize</span>;<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        core::arch::asm!(<br>            <span class="hljs-string">&quot;ecall&quot;</span>,<br>            <span class="hljs-title function_ invoke__">inlateout</span>(<span class="hljs-string">&quot;x10&quot;</span>) args[<span class="hljs-number">0</span>] =&gt; ret,<br>            <span class="hljs-title function_ invoke__">in</span>(<span class="hljs-string">&quot;x11&quot;</span>) args[<span class="hljs-number">1</span>],<br>            <span class="hljs-title function_ invoke__">in</span>(<span class="hljs-string">&quot;x12&quot;</span>) args[<span class="hljs-number">2</span>],<br>            <span class="hljs-title function_ invoke__">in</span>(<span class="hljs-string">&quot;x17&quot;</span>) id<br>        );<br>    &#125;<br>    ret<br>&#125;<br><br><span class="hljs-comment">// os/src/trap/mod.rs</span><br>Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::UserEnvCall) =&gt; &#123;<br>    <span class="hljs-title function_ invoke__">current_task</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">inner_exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">user_time_end</span>();    <br>    <span class="hljs-comment">// jump to next instruction anyway</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cx</span> = <span class="hljs-title function_ invoke__">current_trap_cx</span>();<br>    cx.sepc += <span class="hljs-number">4</span>;<br>    <span class="hljs-title function_ invoke__">enable_supervisor_interrupt</span>();<br>    <span class="hljs-comment">// get system call return value</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">syscall</span>(cx.x[<span class="hljs-number">17</span>], [cx.x[<span class="hljs-number">10</span>], cx.x[<span class="hljs-number">11</span>], cx.x[<span class="hljs-number">12</span>]]);<br>    <span class="hljs-comment">// cx is changed during sys_exec, so we have to call it again</span><br>    cx = <span class="hljs-title function_ invoke__">current_trap_cx</span>();<br>    cx.x[<span class="hljs-number">10</span>] = result <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>;<br>&#125;<br><br><span class="hljs-comment">// os/src/syscall/mod.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">syscall</span>(syscall_id: <span class="hljs-type">usize</span>, args: [<span class="hljs-type">usize</span>; <span class="hljs-number">3</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123;<br>    <span class="hljs-keyword">match</span> syscall_id &#123;<br>        SYSCALL_FSTAT =&gt; <span class="hljs-title function_ invoke__">sys_fstat</span>(args[<span class="hljs-number">0</span>], args[<span class="hljs-number">1</span>]),<br>        SYSCALL_GETCWD =&gt; <span class="hljs-title function_ invoke__">sys_getcwd</span>(args[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>, args[<span class="hljs-number">1</span>]),<br>        <span class="hljs-comment">// ...</span><br>        _ =&gt; <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Unsupported syscall_id: &#123;&#125;&quot;</span>, syscall_id),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>syscall</code>ÈÄöËøá<code>ecall</code>ÂèëËµ∑<code>UserEnvCall</code>Ôºå‰º†ÈÄíÂáΩÊï∞Âêç(Êûö‰∏æ)ÂíåÂèÇÊï∞ÔºåÊâæÂà∞Âπ∂ÊâßË°åÂØπÂ∫îÁöÑÁ≥ªÁªüË∞ÉÁî®ÂáΩÊï∞„ÄÇ</p>
<blockquote>
<p>ecall</p>
<ol>
<li>Á≥ªÁªüË∞ÉÁî®Êé•Âè£</li>
</ol>
<p><code>ecall</code> Êåá‰ª§ÁöÑ‰∏ªË¶ÅÁî®ÈÄîÊòØÂÆûÁé∞<strong>Á≥ªÁªüË∞ÉÁî®</strong>ÔºàSystem CallÔºâ„ÄÇÂΩìÁî®Êà∑Á®ãÂ∫èÈúÄË¶ÅÊâßË°åÁâπÊùÉÊìç‰ΩúÔºàÂ¶ÇÊñá‰ª∂ËØªÂÜô„ÄÅËøõÁ®ãÂàõÂª∫„ÄÅÂÜÖÂ≠òÁÆ°ÁêÜÁ≠âÔºâÊó∂ÔºåÊó†Ê≥ïÁõ¥Êé•ËÆøÈóÆÁ°¨‰ª∂ËµÑÊ∫êÔºåÂøÖÈ°ªÈÄöËøá <code>ecall</code> Êåá‰ª§ËØ∑Ê±ÇÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏Êèê‰æõÊúçÂä°„ÄÇ</p>
<ol start="2">
<li>ÁâπÊùÉÁ∫ßÂàáÊç¢</li>
</ol>
<ul>
<li><strong>Áî®Êà∑Ê®°ÂºèÔºàU-modeÔºâ</strong>ÔºöÁî®Êà∑Á®ãÂ∫èËøêË°åÂú®Ê≠§Ê®°ÂºèÔºåÊùÉÈôêÂèóÈôêÔºåÊó†Ê≥ïÁõ¥Êé•ËÆøÈóÆÁ°¨‰ª∂ÊàñÊâßË°åÁâπÊùÉÊåá‰ª§„ÄÇ</li>
<li><strong>ÁõëÁÆ°ËÄÖÊ®°ÂºèÔºàS-modeÔºâ</strong>ÔºöÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ËøêË°åÂú®Ê≠§Ê®°ÂºèÔºåÊã•ÊúâÂÆåÊï¥ÁöÑÁ°¨‰ª∂ËÆøÈóÆÊùÉÈôê„ÄÇ</li>
<li><strong><code>ecall</code> ÁöÑ‰ΩúÁî®</strong>ÔºöÂ∞ÜÂ§ÑÁêÜÂô®‰ªé U-mode ÂàáÊç¢Âà∞ S-modeÔºåÂπ∂Ë∑≥ËΩ¨Âà∞ÂÜÖÊ†∏È¢ÑÂÖàËÆæÁΩÆÁöÑ<strong>Èô∑Èò±Â§ÑÁêÜÁ®ãÂ∫è</strong>ÔºàTrap HandlerÔºâ„ÄÇ</li>
</ul>
</blockquote>
<h2 id="Âú∞ÂùÄÁ©∫Èó¥ÁÆ°ÁêÜ"><a href="#Âú∞ÂùÄÁ©∫Èó¥ÁÆ°ÁêÜ" class="headerlink" title="Âú∞ÂùÄÁ©∫Èó¥ÁÆ°ÁêÜ"></a>Âú∞ÂùÄÁ©∫Èó¥ÁÆ°ÁêÜ</h2><p>OSÈúÄË¶ÅÊèê‰æõËôöÊãüÂú∞ÂùÄÔºåÈúÄË¶ÅËøõË°åÁâ©ÁêÜÂú∞ÂùÄÂíåËôöÊãüÂú∞ÂùÄÁöÑËΩ¨Êç¢ÔºåÈúÄË¶ÅÂä®ÊÄÅÂàÜÈÖçÂú∞ÂùÄÁ©∫Èó¥„ÄÇ</p>
<h3 id="ÂÜÖÂ≠òÁÆ°ÁêÜ"><a href="#ÂÜÖÂ≠òÁÆ°ÁêÜ" class="headerlink" title="ÂÜÖÂ≠òÁÆ°ÁêÜ"></a>ÂÜÖÂ≠òÁÆ°ÁêÜ</h3><p>Âú®PotatOS‰∏≠ÔºåÂÜÖÂ≠ò‰∏ªË¶ÅÁî±<code>page, page table, frame</code>ÁÆ°ÁêÜ„ÄÇ</p>
<ul>
<li><strong>page</strong>ÔºöËôöÊãüÂÜÖÂ≠òÁöÑÂçï‰ΩçÔºåÈÄöÂ∏∏‰∏∫ 4KiB„ÄÇÊìç‰ΩúÁ≥ªÁªüÂ∞ÜËôöÊãüÂú∞ÂùÄÁ©∫Èó¥ÂàíÂàÜ‰∏∫Â§ö‰∏™È°µÈù¢ÔºåÊñπ‰æøËøõË°åÂÜÖÂ≠òÁÆ°ÁêÜÂíå‰øùÊä§„ÄÇ</li>
<li><strong>frame</strong>ÔºöÁâ©ÁêÜÂÜÖÂ≠òÁöÑÂçï‰ΩçÔºå‰πüÈÄöÂ∏∏‰∏∫ 4KiB„ÄÇÁâ©ÁêÜÂÜÖÂ≠òË¢´ÂàíÂàÜ‰∏∫Â§ö‰∏™Â∏ßÔºåÁî®‰∫éÂ≠òÂÇ®È°µÈù¢ÁöÑÊï∞ÊçÆ„ÄÇ</li>
<li><strong>page_table</strong>ÔºöËôöÊãüÂú∞ÂùÄÂà∞Áâ©ÁêÜÂú∞ÂùÄÁöÑËΩ¨Êç¢Ë°®„ÄÇÈÄöËøáÈ°µË°®ÔºåÊìç‰ΩúÁ≥ªÁªüÂèØ‰ª•Â∞ÜËôöÊãüÂú∞ÂùÄÊò†Â∞ÑÂà∞ÂØπÂ∫îÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºåÂÆûÁé∞ËôöÊãüÂÜÖÂ≠òÂíåÁâ©ÁêÜÂÜÖÂ≠òÁöÑÂàÜÁ¶ª„ÄÇ</li>
</ul>
<h3 id="ÂÜÖÂ≠òÁÆ°ÁêÜËÄÖÊ®°Âûã"><a href="#ÂÜÖÂ≠òÁÆ°ÁêÜËÄÖÊ®°Âûã" class="headerlink" title="ÂÜÖÂ≠òÁÆ°ÁêÜËÄÖÊ®°Âûã"></a>ÂÜÖÂ≠òÁÆ°ÁêÜËÄÖÊ®°Âûã</h3><p>Êàë‰ª¨ÈÄöËøáÂõ∫ÂÆöÂàÜÈÖçÁöÑ<strong>HEAP_ALLOCATOR</strong>‰Ωú‰∏∫ÂÜÖÊ†∏ÁöÑÂ†ÜÂ≠òÂÇ®Á©∫Èó¥Ôºå<strong>FRAME_ALLOCATOR</strong>‰Ωú‰∏∫Âä®ÊÄÅÂàÜÈÖçÁöÑÊ†àÁ©∫Èó¥„ÄÇ‰ªñ‰ª¨ÂàÜÂà´‰ªéÂú∞ÂùÄÁ©∫Èó¥ÁöÑÂºÄÂßã&#x2F;ÁªìÂ∞æÂàÜÈÖçÂÜÖÂ≠ò„ÄÇ</p>
<h5 id="HEAP-ALLOCATOR"><a href="#HEAP-ALLOCATOR" class="headerlink" title="HEAP-ALLOCATOR"></a>HEAP-ALLOCATOR</h5><p>ÁÆÄÂçïÂú∞‰ΩøÁî®‰∏ÄÊÆµÊï∞ÁªÑÊù•ÂàÜÈÖçÊï∞ÊçÆ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[global_allocator]</span><br><span class="hljs-keyword">static</span> HEAP_ALLOCATOR: LockedHeap = LockedHeap::<span class="hljs-title function_ invoke__">empty</span>();<br><br><span class="hljs-meta">#[alloc_error_handler]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle_alloc_error</span>(layout: core::alloc::Layout) <span class="hljs-punctuation">-&gt;</span> ! &#123;<br>    <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Heap allocation error, layout = &#123;:?&#125;&quot;</span>, layout);<br>&#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">mut</span> HEAP_SPACE: [<span class="hljs-type">u8</span>; KERNEL_HEAP_SIZE] = [<span class="hljs-number">0</span>; KERNEL_HEAP_SIZE];<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init_heap</span>() &#123;<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        HEAP_ALLOCATOR<br>            .<span class="hljs-title function_ invoke__">lock</span>()<br>            .<span class="hljs-title function_ invoke__">init</span>(HEAP_SPACE.<span class="hljs-title function_ invoke__">as_ptr</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, KERNEL_HEAP_SIZE);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<ul>
<li><code>HEAP_ALLOCATOR</code>ÔºöÂÖ®Â±ÄÂ†ÜÂàÜÈÖçÂô®ÔºåÁî®‰∫éÁÆ°ÁêÜÂÜÖÊ†∏ÁöÑÂ†ÜÂÜÖÂ≠ò„ÄÇ</li>
<li><code>handle_alloc_error</code>ÔºöÂ†ÜÂàÜÈÖçÈîôËØØÂ§ÑÁêÜÂáΩÊï∞ÔºåÂΩìÂ†ÜÂàÜÈÖçÂ§±Ë¥•Êó∂‰ºöËß¶ÂèëËØ•ÂáΩÊï∞„ÄÇ</li>
<li><code>HEAP_SPACE</code>ÔºöÂ†ÜÂÜÖÂ≠òÁ©∫Èó¥ÔºåÊòØ‰∏Ä‰∏™Âõ∫ÂÆöÂ§ßÂ∞èÁöÑÊï∞ÁªÑ„ÄÇ</li>
<li><code>init_heap</code>ÔºöÂàùÂßãÂåñÂ†ÜÂàÜÈÖçÂô®ÔºåÂ∞ÜÂ†ÜÂÜÖÂ≠òÁ©∫Èó¥ÁöÑËµ∑ÂßãÂú∞ÂùÄÂíåÂ§ßÂ∞è‰º†ÈÄíÁªôÂ†ÜÂàÜÈÖçÂô®„ÄÇ</li>
</ul>
<h5 id="FRAME-ALLOCATOR"><a href="#FRAME-ALLOCATOR" class="headerlink" title="FRAME_ALLOCATOR"></a>FRAME_ALLOCATOR</h5><p>‰ΩøÁî®ÁÆÄÂçïÁöÑ<strong>ÂèåÊåáÈíàÊ†áËÆ∞</strong>ÔºåÈ°∫Â∫èÈÅçÂéÜÊù•ÂàÜÈÖçÁâ©ÁêÜÈ°µÂ∏ß„ÄÇËÆæÁΩÆ‰∫ÜÂÖ®Â±ÄÈùôÊÄÅ<code>FRAME_ALLOCATOR</code>Êù•ÂåÖË£ÖÂπ∂ÂàÜÈÖç„ÄÇ</p>
<p><strong>ekernel</strong>Ë°®Á§∫Êï∞ÊçÆÊÆµÁöÑÁªìÂ∞æ„ÄÇÂ∞ΩÁÆ°ÂΩ¢Âºè‰∏äÊòØËøôÊ†∑ÁöÑÔºåÊàëËøòÊòØÂÄæÂêë‰∫éÊ†àÁî±È´ò‰ΩçÂêë‰Ωé‰ΩçÂàÜÈÖç„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">StackFrameAllocator</span> &#123;<br>    current: <span class="hljs-type">usize</span>,<br>    end: <span class="hljs-type">usize</span>,<br>    recycled: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">usize</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">StackFrameAllocator</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, l: PhysPageNum, r: PhysPageNum) &#123;<br>        <span class="hljs-keyword">self</span>.current = l.<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">self</span>.end = r.<span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">FrameAllocator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">StackFrameAllocator</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123;<br>            current: <span class="hljs-number">0</span>,<br>            end: <span class="hljs-number">0</span>,<br>            recycled: <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>(),<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">alloc</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;PhysPageNum&gt; &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(ppn) = <span class="hljs-keyword">self</span>.recycled.<span class="hljs-title function_ invoke__">pop</span>() &#123;<br>            <span class="hljs-title function_ invoke__">Some</span>(ppn.<span class="hljs-title function_ invoke__">into</span>())<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.current == <span class="hljs-keyword">self</span>.end &#123;<br>            <span class="hljs-literal">None</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">self</span>.current += <span class="hljs-number">1</span>;<br>            <span class="hljs-title function_ invoke__">Some</span>((<span class="hljs-keyword">self</span>.current - <span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">into</span>())<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">alloc_more</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, pages: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">Vec</span>&lt;PhysPageNum&gt;&gt; &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.current + pages &gt;= <span class="hljs-keyword">self</span>.end &#123;<br>            <span class="hljs-literal">None</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">self</span>.current += pages;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">arr</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">usize</span>&gt; = (<span class="hljs-number">1</span>..pages + <span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">collect</span>();<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">v</span> = arr.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">map</span>(|x| (<span class="hljs-keyword">self</span>.current - x).<span class="hljs-title function_ invoke__">into</span>()).<span class="hljs-title function_ invoke__">collect</span>();<br>            <span class="hljs-title function_ invoke__">Some</span>(v)<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">dealloc</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, ppn: PhysPageNum) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">ppn</span> = ppn.<span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// validity check</span><br>        <span class="hljs-keyword">if</span> ppn &gt;= <span class="hljs-keyword">self</span>.current || <span class="hljs-keyword">self</span>.recycled.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">any</span>(|&amp;v| v == ppn) &#123;<br>            <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Frame ppn=&#123;:#x&#125; has not been allocated!&quot;</span>, ppn);<br>        &#125;<br>        <span class="hljs-comment">// recycle</span><br>        <span class="hljs-keyword">self</span>.recycled.<span class="hljs-title function_ invoke__">push</span>(ppn);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">FrameAllocatorImpl</span> = StackFrameAllocator;<br><br>lazy_static! &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">ref</span> FRAME_ALLOCATOR: UPIntrFreeCell&lt;FrameAllocatorImpl&gt; =<br>        <span class="hljs-keyword">unsafe</span> &#123; UPIntrFreeCell::<span class="hljs-title function_ invoke__">new</span>(FrameAllocatorImpl::<span class="hljs-title function_ invoke__">new</span>()) &#125;;<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init_frame_allocator</span>() &#123;<br>    <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123;<br>        <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ekernel</span>();<br>    &#125;<br>    FRAME_ALLOCATOR.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">init</span>(<br>        PhysAddr::<span class="hljs-title function_ invoke__">from</span>(ekernel <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">ceil</span>(),<br>        PhysAddr::<span class="hljs-title function_ invoke__">from</span>(MEMORY_END).<span class="hljs-title function_ invoke__">floor</span>(),<br>    );<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">frame_alloc</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;FrameTracker&gt; &#123;<br>    FRAME_ALLOCATOR<br>        .<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>())<br>        .<span class="hljs-title function_ invoke__">alloc</span>()<br>        .<span class="hljs-title function_ invoke__">map</span>(FrameTracker::new)<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">frame_alloc_more</span>(num: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">Vec</span>&lt;FrameTracker&gt;&gt; &#123;<br>    FRAME_ALLOCATOR<br>        .<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>())<br>        .<span class="hljs-title function_ invoke__">alloc_more</span>(num)<br>        .<span class="hljs-title function_ invoke__">map</span>(|x| x.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">map</span>(|&amp;t| FrameTracker::<span class="hljs-title function_ invoke__">new</span>(t)).<span class="hljs-title function_ invoke__">collect</span>())<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">frame_dealloc</span>(ppn: PhysPageNum) &#123;<br>    FRAME_ALLOCATOR.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">dealloc</span>(ppn);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>StackFrameAllocator</code>ÔºöÊ†àÂ∏ßÂàÜÈÖçÂô®Ôºå‰ΩøÁî®ÂèåÊåáÈíàÊ†áËÆ∞ÂíåÂõûÊî∂Êú∫Âà∂Êù•ÁÆ°ÁêÜÁâ©ÁêÜÈ°µÂ∏ß„ÄÇ</li>
<li><code>init</code>ÔºöÂàùÂßãÂåñÊ†àÂ∏ßÂàÜÈÖçÂô®ÔºåËÆæÁΩÆËµ∑ÂßãÂíåÁªìÊùüÂú∞ÂùÄ„ÄÇ</li>
<li><code>alloc</code>ÔºöÂàÜÈÖç‰∏Ä‰∏™Áâ©ÁêÜÈ°µÂ∏ß„ÄÇÂ¶ÇÊûúÊúâÂõûÊî∂ÁöÑÈ°µÂ∏ßÔºåÂàô‰ºòÂÖà‰ΩøÁî®ÔºõÂê¶ÂàôÔºå‰ªéÂΩìÂâç‰ΩçÁΩÆÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑÈ°µÂ∏ß„ÄÇ</li>
<li><code>alloc_more</code>ÔºöÂàÜÈÖçÂ§ö‰∏™Áâ©ÁêÜÈ°µÂ∏ß„ÄÇ</li>
<li><code>dealloc</code>ÔºöÈáäÊîæ‰∏Ä‰∏™Áâ©ÁêÜÈ°µÂ∏ßÔºåÂπ∂Â∞ÜÂÖ∂Âä†ÂÖ•ÂõûÊî∂ÂàóË°®„ÄÇ</li>
<li><code>FRAME_ALLOCATOR</code>ÔºöÂÖ®Â±ÄÂ∏ßÂàÜÈÖçÂô®Ôºå‰ΩøÁî® <code>lazy_static</code> ËøõË°åÈùôÊÄÅÂàùÂßãÂåñ„ÄÇ</li>
<li><code>init_frame_allocator</code>ÔºöÂàùÂßãÂåñÂ∏ßÂàÜÈÖçÂô®ÔºåËÆæÁΩÆÂàÜÈÖçËåÉÂõ¥„ÄÇ</li>
<li><code>frame_alloc</code>ÔºöÂàÜÈÖç‰∏Ä‰∏™Â∏ßÔºåÂπ∂ËøîÂõû‰∏Ä‰∏™ <code>FrameTracker</code> ÂØπË±°„ÄÇ</li>
<li><code>frame_alloc_more</code>ÔºöÂàÜÈÖçÂ§ö‰∏™Â∏ßÔºåÂπ∂ËøîÂõû‰∏Ä‰∏™ <code>FrameTracker</code> ÂØπË±°ÁöÑÂêëÈáè„ÄÇ</li>
<li><code>frame_dealloc</code>ÔºöÈáäÊîæ‰∏Ä‰∏™Â∏ß„ÄÇ</li>
</ul>
<h3 id="Â§öÁ∫ßÈ°µË°®ÁÆ°ÁêÜÂú∞ÂùÄÁ©∫Èó¥-SV39"><a href="#Â§öÁ∫ßÈ°µË°®ÁÆ°ÁêÜÂú∞ÂùÄÁ©∫Èó¥-SV39" class="headerlink" title="Â§öÁ∫ßÈ°µË°®ÁÆ°ÁêÜÂú∞ÂùÄÁ©∫Èó¥(SV39)"></a>Â§öÁ∫ßÈ°µË°®ÁÆ°ÁêÜÂú∞ÂùÄÁ©∫Èó¥(SV39)</h3><h4 id="Ê¶ÇÂøµ"><a href="#Ê¶ÇÂøµ" class="headerlink" title="Ê¶ÇÂøµ"></a>Ê¶ÇÂøµ</h4><p>Êàë‰ª¨Â∏åÊúõÂÆûÁé∞Áâ©ÁêÜÂú∞ÂùÄÂíåËôöÊãüÂú∞ÂùÄÁöÑËΩ¨Êç¢ÂíåÂàÜÈ°µÁÆ°ÁêÜÂú∞ÂùÄÁ©∫Èó¥ÔºåÂõ†Ê≠§ÈúÄË¶Å‰∏Ä‰∏™Ê†áÂáÜ„ÄÇÂü∫‰∫éSV39ÂÆûÁé∞ÁöÑÂú∞ÂùÄÁ¨¶Âêà‰ª•‰∏ãË¶ÅÊ±Ç„ÄÇ</p>
<p><strong>Âú∞ÂùÄÊ†ºÂºè</strong></p>
<p><img src="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/sv39-va-pa.png" srcset="/img/loading.gif" lazyload alt="..&#x2F;_images&#x2F;sv39-va-pa.png"></p>
<p><strong>È°µË°®Ê†ºÂºè</strong></p>
<p><img src="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/sv39-pte.png" srcset="/img/loading.gif" lazyload alt="..&#x2F;_images&#x2F;sv39-pte.png"></p>
<p>ÂèØ‰ª•ÂèëÁé∞Êàë‰ª¨ÂàíÂàÜ‰∫Ü 4KiB Â§ßÂ∞èÁöÑ page Áî®‰∫éÂØπÈΩê„ÄÇSV39 ÊòØ RISC-V Êû∂ÊûÑ‰∏≠ÁöÑ‰∏ÄÁßçÈ°µË°®Êú∫Âà∂ÔºåÂÆÉÂ∞Ü 39 ‰ΩçÁöÑËôöÊãüÂú∞ÂùÄÂàíÂàÜ‰∏∫‰∏â‰∏™ 9 ‰ΩçÁöÑËôöÊãüÈ°µÂè∑Âíå 12 ‰ΩçÁöÑÈ°µÂÜÖÂÅèÁßªÔºåÂ∞Ü 56 ‰ΩçÁöÑÁâ©ÁêÜÂú∞ÂùÄÂàíÂàÜ‰∏∫Áâ©ÁêÜÈ°µÂè∑ÂíåÈ°µÂÜÖÂÅèÁßª„ÄÇÈÄöËøáÂ§öÁ∫ßÈ°µË°®ÁöÑÊñπÂºèÔºåÂÆûÁé∞ËôöÊãüÂú∞ÂùÄÂà∞Áâ©ÁêÜÂú∞ÂùÄÁöÑËΩ¨Êç¢„ÄÇ</p>
<h4 id="Address"><a href="#Address" class="headerlink" title="Address"></a>Address</h4><p>ÊåâÁÖßÊ†áÂáÜÂÆûÁé∞‰∫ÜÂú∞ÂùÄÁöÑÂåÖË£ÖÔºåÂåÖÊã¨Âú∞ÂùÄ‰πãÈó¥ÁöÑËΩ¨Êç¢ÔºåpageÂÜÖbitsÁöÑËØªÂèñÁ≠âÁ≠â</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/mm/address.rs</span><br><span class="hljs-keyword">const</span> PA_WIDTH_SV39: <span class="hljs-type">usize</span> = <span class="hljs-number">56</span>;<br><span class="hljs-keyword">const</span> VA_WIDTH_SV39: <span class="hljs-type">usize</span> = <span class="hljs-number">39</span>;<br><span class="hljs-comment">/// PAGE_SIZE_BITS = 0x12(4KiB)</span><br><span class="hljs-keyword">const</span> PPN_WIDTH_SV39: <span class="hljs-type">usize</span> = PA_WIDTH_SV39 - PAGE_SIZE_BITS;<br><span class="hljs-keyword">const</span> VPN_WIDTH_SV39: <span class="hljs-type">usize</span> = VA_WIDTH_SV39 - PAGE_SIZE_BITS;<br><br><span class="hljs-comment">/// Definitions</span><br><span class="hljs-meta">#[repr(C)]</span><br><span class="hljs-meta">#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PhysAddr</span>(<span class="hljs-keyword">pub</span> <span class="hljs-type">usize</span>);<br><br><span class="hljs-meta">#[repr(C)]</span><br><span class="hljs-meta">#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VirtAddr</span>(<span class="hljs-keyword">pub</span> <span class="hljs-type">usize</span>);<br><br><span class="hljs-meta">#[repr(C)]</span><br><span class="hljs-meta">#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PhysPageNum</span>(<span class="hljs-keyword">pub</span> <span class="hljs-type">usize</span>);<br><br><span class="hljs-meta">#[repr(C)]</span><br><span class="hljs-meta">#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VirtPageNum</span>(<span class="hljs-keyword">pub</span> <span class="hljs-type">usize</span>);<br><br><span class="hljs-comment">/// Debugging</span><br><span class="hljs-comment">/// ...</span><br><br><span class="hljs-comment">/// T: &#123;PhysAddr, VirtAddr, PhysPageNum, VirtPageNum&#125;</span><br><span class="hljs-comment">/// T -&gt; usize: T.0</span><br><span class="hljs-comment">/// usize -&gt; T: usize.into()</span><br><br><span class="hljs-comment">/// transformations of addresses</span><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">usize</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">PhysAddr</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Self</span>(v &amp; ((<span class="hljs-number">1</span> &lt;&lt; PA_WIDTH_SV39) - <span class="hljs-number">1</span>))<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">usize</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">PhysPageNum</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Self</span>(v &amp; ((<span class="hljs-number">1</span> &lt;&lt; PPN_WIDTH_SV39) - <span class="hljs-number">1</span>))<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">usize</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">VirtAddr</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Self</span>(v &amp; ((<span class="hljs-number">1</span> &lt;&lt; VA_WIDTH_SV39) - <span class="hljs-number">1</span>))<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">usize</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">VirtPageNum</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Self</span>(v &amp; ((<span class="hljs-number">1</span> &lt;&lt; VPN_WIDTH_SV39) - <span class="hljs-number">1</span>))<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;PhysAddr&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">usize</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: PhysAddr) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        v.<span class="hljs-number">0</span><br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;PhysPageNum&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">usize</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: PhysPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        v.<span class="hljs-number">0</span><br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;VirtAddr&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">usize</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: VirtAddr) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">if</span> v.<span class="hljs-number">0</span> &gt;= (<span class="hljs-number">1</span> &lt;&lt; (VA_WIDTH_SV39 - <span class="hljs-number">1</span>)) &#123;<br>            v.<span class="hljs-number">0</span> | (!((<span class="hljs-number">1</span> &lt;&lt; VA_WIDTH_SV39) - <span class="hljs-number">1</span>))<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            v.<span class="hljs-number">0</span><br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;VirtPageNum&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">usize</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: VirtPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        v.<span class="hljs-number">0</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/// get page num by address</span><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">VirtAddr</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">floor</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> VirtPageNum &#123;<br>        <span class="hljs-title function_ invoke__">VirtPageNum</span>(<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> / PAGE_SIZE)<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ceil</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> VirtPageNum &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-title function_ invoke__">VirtPageNum</span>(<span class="hljs-number">0</span>)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-title function_ invoke__">VirtPageNum</span>((<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> - <span class="hljs-number">1</span> + PAGE_SIZE) / PAGE_SIZE)<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">page_offset</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> &amp; (PAGE_SIZE - <span class="hljs-number">1</span>)<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">aligned</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span> &#123;<br>        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">page_offset</span>() == <span class="hljs-number">0</span><br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;VirtAddr&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">VirtPageNum</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: VirtAddr) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-built_in">assert_eq!</span>(v.<span class="hljs-title function_ invoke__">page_offset</span>(), <span class="hljs-number">0</span>);<br>        v.<span class="hljs-title function_ invoke__">floor</span>()<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;VirtPageNum&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">VirtAddr</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: VirtPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Self</span>(v.<span class="hljs-number">0</span> &lt;&lt; PAGE_SIZE_BITS)<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">PhysAddr</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">floor</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> PhysPageNum &#123;<br>        <span class="hljs-title function_ invoke__">PhysPageNum</span>(<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> / PAGE_SIZE)<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ceil</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> PhysPageNum &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-title function_ invoke__">PhysPageNum</span>(<span class="hljs-number">0</span>)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-title function_ invoke__">PhysPageNum</span>((<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> - <span class="hljs-number">1</span> + PAGE_SIZE) / PAGE_SIZE)<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">page_offset</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> &amp; (PAGE_SIZE - <span class="hljs-number">1</span>)<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">aligned</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span> &#123;<br>        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">page_offset</span>() == <span class="hljs-number">0</span><br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;PhysAddr&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">PhysPageNum</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: PhysAddr) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-built_in">assert_eq!</span>(v.<span class="hljs-title function_ invoke__">page_offset</span>(), <span class="hljs-number">0</span>);<br>        v.<span class="hljs-title function_ invoke__">floor</span>()<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;PhysPageNum&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">PhysAddr</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: PhysPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Self</span>(v.<span class="hljs-number">0</span> &lt;&lt; PAGE_SIZE_BITS)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">VirtPageNum</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">indexes</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> [<span class="hljs-type">usize</span>; <span class="hljs-number">3</span>] &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">vpn</span> = <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">idx</span> = [<span class="hljs-number">0usize</span>; <span class="hljs-number">3</span>];<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> (<span class="hljs-number">0</span>..<span class="hljs-number">3</span>).<span class="hljs-title function_ invoke__">rev</span>() &#123;<br>            idx[i] = vpn &amp; <span class="hljs-number">511</span>;<br>            vpn &gt;&gt;= <span class="hljs-number">9</span>;<br>        &#125;<br>        idx<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">PhysAddr</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_ref</span>&lt;T&gt;(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> T &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123; (<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> T).<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>() &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_mut</span>&lt;T&gt;(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> T &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123; (<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> T).<span class="hljs-title function_ invoke__">as_mut</span>().<span class="hljs-title function_ invoke__">unwrap</span>() &#125;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">PhysPageNum</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_pte_array</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> [PageTableEntry] &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pa</span>: PhysAddr = (*<span class="hljs-keyword">self</span>).<span class="hljs-title function_ invoke__">into</span>();<br>        <span class="hljs-keyword">unsafe</span> &#123; core::slice::<span class="hljs-title function_ invoke__">from_raw_parts_mut</span>(pa.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> PageTableEntry, <span class="hljs-number">512</span>) &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_bytes_array</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>] &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pa</span>: PhysAddr = (*<span class="hljs-keyword">self</span>).<span class="hljs-title function_ invoke__">into</span>();<br>        <span class="hljs-keyword">unsafe</span> &#123; core::slice::<span class="hljs-title function_ invoke__">from_raw_parts_mut</span>(pa.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>, <span class="hljs-number">4096</span>) &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_mut</span>&lt;T&gt;(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> T &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pa</span>: PhysAddr = (*<span class="hljs-keyword">self</span>).<span class="hljs-title function_ invoke__">into</span>();<br>        pa.<span class="hljs-title function_ invoke__">get_mut</span>()<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>PhysAddr</code>ÔºöÁâ©ÁêÜÂú∞ÂùÄÁªìÊûÑ‰ΩìÔºåÂåÖË£Ö‰∫Ü‰∏Ä‰∏™ <code>usize</code> Á±ªÂûãÁöÑÁâ©ÁêÜÂú∞ÂùÄ„ÄÇ</li>
<li><code>VirtAddr</code>ÔºöËôöÊãüÂú∞ÂùÄÁªìÊûÑ‰ΩìÔºåÂåÖË£Ö‰∫Ü‰∏Ä‰∏™ <code>usize</code> Á±ªÂûãÁöÑËôöÊãüÂú∞ÂùÄ„ÄÇ</li>
<li><code>PhysPageNum</code>ÔºöÁâ©ÁêÜÈ°µÂè∑ÁªìÊûÑ‰ΩìÔºåÂåÖË£Ö‰∫Ü‰∏Ä‰∏™ <code>usize</code> Á±ªÂûãÁöÑÁâ©ÁêÜÈ°µÂè∑„ÄÇ</li>
<li><code>VirtPageNum</code>ÔºöËôöÊãüÈ°µÂè∑ÁªìÊûÑ‰ΩìÔºåÂåÖË£Ö‰∫Ü‰∏Ä‰∏™ <code>usize</code> Á±ªÂûãÁöÑËôöÊãüÈ°µÂè∑„ÄÇ</li>
<li><code>From</code> ÂÆûÁé∞ÔºöÊèê‰æõ‰∫Ü‰ªé <code>usize</code> Á±ªÂûãÂà∞ÂêÑÁßçÂú∞ÂùÄÂíåÈ°µÂè∑Á±ªÂûãÁöÑËΩ¨Êç¢„ÄÇ</li>
<li><code>From</code>„ÄÅ<code>From</code>„ÄÅ<code>From</code>„ÄÅ<code>From</code> ÂÆûÁé∞ÔºöÊèê‰æõ‰∫Ü‰ªéÂêÑÁßçÂú∞ÂùÄÂíåÈ°µÂè∑Á±ªÂûãÂà∞ <code>usize</code> Á±ªÂûãÁöÑËΩ¨Êç¢„ÄÇ</li>
<li><code>VirtAddr</code> Âíå <code>PhysAddr</code> ÁöÑÊñπÊ≥ïÔºöÊèê‰æõ‰∫ÜËé∑ÂèñÈ°µÂè∑„ÄÅÈ°µÂÜÖÂÅèÁßª„ÄÅÂà§Êñ≠ÂØπÈΩêÁ≠âÂäüËÉΩ„ÄÇ</li>
<li><code>VirtPageNum</code> ÁöÑ <code>indexes</code> ÊñπÊ≥ïÔºöÂ∞ÜËôöÊãüÈ°µÂè∑ÊãÜÂàÜ‰∏∫‰∏â‰∏™ 9 ‰ΩçÁöÑÁ¥¢Âºï„ÄÇ</li>
<li><code>PhysAddr</code> Âíå <code>PhysPageNum</code> ÁöÑÊñπÊ≥ïÔºöÊèê‰æõ‰∫ÜËé∑ÂèñÂºïÁî®„ÄÅ‰øÆÊîπÂºïÁî®„ÄÅËé∑ÂèñÈ°µË°®È°πÊï∞ÁªÑÁ≠âÂäüËÉΩ„ÄÇ</li>
</ul>
<h4 id="PageTable"><a href="#PageTable" class="headerlink" title="PageTable"></a>PageTable</h4><h5 id="Ê¶ÇÂøµ-1"><a href="#Ê¶ÇÂøµ-1" class="headerlink" title="Ê¶ÇÂøµ"></a>Ê¶ÇÂøµ</h5><p><strong>PageTable</strong>‰∏ªË¶ÅË¥üË¥£ËΩ¨Êç¢ËôöÊãüÂú∞ÂùÄÂíåÁâ©ÁêÜÂú∞ÂùÄ„ÄÇSV39Êúâ‰∏âÁ∫ßÈ°µË°®Êú∫Âà∂ÔºåÈúÄË¶ÅÁÆÄÂçïÁöÑÂæ™ÁéØÂíåÊ†áËÆ∞‰ΩçÈ™åËØÅËß£ÂÜ≥ÈóÆÈ¢ò„ÄÇ‰ª•‰∏ã‰∏∫<strong>xv6</strong>È°µË°®ÂèòÊç¢Á§∫ÊÑèÂõæÔºåÂêåÁêÜ„ÄÇ</p>
<p><img src="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/sv39-full.png" srcset="/img/loading.gif" lazyload alt="..&#x2F;_images&#x2F;sv39-full.png"></p>
<p>Âú® SV39 Ê®°Âºè‰∏≠Êàë‰ª¨ÈááÁî®‰∏âÁ∫ßÈ°µË°®ÔºåÂç≥Â∞Ü 27 ‰ΩçÁöÑËôöÊãüÈ°µÂè∑ÂàÜ‰∏∫‰∏â‰∏™Á≠âÈïøÁöÑÈÉ®ÂàÜÔºåÁ¨¨ 26-18 ‰Ωç‰∏∫‰∏ÄÁ∫ßÈ°µÁ¥¢Âºï <strong>VPN0</strong> ÔºåÁ¨¨ 17-9 ‰Ωç‰∏∫‰∫åÁ∫ßÈ°µÁ¥¢Âºï <strong>VPN1</strong> ÔºåÁ¨¨ 8-0 ‰Ωç‰∏∫‰∏âÁ∫ßÈ°µÁ¥¢Âºï <strong>VPN2</strong> „ÄÇ</p>
<p>Êàë‰ª¨‰πüÂ∞ÜÈ°µË°®ÂàÜ‰∏∫‰∏ÄÁ∫ßÈ°µË°®ÔºàÂ§öÁ∫ßÈ°µË°®ÁöÑÊ†πËäÇÁÇπÔºâÔºå‰∫åÁ∫ßÈ°µË°®Ôºå‰∏âÁ∫ßÈ°µË°®ÔºàÂ§öÁ∫ßÈ°µË°®ÁöÑÂè∂ËäÇÁÇπÔºâ„ÄÇÊØè‰∏™È°µË°®ÈÉΩÁî® 9 ‰ΩçÁ¥¢ÂºïÔºåÂõ†Ê≠§Êúâ 29&#x3D;512 ‰∏™È°µË°®È°πÔºåËÄåÊØè‰∏™È°µË°®È°πÈÉΩÊòØ 8 Â≠óËäÇÔºåÂõ†Ê≠§ÊØè‰∏™È°µË°®Â§ßÂ∞èÈÉΩ‰∏∫ 512√ó8&#x3D;4KiB „ÄÇÊ≠£Â•ΩÊòØ‰∏Ä‰∏™Áâ©ÁêÜÈ°µÁöÑÂ§ßÂ∞è„ÄÇÊàë‰ª¨ÂèØ‰ª•Êää‰∏Ä‰∏™È°µË°®ÊîæÂà∞‰∏Ä‰∏™Áâ©ÁêÜÈ°µ‰∏≠ÔºåÂπ∂Áî®‰∏Ä‰∏™Áâ©ÁêÜÈ°µÂè∑Êù•ÊèèËø∞ÂÆÉ„ÄÇ‰∫ãÂÆû‰∏äÔºå‰∏ÄÁ∫ßÈ°µË°®ÁöÑÊØè‰∏™È°µË°®È°π‰∏≠ÁöÑÁâ©ÁêÜÈ°µÂè∑ÂèØÊèèËø∞‰∏Ä‰∏™‰∫åÁ∫ßÈ°µË°®Ôºõ‰∫åÁ∫ßÈ°µË°®ÁöÑÊØè‰∏™È°µË°®È°π‰∏≠ÁöÑÁâ©ÁêÜÈ°µÂè∑ÂèØÊèèËø∞‰∏Ä‰∏™‰∏âÁ∫ßÈ°µË°®Ôºõ‰∏âÁ∫ßÈ°µË°®‰∏≠ÁöÑÈ°µË°®È°πÂÜÖÂÆπÂàôÂíåÊàë‰ª¨ÂàöÊâçÊèêÂà∞ÁöÑÈ°µË°®È°π‰∏ÄÊ†∑ÔºåÂÖ∂ÂÜÖÂÆπÂåÖÂê´Áâ©ÁêÜÈ°µÂè∑ÔºåÂç≥ÊèèËø∞‰∏Ä‰∏™Ë¶ÅÊò†Â∞ÑÂà∞ÁöÑÁâ©ÁêÜÈ°µ„ÄÇ</p>
<p>ÂÖ∑‰ΩìÊù•ËØ¥ÔºåÂÅáËÆæÊàë‰ª¨ÊúâËôöÊãüÂú∞ÂùÄ (VPN0,VPN1,VPN2,offset) Ôºö</p>
<ul>
<li>Êàë‰ª¨È¶ñÂÖà‰ºöËÆ∞ÂΩïË£ÖËΩΩ„ÄåÂΩìÂâçÊâÄÁî®ÁöÑ‰∏ÄÁ∫ßÈ°µË°®ÁöÑÁâ©ÁêÜÈ°µ„ÄçÁöÑÈ°µÂè∑Âà∞ satp ÂØÑÂ≠òÂô®‰∏≠Ôºõ</li>
<li>Êää VPN0 ‰Ωú‰∏∫ÂÅèÁßªÂú®‰∏ÄÁ∫ßÈ°µË°®ÁöÑÁâ©ÁêÜÈ°µ‰∏≠ÊâæÂà∞‰∫åÁ∫ßÈ°µË°®ÁöÑÁâ©ÁêÜÈ°µÂè∑Ôºõ</li>
<li>Êää VPN1 ‰Ωú‰∏∫ÂÅèÁßªÂú®‰∫åÁ∫ßÈ°µË°®ÁöÑÁâ©ÁêÜÈ°µ‰∏≠ÊâæÂà∞‰∏âÁ∫ßÈ°µË°®ÁöÑÁâ©ÁêÜÈ°µÂè∑Ôºõ</li>
<li>Êää VPN2 ‰Ωú‰∏∫ÂÅèÁßªÂú®‰∏âÁ∫ßÈ°µË°®ÁöÑÁâ©ÁêÜÈ°µ‰∏≠ÊâæÂà∞Ë¶ÅËÆøÈóÆ‰ΩçÁΩÆÁöÑÁâ©ÁêÜÈ°µÂè∑Ôºõ</li>
<li>Áâ©ÁêÜÈ°µÂè∑ÂØπÂ∫îÁöÑÁâ©ÁêÜÈ°µÂü∫ÂùÄÔºàÂç≥Áâ©ÁêÜÈ°µÂè∑Â∑¶Áßª12‰ΩçÔºâÂä†‰∏ä offset Â∞±ÊòØËôöÊãüÂú∞ÂùÄÂØπÂ∫îÁöÑÁâ©ÁêÜÂú∞ÂùÄ„ÄÇ</li>
</ul>
<p>ËøôÊ†∑Â§ÑÁêÜÂô®ÈÄöËøáËøôÁßçÂ§öÊ¨°ËΩ¨Êç¢ÔºåÁªà‰∫é‰ªéËôöÊãüÈ°µÂè∑ÊâæÂà∞‰∫Ü‰∏ÄÁ∫ßÈ°µË°®È°πÔºå‰ªéËÄåÂæóÂá∫‰∫ÜÁâ©ÁêÜÈ°µÂè∑ÂíåËôöÊãüÂú∞ÂùÄÊâÄÂØπÂ∫îÁöÑÁâ©ÁêÜÂú∞ÂùÄ„ÄÇÂàöÊâçÊàë‰ª¨ÊèêÂà∞Ëã•È°µË°®È°πÊª°Ë∂≥ R,W,X ÈÉΩ‰∏∫ 0ÔºåË°®ÊòéËøô‰∏™È°µË°®È°πÊåáÂêë‰∏ã‰∏ÄÁ∫ßÈ°µË°®„ÄÇÂú®ËøôÈáå‰∏ÄÁ∫ßÂíå‰∫åÁ∫ßÈ°µË°®È°πÁöÑ R,W,X ‰∏∫ 0 Â∫îËØ•ÊàêÁ´ãÔºåÂõ†‰∏∫ÂÆÉ‰ª¨ÊåáÂêë‰∫Ü‰∏ã‰∏ÄÁ∫ßÈ°µË°®„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/mm/page_table.rs</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">find_pte_create</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, vpn: VirtPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;&amp;<span class="hljs-keyword">mut</span> PageTableEntry&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">idxs</span> = vpn.<span class="hljs-title function_ invoke__">indexes</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ppn</span> = <span class="hljs-keyword">self</span>.root_ppn;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">result</span>: <span class="hljs-type">Option</span>&lt;&amp;<span class="hljs-keyword">mut</span> PageTableEntry&gt; = <span class="hljs-literal">None</span>;<br>    <span class="hljs-keyword">for</span> (i, idx) <span class="hljs-keyword">in</span> idxs.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pte</span> = &amp;<span class="hljs-keyword">mut</span> ppn.<span class="hljs-title function_ invoke__">get_pte_array</span>()[*idx];<br>        <span class="hljs-keyword">if</span> i == <span class="hljs-number">2</span> &#123;<br>            result = <span class="hljs-title function_ invoke__">Some</span>(pte);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> !pte.<span class="hljs-title function_ invoke__">is_valid</span>() &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">frame</span> = <span class="hljs-title function_ invoke__">frame_alloc</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>            *pte = PageTableEntry::<span class="hljs-title function_ invoke__">new</span>(frame.ppn, PTEFlags::V);<br>            <span class="hljs-keyword">self</span>.frames.<span class="hljs-title function_ invoke__">push</span>(frame);<br>        &#125;<br>        ppn = pte.<span class="hljs-title function_ invoke__">ppn</span>();<br>    &#125;<br>    result<br>&#125;<br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">find_pte</span>(&amp;<span class="hljs-keyword">self</span>, vpn: VirtPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;&amp;<span class="hljs-keyword">mut</span> PageTableEntry&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">idxs</span> = vpn.<span class="hljs-title function_ invoke__">indexes</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ppn</span> = <span class="hljs-keyword">self</span>.root_ppn;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">result</span>: <span class="hljs-type">Option</span>&lt;&amp;<span class="hljs-keyword">mut</span> PageTableEntry&gt; = <span class="hljs-literal">None</span>;<br>    <span class="hljs-keyword">for</span> (i, idx) <span class="hljs-keyword">in</span> idxs.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pte</span> = &amp;<span class="hljs-keyword">mut</span> ppn.<span class="hljs-title function_ invoke__">get_pte_array</span>()[*idx];<br>        <span class="hljs-keyword">if</span> i == <span class="hljs-number">2</span> &#123;<br>            result = <span class="hljs-title function_ invoke__">Some</span>(pte);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> !pte.<span class="hljs-title function_ invoke__">is_valid</span>() &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>;<br>        &#125;<br>        ppn = pte.<span class="hljs-title function_ invoke__">ppn</span>();<br>    &#125;<br>    result<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>find_pte_create</code>ÔºöÊü•ÊâæÂπ∂ÂàõÂª∫È°µË°®È°π„ÄÇÂ¶ÇÊûúÈ°µË°®È°π‰∏çÂ≠òÂú®ÔºåÂàôÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑÁâ©ÁêÜÈ°µÂ∏ßÔºåÂπ∂ÂàõÂª∫È°µË°®È°π„ÄÇ</li>
<li><code>find_pte</code>ÔºöÊü•ÊâæÈ°µË°®È°π„ÄÇÂ¶ÇÊûúÈ°µË°®È°π‰∏çÂ≠òÂú®ÔºåÂàôËøîÂõû <code>None</code>„ÄÇ</li>
</ul>
<h5 id="Êò†Â∞Ñ"><a href="#Êò†Â∞Ñ" class="headerlink" title="Êò†Â∞Ñ"></a>Êò†Â∞Ñ</h5><p>ÊØè‰∏™ËøõÁ®ãÊúâËá™Â∑±ÁöÑËôöÊãüÂú∞ÂùÄÔºåÊò†Â∞ÑÂà∞‰∏çÂêåÁöÑÁâ©ÁêÜÂú∞ÂùÄ‰∏≠„ÄÇÈúÄË¶ÅÁî®È°µË°®ËøõË°åÊò†Â∞Ñ&#x2F;ÂèñÊ∂àÊò†Â∞ÑÂíåÁâ©ÁêÜÂú∞ÂùÄ&#x2F;ËôöÊãüÂú∞ÂùÄÁöÑËΩ¨Êç¢„ÄÇ</p>
<p>ËøôÈáåÊàë‰ª¨ÈááÁî®ÊúÄÁÆÄÂçïÁöÑÊÅíÁ≠âÊò†Â∞ÑÔºåÂç≥<code>ppn=vpn</code>ÁöÑÊñπÂºèÊò†Â∞Ñ„ÄÇ</p>
<p>ÂêåÊó∂Ôºå‰∏∫‰∫ÜÂå∫ÂàÜÊØè‰∏™ËøõÁ®ãÁöÑÈ°µË°®Ôºå‰ΩøÁî®<code>Token</code>ÂàÜËæ®È°µË°®„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/mm/page_table.rs</span><br><span class="hljs-meta">#[allow(unused)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">map</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, vpn: VirtPageNum, ppn: PhysPageNum, flags: PTEFlags) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pte</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">find_pte_create</span>(vpn).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-built_in">assert!</span>(!pte.<span class="hljs-title function_ invoke__">is_valid</span>(), <span class="hljs-string">&quot;vpn &#123;:?&#125; is mapped before mapping&quot;</span>, vpn);<br>    *pte = PageTableEntry::<span class="hljs-title function_ invoke__">new</span>(ppn, flags | PTEFlags::V);<br>&#125;<br><span class="hljs-meta">#[allow(unused)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">unmap</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, vpn: VirtPageNum) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pte</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">find_pte</span>(vpn).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-built_in">assert!</span>(pte.<span class="hljs-title function_ invoke__">is_valid</span>(), <span class="hljs-string">&quot;vpn &#123;:?&#125; is invalid before unmapping&quot;</span>, vpn);<br>    *pte = PageTableEntry::<span class="hljs-title function_ invoke__">empty</span>();<br>&#125;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">translate</span>(&amp;<span class="hljs-keyword">self</span>, vpn: VirtPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;PageTableEntry&gt; &#123;<br>    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">find_pte</span>(vpn).<span class="hljs-title function_ invoke__">map</span>(|pte| *pte)<br>&#125;<br><span class="hljs-comment">/// ppn + offset</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">translate_va</span>(&amp;<span class="hljs-keyword">self</span>, va: VirtAddr) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;PhysAddr&gt; &#123;<br>    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">find_pte</span>(va.<span class="hljs-title function_ invoke__">clone</span>().<span class="hljs-title function_ invoke__">floor</span>()).<span class="hljs-title function_ invoke__">map</span>(|pte| &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">aligned_pa</span>: PhysAddr = pte.<span class="hljs-title function_ invoke__">ppn</span>().<span class="hljs-title function_ invoke__">into</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">offset</span> = va.<span class="hljs-title function_ invoke__">page_offset</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">aligned_pa_usize</span>: <span class="hljs-type">usize</span> = aligned_pa.<span class="hljs-title function_ invoke__">into</span>();<br>        (aligned_pa_usize + offset).<span class="hljs-title function_ invoke__">into</span>()<br>    &#125;)<br>&#125;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">token</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>    <span class="hljs-number">8usize</span> &lt;&lt; <span class="hljs-number">60</span> | <span class="hljs-keyword">self</span>.root_ppn.<span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>map</code>ÔºöÂ∞ÜËôöÊãüÈ°µÂè∑Êò†Â∞ÑÂà∞Áâ©ÁêÜÈ°µÂè∑ÔºåÂπ∂ËÆæÁΩÆÁõ∏Â∫îÁöÑÊ†áÂøó‰Ωç„ÄÇ</li>
<li><code>unmap</code>ÔºöÂèñÊ∂àËôöÊãüÈ°µÂè∑ÁöÑÊò†Â∞Ñ„ÄÇ</li>
<li><code>translate</code>ÔºöÂ∞ÜËôöÊãüÈ°µÂè∑ËΩ¨Êç¢‰∏∫È°µË°®È°π„ÄÇ</li>
<li><code>translate_va</code>ÔºöÂ∞ÜËôöÊãüÂú∞ÂùÄËΩ¨Êç¢‰∏∫Áâ©ÁêÜÂú∞ÂùÄ„ÄÇ</li>
<li><code>token</code>ÔºöÁîüÊàêÈ°µË°®ÁöÑ tokenÔºåÁî®‰∫éÂå∫ÂàÜ‰∏çÂêåÁöÑÈ°µË°®„ÄÇ</li>
</ul>
<h3 id="Âú∞ÂùÄÁ©∫Èó¥ÁÆ°ÁêÜ-1"><a href="#Âú∞ÂùÄÁ©∫Èó¥ÁÆ°ÁêÜ-1" class="headerlink" title="Âú∞ÂùÄÁ©∫Èó¥ÁÆ°ÁêÜ"></a>Âú∞ÂùÄÁ©∫Èó¥ÁÆ°ÁêÜ</h3><h4 id="ÈÄªËæëÊÆµ"><a href="#ÈÄªËæëÊÆµ" class="headerlink" title="ÈÄªËæëÊÆµ"></a>ÈÄªËæëÊÆµ</h4><p>ÂâçÈù¢Êàë‰ª¨ÂÆûÁé∞‰∫ÜÈ°µÂ∏ßÁÆ°ÁêÜÂíåÊò†Â∞ÑÊú∫Âà∂Ôºå‰ΩÜÊòØËøôÂ§™Èõ∂Êï£‰∫Ü„ÄÇÊàë‰ª¨ËøòÈúÄË¶Å‰∏ÄÂ±ÇÊäΩË±°Êù•ÁªÑÁªáÈ°µÂ∏ß„ÄÇÊâÄ‰ª•ÈÄªËæëÊÆµÂ∞±ÊòØËøôÊ†∑ÁöÑÊäΩË±°„ÄÇÂÆÉÁªÑÁªá‰∫Ü‰∏ÄÊÆµ<strong>ËøûÁª≠‰∏îÂèØÁî®</strong>ÁöÑËôöÊãüÂú∞ÂùÄ„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/mm/memory_set.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MapArea</span> &#123;<br>    vpn_range: VPNRange,<br>    data_frames: BTreeMap&lt;VirtPageNum, FrameTracker&gt;,<br>    map_type: MapType,<br>    map_perm: MapPermission,<br>&#125;<br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">map_one</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, page_table: &amp;<span class="hljs-keyword">mut</span> PageTable, vpn: VirtPageNum) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ppn</span>: PhysPageNum;<br>    <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.map_type &#123;<br>        MapType::Identical =&gt; &#123;<br>            ppn = <span class="hljs-title function_ invoke__">PhysPageNum</span>(vpn.<span class="hljs-number">0</span>);<br>        &#125;<br>        MapType::Framed =&gt; &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">frame</span> = <span class="hljs-title function_ invoke__">frame_alloc</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>            ppn = frame.ppn;<br>            <span class="hljs-keyword">self</span>.data_frames.<span class="hljs-title function_ invoke__">insert</span>(vpn, frame);<br>        &#125;<br>        MapType::<span class="hljs-title function_ invoke__">Linear</span>(pn_offset) =&gt; &#123;<br>            <span class="hljs-comment">// check for sv39</span><br>            <span class="hljs-built_in">assert!</span>(vpn.<span class="hljs-number">0</span> &lt; (<span class="hljs-number">1usize</span> &lt;&lt; <span class="hljs-number">27</span>));<br>            ppn = <span class="hljs-title function_ invoke__">PhysPageNum</span>((vpn.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> <span class="hljs-type">isize</span> + pn_offset) <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pte_flags</span> = PTEFlags::<span class="hljs-title function_ invoke__">from_bits</span>(<span class="hljs-keyword">self</span>.map_perm.bits).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    page_table.<span class="hljs-title function_ invoke__">map</span>(vpn, ppn, pte_flags);<br>&#125;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">unmap_one</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, page_table: &amp;<span class="hljs-keyword">mut</span> PageTable, vpn: VirtPageNum) &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.map_type == MapType::Framed &#123;<br>        <span class="hljs-keyword">self</span>.data_frames.<span class="hljs-title function_ invoke__">remove</span>(&amp;vpn);<br>    &#125;<br>    page_table.<span class="hljs-title function_ invoke__">unmap</span>(vpn);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>MapArea</code>ÔºöÈÄªËæëÊÆµÁªìÊûÑ‰ΩìÔºåÂåÖÂê´ËôöÊãüÈ°µÂè∑ËåÉÂõ¥„ÄÅÊï∞ÊçÆÂ∏ßÊò†Â∞Ñ„ÄÅÊò†Â∞ÑÁ±ªÂûãÂíåÊò†Â∞ÑÊùÉÈôê„ÄÇ</li>
<li><code>vpn_range</code>Ôºö‰∏ÄÊÆµÂ∑¶Âè≥Èó≠ÂêàÁöÑËôöÊãüÂú∞ÂùÄËåÉÂõ¥„ÄÇ</li>
<li><code>data_frames</code>ÔºöÁâ©ÁêÜÈ°µÂ∏ßÂíåËôöÊãüÂú∞ÂùÄÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÔºå‰ΩøÁî® <code>BTreeMap</code> Â≠òÂÇ®„ÄÇ</li>
<li><code>map_type</code>ÔºöÂ≠òÂú®Âá†ÁßçÊò†Â∞ÑÊñπÂºèÔºåÂåÖÊã¨Áõ¥Êé•Êò†Â∞Ñ„ÄÅÁ∫øÊÄßÊò†Â∞ÑÂíåÊñ∞Âª∫È°µË°®ÈöèÊú∫Êò†Â∞Ñ„ÄÇ<ul>
<li><strong>Áõ¥Êé•Êò†Â∞Ñ</strong>Ôºö<code>ppn = vpn</code>ÔºåÂç≥ËôöÊãüÈ°µÂè∑ÂíåÁâ©ÁêÜÈ°µÂè∑Áõ∏Âêå„ÄÇ</li>
<li><strong>Á∫øÊÄßÊò†Â∞Ñ</strong>ÔºöÈÄöËøá‰∏Ä‰∏™ÂÅèÁßªÈáèÊù•ËÆ°ÁÆóÁâ©ÁêÜÈ°µÂè∑„ÄÇ</li>
<li><strong>Êñ∞Âª∫È°µË°®ÈöèÊú∫Êò†Â∞Ñ</strong>ÔºöÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑÁâ©ÁêÜÈ°µÂ∏ßÔºåÂπ∂ËøõË°åÊò†Â∞Ñ„ÄÇ</li>
</ul>
</li>
<li><code>map_perm</code>ÔºöÊòØÂê¶ÂÖÅËÆ∏Êò†Â∞ÑÔºåÊåáÂÆö‰∫ÜÊò†Â∞ÑÁöÑÊùÉÈôêÔºåÂ¶ÇËØª„ÄÅÂÜô„ÄÅÊâßË°åÁ≠â„ÄÇ</li>
<li><code>map_one</code>ÔºöÊåâÈ°∫Â∫èÂèñÂæó frame ËøõË°åÊò†Â∞Ñ„ÄÇÊ†πÊçÆÊò†Â∞ÑÁ±ªÂûãÈÄâÊã©ÂêàÈÄÇÁöÑÁâ©ÁêÜÈ°µÂè∑ÔºåÂπ∂Ë∞ÉÁî®È°µË°®ÁöÑ <code>map</code> ÊñπÊ≥ïËøõË°åÊò†Â∞Ñ„ÄÇ</li>
<li><code>unmap_one</code>ÔºöÂà†Èô§Â∑≤Êò†Â∞ÑÁöÑ vpn„ÄÇÂ¶ÇÊûúÊòØ <code>Framed</code> Êò†Â∞ÑÁ±ªÂûãÔºåËøòÈúÄË¶Å‰ªé <code>data_frames</code> ‰∏≠ÁßªÈô§Áõ∏Â∫îÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÔºåÂπ∂Ë∞ÉÁî®È°µË°®ÁöÑ <code>unmap</code> ÊñπÊ≥ïÂèñÊ∂àÊò†Â∞Ñ„ÄÇ</li>
</ul>
<h4 id="Âú∞ÂùÄÁ©∫Èó¥"><a href="#Âú∞ÂùÄÁ©∫Èó¥" class="headerlink" title="Âú∞ÂùÄÁ©∫Èó¥"></a>Âú∞ÂùÄÁ©∫Èó¥</h4><p>Áõ∏ÂΩì‰∫é‰∏∫ËøõÁ®ãÁªÑÁªá‰∫Ü‰∏ÄÁ≥ªÂàóÈÄªËæëÊÆµÔºåÁªôÊØè‰∏™ËøõÁ®ãÂàÜÈÖç‰∫Ü‰∏Ä‰∏™<code>PageTable</code>Âíå<code>MapArea</code>Êù•ÁªëÂÆöËøõÁ®ãÁöÑÂú∞ÂùÄÁ©∫Èó¥„ÄÇËøôÊ†∑ÊØè‰∏™ËøõÁ®ãÂ∞±Êúâ‰∫ÜÁã¨Á´ãÁöÑÂú∞ÂùÄÁ©∫Èó¥„ÄÇÈùûÂ∏∏Â•ΩÁöÑÊÉ≥Ê≥ï„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MemorySet</span> &#123;<br>    page_table: PageTable,<br>    areas: <span class="hljs-type">Vec</span>&lt;MapArea&gt;,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Âü∫Êú¨Â∞±ÊòØÊèê‰æõ‰∫ÜÈÄªËæëÊÆµÁöÑË∞ÉÁî®Êé•Âè£„ÄÇ</p>
<h5 id="ÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥"><a href="#ÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥" class="headerlink" title="ÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥"></a>ÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥</h5><p>ÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥ÊòØÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÊâÄ‰ΩøÁî®ÁöÑÂú∞ÂùÄÁ©∫Èó¥ÔºåÈÄöÂ∏∏ÂåÖÂê´ÂÜÖÊ†∏‰ª£Á†Å„ÄÅÊï∞ÊçÆ„ÄÅÊ†àÁ≠â„ÄÇÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥ÊòØÊâÄÊúâËøõÁ®ãÂÖ±‰∫´ÁöÑÔºåÂÆÉÊèê‰æõ‰∫ÜÂØπÁ≥ªÁªüËµÑÊ∫êÁöÑÁõ¥Êé•ËÆøÈóÆÔºåÂ¶ÇËÆæÂ§áÈ©±Âä®„ÄÅ‰∏≠Êñ≠Â§ÑÁêÜÁ≠â„ÄÇÂú® PotatOS ‰∏≠ÔºåÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥ÁöÑÊò†Â∞ÑÂíåÁÆ°ÁêÜÊòØÈÄöËøá <code>PageTable</code> Âíå <code>MapArea</code> Êù•ÂÆûÁé∞ÁöÑ„ÄÇÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥ÁöÑÊò†Â∞ÑÈÄöÂ∏∏ÊòØÈùôÊÄÅÁöÑÔºåÂú®Á≥ªÁªüÂêØÂä®Êó∂Â∞±Â∑≤ÁªèÂÆåÊàê„ÄÇ</p>
<div style="float:left;border:solid 1px 000;margin:2px;"><img src="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/kernel-as-high.png" srcset="/img/loading.gif" lazyload  width="300" height="360" ></div>
<div style="float:left;border:solid 1px 000;margin:2px;"><img src="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/kernel-as-low.png" srcset="/img/loading.gif" lazyload width="300" height="360" ></div>
















<p>ÂÜÖÊ†∏Âú∞ÂùÄÁöÑÂàÜÂ∏ÉÔºåÈ´ò‰ΩçÊòØÂ∫îÁî®ÁöÑÂÜÖÊ†∏Ê†àÔºå‰Ωé‰ΩçÊòØÂÜÖÊ†∏Âú∞ÂùÄÁ©∫Èó¥ÁöÑÈÄªËæëÊÆµÔºåÊåâÁÖßÈ°∫Â∫èÊèíÂÖ•„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new_kernel</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">memory_set</span> = <span class="hljs-keyword">Self</span>::<span class="hljs-title function_ invoke__">new_bare</span>();<br>    <span class="hljs-comment">// map trampoline</span><br>    memory_set.<span class="hljs-title function_ invoke__">map_trampoline</span>();<br>    <span class="hljs-comment">// map kernel sections</span><br>    <span class="hljs-comment">// println!(&quot;mapping .text section&quot;);</span><br>    memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>        MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>            (stext <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            (etext <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            MapType::Identical,<br>            MapPermission::R | MapPermission::X,<br>        ),<br>        <span class="hljs-literal">None</span>,<br>    );<br>    <span class="hljs-comment">// println!(&quot;mapping .rodata section&quot;);</span><br>    memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>        MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>            (srodata <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            (erodata <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            MapType::Identical,<br>            MapPermission::R,<br>        ),<br>        <span class="hljs-literal">None</span>,<br>    );<br>    <span class="hljs-comment">// println!(&quot;mapping .data section&quot;);</span><br>    memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>        MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>            (sdata <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            (edata <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            MapType::Identical,<br>            MapPermission::R | MapPermission::W,<br>        ),<br>        <span class="hljs-literal">None</span>,<br>    );<br>    <span class="hljs-comment">// println!(&quot;mapping .bss section&quot;);</span><br>    memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>        MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>            (sbss_with_stack <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            (ebss <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            MapType::Identical,<br>            MapPermission::R | MapPermission::W,<br>        ),<br>        <span class="hljs-literal">None</span>,<br>    );<br>    <span class="hljs-comment">// println!(&quot;mapping physical memory&quot;);</span><br>    memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>        MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>            (ekernel <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            MEMORY_END.<span class="hljs-title function_ invoke__">into</span>(),<br>            MapType::Identical,<br>            MapPermission::R | MapPermission::W,<br>        ),<br>        <span class="hljs-literal">None</span>,<br>    );<br>    <span class="hljs-comment">//println!(&quot;mapping memory-mapped registers&quot;);</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">pair</span> <span class="hljs-keyword">in</span> MMIO &#123;<br>        memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>            MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>                (*pair).<span class="hljs-number">0</span>.<span class="hljs-title function_ invoke__">into</span>(),<br>                ((*pair).<span class="hljs-number">0</span> + (*pair).<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>                MapType::Identical,<br>                MapPermission::R | MapPermission::W,<br>            ),<br>            <span class="hljs-literal">None</span>,<br>        );<br>    &#125;<br>    memory_set<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="Â∫îÁî®Âú∞ÂùÄÁ©∫Èó¥"><a href="#Â∫îÁî®Âú∞ÂùÄÁ©∫Èó¥" class="headerlink" title="Â∫îÁî®Âú∞ÂùÄÁ©∫Èó¥"></a>Â∫îÁî®Âú∞ÂùÄÁ©∫Èó¥</h5><p>Â∫îÁî®Âú∞ÂùÄÁ©∫Èó¥ÊòØÊØè‰∏™ËøõÁ®ãÁã¨Á´ãÊã•ÊúâÁöÑÂú∞ÂùÄÁ©∫Èó¥ÔºåÁî®‰∫éÂ≠òÂÇ®ËøõÁ®ãÁöÑ‰ª£Á†Å„ÄÅÊï∞ÊçÆ„ÄÅÊ†àÁ≠â„ÄÇÊØè‰∏™ËøõÁ®ãÁöÑÂ∫îÁî®Âú∞ÂùÄÁ©∫Èó¥ÊòØÁõ∏‰∫íÈöîÁ¶ªÁöÑÔºå‰∏Ä‰∏™ËøõÁ®ãÊó†Ê≥ïÁõ¥Êé•ËÆøÈóÆÂè¶‰∏Ä‰∏™ËøõÁ®ãÁöÑÂú∞ÂùÄÁ©∫Èó¥Ôºå‰ªéËÄå‰øùËØÅ‰∫ÜÁ≥ªÁªüÁöÑÂÆâÂÖ®ÊÄßÂíåÁ®≥ÂÆöÊÄß„ÄÇÂú® PotatOS ‰∏≠ÔºåÂ∫îÁî®Âú∞ÂùÄÁ©∫Èó¥ÁöÑÊò†Â∞ÑÂíåÁÆ°ÁêÜ‰πüÊòØÈÄöËøá <code>PageTable</code> Âíå <code>MapArea</code> Êù•ÂÆûÁé∞ÁöÑ„ÄÇÂΩìÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑËøõÁ®ãÊó∂Ôºå‰ºö‰∏∫ÂÖ∂ÂàÜÈÖç‰∏Ä‰∏™Áã¨Á´ãÁöÑÈ°µË°®ÂíåÈÄªËæëÊÆµÔºåÁî®‰∫éÁÆ°ÁêÜÂÖ∂Â∫îÁî®Âú∞ÂùÄÁ©∫Èó¥„ÄÇ</p>
<p><img src="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/app-as-full.png" srcset="/img/loading.gif" lazyload alt="..&#x2F;_images&#x2F;app-as-full.png"></p>
<p>ÂÆûÁé∞‰∫ÜÁî®Êà∑Á©∫Èó¥ÁöÑÁªü‰∏ÄÂåñ‰πãÂêéÔºåÊàë‰ª¨ÂèØ‰ª•ÊääÂ∫îÁî®ÈìæÊé•Âà∞Âêå‰∏Ä‰∏™ËôöÊãüÂú∞ÂùÄ‰∏≠</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs assembly">OUTPUT_ARCH(riscv)<br>ENTRY(_start)<br><br>BASE_ADDRESS = 0x10000;<br><br>SECTIONS<br>&#123;<br>    . = BASE_ADDRESS;<br>    .text : &#123;<br>        *(.text.entry)<br>        *(.text .text.*)<br>    &#125;<br>    . = ALIGN(4K);<br>    .rodata : &#123;<br>        *(.rodata .rodata.*)<br>        *(.srodata .srodata.*)<br>    &#125;<br>    . = ALIGN(4K);<br>    .data : &#123;<br>        *(.data .data.*)<br>        *(.sdata .sdata.*)<br>    &#125;<br>    .bss : &#123;<br>        *(.bss .bss.*)<br>        *(.sbss .sbss.*)<br>    &#125;<br>    /DISCARD/ : &#123;<br>        *(.eh_frame)<br>        *(.debug*)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="ËøõÁ®ã"><a href="#ËøõÁ®ã" class="headerlink" title="ËøõÁ®ã"></a>ËøõÁ®ã</h2><p>ËøõÁ®ãÂèØ‰ª•ÁÆÄÂçïÁêÜËß£‰∏∫<strong>Êìç‰ΩúÁ≥ªÁªüÂØπÁ®ãÂ∫èËøõË°å‰∏ÄÊ¨°ÊâßË°åÁöÑËøáÁ®ã</strong></p>
<p>Âú®<strong>rCore</strong>‰∏≠ÔºåËøõÁ®ãË¢´ÂàÜÁ¶ªÊàê‰∫Ü<code>task</code>Âíå<code>process</code>„ÄÇprocess‰∏ªË¶ÅÊåá‰ª£ËøõÁ®ãÔºåtask‰∏ªË¶ÅÊåá‰ª£ÂÖ∑‰ΩìÊâßË°åÁöÑ‰ªªÂä°ÔºåÂèØ‰ª•ÁêÜËß£‰∏∫Á∫øÁ®ã„ÄÇ</p>
<h3 id="‰ªªÂä°Ê®°Âûã-Task"><a href="#‰ªªÂä°Ê®°Âûã-Task" class="headerlink" title="‰ªªÂä°Ê®°Âûã(Task)"></a>‰ªªÂä°Ê®°Âûã(Task)</h3><p>‰ªªÂä°ÊòØÊìç‰ΩúÁ≥ªÁªü‰∏≠ÊúÄÂ∞èÁöÑÊâßË°åÂçï‰ΩçÔºåÂÆÉÂèØ‰ª•ÊòØ‰∏Ä‰∏™Á∫øÁ®ãÊàñËÄÖ‰∏Ä‰∏™ËøõÁ®ã‰∏≠ÁöÑ‰∏ÄÈÉ®ÂàÜ„ÄÇ‰ªªÂä°ÈÄöÂ∏∏ÂÖ∑ÊúâËá™Â∑±ÁöÑÊâßË°å‰∏ä‰∏ãÊñáÔºåÂåÖÊã¨ÂØÑÂ≠òÂô®Áä∂ÊÄÅ„ÄÅÊ†àÊåáÈíàÁ≠â„ÄÇÂú® PotatOS ‰∏≠Ôºå‰ªªÂä°ÁöÑË∞ÉÂ∫¶ÂíåÁÆ°ÁêÜÊòØÊìç‰ΩúÁ≥ªÁªüÁöÑÈáçË¶ÅÂäüËÉΩ‰πã‰∏ÄÔºåÂÆÉË¥üË¥£ÂÜ≥ÂÆöÂì™‰∏™‰ªªÂä°Âú®‰ΩïÊó∂ÊâßË°åÔºå‰ª•ÊèêÈ´òÁ≥ªÁªüÁöÑÂπ∂ÂèëÊÄßËÉΩÂíåËµÑÊ∫êÂà©Áî®Áéá„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TaskControlBlock</span> &#123;<br>    <span class="hljs-keyword">pub</span> pid: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> ppid: <span class="hljs-type">usize</span>,<br>    <span class="hljs-comment">// immutable</span><br>    <span class="hljs-keyword">pub</span> process: Weak&lt;ProcessControlBlock&gt;,<br>    <span class="hljs-keyword">pub</span> kstack: KernelStack,<br>    <span class="hljs-comment">// mutable</span><br>    <span class="hljs-keyword">pub</span> inner: UPIntrFreeCell&lt;TaskControlBlockInner&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TaskControlBlockInner</span> &#123;<br>    <span class="hljs-keyword">pub</span> res: <span class="hljs-type">Option</span>&lt;TaskUserRes&gt;,<br>    <span class="hljs-keyword">pub</span> trap_cx_ppn: PhysPageNum,<br>    <span class="hljs-keyword">pub</span> task_cx: TaskContext,<br>    <span class="hljs-keyword">pub</span> task_status: TaskStatus,<br>    <span class="hljs-keyword">pub</span> exit_code: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">i32</span>&gt;,<br><br>    <span class="hljs-keyword">pub</span> user_time: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> kernel_time: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> time_created: <span class="hljs-type">usize</span>,    <br>    <span class="hljs-keyword">pub</span> first_time: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> stop_watch: <span class="hljs-type">usize</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>TCB</code>Ôºö‰ªªÂä°ÁöÑÊéßÂà∂ÂùóÔºåÂåÖÂê´‰ªªÂä°Âü∫Êú¨‰ø°ÊÅØ<ul>
<li><code>pid</code>Ôºö‰ªªÂä°ÊâÄÂ±ûËøõÁ®ãid</li>
<li><code>ppid</code>ÔºöÂêåÁêÜÔºåÁà∂ËøõÁ®ãid</li>
</ul>
</li>
<li><code>TCBInner</code>Ôºö‰ªªÂä°ÂÜÖÈÉ®‰ø°ÊÅØÔºåÂåÖÊã¨ÂæàÂ§ö‰ø°ÊÅØÔºåÂèØ‰ª•ÈÄöËøá‰∫íÊñ•ËÆøÈóÆÂæóÂà∞<ul>
<li><code>res</code>ÔºöËøîÂõûÁä∂ÊÄÅ</li>
<li><code>cx</code>Ôºö‰ªªÂä°ÁöÑ‰∏ä‰∏ãÊñáÔºå‰∏ªË¶ÅÂåÖÊã¨ËøîÂõûÂú∞ÂùÄÔºåÊ†àÈ°∂‰ΩçÁΩÆÂíåË¢´Ë∞ÉÁî®ËÄÖÂØÑÂ≠òÂô®</li>
<li><code>time</code>Ôºö‰ªªÂä°ÁöÑÂêÑÁßçÊó∂Èó¥ËÆ∞ÂΩï</li>
</ul>
</li>
</ul>
<p><strong>ÈáçË¶ÅÊñπÊ≥ï</strong>Ôºö</p>
<p>‰∏ªË¶ÅÊòØÂêÑÁßçÊó∂Èó¥Áä∂ÊÄÅÁöÑËÆæÁΩÆÔºåÊØîÂ¶ÇÂú®trapÊó∂ÂºÄÂêØËÆ°Êó∂Ôºå‰∏ã‰∏Ä‰∏™trapÊó∂ÂÅúÊ≠¢ÂΩìËÆ°Êó∂Ôºõ</p>
<p>‰ª•Âèä‰ªªÂä°ÁöÑË∞ÉÂ∫¶„ÄÇ‰ºöÂú®‰∏ãÈù¢Áªü‰∏ÄËÆ≤Ëø∞„ÄÇ</p>
<h3 id="ËøõÁ®ãÊ®°Âûã-Process"><a href="#ËøõÁ®ãÊ®°Âûã-Process" class="headerlink" title="ËøõÁ®ãÊ®°Âûã(Process)"></a>ËøõÁ®ãÊ®°Âûã(Process)</h3><p>‰∏ªË¶ÅÁî±<code>PCB</code>ÊûÑÊàê</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ProcessControlBlock</span> &#123;<br>    <span class="hljs-comment">// immutable</span><br>    <span class="hljs-keyword">pub</span> pid: PidHandle,<br>    <span class="hljs-comment">// mutable</span><br>    inner: UPIntrFreeCell&lt;ProcessControlBlockInner&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ProcessControlBlockInner</span> &#123;<br>    <span class="hljs-keyword">pub</span> is_zombie: <span class="hljs-type">bool</span>,<br>    <span class="hljs-keyword">pub</span> memory_set: MemorySet,<br>    <span class="hljs-keyword">pub</span> parent: <span class="hljs-type">Option</span>&lt;Weak&lt;ProcessControlBlock&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> children: <span class="hljs-type">Vec</span>&lt;Arc&lt;ProcessControlBlock&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> exit_code: <span class="hljs-type">i32</span>,<br>    <span class="hljs-keyword">pub</span> fd_table: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Option</span>&lt;Arc&lt;<span class="hljs-keyword">dyn</span> File + <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span>&gt;&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> signals: SignalFlags,<br>    <span class="hljs-keyword">pub</span> tasks: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Option</span>&lt;Arc&lt;TaskControlBlock&gt;&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> task_res_allocator: RecycleAllocator,<br>    <span class="hljs-keyword">pub</span> mutex_list: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Option</span>&lt;Arc&lt;<span class="hljs-keyword">dyn</span> Mutex&gt;&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> semaphore_list: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Option</span>&lt;Arc&lt;Semaphore&gt;&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> condvar_list: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Option</span>&lt;Arc&lt;Condvar&gt;&gt;&gt;,<br><br>    <span class="hljs-keyword">pub</span> cwd: Arc&lt;Inode&gt;,<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>ProcessControlBlock</code>ÔºöËøõÁ®ãÊéßÂà∂ÂùóÁªìÊûÑ‰ΩìÔºåÂåÖÂê´ËøõÁ®ãÁöÑÂü∫Êú¨‰ø°ÊÅØÂíåÂèØÂèòÈÉ®ÂàÜ„ÄÇ<ul>
<li><code>pid</code>ÔºöËøõÁ®ãÊ†áËØÜÁ¨¶ÔºåÁî®‰∫éÂîØ‰∏ÄÊ†áËØÜ‰∏Ä‰∏™ËøõÁ®ã„ÄÇ</li>
<li><code>inner</code>ÔºöÂèØÂèòÈÉ®ÂàÜÔºå‰ΩøÁî® <code>UPIntrFreeCell</code> ËøõË°åÂ∞ÅË£ÖÔºåÁ°Æ‰øùÁ∫øÁ®ãÂÆâÂÖ®„ÄÇ</li>
</ul>
</li>
<li><code>ProcessControlBlockInner</code>ÔºöËøõÁ®ãÊéßÂà∂ÂùóÁöÑÂèØÂèòÈÉ®ÂàÜÔºåÂåÖÂê´‰∫ÜËøõÁ®ãÁöÑËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇ<ul>
<li><code>is_zombie</code>ÔºöË°®Á§∫ËøõÁ®ãÊòØÂê¶‰∏∫ÂÉµÂ∞∏ËøõÁ®ã„ÄÇÂÉµÂ∞∏ËøõÁ®ãÊòØÊåáÂ∑≤ÁªèÁªìÊùü‰ΩÜÂ∞öÊú™Ë¢´Áà∂ËøõÁ®ãÂõûÊî∂ÁöÑËøõÁ®ã„ÄÇ</li>
<li><code>memory_set</code>ÔºöËøõÁ®ãÁöÑÂú∞ÂùÄÁ©∫Èó¥ÔºåÂåÖÂê´‰∫ÜËøõÁ®ãÁöÑÈ°µË°®ÂíåÈÄªËæëÊÆµ„ÄÇ</li>
<li><code>parent</code>ÔºöÁà∂ËøõÁ®ãÁöÑÂº±ÂºïÁî®ÔºåÁî®‰∫éË°®Á§∫ËøõÁ®ã‰πãÈó¥ÁöÑÁà∂Â≠êÂÖ≥Á≥ª„ÄÇ</li>
<li><code>children</code>ÔºöÂ≠êËøõÁ®ãÁöÑÂº∫ÂºïÁî®ÂàóË°®ÔºåÂ≠òÂÇ®‰∫ÜËØ•ËøõÁ®ãÁöÑÊâÄÊúâÂ≠êËøõÁ®ã„ÄÇ</li>
<li><code>exit_code</code>ÔºöËøõÁ®ãÁöÑÈÄÄÂá∫Á†ÅÔºåÁî®‰∫éË°®Á§∫ËøõÁ®ãÁöÑÈÄÄÂá∫Áä∂ÊÄÅ„ÄÇ</li>
<li><code>fd_table</code>ÔºöÊñá‰ª∂ÊèèËø∞Á¨¶Ë°®ÔºåÂ≠òÂÇ®‰∫ÜËøõÁ®ãÊâìÂºÄÁöÑÊñá‰ª∂ÁöÑÂºïÁî®„ÄÇ</li>
<li><code>signals</code>Ôºö‰ø°Âè∑Ê†áÂøóÔºåÁî®‰∫éÂ§ÑÁêÜËøõÁ®ãÊé•Êî∂Âà∞ÁöÑ‰ø°Âè∑„ÄÇ</li>
<li><code>tasks</code>Ôºö‰ªªÂä°ÂàóË°®ÔºåÂ≠òÂÇ®‰∫ÜËøõÁ®ã‰∏≠ÁöÑÊâÄÊúâ‰ªªÂä°„ÄÇ</li>
<li><code>task_res_allocator</code>Ôºö‰ªªÂä°ËµÑÊ∫êÂàÜÈÖçÂô®ÔºåÁî®‰∫éÂàÜÈÖçÂíåÂõûÊî∂‰ªªÂä°ÁöÑËµÑÊ∫ê„ÄÇ</li>
<li><code>mutex_list</code>Ôºö‰∫íÊñ•ÈîÅÂàóË°®ÔºåÁî®‰∫éÂÆûÁé∞ËøõÁ®ãÂÜÖÁöÑ‰∫íÊñ•ËÆøÈóÆ„ÄÇ</li>
<li><code>semaphore_list</code>Ôºö‰ø°Âè∑ÈáèÂàóË°®ÔºåÁî®‰∫éÂÆûÁé∞ËøõÁ®ãÈó¥ÁöÑÂêåÊ≠•Âíå‰∫íÊñ•„ÄÇ</li>
<li><code>condvar_list</code>ÔºöÊù°‰ª∂ÂèòÈáèÂàóË°®ÔºåÁî®‰∫éÂÆûÁé∞ËøõÁ®ãÈó¥ÁöÑÂêåÊ≠•ÂíåÈÄö‰ø°„ÄÇ</li>
<li><code>cwd</code>ÔºöÂΩìÂâçÂ∑•‰ΩúÁõÆÂΩïÁöÑÁ¥¢ÂºïËäÇÁÇπÔºåÁî®‰∫éÊåáÂÆöËøõÁ®ãÁöÑÂΩìÂâçÂ∑•‰ΩúÁõÆÂΩï„ÄÇ</li>
</ul>
</li>
</ul>
<p><strong>ÈáçË¶ÅÊñπÊ≥ï</strong>Ôºö</p>
<ul>
<li><code>fork</code>ÔºöÈô§‰∫ÜÂàùÂßãËøõÁ®ãÂ§ñÔºåÈÄöÁî®ÁöÑËøõÁ®ã‰∫ßÁîüÊñπÊ≥ï„ÄÇÈô§‰∫Ü pid Â§ñÔºåchild ÁªßÊâø parent Â§ßÈÉ®ÂàÜ‰ø°ÊÅØ„ÄÇ<code>fork</code> Á≥ªÁªüË∞ÉÁî®‰ºöÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑËøõÁ®ãÔºåËØ•ËøõÁ®ãÊòØË∞ÉÁî®ËøõÁ®ãÁöÑÂâØÊú¨ÔºåÊã•ÊúâÁõ∏ÂêåÁöÑ‰ª£Á†Å„ÄÅÊï∞ÊçÆÂíåÊñá‰ª∂ÊèèËø∞Á¨¶Á≠â„ÄÇÊñ∞ËøõÁ®ãÁöÑ pid ÊòØÂîØ‰∏ÄÁöÑÔºå‰∏éÁà∂ËøõÁ®ã‰∏çÂêå„ÄÇ</li>
<li><code>exec</code>ÔºöÂ∞ÜÂΩìÂâçËøõÁ®ãÁöÑÂú∞ÂùÄÁ©∫Èó¥Ê∏ÖÁ©∫Âπ∂Âä†ËΩΩ‰∏Ä‰∏™ÁâπÂÆöÁöÑÂèØÊâßË°åÊñá‰ª∂ÔºåËøîÂõûÁî®Êà∑ÊÄÅÂêéÂºÄÂßãÂÆÉÁöÑÊâßË°å„ÄÇ<code>exec</code> Á≥ªÁªüË∞ÉÁî®‰ºöÁî®Êñ∞ÁöÑÂèØÊâßË°åÊñá‰ª∂ÊõøÊç¢ÂΩìÂâçËøõÁ®ãÁöÑÂú∞ÂùÄÁ©∫Èó¥Ôºå‰ªéËÄå‰ΩøËøõÁ®ãÊâßË°åÊñ∞ÁöÑÁ®ãÂ∫è„ÄÇ</li>
<li><code>waitpid</code>ÔºöÂΩìÂâçËøõÁ®ãÁ≠âÂæÖ‰∏Ä‰∏™Â≠êËøõÁ®ãÂèò‰∏∫ÂÉµÂ∞∏ËøõÁ®ãÔºåÂõûÊî∂ÂÖ∂ÂÖ®ÈÉ®ËµÑÊ∫êÂπ∂Êî∂ÈõÜÂÖ∂ËøîÂõûÂÄº„ÄÇ<code>waitpid</code> Á≥ªÁªüË∞ÉÁî®‰ºöÈòªÂ°ûÂΩìÂâçËøõÁ®ãÔºåÁõ¥Âà∞ÊåáÂÆöÁöÑÂ≠êËøõÁ®ãÁªìÊùüÂπ∂Âèò‰∏∫ÂÉµÂ∞∏ËøõÁ®ãÔºåÁÑ∂ÂêéÂõûÊî∂Â≠êËøõÁ®ãÁöÑËµÑÊ∫êÔºåÂπ∂Ëé∑ÂèñÂÖ∂ÈÄÄÂá∫Á†Å„ÄÇ</li>
</ul>
<h4 id="initproc"><a href="#initproc" class="headerlink" title="initproc"></a>initproc</h4><p>ÂàùÂßãËøõÁ®ãÔºåÊâÄÊúâËøõÁ®ãÈÉΩ‰ªéÂÆÉ fork Âá∫Êù•„ÄÇËøôÈáåÁöÑÂÆûÁé∞ÊòØÁõ¥Êé• fork Âá∫‰∏Ä‰∏™<strong>user_shell</strong>ËøõÁ®ã„ÄÇ<code>initproc</code> ÊòØÊìç‰ΩúÁ≥ªÁªüÂêØÂä®ÂêéÁöÑÁ¨¨‰∏Ä‰∏™ËøõÁ®ãÔºåÂÆÉË¥üË¥£ÂàõÂª∫ÂÖ∂‰ªñËøõÁ®ãÂíåÂàùÂßãÂåñÁ≥ªÁªüÁéØÂ¢É„ÄÇÂú® PotatOS ‰∏≠Ôºå<code>initproc</code> ‰ºö fork Âá∫‰∏Ä‰∏™ <code>user_shell</code> ËøõÁ®ãÔºåÁî®‰∫éÊèê‰æõÁî®Êà∑‰∫§‰∫íÁïåÈù¢„ÄÇ</p>
<h4 id="user-shell"><a href="#user-shell" class="headerlink" title="user_shell"></a>user_shell</h4><p>‰∏Ä‰∏™ÁÆÄÂçïÁöÑ shell Á®ãÂ∫èÔºåË¥üË¥£ÊâßË°åÂÜÖÈÉ®ÂëΩ‰ª§ÂíåÂ§ñÈÉ®ÂëΩ‰ª§„ÄÇ</p>
<ul>
<li><strong>ÂÜÖÈÉ®ÂëΩ‰ª§</strong>ÔºöÂÖ≥Á≥ªÂà∞ÂΩìÂâç‰∏ªËøõÁ®ãÔºåÈúÄË¶ÅÊîπÂèòÂÖ∂Áä∂ÊÄÅÁöÑÂëΩ‰ª§„ÄÇÊØîÂ¶Ç<code>pwd</code>Ôºå<code>chdir</code>Á≠âÁ≠â„ÄÇÂÜÖÈÉ®ÂëΩ‰ª§ÈÄöÂ∏∏ÊòØÁî± shell Êú¨Ë∫´ÂÆûÁé∞ÁöÑÔºå‰∏çÈúÄË¶ÅÂàõÂª∫Êñ∞ÁöÑËøõÁ®ãÊù•ÊâßË°å„ÄÇ</li>
<li><strong>Â§ñÈÉ®ÂëΩ‰ª§</strong>ÔºöÊâßË°åÁ≥ªÁªüÂ§ñÈÉ®ÁöÑÁ®ãÂ∫èÔºåÁÆÄÂçïÂú∞ fork Âêé exec„ÄÇÂ§ñÈÉ®ÂëΩ‰ª§ÊòØÊåáÈúÄË¶ÅÊâßË°åÁ≥ªÁªü‰∏≠ÂÖ∂‰ªñÂèØÊâßË°åÊñá‰ª∂ÁöÑÂëΩ‰ª§Ôºåshell ‰ºöÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑËøõÁ®ãÊù•ÊâßË°åËøô‰∫õÂëΩ‰ª§„ÄÇ</li>
</ul>
<h3 id="ËøõÁ®ãÊâßË°å"><a href="#ËøõÁ®ãÊâßË°å" class="headerlink" title="ËøõÁ®ãÊâßË°å"></a>ËøõÁ®ãÊâßË°å</h3><h4 id="Â∫îÁî®ÁöÑÈìæÊé•‰∏éÂä†ËΩΩ"><a href="#Â∫îÁî®ÁöÑÈìæÊé•‰∏éÂä†ËΩΩ" class="headerlink" title="Â∫îÁî®ÁöÑÈìæÊé•‰∏éÂä†ËΩΩ"></a>Â∫îÁî®ÁöÑÈìæÊé•‰∏éÂä†ËΩΩ</h4><p>Âú®<code>Make</code>ÂêØÂä® Qemu Êó∂Ôºåuser&#x2F;src&#x2F;bin&#x2F; ÂÜÖÁöÑÁ®ãÂ∫è‰ºöÈÄöËøá<strong>efs-fuse</strong>Ë¢´È¢ÑÂä†ËΩΩÂà∞ fs.img ‰∏≠„ÄÇËØ¶ËßÅ‰∏ãÊñá„ÄÇÂ¶ÇÊûú‰∏ç‰ΩøÁî® efs-fuseÔºåÂàôÈúÄË¶Å‰ΩøÁî®<strong>link_app.S</strong>ÊääÁºñËØëÂêéÁöÑÊñá‰ª∂‰∏Ä‰∏™‰∏™Âä†ËΩΩÂà∞ÂÜÖÂ≠òÁöÑÂú∞ÂùÄ‰∏≠„ÄÇËøôÁßçÁ°¨ÁºñÁ†ÅÁöÑÂΩ¢Âºè‰ª§‰∫∫ÈöæÂèó„ÄÇ</p>
<p><code>efs-fuse</code> ÊòØ‰∏Ä‰∏™Áî®Êà∑Á©∫Èó¥ÁöÑÊñá‰ª∂Á≥ªÁªüÔºåÂÆÉÂèØ‰ª•Â∞Ü user&#x2F;src&#x2F;bin&#x2F; ÁõÆÂΩï‰∏ãÁöÑÊâÄÊúâÁ®ãÂ∫è‰∫åËøõÂà∂Ê†ºÂºèÊâìÂåÖÔºåÂπ∂Âä†ËΩΩÂà∞È¢ÑÂÖàÂáÜÂ§áÂ•ΩÁöÑ fs.img ‰∏≠„ÄÇËøôÊ†∑ÔºåÂú®ÂêØÂä® Qemu Êó∂ÔºåÊìç‰ΩúÁ≥ªÁªüÂèØ‰ª•Áõ¥Êé•‰ªé fs.img ‰∏≠ËØªÂèñËøô‰∫õÁ®ãÂ∫èÔºåÂπ∂Âä†ËΩΩÂà∞ÂÜÖÂ≠ò‰∏≠ÊâßË°å„ÄÇËÄå‰ΩøÁî® <code>link_app.S</code> ÂàôÈúÄË¶ÅÊâãÂä®Â∞ÜÁºñËØëÂêéÁöÑÊñá‰ª∂Âä†ËΩΩÂà∞ÂÜÖÂ≠òÁöÑÊåáÂÆöÂú∞ÂùÄÔºåËøôÁßçÊñπÂºèÊØîËæÉÁπÅÁêêÔºåËÄå‰∏îÂÆπÊòìÂá∫Èîô„ÄÇ</p>
<h3 id="‰ªªÂä°Ë∞ÉÂ∫¶"><a href="#‰ªªÂä°Ë∞ÉÂ∫¶" class="headerlink" title="‰ªªÂä°Ë∞ÉÂ∫¶"></a>‰ªªÂä°Ë∞ÉÂ∫¶</h3><p>ËøõÁ®ãÁöÑË∞ÉÂ∫¶Âü∫‰∫é<strong>‰ªªÂä°Ë∞ÉÂ∫¶</strong>„ÄÇ‰ªªÂä°Ë∞ÉÂ∫¶ÊòØÊìç‰ΩúÁ≥ªÁªüÁöÑÊ†∏ÂøÉÂäüËÉΩ‰πã‰∏ÄÔºåÂÆÉË¥üË¥£ÂÜ≥ÂÆöÂì™‰∏™‰ªªÂä°Âú®‰ΩïÊó∂ÊâßË°åÔºå‰ª•ÊèêÈ´òÁ≥ªÁªüÁöÑÂπ∂ÂèëÊÄßËÉΩÂíåËµÑÊ∫êÂà©Áî®Áéá„ÄÇÂú®PotatOS‰∏≠Ôºå‰ªªÂä°Ë∞ÉÂ∫¶‰ΩøÁî®ÁÆÄÂçïÁöÑRRÊó∂Èó¥ÁâáÊñπÊ≥ï„ÄÇ</p>
<h4 id="Ë∞ÉÂ∫¶ÊñπÊ≥ï"><a href="#Ë∞ÉÂ∫¶ÊñπÊ≥ï" class="headerlink" title="Ë∞ÉÂ∫¶ÊñπÊ≥ï"></a>Ë∞ÉÂ∫¶ÊñπÊ≥ï</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/task/manager.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TaskManager</span> &#123;<br>    ready_queue: VecDeque&lt;Arc&lt;TaskControlBlock&gt;&gt;,<br>&#125;<br><br><span class="hljs-comment">/// A simple FIFO scheduler.</span><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">TaskManager</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123;<br>            ready_queue: VecDeque::<span class="hljs-title function_ invoke__">new</span>(),<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, task: Arc&lt;TaskControlBlock&gt;) &#123;<br>        <span class="hljs-keyword">self</span>.ready_queue.<span class="hljs-title function_ invoke__">push_back</span>(task);<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">fetch</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Arc&lt;TaskControlBlock&gt;&gt; &#123;<br>        <span class="hljs-keyword">self</span>.ready_queue.<span class="hljs-title function_ invoke__">pop_front</span>()<br>    &#125;<br>&#125;<br><br>lazy_static! &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">ref</span> TASK_MANAGER: UPIntrFreeCell&lt;TaskManager&gt; =<br>        <span class="hljs-keyword">unsafe</span> &#123; UPIntrFreeCell::<span class="hljs-title function_ invoke__">new</span>(TaskManager::<span class="hljs-title function_ invoke__">new</span>()) &#125;;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">ref</span> PID2PCB: UPIntrFreeCell&lt;BTreeMap&lt;<span class="hljs-type">usize</span>, Arc&lt;ProcessControlBlock&gt;&gt;&gt; =<br>        <span class="hljs-keyword">unsafe</span> &#123; UPIntrFreeCell::<span class="hljs-title function_ invoke__">new</span>(BTreeMap::<span class="hljs-title function_ invoke__">new</span>()) &#125;;<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_task</span>(task: Arc&lt;TaskControlBlock&gt;) &#123;<br>    TASK_MANAGER.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">add</span>(task);<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">wakeup_task</span>(task: Arc&lt;TaskControlBlock&gt;) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">task_inner</span> = task.<span class="hljs-title function_ invoke__">inner_exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>    task_inner.task_status = TaskStatus::Ready;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">task_info</span> = TaskInfo &#123;<br>        pid: task.<span class="hljs-title function_ invoke__">get_pid</span>(),<br>        ppid: task.<span class="hljs-title function_ invoke__">get_ppid</span>(), <br>        status: task_inner.task_status,<br>        user_time: task_inner.user_time,<br>        kernel_time: task_inner.kernel_time,<br>        time_created: task_inner.time_created,<br>        first_time: task_inner.first_time,<br>    &#125;;<br>    <br>    <span class="hljs-title function_ invoke__">drop</span>(task_inner);<br>    <span class="hljs-title function_ invoke__">add_task</span>(task);<br>    <br>    <span class="hljs-title function_ invoke__">write_proc</span>(task_info);<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">fetch_task</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Arc&lt;TaskControlBlock&gt;&gt; &#123;<br>    TASK_MANAGER.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">fetch</span>()<br>&#125;<br></code></pre></td></tr></table></figure>

<p>‰ªªÂä°ÁöÑË∞ÉÂ∫¶Áî±ÁÆÄÂçïÁöÑ<strong>FIFOÈòüÂàó</strong>ÂÆûÁé∞„ÄÇ‰∏ªË¶ÅÂåÖÊã¨‰∏Ä‰∏ãÂá†‰∏™ÊñπÊ≥ïÔºö</p>
<ul>
<li><code>add_task</code>ÔºöÁõ¥Êé•ÂæÄÈòüÂàóÈáåÂä†ÂÖ•task</li>
<li><code>wakeup_task</code>ÔºöÊää‰∏Ä‰∏™Êñ∞ÁöÑtaskÂî§ÈÜíÔºåÁÑ∂ÂêéÊèíÂÖ•Âà∞procesÈòüÂàóÈáå</li>
<li><code>fetch_task</code>ÔºöÂèñÂæó‰∏Ä‰∏™task</li>
</ul>
<h4 id="RR"><a href="#RR" class="headerlink" title="RR"></a>RR</h4><p>Âú®ÂÜÖÊ†∏ÈáåÔºåÊàë‰ª¨ËÆæÁΩÆ‰∫Ü‰∏Ä‰∏™timerÁ±ªÔºåÁî®‰∫éÊó∂Èó¥ÁâáËΩÆËΩ¨ÊñπÊ≥ï„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/timer.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_time</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>    time::<span class="hljs-title function_ invoke__">read</span>()<br>&#125;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_time_ms</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>    time::<span class="hljs-title function_ invoke__">read</span>() / (CLOCK_FREQ / MSEC_PER_SEC)<br>&#125;<br><span class="hljs-comment">/// set time slice for current task</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">set_next_trigger</span>() &#123;<br>    <span class="hljs-title function_ invoke__">set_timer</span>(<span class="hljs-title function_ invoke__">get_time</span>() + CLOCK_FREQ / TICKS_PER_SEC);<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_timer</span>(expire_ms: <span class="hljs-type">usize</span>, task: Arc&lt;TaskControlBlock&gt;) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">timers</span> = TIMERS.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>    timers.<span class="hljs-title function_ invoke__">push</span>(TimerCondVar &#123; expire_ms, task &#125;);<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">check_timer</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">current_ms</span> = <span class="hljs-title function_ invoke__">get_time_ms</span>();<br>    TIMERS.<span class="hljs-title function_ invoke__">exclusive_session</span>(|timers| &#123;<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(timer) = timers.<span class="hljs-title function_ invoke__">peek</span>() &#123;<br>            <span class="hljs-keyword">if</span> timer.expire_ms &lt;= current_ms &#123;<br>                <span class="hljs-title function_ invoke__">wakeup_task</span>(Arc::<span class="hljs-title function_ invoke__">clone</span>(&amp;timer.task));<br>                timers.<span class="hljs-title function_ invoke__">pop</span>();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="ËøõÁ®ãË∞ÉÂ∫¶"><a href="#ËøõÁ®ãË∞ÉÂ∫¶" class="headerlink" title="ËøõÁ®ãË∞ÉÂ∫¶"></a>ËøõÁ®ãË∞ÉÂ∫¶</h3><h3 id="Âπ∂ÂèëÊéßÂà∂"><a href="#Âπ∂ÂèëÊéßÂà∂" class="headerlink" title="Âπ∂ÂèëÊéßÂà∂"></a>Âπ∂ÂèëÊéßÂà∂</h3><h2 id="Êñá‰ª∂Á≥ªÁªü"><a href="#Êñá‰ª∂Á≥ªÁªü" class="headerlink" title="Êñá‰ª∂Á≥ªÁªü"></a>Êñá‰ª∂Á≥ªÁªü</h2><p>Êú¨Á≥ªÁªüÊ®°‰ªø‰ΩøÁî®‰∫Ü<strong>easyfs</strong>Ôºå‰∏Ä‰∏™ÁÆÄÂåñÁâàÊú¨ÁöÑÊñá‰ª∂Á≥ªÁªü„ÄÇ‰∏∫‰∫ÜÈôç‰ΩéËÄ¶ÂêàÊÄßÔºåÊï¥‰ΩìÂèØ‰ª•ÂàÜ‰∏∫‰∫îÂ±ÇÔºö</p>
<ol>
<li><strong>Á£ÅÁõòÂùóÊé•Âè£Â±Ç</strong>ÔºöÊäΩË±°Â∞ÅË£ÖÁ£ÅÁõòÂùóÔºåÂÆûÁé∞ÂØπÂ§ñÊé•Âè£„ÄÇËØ•Â±ÇÊèê‰æõ‰∫ÜÂØπÁ£ÅÁõòÂùóÁöÑÂü∫Êú¨ËØªÂÜôÊìç‰ΩúÔºåÊòØÊñá‰ª∂Á≥ªÁªü‰∏éÁ£ÅÁõòËÆæÂ§á‰πãÈó¥ÁöÑÊé•Âè£„ÄÇ</li>
<li><strong>ÂùóÁºìÂ≠òÂ±Ç</strong>ÔºöÂÆûÁé∞ÂùóÁºìÂ≠òÂäüËÉΩÔºåÊèê‰æõÂØπÂ§ñËØªÂÜôÊé•Âè£„ÄÇ‰∏∫‰∫ÜÊèêÈ´òÊñá‰ª∂Á≥ªÁªüÁöÑËØªÂÜôÊÄßËÉΩÔºåËØ•Â±ÇÂºïÂÖ•‰∫ÜÂùóÁºìÂ≠òÊú∫Âà∂ÔºåÂ∞ÜÁªèÂ∏∏ËÆøÈóÆÁöÑÁ£ÅÁõòÂùóÁºìÂ≠òÂà∞ÂÜÖÂ≠ò‰∏≠ÔºåÂáèÂ∞ë‰∫ÜÁ£ÅÁõòÁöÑËØªÂÜôÊ¨°Êï∞„ÄÇ</li>
<li><strong>Á£ÅÁõòÂùóÊï∞ÊçÆÁªìÊûÑÂ±Ç</strong>ÔºöÂÆûÁé∞ superblockÔºådatablockÔºåinode Á≠âÁ≠â„ÄÇËØ•Â±ÇÂÆö‰πâ‰∫ÜÊñá‰ª∂Á≥ªÁªüÁöÑÂü∫Êú¨Êï∞ÊçÆÁªìÊûÑÔºåÂ¶ÇË∂ÖÁ∫ßÂùó„ÄÅÊï∞ÊçÆÂùó„ÄÅÁ¥¢ÂºïËäÇÁÇπÁ≠âÔºåÁî®‰∫éÁÆ°ÁêÜÊñá‰ª∂ÂíåÁõÆÂΩïÁöÑÂ≠òÂÇ®„ÄÇ</li>
<li><strong>Á£ÅÁõòÂùóÁÆ°ÁêÜÂ±Ç</strong>Ôºöeasyfs ÁöÑ‰∏ªË¶ÅÈÉ®ÂàÜÔºåËøõË°åÂùóÁöÑÁÆ°ÁêÜ„ÄÇËØ•Â±ÇË¥üË¥£Á£ÅÁõòÂùóÁöÑÂàÜÈÖçÂíåÂõûÊî∂ÔºåÁ°Æ‰øùÊñá‰ª∂Á≥ªÁªüËÉΩÂ§üÈ´òÊïàÂú∞Âà©Áî®Á£ÅÁõòÁ©∫Èó¥„ÄÇ</li>
<li><strong>Á¥¢ÂºïËäÇÁÇπÂ±Ç</strong>Ôºöinode ÂÆûÁé∞Êñá‰ª∂ËØªÂÜôÁÆ°ÁêÜÂäüËÉΩÔºåÂ∞ÅË£ÖÂêéÂèØ‰ª•Êèê‰æõÂØπÂ§ñÊé•Âè£ËØªÂÜô„ÄÇËØ•Â±ÇÈÄöËøáÁ¥¢ÂºïËäÇÁÇπÊù•ÁÆ°ÁêÜÊñá‰ª∂ÂíåÁõÆÂΩïÁöÑËØªÂÜôÊìç‰ΩúÔºå‰∏∫‰∏äÂ±ÇÁöÑÊìç‰ΩúÁ≥ªÁªüÊèê‰æõ‰∫ÜÁªü‰∏ÄÁöÑÊñá‰ª∂ËÆøÈóÆÊé•Âè£„ÄÇ</li>
</ol>
<p>ÈÄöËøá VFS Âíå File trait Â∞ÅË£ÖÊï¥‰∏™ easyfs ÁöÑ inodeÔºå‰∏∫‰∏äÂ±ÇÁöÑ OS Êèê‰æõÊé•Âè£„ÄÇÊúÄÂêéÈÄöËøá VirtIO Ê®°ÊãüÂùóËÆæÂ§áÈ©±Âä®ÔºåÊê≠ËΩΩÂà∞ qemu Ê®°ÊãüÂô®‰∏äÈù¢„ÄÇ</p>
<h3 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h3><h4 id="ÂùóËÆæÂ§áÊé•Âè£Â±Ç"><a href="#ÂùóËÆæÂ§áÊé•Âè£Â±Ç" class="headerlink" title="ÂùóËÆæÂ§áÊé•Âè£Â±Ç"></a>ÂùóËÆæÂ§áÊé•Âè£Â±Ç</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">BlockDevice</span>: <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span> + Any &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_block</span>(&amp;<span class="hljs-keyword">self</span>, block_id: <span class="hljs-type">usize</span>, buf: &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>]);<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_block</span>(&amp;<span class="hljs-keyword">self</span>, block_id: <span class="hljs-type">usize</span>, buf: &amp;[<span class="hljs-type">u8</span>]);<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle_irq</span>(&amp;<span class="hljs-keyword">self</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂÆûÁé∞‰∫ÜËØªÂÜôÂùóÂíåÂ§ÑÁêÜ‰∏≠Êñ≠ÁöÑÂäüËÉΩ„ÄÇËØ•Êé•Âè£ÂÆö‰πâ‰∫ÜÂùóËÆæÂ§áÁöÑÂü∫Êú¨Êìç‰ΩúÔºåÂåÖÊã¨ËØªÂèñÁ£ÅÁõòÂùó„ÄÅÂÜôÂÖ•Á£ÅÁõòÂùóÂíåÂ§ÑÁêÜ‰∏≠Êñ≠„ÄÇ‰ªª‰ΩïÂÆûÁé∞‰∫ÜËØ•Êé•Âè£ÁöÑÁ±ªÂûãÈÉΩÂèØ‰ª•‰Ωú‰∏∫ÂùóËÆæÂ§á‰ΩøÁî®„ÄÇ</p>
<h4 id="ÂùóÁºìÂ≠òÂ±Ç"><a href="#ÂùóÁºìÂ≠òÂ±Ç" class="headerlink" title="ÂùóÁºìÂ≠òÂ±Ç"></a>ÂùóÁºìÂ≠òÂ±Ç</h4><p>‰∏∫‰∫ÜÂ∫îÂØπÈ¢ëÁπÅÁöÑËØªÂÜôÈááÁî®ÁºìÂ≠òÂä†ÈÄü„ÄÇ</p>
<p><strong>ÂùóÁºìÂ≠ò</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">BlockCache</span> &#123;<br>    cache: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;,<br>    block_id: <span class="hljs-type">usize</span>,<br>    block_device: Arc&lt;<span class="hljs-keyword">dyn</span> BlockDevice&gt;,<br>    modified: <span class="hljs-type">bool</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>cache</code>ÔºöÁºìÂ≠òÂ≠óËäÇËÆ∞ÂΩïÔºåÁî®‰∫éÂ≠òÂÇ®Á£ÅÁõòÂùóÁöÑÂÜÖÂÆπ„ÄÇ</li>
<li><code>block_id</code>Ôºå<code>block_device</code>ÔºöÂùóËÆæÂ§á‰ª•ÂèäÂùóÂú∞ÂùÄÔºåÁî®‰∫éÊ†áËØÜÁºìÂ≠òÁöÑÁ£ÅÁõòÂùó„ÄÇ</li>
<li><code>modified</code>ÔºöËÑèÊ†áËÆ∞ÔºåÈááÁî®ÊáíÊõ¥Êñ∞ÊñπÂºèÂà∑ÂÖ•Á£ÅÁõò„ÄÇÂ¶ÇÊûúËØ•Ê†áËÆ∞‰∏∫ <code>true</code>ÔºåË°®Á§∫ÁºìÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆÂ∑≤ÁªèË¢´‰øÆÊîπÔºåÈúÄË¶ÅÂú®ÈÄÇÂΩìÁöÑÊó∂ÂÄôÂ∞ÜÂÖ∂ÂÜôÂõûÁ£ÅÁõò„ÄÇ</li>
</ul>
<p>Êèê‰æõ‰∫ÜÂü∫Êú¨ÁöÑËØªÂÜôÂíåÂêåÊ≠•Âà∑ÁõòÊñπÊ≥ï„ÄÇÂèØÈÄöËøá<code>get_block_cache</code>ÂèñÂæóÔºåÈÄöËøá‰º†ÈÄí‰∏Ä‰∏™Èó≠ÂåÖÂÆûÁé∞ÂØπÂ∫îÁöÑÊñπÊ≥ïÂíåËÆøÈóÆÂäüËÉΩ„ÄÇÂùóÁºìÂ≠òÁöÑËØªÂÜôÊìç‰Ωú‰ºöÂÖàÂú®ÁºìÂ≠ò‰∏≠Êü•ÊâæÔºåÂ¶ÇÊûúÁºìÂ≠ò‰∏≠Â≠òÂú®ÊâÄÈúÄÁöÑÊï∞ÊçÆÔºåÂàôÁõ¥Êé•‰ªéÁºìÂ≠ò‰∏≠ËØªÂèñÔºõÂ¶ÇÊûúÁºìÂ≠ò‰∏≠‰∏çÂ≠òÂú®ÔºåÂàô‰ªéÁ£ÅÁõò‰∏≠ËØªÂèñÂπ∂Êõ¥Êñ∞ÁºìÂ≠ò„ÄÇÂêåÊ≠•Âà∑ÁõòÊñπÊ≥ï‰ºöÂ∞ÜÁºìÂ≠ò‰∏≠Ë¢´‰øÆÊîπÁöÑÊï∞ÊçÆÂÜôÂõûÁ£ÅÁõò„ÄÇ</p>
<p><strong>ÂùóÁºìÂ≠òÁÆ°ÁêÜ</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">const</span> BLOCK_CACHE_SIZE: <span class="hljs-type">usize</span> = <span class="hljs-number">16</span>;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">BlockCacheManager</span> &#123;<br>    queue: VecDeque&lt;(<span class="hljs-type">usize</span>, Arc&lt;Mutex&lt;BlockCache&gt;&gt;)&gt;,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>‰∏Ä‰∏™ÁÆÄÂçïÁöÑÁºìÂ≠òÁÆ°ÁêÜÁªìÊûÑÔºåÂÆûÁé∞‰∫Ü LRUÂá∫ÂÖ•ÈòüÂíåËØªÂÜô„ÄÅÂêåÊ≠•ÊñπÊ≥ï„ÄÇËØ•ÁÆ°ÁêÜÂô®‰ΩøÁî®‰∏Ä‰∏™ÂèåÁ´ØÈòüÂàóÊù•Áª¥Êä§ÁºìÂ≠òÂùóÁöÑËÆøÈóÆÈ°∫Â∫èÔºåÊúÄËøëËÆøÈóÆÁöÑÁºìÂ≠òÂùó‰ºöË¢´ÁßªÂä®Âà∞ÈòüÂàóÁöÑÂ§¥ÈÉ®ÔºåÂΩìÁºìÂ≠òÊª°Êó∂Ôºå‰ºöÂ∞ÜÈòüÂàóÂ∞æÈÉ®ÁöÑÁºìÂ≠òÂùóÊ∑òÊ±∞„ÄÇ</p>
<h3 id="EasyFS"><a href="#EasyFS" class="headerlink" title="EasyFS"></a>EasyFS</h3><h4 id="Ê¶ÇËø∞"><a href="#Ê¶ÇËø∞" class="headerlink" title="Ê¶ÇËø∞"></a>Ê¶ÇËø∞</h4><img src="C:\Users\Kid_A\AppData\Roaming\Typora\typora-user-images\image-20250328175205292.png" srcset="/img/loading.gif" lazyload alt="image-20250328175205292" style="zoom:50%;" />

<p>Âü∫Êú¨ÁªìÊûÑÂ¶ÇÂõæÊâÄÁ§∫</p>
<h4 id="Ë∂ÖÁ∫ßÂùó"><a href="#Ë∂ÖÁ∫ßÂùó" class="headerlink" title="Ë∂ÖÁ∫ßÂùó"></a>Ë∂ÖÁ∫ßÂùó</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SuperBlock</span> &#123;<br>    magic: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> total_blocks: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> inode_bitmap_blocks: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> inode_area_blocks: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> data_bitmap_blocks: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> data_area_blocks: <span class="hljs-type">u32</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>magic</code>ÔºöÊñá‰ª∂Á≥ªÁªüÊ£ÄÊü•ÁöÑÈ≠îÊï∞ÔºåÁî®‰∫éÊ†áËØÜÊñá‰ª∂Á≥ªÁªüÁöÑÁ±ªÂûã„ÄÇ</li>
<li><code>total_blocks</code>ÔºöÊñá‰ª∂Á≥ªÁªüÁöÑÊÄªÂùóÊï∞ÔºåÂç≥Á£ÅÁõò‰∏äÂèØÁî®ÁöÑÊÄªÂùóÊï∞„ÄÇ</li>
<li><code>****_blocks</code>ÔºöÁªôÂá∫‰∫ÜÂêÑ‰∏™Âå∫ÂüüÁöÑÂùóÊï∞ÔºåÂåÖÊã¨ inode ‰ΩçÂõæÂùóÊï∞„ÄÅinode Âå∫ÂüüÂùóÊï∞„ÄÅÊï∞ÊçÆ‰ΩçÂõæÂùóÊï∞ÂíåÊï∞ÊçÆÂå∫ÂüüÂùóÊï∞„ÄÇ</li>
</ul>
<p>Ë∂ÖÁ∫ßÂùóÂÆûÁé∞‰∫Ü<code>debug</code>ÊñπÊ≥ïÔºåÂç≥Ê£ÄÊü•ÂêÑÈÉ®ÂàÜÂùóÊï∞Ôºå‰ª•ÂèäÊñá‰ª∂Á≥ªÁªüÁöÑÊ£ÄÊü•ÔºåÂà§ÂÆöÊòØÂê¶‰∏∫EFS</p>
<h4 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">const</span> BLOCK_BITS: <span class="hljs-type">usize</span> = BLOCK_SZ * <span class="hljs-number">8</span>;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Bitmap</span> &#123;<br>    start_block_id: <span class="hljs-type">usize</span>,<br>    blocks: <span class="hljs-type">usize</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>start_block_id</code>ÔºöÂΩìÂâç bitmap Ëµ∑Âßã‰ΩçÁΩÆÔºåÂç≥‰ΩçÂõæÊâÄÁÆ°ÁêÜÁöÑÁ¨¨‰∏Ä‰∏™Á£ÅÁõòÂùóÁöÑÁºñÂè∑„ÄÇ</li>
<li><code>blocks</code>Ôºöbitmap ÁÆ°ÁêÜ‰∫ÜÂ§öÂ∞ëÂùóÔºåÂç≥‰ΩçÂõæÊâÄÁÆ°ÁêÜÁöÑÁ£ÅÁõòÂùóÁöÑÊï∞Èáè„ÄÇ</li>
</ul>
<p>bitmap ÂÆûÁé∞‰∫ÜÂü∫Êú¨ÁöÑÂàÜÈÖçÂäüËÉΩÔºåÂåÖÊã¨ÂàÜÈÖçÂíåÈáäÊîæÂùóÊó∂‰ΩçÂõæÁöÑÊîπÂèò„ÄÇËøôÈáåÈÄöËøáÁÆÄÂçïÁöÑÁ∫øÊÄßÈÅçÂéÜËøõË°åÁ©∫ÂùóÂà§Êñ≠„ÄÇÂΩìÈúÄË¶ÅÂàÜÈÖç‰∏Ä‰∏™Á£ÅÁõòÂùóÊó∂Ôºå‰ΩçÂõæ‰ºö‰ªéËµ∑Âßã‰ΩçÁΩÆÂºÄÂßãÁ∫øÊÄßÈÅçÂéÜÔºåÊâæÂà∞Á¨¨‰∏Ä‰∏™Êú™Ë¢´‰ΩøÁî®ÁöÑÂùóÔºåÂπ∂Â∞ÜÂÖ∂Ê†áËÆ∞‰∏∫Â∑≤‰ΩøÁî®ÔºõÂΩìÈúÄË¶ÅÈáäÊîæ‰∏Ä‰∏™Á£ÅÁõòÂùóÊó∂Ôºå‰ΩçÂõæ‰ºöÂ∞ÜËØ•ÂùóÊ†áËÆ∞‰∏∫Êú™‰ΩøÁî®„ÄÇ</p>
<h4 id="DiskInode"><a href="#DiskInode" class="headerlink" title="DiskInode"></a>DiskInode</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">const</span> INODE_DIRECT_COUNT: <span class="hljs-type">usize</span> = <span class="hljs-number">27</span>;<br><span class="hljs-keyword">const</span> INODE_INDIRECT1_COUNT: <span class="hljs-type">usize</span> = BLOCK_SZ / <span class="hljs-number">4</span>;<br><span class="hljs-keyword">const</span> INODE_INDIRECT2_COUNT: <span class="hljs-type">usize</span> = INODE_INDIRECT1_COUNT * INODE_INDIRECT1_COUNT;<br><span class="hljs-keyword">const</span> INODE_INDIRECT3_COUNT: <span class="hljs-type">usize</span> = INODE_INDIRECT2_COUNT * INODE_INDIRECT1_COUNT;<br><span class="hljs-keyword">const</span> DIRECT_BOUND: <span class="hljs-type">usize</span> = INODE_DIRECT_COUNT;<br><span class="hljs-keyword">const</span> INDIRECT1_BOUND: <span class="hljs-type">usize</span> = DIRECT_BOUND + INODE_INDIRECT1_COUNT;<br><span class="hljs-keyword">const</span> INDIRECT2_BOUND: <span class="hljs-type">usize</span> = INDIRECT1_BOUND + INODE_INDIRECT2_COUNT;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DiskInodeType</span> &#123;<br>    File,<br>    Directory,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">DiskInode</span> &#123;<br>    <span class="hljs-keyword">pub</span> size: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> direct: [<span class="hljs-type">u32</span>; INODE_DIRECT_COUNT],<br>    <span class="hljs-keyword">pub</span> indirect1: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> indirect2: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> indirect3: <span class="hljs-type">u32</span>,<br>    type_: DiskInodeType,<br>    <span class="hljs-keyword">pub</span> nlink: <span class="hljs-type">u32</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>size</code>ÔºöÂΩìÂâçÂç†ÊçÆÁöÑÂùóÂ§ßÂ∞èÔºåÂç≥Êñá‰ª∂ÊàñÁõÆÂΩïÊâÄÂç†Áî®ÁöÑÁ£ÅÁõòÂùóÊï∞„ÄÇ</li>
<li><code>direct...</code>ÔºöÁõ¥Êé•Á¥¢ÂºïÂíå‰∏âÁ∫ßÈó¥Êé•Á¥¢ÂºïÔºåÁî®‰∫éÁÆ°ÁêÜÊñá‰ª∂ÊàñÁõÆÂΩïÁöÑÊï∞ÊçÆÂùó„ÄÇÁõ¥Êé•Á¥¢ÂºïÂèØ‰ª•Áõ¥Êé•ÊåáÂêëÊï∞ÊçÆÂùóÔºåËÄåÈó¥Êé•Á¥¢ÂºïÂàôÈÄöËøáÁ¥¢ÂºïÂùóÊù•ÊåáÂêëÊï∞ÊçÆÂùó„ÄÇ</li>
<li><code>type_</code>ÔºöÁ¥¢ÂºïËäÇÁÇπÁ±ªÂûãÔºåÂàÜ‰∏∫Êñá‰ª∂ÂíåÁõÆÂΩï‰∏§ÁßçÁ±ªÂûã„ÄÇ</li>
<li><code>nlink</code>ÔºöÁ°¨ÈìæÊé•Êï∞ÈáèÔºåÂç≥ÊåáÂêëËØ•Á¥¢ÂºïËäÇÁÇπÁöÑÁ°¨ÈìæÊé•ÁöÑÊï∞Èáè„ÄÇ</li>
</ul>
<p><strong>DiskInode</strong>ÊòØÁ£ÅÁõò‰∏äÊñá‰ª∂ÔºàFile or DirectoryÔºâÂ≠òÂÇ®ÁöÑÂü∫Êú¨ÂΩ¢Âºè„ÄÇÈÄöËøáÁõ¥Êé•+Èó¥Êé•Á¥¢ÂºïÁöÑÂΩ¢ÂºèÁÆ°ÁêÜÊñá‰ª∂Êï∞ÊçÆ„ÄÇÂú®ÂùóËé∑ÂèñÔºåÁ©∫Èó¥ÁÆ°ÁêÜÊñπÈù¢Ê†πÊçÆÁ¥¢ÂºïÂÆûÁé∞„ÄÇÊúâÂ¶Ç‰∏ãÈáçË¶ÅÊñπÊ≥ïÔºö</p>
<ul>
<li><code>is_file</code> Âíå <code>is_dir</code>ÔºöÁ±ªÂûãÂà§Êñ≠</li>
<li><code>increase_size</code>Âíå<code>build_tree</code>ÔºöDiskInodeÁ©∫Èó¥Â¢ûÈïøÂíåËæÖÂä©ÂáΩÊï∞„ÄÇ‰∏ªË¶ÅÊòØÂ§öÁ∫ßÁ¥¢ÂºïÁöÑÈÄíÂΩíÂàÜÈÖç</li>
<li><code>clear_size</code>Âíå<code>collect_tree_blocks</code>ÔºöÈáäÊîæDiskInodeÁöÑÊñπÊ≥ïÂíåÂØπÂ∫îÁöÑÂ§öÁ∫ßÁ¥¢ÂºïÈÄíÂΩíÈáäÊîæ</li>
<li><code>read_at</code>Âíå<code>write_at</code>Âíå<code>get_block_id</code>ÔºöËØªÂÜôÊñπÊ≥ïÂíåÂ§öÁ∫ßÁ¥¢ÂºïËé∑ÂèñÂùóIDÊñπÊ≥ï</li>
</ul>
<h4 id="DitEntryÔºàDEntryÔºâ"><a href="#DitEntryÔºàDEntryÔºâ" class="headerlink" title="DitEntryÔºàDEntryÔºâ"></a>DitEntryÔºàDEntryÔºâ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">DirEntry</span> &#123;<br>    name: [<span class="hljs-type">u8</span>; NAME_LENGTH_LIMIT + <span class="hljs-number">1</span>],<br>    inode_number: <span class="hljs-type">u32</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>name</code>ÔºöInode NameÔºåÂç≥Êñá‰ª∂ÊàñÁõÆÂΩïÁöÑÂêçÁß∞„ÄÇ</li>
<li><code>inode_number</code>Ôºöinode ÂîØ‰∏ÄÊ†áËØÜÔºåÁî®‰∫éÂîØ‰∏ÄÊ†áËØÜ‰∏Ä‰∏™Á¥¢ÂºïËäÇÁÇπ„ÄÇ</li>
</ul>
<p>DirEntry ÊòØ Inode Âú® DiskInode ‰∏≠Â≠òÂÇ®ÁöÑÂü∫Êú¨Âçï‰Ωç„ÄÇÂõ∫ÂÆö‰∏∫ 32B ‰æø‰∫éÁÆ°ÁêÜ„ÄÇÂÆûÁé∞‰∫ÜÁÆÄÂçïÁöÑÂèñÂÄºÊñπÊ≥ï„ÄÇ‰∏ªË¶ÅËÅåËÉΩÊòØ‰ªé inode block ÊåáÂêë data block„ÄÇÈÄöËøáÁõÆÂΩïÈ°πÔºåÂèØ‰ª•Â∞ÜÁõÆÂΩïÂíåÊñá‰ª∂ÂÖ≥ËÅîËµ∑Êù•ÔºåÂÆûÁé∞Êñá‰ª∂Á≥ªÁªüÁöÑÁõÆÂΩïÁªìÊûÑ„ÄÇ</p>
<h4 id="EFSÁÆ°ÁêÜÂô®"><a href="#EFSÁÆ°ÁêÜÂô®" class="headerlink" title="EFSÁÆ°ÁêÜÂô®"></a>EFSÁÆ°ÁêÜÂô®</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">EasyFileSystem</span> &#123;<br>    <span class="hljs-keyword">pub</span> block_device: Arc&lt;<span class="hljs-keyword">dyn</span> BlockDevice&gt;,<br>    <span class="hljs-keyword">pub</span> inode_bitmap: Bitmap,<br>    <span class="hljs-keyword">pub</span> data_bitmap: Bitmap,<br>    inode_area_start_block: <span class="hljs-type">u32</span>,<br>    data_area_start_block: <span class="hljs-type">u32</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>block_device</code>ÔºöÁÆ°ÁêÜÂùóÁöÑÂùóËÆæÂ§áÔºåÁî®‰∫éËØªÂÜôÁ£ÅÁõòÂùó„ÄÇ</li>
<li><code>inode_bitmap</code>ÔºöÁÆ°ÁêÜ inode ÂàÜÈÖçÁöÑ bitmapÔºåÁî®‰∫éËÆ∞ÂΩï inode ÁöÑ‰ΩøÁî®ÊÉÖÂÜµ„ÄÇ</li>
<li><code>data_bitmap</code>ÔºöÁÆ°ÁêÜÊï∞ÊçÆÂùóÂàÜÈÖçÁöÑ bitmapÔºåÁî®‰∫éËÆ∞ÂΩïÊï∞ÊçÆÂùóÁöÑ‰ΩøÁî®ÊÉÖÂÜµ„ÄÇ</li>
<li><code>inode_area_start_block</code>Ôºöinode Âå∫ÂüüÁöÑËµ∑ÂßãÂùóÁºñÂè∑„ÄÇ</li>
<li><code>data_area_start_block</code>ÔºöÊï∞ÊçÆÂå∫ÂüüÁöÑËµ∑ÂßãÂùóÁºñÂè∑„ÄÇ</li>
</ul>
<p>EFS ‰Ωú‰∏∫Êï¥‰ΩìÁöÑÊñá‰ª∂Á≥ªÁªüÔºåÂØπÊé•ÁöÑÊòØÁ£ÅÁõòÁÆ°ÁêÜÂíå VFSÔºå‰∏∫‰ªñ‰ª¨Êèê‰æõÊé•Âè£„ÄÇÂÆûÁé∞ÊñπÊ≥ïÔºö</p>
<ul>
<li><code>create</code>ÔºöÂú®ÂùóËÆæÂ§á‰∏äÂàõÂª∫ EFSÔºåÂàùÂßãÂåñÊñá‰ª∂Á≥ªÁªüÁöÑË∂ÖÁ∫ßÂùó„ÄÅ‰ΩçÂõæÂíåÁ¥¢ÂºïËäÇÁÇπÁ≠â„ÄÇ</li>
<li><code>open</code>ÔºöÊâìÂºÄÂùóËÆæÂ§áÔºåËØªÂèñÊñá‰ª∂Á≥ªÁªüÁöÑË∂ÖÁ∫ßÂùóÂíå‰ΩçÂõæÁ≠â‰ø°ÊÅØÔºåÈ™åËØÅÊñá‰ª∂Á≥ªÁªüÁöÑÂÆåÊï¥ÊÄß„ÄÇ</li>
<li><code>root_inode</code>ÔºöËé∑ÂèñÊ†πËäÇÁÇπÔºåËøîÂõûÊñá‰ª∂Á≥ªÁªüÁöÑÊ†πÁ¥¢ÂºïËäÇÁÇπ„ÄÇ</li>
<li><code>alloc_data</code>Âíå<code>dealloc_data</code>ÔºöÂØπÊé• bitmap ÁöÑÊé•Âè£ÔºåÁî®‰∫éÂàÜÈÖçÂíåÈáäÊîæÊï∞ÊçÆÂùó„ÄÇ</li>
</ul>
<h4 id="easy-fs-fuse"><a href="#easy-fs-fuse" class="headerlink" title="easy-fs-fuse"></a>easy-fs-fuse</h4><p>‰ΩúÁî®ÊòØËÉΩÊää user&#x2F;src&#x2F;bin&#x2F; ÂÜÖÁöÑÊâÄÊúâÁ®ãÂ∫è‰∫åËøõÂà∂Ê†ºÂºèÊâìÂåÖÔºåÂä†ËΩΩÂà∞È¢ÑÂÖàÂáÜÂ§áÂ•ΩÁöÑ fs.img ‰∏≠„ÄÇËøôÊ†∑Â∞±‰∏çÈúÄË¶Å‰∏Ä‰∏™‰∏™ÈìæÊé•ËøõÂéª‰∫Ü„ÄÇ<code>easy-fs-fuse</code> ÊòØ‰∏Ä‰∏™Áî®Êà∑Á©∫Èó¥ÁöÑÊñá‰ª∂Á≥ªÁªüÔºåÂÆÉÂèØ‰ª•Â∞Ü user&#x2F;src&#x2F;bin&#x2F; ÁõÆÂΩï‰∏ãÁöÑÊâÄÊúâÁ®ãÂ∫è‰∫åËøõÂà∂Ê†ºÂºèÊâìÂåÖÔºåÂπ∂Âä†ËΩΩÂà∞È¢ÑÂÖàÂáÜÂ§áÂ•ΩÁöÑ fs.img ‰∏≠„ÄÇËøôÊ†∑ÔºåÂú®ÂêØÂä® Qemu Êó∂ÔºåÊìç‰ΩúÁ≥ªÁªüÂèØ‰ª•Áõ¥Êé•‰ªé fs.img ‰∏≠ËØªÂèñËøô‰∫õÁ®ãÂ∫èÔºåÂπ∂Âä†ËΩΩÂà∞ÂÜÖÂ≠ò‰∏≠ÊâßË°å„ÄÇ</p>
<h3 id="VFS"><a href="#VFS" class="headerlink" title="VFS"></a>VFS</h3><h4 id="Ê¶ÇËø∞-1"><a href="#Ê¶ÇËø∞-1" class="headerlink" title="Ê¶ÇËø∞"></a>Ê¶ÇËø∞</h4><p>ËøûÊé• EFS Âíå OS ÂÜÖÊ†∏ÁöÑÊäΩË±°Â±ÇÔºå‰∏∫‰ªñ‰ª¨Êèê‰æõÊé•Âè£ÔºåÂπ∂Ëá¥Âäõ‰∫éÂÆûÁé∞ÈÄèÊòéÂåñ„ÄÇVFSÊòØ‰∏Ä‰∏™ËôöÊãüÊñá‰ª∂Á≥ªÁªüÂ±ÇÔºåÂÆÉÊèê‰æõ‰∫Ü‰∏Ä‰∏™Áªü‰∏ÄÁöÑÊé•Âè£Ôºå‰ΩøÂæóÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÂèØ‰ª•ÈÄöËøáÁõ∏ÂêåÁöÑÊñπÂºèËÆøÈóÆ‰∏çÂêåÁ±ªÂûãÁöÑÊñá‰ª∂Á≥ªÁªü„ÄÇÂú® PotatOS ‰∏≠ÔºåVFS Â±ÇÂ∞Ü EasyFS ÂíåÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ËøûÊé•Ëµ∑Êù•Ôºå‰∏∫ÂÜÖÊ†∏Êèê‰æõ‰∫ÜÁªü‰∏ÄÁöÑÊñá‰ª∂ËÆøÈóÆÊé•Âè£Ôºå‰ΩøÂæóÂÜÖÊ†∏ÂèØ‰ª•Êñπ‰æøÂú∞Êìç‰Ωú EasyFS Êñá‰ª∂Á≥ªÁªü„ÄÇ</p>
<h4 id="Inode"><a href="#Inode" class="headerlink" title="Inode"></a>Inode</h4><p>VFSÂ±Ç‰∏ªË¶ÅÂ∞±ÊòØ‰∏∫Êìç‰ΩúInodeÊèê‰æõÊé•Âè£</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Inode</span> &#123;<br>    name: <span class="hljs-type">String</span>,<br>    block_id: <span class="hljs-type">usize</span>,<br>    block_offset: <span class="hljs-type">usize</span>,<br>    fs: Arc&lt;Mutex&lt;EasyFileSystem&gt;&gt;,<br>    block_device: Arc&lt;<span class="hljs-keyword">dyn</span> BlockDevice&gt;,<br>    inode_id: <span class="hljs-type">u32</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>name</code>ÔºöÊñá‰ª∂ÂêçÔºåÂç≥Êñá‰ª∂ÊàñÁõÆÂΩïÁöÑÂêçÁß∞„ÄÇ</li>
<li><code>block_id</code>Ôºå<code>block_offset</code>ÔºöInode Âú®Âì™‰∏™ÂùóÔºåÂùóÂÜÖÂÅèÁßª„ÄÇÂèØÁî®‰∫éÂÆö‰ΩçÔºåÈÄöËøáÂùóÁºñÂè∑ÂíåÂùóÂÜÖÂÅèÁßªÔºåÂèØ‰ª•ÂáÜÁ°ÆÂú∞ÊâæÂà∞ Inode Âú®Á£ÅÁõò‰∏äÁöÑ‰ΩçÁΩÆ„ÄÇ</li>
<li><code>fs</code>Ôºå<code>block_device</code>ÔºöÂΩìÂâçÊñá‰ª∂Á≥ªÁªüÂíåÂùóËÆæÂ§áÔºåÁî®‰∫éËÆøÈóÆÊñá‰ª∂Á≥ªÁªüÂíåÁ£ÅÁõòÂùó„ÄÇ</li>
<li><code>inode_id</code>Ôºöinode Ê†áËØÜÔºåÁî®‰∫éÂîØ‰∏ÄÊ†áËØÜ‰∏Ä‰∏™Á¥¢ÂºïËäÇÁÇπ„ÄÇ</li>
</ul>
<p>Inode ÈÉ®ÂàÜ‰∏∫ OS ÂÆûÁé∞‰∫ÜÊìç‰ΩúÂùóÁöÑÊé•Âè£„ÄÇÂèØ‰ª•ÁÆÄÂçïÊää Inode Áúã‰ΩúÊñá‰ª∂ &#x2F; ÁõÆÂΩï„ÄÇ</p>
<ul>
<li><code>read_disk_inode</code>Âíå<code>modify_disk_inode</code>ÔºöÊìç‰Ωú DiskInodeÔºåÁî®‰∫éËØªÂèñÂíå‰øÆÊîπÁ£ÅÁõò‰∏äÁöÑÁ¥¢ÂºïËäÇÁÇπ‰ø°ÊÅØ„ÄÇ</li>
<li><code>increase_size</code>Ôºö‰∏Ä‰∫õÊìç‰Ωú DiskInode ÁöÑÊé•Âè£ÔºåÁî®‰∫éÊâ©Â±ïÊñá‰ª∂ÊàñÁõÆÂΩïÁöÑÁ©∫Èó¥„ÄÇ</li>
<li><code>create_file</code>Âíå<code>create_dir</code>ÔºöÂàõÂª∫Êñá‰ª∂ &#x2F; ÁõÆÂΩïÔºåÁî®‰∫éÂú®Êñá‰ª∂Á≥ªÁªü‰∏≠ÂàõÂª∫Êñ∞ÁöÑÊñá‰ª∂ÊàñÁõÆÂΩï„ÄÇ</li>
<li><code>linkat</code>Âíå<code>unlinkat</code>ÔºöËøõË°åÁ°¨ÈìæÊé•Âíå‰Ωú‰∏∫Âà†Èô§ËæÖÂä©ÂáΩÊï∞ÔºåÁî®‰∫éÂàõÂª∫ÂíåÂà†Èô§Á°¨ÈìæÊé•„ÄÇ</li>
<li>‰∏Ä‰∫õËÆøÈóÆÁªìÊûÑÁöÑÂáΩÊï∞ÔºåÁî®‰∫éËé∑Âèñ Inode ÁöÑÁõ∏ÂÖ≥‰ø°ÊÅØ„ÄÇ</li>
</ul>
<h3 id="File-Trait-File-System"><a href="#File-Trait-File-System" class="headerlink" title="File Trait &amp; File System"></a>File Trait &amp; File System</h3><h4 id="File"><a href="#File" class="headerlink" title="File"></a>File</h4><ul>
<li><code>write</code>Âíå<code>read</code>ÔºöËØªÂÜôÊñá‰ª∂</li>
<li><code>stat</code>ÔºöÊñá‰ª∂Áä∂ÊÄÅÔºåÂåÖÊã¨ËÆæÂ§áÂè∑„ÄÅinode_id„ÄÅÊñá‰ª∂Á±ªÂûã„ÄÅÁ°¨ËøûÊé•Êï∞Âíåpadding</li>
</ul>
<h4 id="File-System"><a href="#File-System" class="headerlink" title="File System"></a>File System</h4><p>Á≥ªÁªüË∞ÉÁî®Ôºö</p>
<ul>
<li><p><code>sys_write</code>Ôºå<code>sys_read</code>Ôºå<code>sys_open</code>Ôºå<code>sys_close</code>ÔºöËØªÂÜôÔºåÊâìÂºÄÂÖ≥Èó≠Êñá‰ª∂</p>
</li>
<li><p><code>sys_getcwd</code>Ôºå<code>sys_fstat</code>ÔºöËé∑Âèñcurrent work directoryÔºåËé∑Âèñfstat</p>
</li>
<li><p><code>sys_mkdir</code>Ôºå<code>sys_remove</code>Ôºå<code>remove_dir</code>ÔºöÁõÆÂΩïÂàõÂª∫ÂíåÂà†Èô§ÁöÑÊñπÊ≥ï‰ª•ÂèäËæÖÂä©ÂáΩÊï∞</p>
</li>
</ul>
<h2 id="IOËÆæÂ§áÁÆ°ÁêÜ"><a href="#IOËÆæÂ§áÁÆ°ÁêÜ" class="headerlink" title="IOËÆæÂ§áÁÆ°ÁêÜ"></a>IOËÆæÂ§áÁÆ°ÁêÜ</h2><p>‰∏Ä‰∏™ËÆæÂ§áÈúÄË¶ÅËÆæÂ§áÈ©±Âä®ËøõË°åÁÆ°ÁêÜ„ÄÇËÄå‰∏Ä‰∏™ËÆæÂ§áÈ©±Âä®ÈúÄË¶Å‰ª•‰∏ãÁöÑÂäüËÉΩÔºö</p>
<ol>
<li><strong>ËÆæÂ§áÁöÑÊâ´Êèè &#x2F; ÂèëÁé∞</strong>ÔºöÊ£ÄÊµãÁ≥ªÁªü‰∏≠Â≠òÂú®ÁöÑËÆæÂ§áÔºåÂπ∂ËØÜÂà´ÂÖ∂Á±ªÂûãÂíåÁâπÊÄß„ÄÇ</li>
<li><strong>ËÆæÂ§áÂàùÂßãÂåñ</strong>ÔºöÂØπËÆæÂ§áËøõË°åÂàùÂßãÂåñÔºåÈÖçÁΩÆËÆæÂ§áÁöÑÂØÑÂ≠òÂô®ÂíåÂèÇÊï∞Ôºå‰ΩøÂÖ∂Â§Ñ‰∫éÂèØÁî®Áä∂ÊÄÅ„ÄÇ</li>
<li><strong>ÂáÜÂ§áÂèëÈÄÅÁªôËÆæÂ§áÁöÑÂëΩ‰ª§</strong>ÔºöÊ†πÊçÆÁî®Êà∑ÁöÑËØ∑Ê±ÇÔºåÁîüÊàêÁõ∏Â∫îÁöÑÂëΩ‰ª§ÔºåÂπ∂ÂáÜÂ§áÂèëÈÄÅÁªôËÆæÂ§á„ÄÇ</li>
<li><strong>ÈÄöÁü•ËÆæÂ§á</strong>ÔºöÂ∞ÜÂáÜÂ§áÂ•ΩÁöÑÂëΩ‰ª§ÂèëÈÄÅÁªôËÆæÂ§áÔºåËß¶ÂèëËÆæÂ§áÁöÑÊìç‰Ωú„ÄÇ</li>
<li><strong>Êé•ÂèóËÆæÂ§áÈÄöÁü•</strong>ÔºöÊé•Êî∂ËÆæÂ§áÁöÑÂìçÂ∫îÂíåÈÄöÁü•ÔºåÂ§ÑÁêÜËÆæÂ§áÁöÑ‰∏≠Êñ≠ÂíåÁä∂ÊÄÅÂèòÂåñ„ÄÇ</li>
<li><strong>Âç∏ËΩΩËÆæÂ§áÁöÑÂêåÊó∂ÂõûÊî∂ËÆæÂ§áËµÑÊ∫ê</strong>ÔºöÂΩìËÆæÂ§á‰∏çÂÜç‰ΩøÁî®Êó∂ÔºåÂç∏ËΩΩËÆæÂ§áÈ©±Âä®ÔºåÂπ∂ÂõûÊî∂ËÆæÂ§áÊâÄÂç†Áî®ÁöÑËµÑÊ∫ê„ÄÇ</li>
</ol>
<p>ËøôÈáå‰∏ªË¶ÅÂÆûÁé∞‰∫Ü‰∏§ÁßçËÆæÂ§áÔºö</p>
<ul>
<li><strong>ÁúüÂÆûÁöÑÁâ©ÁêÜËÆæÂ§á</strong>ÔºöÂ¶Ç<code>URAT</code>ÔºåÁî®‰∫éÂÆûÁé∞Â≠óÁ¨¶ËæìÂÖ•ÂíåËæìÂá∫„ÄÇ</li>
<li><strong>ËôöÊãüËÆæÂ§á</strong>ÔºöÂ¶ÇÂêÑÁßç<code>Virtio</code>ËÆæÂ§áÔºåÁî®‰∫éÊ®°ÊãüÁ°¨‰ª∂ËÆæÂ§áÁöÑÂäüËÉΩÔºåÊèêÈ´òÁ≥ªÁªüÁöÑÂèØÁßªÊ§çÊÄßÂíåÂÖºÂÆπÊÄß„ÄÇ</li>
</ul>
<p><strong>qemuÁâπÂåñ</strong></p>
<p>Êú¨È°πÁõÆÂú® qemu Ê®°ÊãüÂô®‰∏äËøêË°åÔºåÂõ†Ê≠§Ë¶ÅÂü∫‰∫é qemu ËøõË°åËÆæÂ§áÁÆ°ÁêÜÁöÑÁâπÂåñ„ÄÇ</p>
<p>Âú® qemu ÈáåÔºåIO ËÆæÂ§áÁöÑ‰∫§‰∫í‰ª•‰∏≠Êñ≠‰∏∫‰∏ªÔºåËΩÆËØ¢‰∏∫ËæÖ„ÄÇÈÄöËøá<code>PLIC Âπ≥Âè∞Á∫ß‰∏≠Êñ≠ÊéßÂà∂Âô®</code>ËøõË°å„ÄÇ</p>
<p><strong>Á°ÆÂÆöËÆæÂ§áÂÜÖÂ≠òÊò†Â∞Ñ</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">const</span> MMIO: &amp;[(<span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>)] = &amp;[<br>    (<span class="hljs-number">0x0010_0000</span>, <span class="hljs-number">0x00_2000</span>), <span class="hljs-comment">// VIRT_TEST/RTC  in virt machine</span><br>    (<span class="hljs-number">0x2000000</span>, <span class="hljs-number">0x10000</span>),<br>    (<span class="hljs-number">0xc000000</span>, <span class="hljs-number">0x210000</span>), <span class="hljs-comment">// VIRT_PLIC in virt machine</span><br>    (<span class="hljs-number">0x10000000</span>, <span class="hljs-number">0x9000</span>),  <span class="hljs-comment">// VIRT_UART0 with GPU  in virt machine</span><br>];<br></code></pre></td></tr></table></figure>

<p><code>MMIO</code>Á°ÆÂÆö‰∫ÜÂêÑ‰∏™ËÆæÂ§áÂú®qemuÈáåÁöÑÂú∞ÂùÄ„ÄÇÈÄöËøáËøô‰∫õÂú∞ÂùÄÊìç‰ΩúÁ≥ªÁªüÂèØ‰ª•Áõ¥Êé•ËØªÂÜôËÆæÂ§áÂØÑÂ≠òÂô®ËøõË°å‰∫§‰∫í</p>
<p><strong>ËÆæÂ§áÂàùÂßãÂåñ</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">device_init</span>() &#123;<br>    <span class="hljs-keyword">use</span> riscv::register::sie;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">plic</span> = <span class="hljs-keyword">unsafe</span> &#123; PLIC::<span class="hljs-title function_ invoke__">new</span>(VIRT_PLIC) &#125;;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">hart_id</span>: <span class="hljs-type">usize</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">supervisor</span> = IntrTargetPriority::Supervisor;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">machine</span> = IntrTargetPriority::Machine;<br>    plic.<span class="hljs-title function_ invoke__">set_threshold</span>(hart_id, supervisor, <span class="hljs-number">0</span>);<br>    plic.<span class="hljs-title function_ invoke__">set_threshold</span>(hart_id, machine, <span class="hljs-number">1</span>);<br>    <span class="hljs-comment">//irq nums: 5 keyboard, 6 mouse, 8 block, 10 uart</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">intr_src_id</span> <span class="hljs-keyword">in</span> [<span class="hljs-number">5usize</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>] &#123;<br>        plic.<span class="hljs-title function_ invoke__">enable</span>(hart_id, supervisor, intr_src_id);<br>        plic.<span class="hljs-title function_ invoke__">set_priority</span>(intr_src_id, <span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        sie::<span class="hljs-title function_ invoke__">set_sext</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ËÆæÂ§áÂàùÂßãÂåñÔºå‰πüÊòØ‰∏≠Êñ≠ÂàùÂßãÂåñÔºåÁªôÊØè‰∏™ËÆæÂ§áÂêØÂä®‰∏≠Êñ≠ÂäüËÉΩ„ÄÇÂΩì‰∏≠Êñ≠ÂèëÁîüÊó∂ÂèØ‰ª•Ë∞ÉÁî®ÂØπÂ∫îËÆæÂ§áÁöÑ‰∏≠Êñ≠ÂìçÂ∫îÂáΩÊï∞„ÄÇÂú®ËÆæÂ§áÂàùÂßãÂåñËøáÁ®ã‰∏≠Ôºå‰ºöÂØπ PLICÔºàPlatform-Level Interrupt ControllerÔºâËøõË°åÈÖçÁΩÆÔºåËÆæÁΩÆ‰∏≠Êñ≠ÈòàÂÄºÂíå‰ºòÂÖàÁ∫ßÔºåÂπ∂‰ΩøËÉΩÁõ∏Â∫îÁöÑ‰∏≠Êñ≠Ê∫ê„ÄÇÂêåÊó∂Ôºå‰ºöÂºÄÂêØÂ§ñÈÉ®‰∏≠Êñ≠‰ΩøËÉΩ‰ΩçÔºåÂÖÅËÆ∏Á≥ªÁªüÊé•Êî∂Â§ñÈÉ®ËÆæÂ§áÁöÑ‰∏≠Êñ≠ËØ∑Ê±Ç„ÄÇ</p>
<h4 id="‰∏≠Êñ≠Â§ÑÁêÜ"><a href="#‰∏≠Êñ≠Â§ÑÁêÜ" class="headerlink" title="‰∏≠Êñ≠Â§ÑÁêÜ"></a>‰∏≠Êñ≠Â§ÑÁêÜ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">irq_handler</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">plic</span> = <span class="hljs-keyword">unsafe</span> &#123; PLIC::<span class="hljs-title function_ invoke__">new</span>(VIRT_PLIC) &#125;;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">intr_src_id</span> = plic.<span class="hljs-title function_ invoke__">claim</span>(<span class="hljs-number">0</span>, IntrTargetPriority::Supervisor);<br>    <span class="hljs-keyword">match</span> intr_src_id &#123;<br>        <span class="hljs-number">5</span> =&gt; KEYBOARD_DEVICE.<span class="hljs-title function_ invoke__">handle_irq</span>(),<br>        <span class="hljs-number">6</span> =&gt; MOUSE_DEVICE.<span class="hljs-title function_ invoke__">handle_irq</span>(),<br>        <span class="hljs-number">8</span> =&gt; BLOCK_DEVICE.<span class="hljs-title function_ invoke__">handle_irq</span>(),<br>        <span class="hljs-number">10</span> =&gt; UART.<span class="hljs-title function_ invoke__">handle_irq</span>(),<br>        _ =&gt; <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;unsupported IRQ &#123;&#125;&quot;</span>, intr_src_id),<br>    &#125;<br>    plic.<span class="hljs-title function_ invoke__">complete</span>(<span class="hljs-number">0</span>, IntrTargetPriority::Supervisor, intr_src_id);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂΩìÂèëÁîü‰∏≠Êñ≠Êó∂ÔºåÊìç‰ΩúÁ≥ªÁªü‰ºöË∞ÉÁî® <code>irq_handler</code> ÂáΩÊï∞ËøõË°åÂ§ÑÁêÜ„ÄÇËØ•ÂáΩÊï∞‰ºö‰ªé PLIC ‰∏≠Ëé∑Âèñ‰∏≠Êñ≠Ê∫êÁöÑÁºñÂè∑ÔºåÂπ∂Ê†πÊçÆÁºñÂè∑Ë∞ÉÁî®Áõ∏Â∫îËÆæÂ§áÁöÑ‰∏≠Êñ≠Â§ÑÁêÜÂáΩÊï∞„ÄÇÂ§ÑÁêÜÂÆå‰∏≠Êñ≠ÂêéÔºå‰ºöÈÄöÁü• PLIC ‰∏≠Êñ≠Â§ÑÁêÜÂÆåÊàê„ÄÇ</p>
<h4 id="trap-ÂìçÂ∫î"><a href="#trap-ÂìçÂ∫î" class="headerlink" title="trap ÂìçÂ∫î"></a>trap ÂìçÂ∫î</h4><p>ÂÜôÂÖ•<code>scause</code>‰∏∫Â§ñÈÉ®‰∏≠Êñ≠ÔºåÁî±qemu‰∏≠Êñ≠Â§ÑÁêÜ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// trap/mod.rs</span><br><span class="hljs-comment">// ...</span><br>Trap::<span class="hljs-title function_ invoke__">Interrupt</span>(Interrupt::SupervisorExternal) =&gt; &#123;<br>    crate::board::<span class="hljs-title function_ invoke__">irq_handler</span>();<br>&#125;<br><span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure>

<p>ÂΩìÂèëÁîüË∂ÖÁ∫ßÁî®Êà∑Â§ñÈÉ®‰∏≠Êñ≠Êó∂ÔºåÊìç‰ΩúÁ≥ªÁªü‰ºöË∞ÉÁî® <code>irq_handler</code> ÂáΩÊï∞ËøõË°åÂ§ÑÁêÜ„ÄÇËøôÊ†∑ÔºåÊìç‰ΩúÁ≥ªÁªüÂèØ‰ª•ÂèäÊó∂ÂìçÂ∫îÂ§ñÈÉ®ËÆæÂ§áÁöÑ‰∏≠Êñ≠ËØ∑Ê±ÇÔºåÂ§ÑÁêÜËÆæÂ§áÁöÑËæìÂÖ•ÂíåËæìÂá∫„ÄÇ</p>
<h3 id="‰∏≤Âè£È©±Âä®Á®ãÂ∫èUART"><a href="#‰∏≤Âè£È©±Âä®Á®ãÂ∫èUART" class="headerlink" title="‰∏≤Âè£È©±Âä®Á®ãÂ∫èUART"></a>‰∏≤Âè£È©±Âä®Á®ãÂ∫èUART</h3><p><strong>ÁõÆÁöÑ</strong></p>
<p>ÊääÂ≠óÁ¨¶ËæìÂÖ•Âà∞Êìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏Èáå„ÄÇUARTÔºàUniversal Asynchronous Receiver&#x2F;TransmitterÔºâÊòØ‰∏ÄÁßçÈÄöÁî®ÁöÑÂºÇÊ≠•Êî∂Âèë‰º†ËæìÂô®ÔºåÁî®‰∫éÂÆûÁé∞Â≠óÁ¨¶ÁöÑËæìÂÖ•ÂíåËæìÂá∫„ÄÇÂú® PotatOS ‰∏≠ÔºåUART È©±Âä®Á®ãÂ∫èË¥üË¥£Â∞ÜÁî®Êà∑ËæìÂÖ•ÁöÑÂ≠óÁ¨¶‰º†ËæìÂà∞Êìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÔºåÂπ∂Â∞ÜÂÜÖÊ†∏ËæìÂá∫ÁöÑÂ≠óÁ¨¶ÂèëÈÄÅÂà∞ÁªàÁ´ØËÆæÂ§á„ÄÇ</p>
<h4 id="ÂàùÂßãÂåñ"><a href="#ÂàùÂßãÂåñ" class="headerlink" title="ÂàùÂßãÂåñ"></a>ÂàùÂßãÂåñ</h4><p><strong>ns16550a</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">NS16550aRaw</span> &#123;<br>    base_addr: <span class="hljs-type">usize</span>,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">NS16550aRaw</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_end</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> ReadWithoutDLAB &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123; &amp;<span class="hljs-keyword">mut</span> *(<span class="hljs-keyword">self</span>.base_addr <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> ReadWithoutDLAB) &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_end</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> WriteWithoutDLAB &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123; &amp;<span class="hljs-keyword">mut</span> *(<span class="hljs-keyword">self</span>.base_addr <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> WriteWithoutDLAB) &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(base_addr: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123; base_addr &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">read_end</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">read_end</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">mcr</span> = MCR::<span class="hljs-title function_ invoke__">empty</span>();<br>        mcr |= MCR::DATA_TERMINAL_READY;<br>        mcr |= MCR::REQUEST_TO_SEND;<br>        mcr |= MCR::AUX_OUTPUT2;<br>        read_end.mcr.<span class="hljs-title function_ invoke__">write</span>(mcr);<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">ier</span> = IER::RX_AVAILABLE;<br>        read_end.ier.<span class="hljs-title function_ invoke__">write</span>(ier);<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">read</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">u8</span>&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">read_end</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">read_end</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">lsr</span> = read_end.lsr.<span class="hljs-title function_ invoke__">read</span>();<br>        <span class="hljs-keyword">if</span> lsr.<span class="hljs-title function_ invoke__">contains</span>(LSR::DATA_AVAILABLE) &#123;<br>            <span class="hljs-title function_ invoke__">Some</span>(read_end.rbr.<span class="hljs-title function_ invoke__">read</span>())<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-literal">None</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, ch: <span class="hljs-type">u8</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">write_end</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">write_end</span>();<br>        <span class="hljs-keyword">loop</span> &#123;<br>            <span class="hljs-keyword">if</span> write_end.lsr.<span class="hljs-title function_ invoke__">read</span>().<span class="hljs-title function_ invoke__">contains</span>(LSR::THR_EMPTY) &#123;<br>                write_end.thr.<span class="hljs-title function_ invoke__">write</span>(ch);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÈÄöËøá<code>MMIO</code>ËøõË°åÈÄö‰ø°ÔºåËØªÂÜô„ÄÇÂÜÖÈÉ®ÊòØ‰∏ÄÂ†ÜÂØÑÂ≠òÂô®„ÄÇ<code>NS16550aRaw</code> ÊòØ‰∏Ä‰∏™ÂéüÂßãÁöÑ UART ËÆæÂ§áÁªìÊûÑ‰ΩìÔºåÂÆÉÈÄöËøáÂÜÖÂ≠òÊò†Â∞ÑËæìÂÖ•ËæìÂá∫ÔºàMMIOÔºâÁöÑÊñπÂºè‰∏é UART ËÆæÂ§áËøõË°åÈÄö‰ø°„ÄÇÂú®ÂàùÂßãÂåñËøáÁ®ã‰∏≠Ôºå‰ºöÈÖçÁΩÆ UART ËÆæÂ§áÁöÑÂØÑÂ≠òÂô®Ôºå‰ΩøËÉΩÊé•Êî∂‰∏≠Êñ≠ÔºåÂπ∂ËÆæÁΩÆÁõ∏Â∫îÁöÑÊéßÂà∂‰Ωç„ÄÇ<code>read</code> ÊñπÊ≥ïÁî®‰∫é‰ªé UART ËÆæÂ§áËØªÂèñ‰∏Ä‰∏™Â≠óÁ¨¶Ôºå<code>write</code> ÊñπÊ≥ïÁî®‰∫éÂêë UART ËÆæÂ§áÂÜôÂÖ•‰∏Ä‰∏™Â≠óÁ¨¶„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ReadWithoutDLAB</span> &#123;<br>    <span class="hljs-comment">/// receiver buffer register</span><br>    <span class="hljs-keyword">pub</span> rbr: ReadOnly&lt;<span class="hljs-type">u8</span>&gt;,<br>    <span class="hljs-comment">/// interrupt enable register</span><br>    <span class="hljs-keyword">pub</span> ier: Volatile&lt;IER&gt;,<br>    <span class="hljs-comment">/// interrupt identification register</span><br>    <span class="hljs-keyword">pub</span> iir: ReadOnly&lt;<span class="hljs-type">u8</span>&gt;,<br>    <span class="hljs-comment">/// line control register</span><br>    <span class="hljs-keyword">pub</span> lcr: Volatile&lt;<span class="hljs-type">u8</span>&gt;,<br>    <span class="hljs-comment">/// model control register</span><br>    <span class="hljs-keyword">pub</span> mcr: Volatile&lt;MCR&gt;,<br>    <span class="hljs-comment">/// line status register</span><br>    <span class="hljs-keyword">pub</span> lsr: ReadOnly&lt;LSR&gt;,<br>    <span class="hljs-comment">/// ignore MSR</span><br>    _padding1: ReadOnly&lt;<span class="hljs-type">u8</span>&gt;,<br>    <span class="hljs-comment">/// ignore SCR</span><br>    _padding2: ReadOnly&lt;<span class="hljs-type">u8</span>&gt;,<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>ReadWithoutDLAB</code> ÁªìÊûÑ‰ΩìÂÆö‰πâ‰∫Ü UART ËÆæÂ§áÁöÑÂØÑÂ≠òÂô®Â∏ÉÂ±ÄÔºåÂåÖÊã¨Êé•Êî∂ÁºìÂÜ≤Âå∫ÂØÑÂ≠òÂô®„ÄÅ‰∏≠Êñ≠‰ΩøËÉΩÂØÑÂ≠òÂô®„ÄÅ‰∏≠Êñ≠Ê†áËØÜÂØÑÂ≠òÂô®Á≠â„ÄÇÈÄöËøáËÆøÈóÆËøô‰∫õÂØÑÂ≠òÂô®ÔºåÂèØ‰ª•ÂÆûÁé∞ÂØπ UART ËÆæÂ§áÁöÑÊéßÂà∂ÂíåÊï∞ÊçÆ‰º†Ëæì„ÄÇ</p>
<h4 id="‰∏≠Êñ≠Â§ÑÁêÜ-1"><a href="#‰∏≠Êñ≠Â§ÑÁêÜ-1" class="headerlink" title="‰∏≠Êñ≠Â§ÑÁêÜ"></a>‰∏≠Êñ≠Â§ÑÁêÜ</h4><p>ËÆæÂ§áÂåÖË£ÖÊàê<code>u8Â≠óËäÇ‰∏≤</code>‰∏éÂÜÖÊ†∏ËøõË°å‰∏≠Êñ≠‰∫§‰∫í</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">NS16550a</span>&lt;<span class="hljs-keyword">const</span> BASE_ADDR: <span class="hljs-type">usize</span>&gt; &#123;<br>    inner: UPIntrFreeCell&lt;NS16550aInner&gt;,<br>    condvar: Condvar,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÈÄöËøá‰ø°Âè∑Èáè<code>condvar</code>ÂÆûÁé∞ÂÜÖÊ†∏ÈÉ®ÂàÜÁöÑ‰ø°Âè∑È©±Âä® IO„ÄÇÂΩì UART ËÆæÂ§áÊé•Êî∂Âà∞Â≠óÁ¨¶Êó∂Ôºå‰ºöËß¶Âèë‰∏≠Êñ≠Ôºå‰∏≠Êñ≠Â§ÑÁêÜÂáΩÊï∞‰ºöÂ∞ÜÊé•Êî∂Âà∞ÁöÑÂ≠óÁ¨¶Â≠òÂÇ®Âà∞ÁºìÂÜ≤Âå∫‰∏≠ÔºåÂπ∂ÈÄöËøá‰ø°Âè∑ÈáèÈÄöÁü•ÂÜÖÊ†∏ÊúâÊñ∞ÁöÑÂ≠óÁ¨¶ÂèØÁî®„ÄÇÂÜÖÊ†∏ÂèØ‰ª•ÈÄöËøáÁ≠âÂæÖ‰ø°Âè∑ÈáèÊù•Ëé∑ÂèñÊñ∞ÁöÑÂ≠óÁ¨¶„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle_irq</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">count</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">self</span>.inner.<span class="hljs-title function_ invoke__">exclusive_session</span>(|inner| &#123;<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(ch) = inner.ns16550a.<span class="hljs-title function_ invoke__">read</span>() &#123;<br>            count += <span class="hljs-number">1</span>;<br>            inner.read_buffer.<span class="hljs-title function_ invoke__">push_back</span>(ch);<br>        &#125;<br>    &#125;);<br>    <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">self</span>.condvar.<span class="hljs-title function_ invoke__">signal</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Âú®‰∏≠Êñ≠Â§ÑÁêÜÂáΩÊï∞‰∏≠Ôºå‰ºö‰∏çÊñ≠‰ªé UART ËÆæÂ§áËØªÂèñÂ≠óÁ¨¶ÔºåÂπ∂Â∞ÜÂÖ∂Â≠òÂÇ®Âà∞ÁºìÂÜ≤Âå∫‰∏≠„ÄÇÂ¶ÇÊûúËØªÂèñÂà∞‰∫ÜÂ≠óÁ¨¶ÔºåÂàôÈÄöËøá‰ø°Âè∑ÈáèÈÄöÁü•ÂÜÖÊ†∏„ÄÇËøôÊ†∑ÔºåÂÜÖÊ†∏ÂèØ‰ª•Âú®ÊúâÊñ∞ÁöÑÂ≠óÁ¨¶ÂèØÁî®Êó∂Ë¢´Âî§ÈÜíÔºåÊèêÈ´ò‰∫ÜÁ≥ªÁªüÁöÑÂìçÂ∫îÊÄßËÉΩ„ÄÇ</p>
<h4 id="ÂÜÖÊ†∏ÈÄö‰ø°"><a href="#ÂÜÖÊ†∏ÈÄö‰ø°" class="headerlink" title="ÂÜÖÊ†∏ÈÄö‰ø°"></a>ÂÜÖÊ†∏ÈÄö‰ø°</h4><p>UART‰Ωú‰∏∫ËæìÂÖ•ËÆæÂ§áËÆæÁ´ãÊàê<code>stdin</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// stdio.rs</span><br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">File</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Stdin</span> &#123;<br>	<span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">read</span>(&amp;<span class="hljs-keyword">self</span>, <span class="hljs-keyword">mut</span> user_buf: UserBuffer) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        <span class="hljs-built_in">assert_eq!</span>(user_buf.<span class="hljs-title function_ invoke__">len</span>(), <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">//println!(&quot;before UART.read() in Stdin::read()&quot;);</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">ch</span> = UART.<span class="hljs-title function_ invoke__">read</span>();<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            user_buf.buffers[<span class="hljs-number">0</span>].<span class="hljs-title function_ invoke__">as_mut_ptr</span>().<span class="hljs-title function_ invoke__">write_volatile</span>(ch);<br>        &#125;<br>        <span class="hljs-number">1</span><br>    &#125;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>Âú®ËøõÁ®ãÂàõÂª∫‰∏≠Ëá™Âä®ËÆæÁΩÆ<code>stdin</code>Ôºå<code>stdout</code>Ôºå<code>stderr</code>„ÄÇUART ËÆæÂ§á‰Ωú‰∏∫Ê†áÂáÜËæìÂÖ•ËÆæÂ§áÔºà<code>stdin</code>ÔºâÔºåÁî®Êà∑Á®ãÂ∫èÂèØ‰ª•ÈÄöËøáË∞ÉÁî® <code>Stdin</code> ÁöÑ <code>read</code> ÊñπÊ≥ï‰ªé UART ËÆæÂ§áËØªÂèñÂ≠óÁ¨¶„ÄÇÂú®ËøõÁ®ãÂàõÂª∫Êó∂Ôºå‰ºöËá™Âä®Â∞Ü <code>stdin</code>„ÄÅ<code>stdout</code> Âíå <code>stderr</code> ÂàÜÂà´ËÆæÁΩÆ‰∏∫ UART ËÆæÂ§áÔºåÊñπ‰æøÁî®Êà∑Á®ãÂ∫èËøõË°åËæìÂÖ•ËæìÂá∫Êìç‰Ωú„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust">fd_table: <span class="hljs-built_in">vec!</span>[<br>    <span class="hljs-comment">// 0 -&gt; stdin</span><br>    <span class="hljs-title function_ invoke__">Some</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(Stdin)),<br>    <span class="hljs-comment">// 1 -&gt; stdout</span><br>    <span class="hljs-title function_ invoke__">Some</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(Stdout)),<br>    <span class="hljs-comment">// 2 -&gt; stderr</span><br>    <span class="hljs-title function_ invoke__">Some</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(Stdout)),<br>],<br></code></pre></td></tr></table></figure>

<p>Ê≠§Â§ÑÈîôËØØËæìÂá∫Ëá™Âä®ÂØºÂêëÁªàÁ´Ø</p>
<h3 id="Virtio-Device"><a href="#Virtio-Device" class="headerlink" title="Virtio Device"></a>Virtio Device</h3><p>‰Ωú‰∏∫‰∏Ä‰∏™ËÆæÂ§áÊé•Âè£ÔºåÂÖÅËÆ∏ËôöÊãüÊú∫‰∏äËøêË°åÁöÑÊìç‰ΩúÁ≥ªÁªü<strong>ÈÄöËøáËÆøÈóÆvirtioËÆæÂ§á‰ΩøÁî®‰∏ªÊú∫ËÆæÂ§á</strong>„ÄÇËøôÈáå‰∏ªË¶ÅÊòØÂà©Áî®ÂÆÉÁÆÄÂçïÂú∞ÂÆûÁé∞ËôöÊãüËÆæÂ§á„ÄÇ</p>
<h3 id="Virtio-Block-Device"><a href="#Virtio-Block-Device" class="headerlink" title="Virtio Block Device"></a>Virtio Block Device</h3><p>Êàë‰ª¨Â∏åÊúõÈÄöËøáÊìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÂØπËôöÊãüÂùóËÆæÂ§áËøõË°åÁÆÄÂçïÁöÑËØªÂÜô„ÄÇ</p>
<h4 id="block-dev-trait"><a href="#block-dev-trait" class="headerlink" title="block-dev trait"></a>block-dev trait</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">BlockDevice</span>: <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span> + Any &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_block</span>(&amp;<span class="hljs-keyword">self</span>, block_id: <span class="hljs-type">usize</span>, buf: &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>]);<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_block</span>(&amp;<span class="hljs-keyword">self</span>, block_id: <span class="hljs-type">usize</span>, buf: &amp;[<span class="hljs-type">u8</span>]);<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle_irq</span>(&amp;<span class="hljs-keyword">self</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂùóËÆæÂ§áÈúÄË¶ÅÂÆûÁé∞ÁöÑ<code>trait</code>ÔºåÂåÖÊã¨ÁÆÄÂçïÁöÑËØªÂÜôÂíå‰∏≠Êñ≠Â§ÑÁêÜ„ÄÇÂú®<code>Êñá‰ª∂Á≥ªÁªü</code>Á´†ËäÇÊúâÊèêÂèä„ÄÇ</p>
<h4 id="virtio-block"><a href="#virtio-block" class="headerlink" title="virtio-block"></a>virtio-block</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VirtIOBlk</span>&lt;<span class="hljs-symbol">&#x27;a</span>, H: Hal&gt; &#123;<br>    header: &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> VirtIOHeader,<br>    queue: VirtQueue&lt;<span class="hljs-symbol">&#x27;a</span>, H&gt;,<br>    capacity: <span class="hljs-type">usize</span>,<br>&#125;<br><br><span class="hljs-comment">// drivers/block/virtio_blk.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VirtIOBlock</span> &#123;<br>    virtio_blk: UPIntrFreeCell&lt;VirtIOBlk&lt;<span class="hljs-symbol">&#x27;static</span>, VirtioHal&gt;&gt;,<br>    condvars: BTreeMap&lt;<span class="hljs-type">u16</span>, Condvar&gt;,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂåÖÂê´‰∫ÜËôöÊãüÂùóËÆæÂ§áÁöÑÂü∫Êú¨ÁªìÊûÑÔºåÂåÖÊã¨virtio-driverÂíåÂ§öÈÄöÈÅìÈÄö‰ø°„ÄÇ</p>
<p><code>condvars</code>Áî®‰∫éÂÆûÁé∞IOËØªÂÜô„ÄÇ‰∫ãÂÆû‰∏äÔºå‰∏Ä‰∏™<code>condvar</code>ÂØπÂ∫î‰∏Ä‰∏™<code>virtio-queue</code>„ÄÇvirtio-queueÊòØËôöÊãüËÆæÂ§á‰∏≠ÈÄöËøá<strong>‰∏≠Êñ≠È©±Âä®ÁöÑIOÈòüÂàóÔºåÊîØÊåÅËΩÆËØ¢</strong>„ÄÇÈÄöËøávirtio-queueÂèØ‰ª•ÂÆûÁé∞ËÆæÂ§áÂíåÈ©±Âä®Á®ãÂ∫èÁöÑÂêÑÁßçÊï∞ÊçÆ‰º†ËæìÂ∑•‰Ωú„ÄÇ</p>
<h4 id="Êìç‰ΩúÁ≥ªÁªüÂØπÊé•ÂùóËÆæÂ§áÂàùÂßãÂåñ"><a href="#Êìç‰ΩúÁ≥ªÁªüÂØπÊé•ÂùóËÆæÂ§áÂàùÂßãÂåñ" class="headerlink" title="Êìç‰ΩúÁ≥ªÁªüÂØπÊé•ÂùóËÆæÂ§áÂàùÂßãÂåñ"></a>Êìç‰ΩúÁ≥ªÁªüÂØπÊé•ÂùóËÆæÂ§áÂàùÂßãÂåñ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">VirtIOBlock</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">virtio_blk</span> = <span class="hljs-keyword">unsafe</span> &#123;<br>            UPIntrFreeCell::<span class="hljs-title function_ invoke__">new</span>(<br>                VirtIOBlk::&lt;VirtioHal&gt;::<span class="hljs-title function_ invoke__">new</span>(&amp;<span class="hljs-keyword">mut</span> *(VIRTIO0 <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> VirtIOHeader)).<span class="hljs-title function_ invoke__">unwrap</span>(),<br>            )<br>        &#125;;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">condvars</span> = BTreeMap::<span class="hljs-title function_ invoke__">new</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">channels</span> = virtio_blk.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">virt_queue_size</span>();<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..channels &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">condvar</span> = Condvar::<span class="hljs-title function_ invoke__">new</span>();<br>            condvars.<span class="hljs-title function_ invoke__">insert</span>(i, condvar);<br>        &#125;<br>        <span class="hljs-keyword">Self</span> &#123;<br>            virtio_blk,<br>            condvars,<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂàùÂßãÂåñ<code>virtio-block</code>Âíå<code>channels</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// qemu.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">BlockDeviceImpl</span> = crate::drivers::block::VirtIOBlock;<br><br><span class="hljs-comment">// drivers/block/mod.rs</span><br>lazy_static! &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">ref</span> BLOCK_DEVICE: Arc&lt;<span class="hljs-keyword">dyn</span> BlockDevice&gt; = Arc::<span class="hljs-title function_ invoke__">new</span>(BlockDeviceImpl::<span class="hljs-title function_ invoke__">new</span>());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂÖ®Â±ÄÂàùÂßãÂåñÂùóËÆæÂ§á</p>
<h4 id="‰∏≠Êñ≠Â§ÑÁêÜ-2"><a href="#‰∏≠Êñ≠Â§ÑÁêÜ-2" class="headerlink" title="‰∏≠Êñ≠Â§ÑÁêÜ"></a>‰∏≠Êñ≠Â§ÑÁêÜ</h4><p>Âêå‰∏äÔºåÈÄöËøá‰∏≠Êñ≠ËøõË°åÊï∞ÊçÆ‰º†Ëæì„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle_irq</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>    <span class="hljs-keyword">self</span>.virtio_blk.<span class="hljs-title function_ invoke__">exclusive_session</span>(|blk| &#123;<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Ok</span>(token) = blk.<span class="hljs-title function_ invoke__">pop_used</span>() &#123;<br>            <span class="hljs-keyword">self</span>.condvars.<span class="hljs-title function_ invoke__">get</span>(&amp;token).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">signal</span>();<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>‰ªévirtio-queue‰∏≠ÂèñÂá∫Â∑≤‰ΩøÁî®ËøáÁöÑÈÉ®ÂàÜËøõË°åÊï∞ÊçÆ‰º†Ëæì</p>
<h3 id="Virtio-GPU-Device"><a href="#Virtio-GPU-Device" class="headerlink" title="Virtio GPU Device"></a>Virtio GPU Device</h3><p>‰∏ªË¶ÅÁõÆÁöÑÊòØ‰∏∫‰∫Ü<strong>ËøõÁ®ãË∞ÉÂ∫¶ÁöÑÂõæÂΩ¢Âåñ</strong>ËÄå‰ΩøÁî®qemuËôöÊãüÁé∞ÂÆûËÆæÂ§á„ÄÇ‰∏ªË¶ÅÁöÑÂäüËÉΩÊòØÂØπÊòæÁ§∫ËÆæÂ§áÂÜÖÂ≠òËøõË°åÊï∞ÊçÆËØªÂÜô„ÄÇÈÄöËøáËÆæÁΩÆ<code>ÊòæÁ§∫Â±èÂ∞∫ÂØ∏</code>Ôºå<code>ÂÉèÁ¥†ÁÇπ‰ΩçÁΩÆ</code>Âíå<code>ÂÉèÁ¥†ÁÇπÈ¢úËâ≤</code>ÂèØ‰ª•ÂÆûÁé∞Âü∫Êú¨ÁöÑÂõæÂΩ¢Â±ïÁ§∫„ÄÇÂÉèÁ¥†ÁÇπÁöÑÊîæÁΩÆÁî±<code>cursor</code>ËæÖÂä©ÂÆûÁé∞„ÄÇ</p>
<p><strong>ÁÆÄÂçïÁöÑÂä®ÁîªÂÆûÁé∞</strong></p>
<p>ÁÆÄÂçïÂú∞ËÄÉËôëÂ∞±ÊòØÔºöÈ¶ñÂÖàÁ®ãÂ∫èÁªòÂà∂ÂΩìÂâçÂ∏ßÔºåÁÑ∂ÂêéÂ±èÂπïÂà∑Êñ∞Â∏ß„ÄÇ</p>
<h4 id="Êï∞ÊçÆÁªìÊûÑ"><a href="#Êï∞ÊçÆÁªìÊûÑ" class="headerlink" title="Êï∞ÊçÆÁªìÊûÑ"></a>Êï∞ÊçÆÁªìÊûÑ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VirtIOGpu</span>&lt;<span class="hljs-symbol">&#x27;a</span>, H: Hal&gt; &#123;<br>    header: &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> VirtIOHeader,<br>    rect: Rect,<br>    <span class="hljs-comment">/// DMA area of frame buffer.</span><br>    frame_buffer_dma: <span class="hljs-type">Option</span>&lt;DMA&lt;H&gt;&gt;,<br>    <span class="hljs-comment">/// DMA area of cursor image buffer.</span><br>    cursor_buffer_dma: <span class="hljs-type">Option</span>&lt;DMA&lt;H&gt;&gt;,<br>    <span class="hljs-comment">/// Queue for sending control commands.</span><br>    control_queue: VirtQueue&lt;<span class="hljs-symbol">&#x27;a</span>, H&gt;,<br>    <span class="hljs-comment">/// Queue for sending cursor commands.</span><br>    cursor_queue: VirtQueue&lt;<span class="hljs-symbol">&#x27;a</span>, H&gt;,<br>    <span class="hljs-comment">/// Queue buffer DMA</span><br>    queue_buf_dma: DMA&lt;H&gt;,<br>    <span class="hljs-comment">/// Send buffer for queue.</span><br>    queue_buf_send: &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>],<br>    <span class="hljs-comment">/// Recv buffer for queue.</span><br>    queue_buf_recv: &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>],<br>&#125;<br></code></pre></td></tr></table></figure>

<p>‰∏∫‰∫ÜÊèêÈ´òÁ≥ªÁªüÊâßË°åÊïàÁéáÔºå<code>ÂÉèÁ¥†ÂÜÖÂ≠ò</code>Âíå<code>ÂÖâÊ†áÊòæÁ§∫ÂÜÖÂ≠ò</code>Áî±<strong>DMA</strong>ÁÆ°ÁêÜÂπ∂ËøõË°åÊï∞ÊçÆ‰º†Ëæì„ÄÇ</p>
<p>ËøôÈáåÁöÑDMA‰ΩøÁî®ÂâçÊñá<code>ÂÜÖÂ≠òÁÆ°ÁêÜ</code>ÊèêÂà∞ÁöÑÂáΩÊï∞ÊñπÊ≥ïÁõ¥Êé•ËÆøÈóÆÁâ©ÁêÜ&#x2F;ËôöÊãüÂÜÖÂ≠ò„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Debug)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">DMA</span>&lt;H: Hal&gt; &#123;<br>    paddr: <span class="hljs-type">usize</span>,<br>    pages: <span class="hljs-type">usize</span>,<br>    _phantom: PhantomData&lt;H&gt;,<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;H: Hal&gt; DMA&lt;H&gt; &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(pages: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-keyword">Self</span>&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">paddr</span> = H::<span class="hljs-title function_ invoke__">dma_alloc</span>(pages);<br>        <span class="hljs-keyword">if</span> paddr == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(Error::DmaError);<br>        &#125;<br>        <span class="hljs-title function_ invoke__">Ok</span>(DMA &#123;<br>            paddr,<br>            pages,<br>            _phantom: PhantomData::<span class="hljs-title function_ invoke__">default</span>(),<br>        &#125;)<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">paddr</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        <span class="hljs-keyword">self</span>.paddr<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">vaddr</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        H::<span class="hljs-title function_ invoke__">phys_to_virt</span>(<span class="hljs-keyword">self</span>.paddr)<br>    &#125;<br><br>    <span class="hljs-comment">/// Returns the physical page frame number.</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">pfn</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> &#123;<br>        (<span class="hljs-keyword">self</span>.paddr &gt;&gt; <span class="hljs-number">12</span>) <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span><br>    &#125;<br><br>    <span class="hljs-comment">/// Convert to a buffer</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">as_buf</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>] &#123;<br>        core::slice::<span class="hljs-title function_ invoke__">from_raw_parts_mut</span>(<span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">vaddr</span>() <span class="hljs-keyword">as</span> _, PAGE_SIZE * <span class="hljs-keyword">self</span>.pages <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;H: Hal&gt; <span class="hljs-built_in">Drop</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">DMA</span>&lt;H&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">drop</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">err</span> = H::<span class="hljs-title function_ invoke__">dma_dealloc</span>(<span class="hljs-keyword">self</span>.paddr <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, <span class="hljs-keyword">self</span>.pages <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>);<br>        <span class="hljs-built_in">assert_eq!</span>(err, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;failed to deallocate DMA&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/// The interface which a particular hardware implementation must implement.</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">Hal</span> &#123;<br>    <span class="hljs-comment">/// Allocates the given number of contiguous physical pages of DMA memory for virtio use.</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">dma_alloc</span>(pages: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> PhysAddr;<br>    <span class="hljs-comment">/// Deallocates the given contiguous physical DMA memory pages.</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">dma_dealloc</span>(paddr: PhysAddr, pages: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span>;<br>    <span class="hljs-comment">/// Converts a physical address used for virtio to a virtual address which the program can</span><br>    <span class="hljs-comment">/// access.</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">phys_to_virt</span>(paddr: PhysAddr) <span class="hljs-punctuation">-&gt;</span> VirtAddr;<br>    <span class="hljs-comment">/// Converts a virtual address which the program can access to the corresponding physical</span><br>    <span class="hljs-comment">/// address to use for virtio.</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">virt_to_phys</span>(vaddr: VirtAddr) <span class="hljs-punctuation">-&gt;</span> PhysAddr;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>trait Hal</code>Áõ¥Êé•Áî≥ËØ∑Áâ©ÁêÜÈ°µË°®ÂíåÁâ©ÁêÜÂú∞ÂùÄÔºå‰ªéËÄå‰∏ç‰ΩøÁî®‰∏≠Êñ≠Áõ¥Êé•ËÆøÈóÆÂú∞ÂùÄÁ©∫Èó¥„ÄÇËøôÊ†∑ÂèØ‰ª•Âä†ÈÄüÁ≥ªÁªüÊâßË°åÊïàÁéá</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Hal</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">VirtioHal</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">dma_alloc</span>(pages: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">trakcers</span> = <span class="hljs-title function_ invoke__">frame_alloc_more</span>(pages);<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">ppn_base</span> = trakcers.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">last</span>().<span class="hljs-title function_ invoke__">unwrap</span>().ppn;<br>        QUEUE_FRAMES<br>            .<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>())<br>            .<span class="hljs-title function_ invoke__">append</span>(&amp;<span class="hljs-keyword">mut</span> trakcers.<span class="hljs-title function_ invoke__">unwrap</span>());<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pa</span>: PhysAddr = ppn_base.<span class="hljs-title function_ invoke__">into</span>();<br>        pa.<span class="hljs-number">0</span><br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">dma_dealloc</span>(pa: <span class="hljs-type">usize</span>, pages: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pa</span> = PhysAddr::<span class="hljs-title function_ invoke__">from</span>(pa);<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ppn_base</span>: PhysPageNum = pa.<span class="hljs-title function_ invoke__">into</span>();<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..pages &#123;<br>            <span class="hljs-title function_ invoke__">frame_dealloc</span>(ppn_base);<br>            ppn_base.<span class="hljs-title function_ invoke__">step</span>();<br>        &#125;<br>        <span class="hljs-number">0</span><br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">phys_to_virt</span>(addr: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        addr<br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">virt_to_phys</span>(vaddr: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        PageTable::<span class="hljs-title function_ invoke__">from_token</span>(<span class="hljs-title function_ invoke__">kernel_token</span>())<br>            .<span class="hljs-title function_ invoke__">translate_va</span>(VirtAddr::<span class="hljs-title function_ invoke__">from</span>(vaddr))<br>            .<span class="hljs-title function_ invoke__">unwrap</span>()<br>            .<span class="hljs-number">0</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="ÂàùÂßãÂåñËôöÊãüGPUËÆæÂ§á"><a href="#ÂàùÂßãÂåñËôöÊãüGPUËÆæÂ§á" class="headerlink" title="ÂàùÂßãÂåñËôöÊãüGPUËÆæÂ§á"></a>ÂàùÂßãÂåñËôöÊãüGPUËÆæÂ§á</h4><p>Ëøô‰∏ÄÊ≠•Â∞±ÊòØËøîÂõû‰∏Ä‰∏™ÂàùÂßãÂåñÂêéÁöÑGPUËÆæÂ§á</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(header: &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> VirtIOHeader) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-keyword">Self</span>&gt; &#123;<br>        header.<span class="hljs-title function_ invoke__">begin_init</span>(|features| &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">features</span> = Features::<span class="hljs-title function_ invoke__">from_bits_truncate</span>(features);<br>            info!(<span class="hljs-string">&quot;Device features &#123;:?&#125;&quot;</span>, features);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">supported_features</span> = Features::<span class="hljs-title function_ invoke__">empty</span>();<br>            (features &amp; supported_features).<span class="hljs-title function_ invoke__">bits</span>()<br>        &#125;);<br><br>        <span class="hljs-comment">// read configuration space</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">config</span> = <span class="hljs-keyword">unsafe</span> &#123; &amp;<span class="hljs-keyword">mut</span> *(header.<span class="hljs-title function_ invoke__">config_space</span>() <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> Config) &#125;;<br>        info!(<span class="hljs-string">&quot;Config: &#123;:?&#125;&quot;</span>, config);<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">control_queue</span> = VirtQueue::<span class="hljs-title function_ invoke__">new</span>(header, QUEUE_TRANSMIT, <span class="hljs-number">2</span>)?;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">cursor_queue</span> = VirtQueue::<span class="hljs-title function_ invoke__">new</span>(header, QUEUE_CURSOR, <span class="hljs-number">2</span>)?;<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">queue_buf_dma</span> = DMA::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">2</span>)?;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">queue_buf_send</span> = <span class="hljs-keyword">unsafe</span> &#123; &amp;<span class="hljs-keyword">mut</span> queue_buf_dma.<span class="hljs-title function_ invoke__">as_buf</span>()[..PAGE_SIZE] &#125;;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">queue_buf_recv</span> = <span class="hljs-keyword">unsafe</span> &#123; &amp;<span class="hljs-keyword">mut</span> queue_buf_dma.<span class="hljs-title function_ invoke__">as_buf</span>()[PAGE_SIZE..] &#125;;<br><br>        header.<span class="hljs-title function_ invoke__">finish_init</span>();<br><br>        <span class="hljs-title function_ invoke__">Ok</span>(VirtIOGpu &#123;<br>            header,<br>            frame_buffer_dma: <span class="hljs-literal">None</span>,<br>            cursor_buffer_dma: <span class="hljs-literal">None</span>,<br>            rect: Rect::<span class="hljs-title function_ invoke__">default</span>(),<br>            control_queue,<br>            cursor_queue,<br>            queue_buf_dma,<br>            queue_buf_send,<br>            queue_buf_recv,<br>        &#125;)<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>‰∏∫‰∫ÜËÉΩÂ§üÂÆûÁé∞ÂõæÂΩ¢ÂåñÔºåËøòÈúÄË¶ÅÂª∫Á´ã<strong>ÊòæÁ§∫Âå∫Âüü</strong>ÔºåÂç≥<strong>Ê∏≤ÊüìÂ∏ß</strong>Âíå<strong>Âà∑Êñ∞Â∏ß</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">setup_framebuffer</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;&amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>]&gt; &#123;<br>        <span class="hljs-comment">// get display info</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">display_info</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">get_display_info</span>()?;<br>        info!(<span class="hljs-string">&quot;=&gt; &#123;:?&#125;&quot;</span>, display_info);<br>        <span class="hljs-keyword">self</span>.rect = display_info.rect;<br><br>        <span class="hljs-comment">// create resource 2d</span><br>        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">resource_create_2d</span>(<br>            RESOURCE_ID_FB,<br>            display_info.rect.width,<br>            display_info.rect.height,<br>        )?;<br><br>        <span class="hljs-comment">// alloc continuous pages for the frame buffer</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">size</span> = display_info.rect.width * display_info.rect.height * <span class="hljs-number">4</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">frame_buffer_dma</span> = DMA::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-title function_ invoke__">pages</span>(size <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>))?;<br><br>        <span class="hljs-comment">// resource_attach_backing</span><br>        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">resource_attach_backing</span>(RESOURCE_ID_FB, frame_buffer_dma.<span class="hljs-title function_ invoke__">paddr</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u64</span>, size)?;<br><br>        <span class="hljs-comment">// map frame buffer to screen</span><br>        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">set_scanout</span>(display_info.rect, SCANOUT_ID, RESOURCE_ID_FB)?;<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">buf</span> = <span class="hljs-keyword">unsafe</span> &#123; frame_buffer_dma.<span class="hljs-title function_ invoke__">as_buf</span>() &#125;;<br>        <span class="hljs-keyword">self</span>.frame_buffer_dma = <span class="hljs-title function_ invoke__">Some</span>(frame_buffer_dma);<br>        <span class="hljs-title function_ invoke__">Ok</span>(buf)<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>Ëøô‰∏ÄÊ≠•ËÆæÁΩÆ‰∫Ü<code>ÊòæÁ§∫ËÆæÁΩÆ</code>ÔºåÂç≥ËÆæÂ§áÂ∞∫ÂØ∏ÂíåÂàÜËæ®Áéá„ÄÇ‰∏Ä‰∏™ÂÉèÁ¥†Â§ßÂ∞è<code>4Â≠óËäÇ</code>ÔºåÁÑ∂ÂêéÈìæÊé•Â∏ßÂíåÂ±èÂπï„ÄÇ</p>
<h4 id="ËôöÊãüGPUËÆæÂ§áIOÊìç‰Ωú"><a href="#ËôöÊãüGPUËÆæÂ§áIOÊìç‰Ωú" class="headerlink" title="ËôöÊãüGPUËÆæÂ§áIOÊìç‰Ωú"></a>ËôöÊãüGPUËÆæÂ§áIOÊìç‰Ωú</h4><p>Â¶Ç‰∏äÊâÄË®ÄÔºåGPUËÆæÂ§á‰ªÖÈúÄË¶Å‰∏§Ê≠•Êìç‰ΩúÔºö</p>
<ol>
<li>Ê∏≤ÊüìÂ∏ßÔºöÊääÂÉèÁ¥†Êï∞ÊçÆÂà∑ÂÖ•ÊòæÂ≠òÂÜÖ</li>
<li>Âà∑Êñ∞Â∏ßÔºöÊääÊñ∞Â∏ßÂà∑Âà∞Â±èÂπï‰∏ä</li>
</ol>
<h4 id="ËôöÊãüGPUÈ©±Âä®"><a href="#ËôöÊãüGPUÈ©±Âä®" class="headerlink" title="ËôöÊãüGPUÈ©±Âä®"></a>ËôöÊãüGPUÈ©±Âä®</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">GpuDevice</span>: <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span> + Any &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_framebuffer</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>];<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">flush</span>(&amp;<span class="hljs-keyword">self</span>);<br>&#125;<br><br>lazy_static::lazy_static!(<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">ref</span> GPU_DEVICE: Arc&lt;<span class="hljs-keyword">dyn</span> GpuDevice&gt; = Arc::<span class="hljs-title function_ invoke__">new</span>(VirtIOGpuWrapper::<span class="hljs-title function_ invoke__">new</span>());<br>);<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VirtIOGpuWrapper</span> &#123;<br>    gpu: UPIntrFreeCell&lt;VirtIOGpu&lt;<span class="hljs-symbol">&#x27;static</span>, VirtioHal&gt;&gt;,<br>    fb: &amp;<span class="hljs-symbol">&#x27;static</span> [<span class="hljs-type">u8</span>],<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">GpuDevice</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">VirtIOGpuWrapper</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">flush</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">self</span>.gpu.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">flush</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    &#125;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_framebuffer</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>] &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">ptr</span> = <span class="hljs-keyword">self</span>.fb.<span class="hljs-title function_ invoke__">as_ptr</span>() <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> _ <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>;<br>            core::slice::<span class="hljs-title function_ invoke__">from_raw_parts_mut</span>(ptr, <span class="hljs-keyword">self</span>.fb.<span class="hljs-title function_ invoke__">len</span>())<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ËôöÊãüGPUËÆæÂ§áÈááÁî®<code>DMA</code>ÔºåÂõ†Ê≠§‰∏éÊìç‰ΩúÁ≥ªÁªüÁöÑ‰∫§‰∫í‰∏çÈúÄË¶ÅËøõË°åÂú∞ÂùÄÂèòÊç¢ÔºåÁõ¥Êé•ËøõË°åÂ≠óËäÇËØªÂÜôÂç≥ÂèØ„ÄÇ</p>
<p>Áé∞Âú®<strong>ÂÜÖÊ†∏ÊÄÅ</strong>ÂèØ‰ª•Áõ¥Êé•‰ΩøÁî®ËôöÊãüGPUËÆæÂ§á„ÄÇ‰ΩÜÊòØÊÉ≥Ë¶ÅÂú®Áî®Êà∑ÊÄÅ‰ΩøÁî®(ËÆæËÆ°Â∫îÁî®)ËøòÈúÄË¶ÅÁ≥ªÁªüË∞ÉÁî®„ÄÇ</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">sys_framebuffer</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">fb</span> = GPU_DEVICE.<span class="hljs-title function_ invoke__">get_framebuffer</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">len</span> = fb.<span class="hljs-title function_ invoke__">len</span>();<br>    <span class="hljs-comment">// println!(&quot;[kernel] FrameBuffer: addr 0x&#123;:X&#125;, len &#123;&#125;&quot;, fb.as_ptr() as usize , len);</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">fb_start_pa</span> = PhysAddr::<span class="hljs-title function_ invoke__">from</span>(fb.<span class="hljs-title function_ invoke__">as_ptr</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>);<br>    <span class="hljs-built_in">assert!</span>(fb_start_pa.<span class="hljs-title function_ invoke__">aligned</span>());<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">fb_start_ppn</span> = fb_start_pa.<span class="hljs-title function_ invoke__">floor</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">fb_start_vpn</span> = VirtAddr::<span class="hljs-title function_ invoke__">from</span>(FB_VADDR).<span class="hljs-title function_ invoke__">floor</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pn_offset</span> = fb_start_ppn.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> <span class="hljs-type">isize</span> - fb_start_vpn.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> <span class="hljs-type">isize</span>;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">current_process</span> = <span class="hljs-title function_ invoke__">current_process</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">inner</span> = current_process.<span class="hljs-title function_ invoke__">inner_exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>    inner.memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>        MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>            (FB_VADDR <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            (FB_VADDR + len <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            MapType::<span class="hljs-title function_ invoke__">Linear</span>(pn_offset),<br>            MapPermission::R | MapPermission::W | MapPermission::U,<br>        ),<br>        <span class="hljs-literal">None</span>,<br>    );<br>    FB_VADDR <span class="hljs-keyword">as</span> <span class="hljs-type">isize</span><br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">sys_framebuffer_flush</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123;<br>    GPU_DEVICE.<span class="hljs-title function_ invoke__">flush</span>();<br>    <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>Ëøô‰∏§‰∏™Á≥ªÁªüË∞ÉÁî®ÂàÜÂà´ÂØπÂ∫î‰∫Ü‰∏§‰∏™Ê≠•È™§Ôºö<strong>Ëé∑ÂèñÂ∏ßÂú∞ÂùÄÂπ∂Â∞ùËØïÊ∏≤Êüì</strong>Âíå<strong>Âà∑Êñ∞Â∏ß</strong></p>
<h4 id="ÁßªÊ§çÂõæÂΩ¢Â∫ìËæÖÂä©ÂºÄÂèë"><a href="#ÁßªÊ§çÂõæÂΩ¢Â∫ìËæÖÂä©ÂºÄÂèë" class="headerlink" title="ÁßªÊ§çÂõæÂΩ¢Â∫ìËæÖÂä©ÂºÄÂèë"></a>ÁßªÊ§çÂõæÂΩ¢Â∫ìËæÖÂä©ÂºÄÂèë</h4><p>ÂõæÂΩ¢Â∫ì<strong>embedded-graphics</strong>‰∏∫ÂõæÂΩ¢ÂåñÁöÑÂºÄÂèëÊèê‰æõÂæàÂ§ö‰æøÂà©Ôºå‰ªÖÈúÄË¶ÅÂÆûÁé∞<code>trait Display</code>Âç≥ÂèØÊñπ‰æø‰ΩúÁîª</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Display</span> &#123;<br>    <span class="hljs-keyword">pub</span> size: Size,<br>    <span class="hljs-keyword">pub</span> fb: &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>],<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Display</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(size: Size) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">fb_ptr</span> = <span class="hljs-title function_ invoke__">framebuffer</span>() <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">fb</span> = <span class="hljs-keyword">unsafe</span> &#123; core::slice::<span class="hljs-title function_ invoke__">from_raw_parts_mut</span>(fb_ptr, VIRTGPU_LEN <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>) &#125;;<br>        <span class="hljs-keyword">Self</span> &#123; size, fb &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">framebuffer</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>] &#123;<br>        <span class="hljs-keyword">self</span>.fb<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">paint_on_framebuffer</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, p: <span class="hljs-keyword">impl</span> <span class="hljs-title class_">FnOnce</span>(&amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> ()) &#123;<br>        <span class="hljs-title function_ invoke__">p</span>(<span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">framebuffer</span>());<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">flush</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-title function_ invoke__">framebuffer_flush</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">OriginDimensions</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Display</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">size</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> Size &#123;<br>        <span class="hljs-keyword">self</span>.size<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">DrawTarget</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Display</span> &#123;<br>    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Color</span> = Rgb888;<br><br>    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Error</span> = core::convert::Infallible;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">draw_iter</span>&lt;I&gt;(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, pixels: I) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), <span class="hljs-keyword">Self</span>::Error&gt;<br>    <span class="hljs-keyword">where</span><br>        I: <span class="hljs-built_in">IntoIterator</span>&lt;Item = embedded_graphics::Pixel&lt;<span class="hljs-keyword">Self</span>::Color&gt;&gt;,<br>    &#123;<br>        pixels.<span class="hljs-title function_ invoke__">into_iter</span>().for_each(|px| &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">idx</span> = (px.<span class="hljs-number">0</span>.y * VIRTGPU_XRES <span class="hljs-keyword">as</span> <span class="hljs-type">i32</span> + px.<span class="hljs-number">0</span>.x) <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> * <span class="hljs-number">4</span>;<br>            <span class="hljs-keyword">if</span> idx + <span class="hljs-number">2</span> &gt;= <span class="hljs-keyword">self</span>.fb.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">self</span>.fb[idx] = px.<span class="hljs-number">1</span>.<span class="hljs-title function_ invoke__">b</span>();<br>            <span class="hljs-keyword">self</span>.fb[idx + <span class="hljs-number">1</span>] = px.<span class="hljs-number">1</span>.<span class="hljs-title function_ invoke__">g</span>();<br>            <span class="hljs-keyword">self</span>.fb[idx + <span class="hljs-number">2</span>] = px.<span class="hljs-number">1</span>.<span class="hljs-title function_ invoke__">r</span>();<br>        &#125;);<br>        <span class="hljs-title function_ invoke__">Ok</span>(())<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ËøôÊ†∑ÔºåÂ∞±ÂèØ‰ª•ÈÄöËøáËØ•ÂõæÂΩ¢Â∫ìËæÖÂä©ÂõæÂΩ¢ÂåñÂºÄÂèë„ÄÇ</p>
<h2 id="ÂèÇËÄÉËµÑÊñô"><a href="#ÂèÇËÄÉËµÑÊñô" class="headerlink" title="ÂèÇËÄÉËµÑÊñô"></a>ÂèÇËÄÉËµÑÊñô</h2><ol>
<li><p><a target="_blank" rel="noopener" href="https://rcore-os.cn/rCore-Tutorial-Book-v3/">https://rcore-os.cn/rCore-Tutorial-Book-v3/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/isrc-cas/riscv-isa-manual-cn">https://github.com/isrc-cas/riscv-isa-manual-cn</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://rustmagazine.github.io/rust_magazine_2021/">https://rustmagazine.github.io/rust_magazine_2021/</a></p>
</li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="print-no-link">#Êìç‰ΩúÁ≥ªÁªü</a>
      
        <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3/" class="print-no-link">#ËÆæËÆ°ÊñáÊ°£</a>
      
        <a href="/tags/%E8%AF%BE%E7%A8%8B%E8%AE%BE%E8%AE%A1/" class="print-no-link">#ËØæÁ®ãËÆæËÆ°</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>PotatOSËÆæËÆ°ÊñáÊ°£</div>
      <div>https://kiid-a.github.io/2025/06/15/PotatOSÊû∂ÊûÑ/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Beitragsautor</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Ver√∂ffentlicht am</div>
          <div>June 15, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Urheberrechtshinweis</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/03/02/%E9%A1%B9%E7%9B%AE/" title="È°πÁõÆ">
                        <span class="hidden-mobile">È°πÁõÆ</span>
                        <span class="visible-mobile">N√§chster</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Inhaltsverzeichnis</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Suchen</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Stichwort</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- ‰∏ªÈ¢òÁöÑÂêØÂä®È°πÔºåÂ∞ÜÂÆÉ‰øùÊåÅÂú®ÊúÄÂ∫ïÈÉ® -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog funktioniert am besten mit aktiviertem JavaScript</div>
  </noscript>
</body>
</html>
