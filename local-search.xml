<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>PotatOSè®¾è®¡æ–‡æ¡£</title>
    <link href="/2025/06/15/PotatOS%E6%9E%B6%E6%9E%84/"/>
    <url>/2025/06/15/PotatOS%E6%9E%B6%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h1 id="PotatOSğŸ¥”"><a href="#PotatOSğŸ¥”" class="headerlink" title="PotatOSğŸ¥”"></a>PotatOSğŸ¥”</h1><p>[toc]</p><h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><h3 id="ğŸ¥”ä»€ä¹ˆæ˜¯PotatOS"><a href="#ğŸ¥”ä»€ä¹ˆæ˜¯PotatOS" class="headerlink" title="ğŸ¥”ä»€ä¹ˆæ˜¯PotatOS"></a>ğŸ¥”ä»€ä¹ˆæ˜¯PotatOS</h3><p>PotatOSæ˜¯ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„åŸºäº <a href="https://github.com/bosswnx/2024s-rcore-bosswnx">2024 æ˜¥å¤å­£å¼€æºæ“ä½œç³»ç»Ÿè®­ç»ƒè¥ rCore é¡¹ç›®</a>çš„ RISC-V æ¶æ„çš„å…¼å®¹ POSIX åè®®çš„æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå®ç°äº†åŸºæœ¬çš„è¿›ç¨‹ç®¡ç†ã€å†…å­˜ç®¡ç†ã€æ–‡ä»¶ç³»ç»Ÿå’Œè®¾å¤‡é©±åŠ¨ã€‚</p><h3 id="å¼€å‘ç¯å¢ƒ"><a href="#å¼€å‘ç¯å¢ƒ" class="headerlink" title="å¼€å‘ç¯å¢ƒ"></a>å¼€å‘ç¯å¢ƒ</h3><ul><li>ä¸»æœºï¼šx86_64 Ubuntu 22.04 LTS</li><li>å·¥å…·é“¾ï¼šRust (nightly) + riscv64gc-unknown-elf-gcc</li><li>è°ƒè¯•ï¼šQEMU + GDB + VSCode (rust-analyzer)</li></ul><h3 id="æ–‡ä»¶ç»“æ„"><a href="#æ–‡ä»¶ç»“æ„" class="headerlink" title="æ–‡ä»¶ç»“æ„"></a>æ–‡ä»¶ç»“æ„</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">.<br>â”œâ”€â”€ bootloader<br>â”œâ”€â”€ easy-fs<br>â”œâ”€â”€ easy-fs-fuse<br>â”œâ”€â”€ Makefile<br>â”œâ”€â”€ os<br>â”œâ”€â”€ qemu-7.0.0<br>â”œâ”€â”€ rust-toolchain.toml<br>â”œâ”€â”€ setenv.sh<br>â””â”€â”€ user<br></code></pre></td></tr></table></figure><ul><li><strong>bootloader</strong>ï¼šQemu æ¨¡æ‹Ÿå™¨å¯åŠ¨æ—¶çš„å¼•å¯¼åŠ è½½ç¨‹åºã€‚å®ƒè´Ÿè´£åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶åˆå§‹åŒ–ç¡¬ä»¶ï¼Œå¹¶å°†æ§åˆ¶æƒäº¤ç»™æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚</li><li><strong>easy-fs</strong>ï¼šeasy file systemï¼Œæ˜¯æœ¬ç³»ç»Ÿé‡‡ç”¨çš„ç®€åŒ–æ–‡ä»¶ç³»ç»Ÿï¼Œè´Ÿè´£æ–‡ä»¶çš„å­˜å‚¨å’Œç®¡ç†ã€‚</li><li><strong>easy-fs-fuse</strong>ï¼šefs filesystem in userspaceï¼Œç”¨äºæµ‹è¯• efsï¼Œå¹¶ä¸”èƒ½å¤ŸæŠŠå†…æ ¸å¼€å‘çš„åº”ç”¨æ‰“åŒ…æˆä¸€ä¸ª efs æ ¼å¼çš„æ–‡ä»¶ç³»ç»Ÿé•œåƒï¼Œæ–¹ä¾¿åœ¨æ¨¡æ‹Ÿå™¨ä¸­ä½¿ç”¨ã€‚</li><li><strong>Makefile</strong>ï¼šåŒ…å«äº†ä¸€ç³»åˆ—ç¼–è¯‘å’Œè¿è¡Œçš„è§„åˆ™ï¼Œé€šè¿‡<code>make</code>å‘½ä»¤å¯ä»¥æ–¹ä¾¿åœ°ç¼–è¯‘å’Œè¿è¡Œæ“ä½œç³»ç»Ÿã€‚</li><li><strong>os</strong>ï¼šå†…æ ¸æ–‡ä»¶å¤¹ï¼Œå­˜æ”¾æ“ä½œç³»ç»Ÿå†…æ ¸çš„æºä»£ç ã€‚</li><li><strong>qemu-7.0.0</strong>ï¼šQemu æ–‡ä»¶å¤¹ï¼ŒåŒ…å«äº† Qemu æ¨¡æ‹Ÿå™¨çš„ç›¸å…³æ–‡ä»¶ã€‚</li><li><strong>rust-toolchain.toml</strong>ï¼šrust å·¥å…·é“¾æè¿°æ–‡ä»¶ï¼ŒæŒ‡å®šäº†ä½¿ç”¨çš„ Rust ç‰ˆæœ¬å’Œç›¸å…³é…ç½®ã€‚</li><li><strong>setenv.sh</strong>ï¼šè®¾ç½®å¼€å‘ç¯å¢ƒçš„è„šæœ¬ï¼Œè¿è¡Œè¯¥è„šæœ¬å¯ä»¥é…ç½®å¿…è¦çš„ç¯å¢ƒå˜é‡ã€‚</li><li><strong>user</strong>ï¼šç”¨æˆ·ç©ºé—´æ–‡ä»¶å¤¹ï¼Œå­˜æ”¾ç”¨æˆ·åº”ç”¨ç¨‹åºçš„æºä»£ç ã€‚</li></ul><h2 id="æ‰§è¡Œç¯å¢ƒä¸å¹³å°"><a href="#æ‰§è¡Œç¯å¢ƒä¸å¹³å°" class="headerlink" title="æ‰§è¡Œç¯å¢ƒä¸å¹³å°"></a>æ‰§è¡Œç¯å¢ƒä¸å¹³å°</h2><ul><li><p><strong>æ¶æ„</strong>ï¼šRISC-V RV64GCï¼ˆç‰¹æƒæ¨¡å¼ï¼šS-modeï¼‰</p></li><li><p><strong>QEMU é…ç½®</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-system-riscv64 \<br>  -machine virt \<br>  -nographic \<br>  -bios none \<br>  -kernel target/riscv64gc-unknown-none-elf/debug/potatos \<br>  -device virtio-blk-device,drive=disk0 \<br>  -drive file=fs.img,format=raw,<span class="hljs-built_in">id</span>=disk0<br></code></pre></td></tr></table></figure><ul><li><code>-machine virt</code>ï¼šæŒ‡å®šä½¿ç”¨ QEMU çš„è™šæ‹Ÿç¡¬ä»¶æ¨¡å‹ã€‚</li><li><code>-nographic</code>ï¼šä¸ä½¿ç”¨å›¾å½¢ç•Œé¢ï¼Œä»¥æ–‡æœ¬æ¨¡å¼è¿è¡Œã€‚å¦‚æœéœ€è¦å›¾å½¢åŒ–ç•Œé¢ï¼Œå¯ä»¥å»æ‰è¯¥é€‰é¡¹ã€‚</li><li><code>-bios none</code>ï¼šä¸ä½¿ç”¨ BIOSã€‚</li><li><code>-kernel target/riscv64gc-unknown-none-elf/debug/potatos</code>ï¼šæŒ‡å®šè¦åŠ è½½çš„å†…æ ¸äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li><li><code>-device virtio-blk-device,drive=disk0</code>ï¼šæ·»åŠ ä¸€ä¸ª Virtio å—è®¾å¤‡ã€‚</li><li><code>-drive file=fs.img,format=raw,id=disk0</code>ï¼šæŒ‡å®šä½¿ç”¨çš„ç£ç›˜é•œåƒæ–‡ä»¶ã€‚</li></ul></li></ul><h3 id="RustSbi"><a href="#RustSbi" class="headerlink" title="RustSbi"></a>RustSbi</h3><p><code>SBI</code>æ˜¯RISC-Vå®šä¹‰çš„ä¸€ç»„æ¥å£è§„èŒƒï¼Œç”¨äºæ“ä½œç³»ç»Ÿä¸ç¡¬ä»¶é—´çš„æ²Ÿé€šã€‚<code>RustSbi</code>æ˜¯è¿æ¥è¯¥æ“ä½œç³»ç»Ÿä¸åº•å±‚ç¡¬ä»¶çš„æ¡¥æ¢ï¼Œä¸»è¦æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li><strong>ç¡¬ä»¶æŠ½è±¡</strong>ï¼šå°†ç¡¬ä»¶è®¿é—®æŠ½è±¡æˆæ¥å£ï¼Œä½¿å¾—æ“ä½œç³»ç»Ÿå†…æ ¸å¯ä»¥é€šè¿‡ç»Ÿä¸€çš„æ¥å£è®¿é—®ä¸åŒçš„ç¡¬ä»¶è®¾å¤‡ï¼Œæé«˜äº†ä»£ç çš„å¯ç§»æ¤æ€§ã€‚</li><li><strong>ç³»ç»Ÿå¯åŠ¨</strong>ï¼šä¸Šç”µæ—¶ Sbi è´Ÿè´£åˆå§‹åŒ–ç¡¬ä»¶ï¼Œç„¶åä»å­˜å‚¨ä¸­åŠ è½½åˆ°æ“ä½œç³»ç»Ÿã€‚å®ƒä¼šå®Œæˆä¸€äº›å¿…è¦çš„ç¡¬ä»¶åˆå§‹åŒ–å·¥ä½œï¼Œå¦‚è®¾ç½®å†…å­˜æ˜ å°„ã€åˆå§‹åŒ–ä¸­æ–­æ§åˆ¶å™¨ç­‰ï¼Œä¸ºæ“ä½œç³»ç»Ÿçš„å¯åŠ¨åšå¥½å‡†å¤‡ã€‚</li><li><strong>å¼‚å¸¸å’Œä¸­æ–­å¤„ç†</strong>ï¼šå½“å‘ç”Ÿå¼‚å¸¸æˆ–ä¸­æ–­æ—¶ï¼Œæ“ä½œç³»ç»ŸæŠŠç¡¬ä»¶æ§åˆ¶æƒäº¤ç»™ Sbiï¼ŒSbi åœ¨åº•å±‚å®Œæˆå¤„ç†åäº¤è¿˜æ§åˆ¶æƒã€‚Sbi å¯ä»¥å¤„ç†ä¸€äº›åº•å±‚çš„å¼‚å¸¸å’Œä¸­æ–­ï¼Œå¦‚å®šæ—¶å™¨ä¸­æ–­ã€å¤–éƒ¨è®¾å¤‡ä¸­æ–­ç­‰ï¼Œå‡è½»äº†æ“ä½œç³»ç»Ÿå†…æ ¸çš„è´Ÿæ‹…ã€‚</li></ul><h2 id="Boot"><a href="#Boot" class="headerlink" title="Boot"></a>Boot</h2><p>é€šè¿‡Qemuå¯åŠ¨</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs makefile">QEMU_ARGS := -machine virt \<br> -bios <span class="hljs-variable">$(BOOTLOADER)</span> \<br> -serial stdio \<br> <span class="hljs-variable">$(GUI_OPTION)</span> \<br> -device loader,file=<span class="hljs-variable">$(KERNEL_BIN)</span>,addr=<span class="hljs-variable">$(KERNEL_ENTRY_PA)</span> \<br> -drive file=<span class="hljs-variable">$(FS_IMG)</span>,if=none,format=raw,id=x0 \<br> -device virtio-blk-device,drive=x0 \<br> -device virtio-gpu-device \<br> -device virtio-keyboard-device \<br> -device virtio-mouse-device \<br> -device virtio-net-device,netdev=net0 \<br> -netdev user,id=net0,hostfwd=udp::6200-:2000,hostfwd=tcp::6201-:80<br></code></pre></td></tr></table></figure><p>å°†ç¼–è¯‘å¥½çš„kerneläºŒè¿›åˆ¶æ–‡ä»¶åŠ è½½åˆ°å¯¹åº”çš„å¯åŠ¨ä½ç½®ï¼Œè¿™é‡Œæ˜¯<code>0x80200000</code></p><h2 id="ä¸­æ–­-ç‰¹æƒçº§æœºåˆ¶"><a href="#ä¸­æ–­-ç‰¹æƒçº§æœºåˆ¶" class="headerlink" title="ä¸­æ–­&#x2F;ç‰¹æƒçº§æœºåˆ¶"></a>ä¸­æ–­&#x2F;ç‰¹æƒçº§æœºåˆ¶</h2><p>RISC-Vä¸ºäº†ç»™æ“ä½œç³»ç»Ÿä¸€ä¸ªç¨³å®šçš„è¿è¡Œç¯å¢ƒï¼Œä¸ä¼šè¢«åº”ç”¨æ‰€å¹²æ‰°ï¼Œè®¾è®¡äº†ä¸€ä¸ªç‰¹æƒçº§æœºåˆ¶ã€‚è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ˜¯å®ç°è¿™ä¸€éƒ¨åˆ†çš„åŠŸèƒ½ã€‚</p><h3 id="åˆ‡æ¢"><a href="#åˆ‡æ¢" class="headerlink" title="åˆ‡æ¢"></a>åˆ‡æ¢</h3><ol><li><strong>ç”¨æˆ·ç¨‹åºæ‰§è¡Œè§¦å‘ Trap</strong>ï¼šå½“ç”¨æˆ·ç¨‹åºæ‰§è¡ŒæŸäº›ç‰¹æ®ŠæŒ‡ä»¤æˆ–å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¼šè§¦å‘ Trap æœºåˆ¶ï¼Œå°†æ§åˆ¶æƒè½¬ç§»åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚</li><li><strong>ç¡¬ä»¶è‡ªåŠ¨ä¿å­˜ <code>sepc</code>ã€<code>sstatus</code> ç­‰å¯„å­˜å™¨åˆ°å†…æ ¸ç©ºé—´çš„ <code>TrapContext</code></strong>ï¼š<code>sepc</code> ä¿å­˜äº† Trap å‘ç”Ÿæ—¶çš„ç¨‹åºè®¡æ•°å™¨ï¼Œ<code>sstatus</code> ä¿å­˜äº†å½“å‰çš„çŠ¶æ€ä¿¡æ¯ã€‚ç¡¬ä»¶ä¼šè‡ªåŠ¨å°†è¿™äº›å¯„å­˜å™¨çš„å€¼ä¿å­˜åˆ°å†…æ ¸ç©ºé—´çš„ <code>TrapContext</code> ä¸­ï¼Œä»¥ä¾¿åç»­æ¢å¤ã€‚</li><li><strong>å†…æ ¸è¯»å– <code>TrapContext</code>ï¼Œæ‰§è¡Œ <code>trap_handler</code> å¤„ç†é€»è¾‘ï¼ˆå¦‚ç³»ç»Ÿè°ƒç”¨æœåŠ¡ï¼‰</strong>ï¼šå†…æ ¸ä» <code>TrapContext</code> ä¸­è¯»å–ç›¸å…³ä¿¡æ¯ï¼Œæ ¹æ®ä¸åŒçš„ Trap åŸå› æ‰§è¡Œç›¸åº”çš„å¤„ç†é€»è¾‘ï¼Œå¦‚å¤„ç†ç³»ç»Ÿè°ƒç”¨ã€å¼‚å¸¸å¤„ç†ç­‰ã€‚</li><li><strong>å¤„ç†å®Œæ¯•åï¼Œä» <code>TrapContext</code> æ¢å¤ç”¨æˆ·å¯„å­˜å™¨ï¼ˆ<code>x</code>ã€<code>sstatus</code>ï¼‰ï¼Œé€šè¿‡ <code>sret</code> æŒ‡ä»¤è·³å› <code>sepc</code> ç»§ç»­æ‰§è¡Œç”¨æˆ·ç¨‹åº</strong>ï¼šå¤„ç†å®Œ Trap åï¼Œå†…æ ¸å°†ç”¨æˆ·å¯„å­˜å™¨çš„å€¼ä» <code>TrapContext</code> ä¸­æ¢å¤ï¼Œå¹¶é€šè¿‡ <code>sret</code> æŒ‡ä»¤å°†æ§åˆ¶æƒäº¤è¿˜ç»™ç”¨æˆ·ç¨‹åºï¼Œç»§ç»­æ‰§è¡Œåç»­çš„æŒ‡ä»¤ã€‚</li></ol><h4 id="ç”¨æˆ·æ ˆ-å†…æ ¸æ ˆ"><a href="#ç”¨æˆ·æ ˆ-å†…æ ¸æ ˆ" class="headerlink" title="ç”¨æˆ·æ ˆ&#x2F;å†…æ ¸æ ˆ"></a>ç”¨æˆ·æ ˆ&#x2F;å†…æ ¸æ ˆ</h4><p>åŒºåˆ†ä¸¤ä¸ªæ ˆæ˜¯ä¸ºäº†åº”ç”¨ç¨‹åºä¸ä¼šé€šè¿‡æ ˆä¿¡æ¯è¯»å–åˆ°å†…æ ¸çš„æ§åˆ¶æµï¼Œä»è€Œé¿å…äº†ä¸€å®šçš„å®‰å…¨éšæ‚£ã€‚</p><p>ä½†åœ¨PotatOSé‡Œï¼Œç”¨æˆ·æ ˆè¢«ç®€å•åœ°æŠ½è±¡æˆäº†<strong>åº”ç”¨æ ˆ</strong></p><p>å†…æ ¸æ ˆä¸è¿›ç¨‹ç»‘å®šï¼ŒæŠ½è±¡æˆäº†è¿›ç¨‹ç‹¬ç«‹ä¸”éš”ç¦»çš„<strong>è¿›ç¨‹æ ˆ</strong></p><h4 id="ä¸Šä¸‹æ–‡åˆ‡æ¢-æ¢å¤"><a href="#ä¸Šä¸‹æ–‡åˆ‡æ¢-æ¢å¤" class="headerlink" title="ä¸Šä¸‹æ–‡åˆ‡æ¢&#x2F;æ¢å¤"></a>ä¸Šä¸‹æ–‡åˆ‡æ¢&#x2F;æ¢å¤</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TrapContext</span> &#123;<br>    <span class="hljs-keyword">pub</span> x: [<span class="hljs-type">usize</span>; <span class="hljs-number">32</span>],<br>    <span class="hljs-keyword">pub</span> sstatus: Sstatus,<br>    <span class="hljs-keyword">pub</span> sepc: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> kernel_satp: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> kernel_sp: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> trap_handler: <span class="hljs-type">usize</span>,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>x</code>ï¼šä¿å­˜32ä¸ªé€šç”¨å¯„å­˜å™¨çš„å€¼ï¼Œæš‚å­˜ç”¨æˆ·ç©ºé—´çš„å¯„å­˜å™¨çŠ¶æ€ï¼Œä»¥ä¾¿é™·é˜±å¤„ç†å®Œæ¯•åæ¢å¤æ‰§è¡Œ</li><li><code>sstatus</code>ï¼šä¿å­˜è¶…çº§ç”¨æˆ·çŠ¶æ€å¯„å­˜å™¨(Sstatus)çš„å€¼ï¼Œè®°å½•å½“å‰ç‰¹æƒçº§ï¼Œä¸­æ–­ä½¿èƒ½ï¼ŒçŠ¶æ€æ ‡å¿—ï¼Œç”¨äºçŠ¶æ€æ¢å¤</li><li><code>sepc</code>ï¼šä¿å­˜è¶…çº§ç”¨æˆ·å¼‚å¸¸ç¨‹åºè®¡æ•°å™¨(SEPC)çš„å€¼ï¼Œè®°å½•trapå‘ç”Ÿæ—¶çš„åœ°å€</li><li><code>kernel_satp</code> ï¼šå†…æ ¸åœ°å€ç©ºé—´çš„ token ï¼Œå³å†…æ ¸é¡µè¡¨çš„èµ·å§‹ç‰©ç†åœ°å€</li><li><code>kernel_sp</code> ï¼šå½“å‰åº”ç”¨åœ¨å†…æ ¸åœ°å€ç©ºé—´ä¸­çš„å†…æ ¸æ ˆæ ˆé¡¶çš„è™šæ‹Ÿåœ°å€</li><li><code>trap_handler</code> ï¼šå†…æ ¸ä¸­ trap handler å…¥å£ç‚¹çš„è™šæ‹Ÿåœ°å€</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.altmacro<br>.macro SAVE_GP n<br>    sd x\n, \n*8(sp)<br>.endm<br>.macro LOAD_GP n<br>    ld x\n, \n*8(sp)<br>.endm<br>    .section .text.trampoline<br>    .globl __alltraps<br>    .globl __restore<br>    .globl __alltraps_k<br>    .globl __restore_k<br>    .align 2<br>__alltraps:<br>    csrrw sp, sscratch, sp<br>    # now sp-&gt;*TrapContext in user space, sscratch-&gt;user stack<br>    # save other general purpose registers<br>    sd x1, 1*8(sp)<br>    # skip sp(x2), we will save it later<br>    sd x3, 3*8(sp)<br>    # skip tp(x4), application does not use it<br>    # save x5~x31<br>    .set n, 5<br>    .rept 27<br>        SAVE_GP %n<br>        .set n, n+1<br>    .endr<br>    # we can use t0/t1/t2 freely, because they have been saved in TrapContext<br>    csrr t0, sstatus<br>    csrr t1, sepc<br>    sd t0, 32*8(sp)<br>    sd t1, 33*8(sp)<br>    # read user stack from sscratch and save it in TrapContext<br>    csrr t2, sscratch<br>    sd t2, 2*8(sp)<br>    # load kernel_satp into t0<br>    ld t0, 34*8(sp)<br>    # load trap_handler into t1<br>    ld t1, 36*8(sp)<br>    # move to kernel_sp<br>    ld sp, 35*8(sp)<br>    # switch to kernel space<br>    csrw satp, t0<br>    sfence.vma<br>    # jump to trap_handler<br>    jr t1<br><br>__restore:<br>    # a0: *TrapContext in user space(Constant); a1: user space token<br>    # switch to user space<br>    csrw satp, a1<br>    sfence.vma<br>    csrw sscratch, a0<br>    mv sp, a0<br>    # now sp points to TrapContext in user space, start restoring based on it<br>    # restore sstatus/sepc<br>    ld t0, 32*8(sp)<br>    ld t1, 33*8(sp)<br>    csrw sstatus, t0<br>    csrw sepc, t1<br>    # restore general purpose registers except x0/sp/tp<br>    ld x1, 1*8(sp)<br>    ld x3, 3*8(sp)<br>    .set n, 5<br>    .rept 27<br>        LOAD_GP %n<br>        .set n, n+1<br>    .endr<br>    # back to user stack<br>    ld sp, 2*8(sp)<br>    sret<br><br>    .align 2<br></code></pre></td></tr></table></figure><ul><li><code>__alltraps</code>ï¼šä¿å­˜ trap ä¸Šä¸‹æ–‡è‡³å†…æ ¸æ ˆã€‚åœ¨å‘ç”Ÿ Trap æ—¶ï¼Œè¯¥å‡½æ•°ä¼šå°†ç”¨æˆ·ç©ºé—´çš„å¯„å­˜å™¨çŠ¶æ€ä¿å­˜åˆ°å†…æ ¸æ ˆçš„ <code>TrapContext</code> ä¸­ï¼Œå¹¶åˆ‡æ¢åˆ°å†…æ ¸ç©ºé—´ã€‚</li><li><code>__restore</code>ï¼šæ¢å¤ trap ä¸Šä¸‹æ–‡ã€‚åœ¨å¤„ç†å®Œ Trap åï¼Œè¯¥å‡½æ•°ä¼šä» <code>TrapContext</code> ä¸­æ¢å¤ç”¨æˆ·å¯„å­˜å™¨çš„å€¼ï¼Œå¹¶åˆ‡æ¢å›ç”¨æˆ·ç©ºé—´ï¼Œç»§ç»­æ‰§è¡Œç”¨æˆ·ç¨‹åºã€‚</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">trap_return</span>() <span class="hljs-punctuation">-&gt;</span> ! &#123;<br>    <span class="hljs-title function_ invoke__">current_task</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">inner_exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">user_time_start</span>();<br><br>    <span class="hljs-title function_ invoke__">disable_supervisor_interrupt</span>();<br>    <span class="hljs-title function_ invoke__">set_user_trap_entry</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">trap_cx_user_va</span> = <span class="hljs-title function_ invoke__">current_trap_cx_user_va</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">user_satp</span> = <span class="hljs-title function_ invoke__">current_user_token</span>();<br>    <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123;<br>        <span class="hljs-keyword">fn</span> <span class="hljs-title function_">__alltraps</span>();<br>        <span class="hljs-keyword">fn</span> <span class="hljs-title function_">__restore</span>();<br>    &#125;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">restore_va</span> = __restore <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> - __alltraps <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> + TRAMPOLINE;<br>    <span class="hljs-comment">//println!(&quot;before return&quot;);</span><br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        asm!(<br>            <span class="hljs-string">&quot;fence.i&quot;</span>,<br>            <span class="hljs-string">&quot;jr &#123;restore_va&#125;&quot;</span>,<br>            restore_va = <span class="hljs-title function_ invoke__">in</span>(reg) restore_va,<br>            <span class="hljs-title function_ invoke__">in</span>(<span class="hljs-string">&quot;a0&quot;</span>) trap_cx_user_va,<br>            <span class="hljs-title function_ invoke__">in</span>(<span class="hljs-string">&quot;a1&quot;</span>) user_satp,<br>            <span class="hljs-title function_ invoke__">options</span>(noreturn)<br>        );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨trapæ¢å¤æ—¶è°ƒç”¨ä¸Šé¢çš„å‡½æ•°å›åˆ°æ­£ç¡®çš„æ ˆç©ºé—´å†…ã€‚</p><h4 id="trapå¤„ç†"><a href="#trapå¤„ç†" class="headerlink" title="trapå¤„ç†"></a>trapå¤„ç†</h4><p>å½“å‘ç”Ÿ Trap æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæ ¹æ® Trap çš„åŸå› æ‰§è¡Œç›¸åº”çš„å¤„ç†é€»è¾‘ã€‚å¸¸è§çš„ Trap åŸå› åŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨ã€å¼‚å¸¸å’Œä¸­æ–­ç­‰ã€‚åœ¨ <code>trap_handler</code> å‡½æ•°ä¸­ï¼Œä¼šæ ¹æ®ä¸åŒçš„ Trap åŸå› è¿›è¡Œåˆ†ç±»å¤„ç†ï¼Œå¦‚å¤„ç†ç³»ç»Ÿè°ƒç”¨æ—¶ä¼šæ ¹æ®ç³»ç»Ÿè°ƒç”¨å·æ‰§è¡Œç›¸åº”çš„æœåŠ¡å‡½æ•°ï¼Œå¤„ç†å¼‚å¸¸æ—¶ä¼šè¿›è¡Œé”™è¯¯å¤„ç†å’Œæ¢å¤ï¼Œå¤„ç†ä¸­æ–­æ—¶ä¼šè°ƒç”¨ç›¸åº”çš„ä¸­æ–­å¤„ç†å‡½æ•°ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">trap_handler</span>() <span class="hljs-punctuation">-&gt;</span> ! &#123;<br>    <span class="hljs-title function_ invoke__">set_kernel_trap_entry</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">scause</span> = scause::<span class="hljs-title function_ invoke__">read</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">stval</span> = stval::<span class="hljs-title function_ invoke__">read</span>();<br>    <span class="hljs-comment">// println!(&quot;into &#123;:?&#125;&quot;, scause.cause());</span><br>    <span class="hljs-keyword">match</span> scause.<span class="hljs-title function_ invoke__">cause</span>() &#123;<br>        Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::UserEnvCall) =&gt; &#123;<br>            <span class="hljs-title function_ invoke__">current_task</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">inner_exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">user_time_end</span>();<br>            <br>            <span class="hljs-comment">// jump to next instruction anyway</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cx</span> = <span class="hljs-title function_ invoke__">current_trap_cx</span>();<br>            cx.sepc += <span class="hljs-number">4</span>;<br><br>            <span class="hljs-title function_ invoke__">enable_supervisor_interrupt</span>();<br><br>            <span class="hljs-comment">// get system call return value</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">syscall</span>(cx.x[<span class="hljs-number">17</span>], [cx.x[<span class="hljs-number">10</span>], cx.x[<span class="hljs-number">11</span>], cx.x[<span class="hljs-number">12</span>]]);<br>            <span class="hljs-comment">// cx is changed during sys_exec, so we have to call it again</span><br>            cx = <span class="hljs-title function_ invoke__">current_trap_cx</span>();<br>            cx.x[<span class="hljs-number">10</span>] = result <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>;<br>        &#125;<br>        Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::StoreFault)<br>        | Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::StorePageFault)<br>        | Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::InstructionFault)<br>        | Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::InstructionPageFault)<br>        | Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::LoadFault)<br>        | Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::LoadPageFault) =&gt; &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            println!(</span><br><span class="hljs-comment">                &quot;[kernel] &#123;:?&#125; in application, bad addr = &#123;:#x&#125;, bad instruction = &#123;:#x&#125;, kernel killed it.&quot;,</span><br><span class="hljs-comment">                scause.cause(),</span><br><span class="hljs-comment">                stval,</span><br><span class="hljs-comment">                current_trap_cx().sepc,</span><br><span class="hljs-comment">            );</span><br><span class="hljs-comment">            */</span><br>            <span class="hljs-title function_ invoke__">current_add_signal</span>(SignalFlags::SIGSEGV);<br>        &#125;<br>        Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::IllegalInstruction) =&gt; &#123;<br>            <span class="hljs-title function_ invoke__">current_add_signal</span>(SignalFlags::SIGILL);<br>        &#125;<br>        Trap::<span class="hljs-title function_ invoke__">Interrupt</span>(Interrupt::SupervisorTimer) =&gt; &#123;<br>            <span class="hljs-title function_ invoke__">set_next_trigger</span>();<br>            <span class="hljs-title function_ invoke__">check_timer</span>();<br>            <span class="hljs-title function_ invoke__">suspend_current_and_run_next</span>();<br>        &#125;<br>        Trap::<span class="hljs-title function_ invoke__">Interrupt</span>(Interrupt::SupervisorExternal) =&gt; &#123;<br>            crate::board::<span class="hljs-title function_ invoke__">irq_handler</span>();<br>        &#125;<br>        _ =&gt; &#123;<br>            <span class="hljs-built_in">panic!</span>(<br>                <span class="hljs-string">&quot;Unsupported trap &#123;:?&#125;, stval = &#123;:#x&#125;!&quot;</span>,<br>                scause.<span class="hljs-title function_ invoke__">cause</span>(),<br>                stval<br>            );<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// check signals</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>((errno, msg)) = <span class="hljs-title function_ invoke__">check_signals_of_current</span>() &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[kernel] &#123;&#125;&quot;</span>, msg);<br>        <span class="hljs-title function_ invoke__">exit_current_and_run_next</span>(errno);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">trap_return</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡<code>match</code>è¯­å¥å®ç°ä¸­æ–­å‘é‡æŸ¥æ‰¾-åŒ¹é…-å¤„ç†ã€‚</p><h3 id="è·³æ¿-Trampoline"><a href="#è·³æ¿-Trampoline" class="headerlink" title="è·³æ¿(Trampoline)"></a>è·³æ¿(Trampoline)</h3><p>åœ¨ä¼ ç»Ÿçš„OSä¸­ï¼Œä¸€ä¸ªåº”ç”¨çš„ç”¨æˆ·å’Œå†…æ ¸æ€é€šå¸¸åˆ†é…åœ¨åŒä¸€ä¸ªåœ°å€ç©ºé—´çš„é«˜ä½å’Œä½ä½ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿åœ°ä½¿ç”¨æ ˆå¯„å­˜å™¨è¿›è¡Œè·³è½¬ã€‚ä½†æ˜¯ï¼Œè¿™æ ·åšä¼šæœ‰å†…æ ¸å·¥ä½œæµæ³„éœ²çš„é£é™©ã€‚æ‰€ä»¥éœ€è¦ä¸€ä¸ªè·³æ¿æ¥ä¿å­˜å·¥ä½œæµè°ƒç”¨è®¿é—®é“¾æ¡ã€‚</p><img src="C:\Users\Kid_A\AppData\Roaming\Typora\typora-user-images\image-20250530132531781.png" alt="image-20250530132531781" style="zoom: 50%;" /><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/mm/memory_set.rs</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">map_trampoline</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>    <span class="hljs-keyword">self</span>.page_table.<span class="hljs-title function_ invoke__">map</span>(<br>        VirtAddr::<span class="hljs-title function_ invoke__">from</span>(TRAMPOLINE).<span class="hljs-title function_ invoke__">into</span>(),<br>        PhysAddr::<span class="hljs-title function_ invoke__">from</span>(strampoline <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>        PTEFlags::R | PTEFlags::X,<br>    );<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡ŒæŠŠè™šæ‹Ÿåœ°å€çš„é«˜ä½éƒ½å›ºå®šæ˜ å°„åˆ°<code>trampoline</code>ã€‚</p><h3 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h3><p>åœ¨<strong>RISC-V</strong>é‡Œï¼Œç³»ç»Ÿè°ƒç”¨ä¸»è¦ç”±<code>ecall</code>å®ç°ã€‚å½“ç”¨æˆ·ç¨‹åºéœ€è¦æ‰§è¡Œç‰¹æƒæ“ä½œï¼Œå¦‚æ–‡ä»¶è¯»å†™ã€è¿›ç¨‹åˆ›å»ºã€å†…å­˜ç®¡ç†ç­‰æ—¶ï¼Œæ— æ³•ç›´æ¥è®¿é—®ç¡¬ä»¶èµ„æºï¼Œå¿…é¡»é€šè¿‡ <code>ecall</code> æŒ‡ä»¤è¯·æ±‚æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›æœåŠ¡ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// usr/src/syscall.rs</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">syscall</span>(id: <span class="hljs-type">usize</span>, args: [<span class="hljs-type">usize</span>; <span class="hljs-number">3</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ret</span>: <span class="hljs-type">isize</span>;<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        core::arch::asm!(<br>            <span class="hljs-string">&quot;ecall&quot;</span>,<br>            <span class="hljs-title function_ invoke__">inlateout</span>(<span class="hljs-string">&quot;x10&quot;</span>) args[<span class="hljs-number">0</span>] =&gt; ret,<br>            <span class="hljs-title function_ invoke__">in</span>(<span class="hljs-string">&quot;x11&quot;</span>) args[<span class="hljs-number">1</span>],<br>            <span class="hljs-title function_ invoke__">in</span>(<span class="hljs-string">&quot;x12&quot;</span>) args[<span class="hljs-number">2</span>],<br>            <span class="hljs-title function_ invoke__">in</span>(<span class="hljs-string">&quot;x17&quot;</span>) id<br>        );<br>    &#125;<br>    ret<br>&#125;<br><br><span class="hljs-comment">// os/src/trap/mod.rs</span><br>Trap::<span class="hljs-title function_ invoke__">Exception</span>(Exception::UserEnvCall) =&gt; &#123;<br>    <span class="hljs-title function_ invoke__">current_task</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">inner_exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">user_time_end</span>();    <br>    <span class="hljs-comment">// jump to next instruction anyway</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cx</span> = <span class="hljs-title function_ invoke__">current_trap_cx</span>();<br>    cx.sepc += <span class="hljs-number">4</span>;<br>    <span class="hljs-title function_ invoke__">enable_supervisor_interrupt</span>();<br>    <span class="hljs-comment">// get system call return value</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">syscall</span>(cx.x[<span class="hljs-number">17</span>], [cx.x[<span class="hljs-number">10</span>], cx.x[<span class="hljs-number">11</span>], cx.x[<span class="hljs-number">12</span>]]);<br>    <span class="hljs-comment">// cx is changed during sys_exec, so we have to call it again</span><br>    cx = <span class="hljs-title function_ invoke__">current_trap_cx</span>();<br>    cx.x[<span class="hljs-number">10</span>] = result <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>;<br>&#125;<br><br><span class="hljs-comment">// os/src/syscall/mod.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">syscall</span>(syscall_id: <span class="hljs-type">usize</span>, args: [<span class="hljs-type">usize</span>; <span class="hljs-number">3</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123;<br>    <span class="hljs-keyword">match</span> syscall_id &#123;<br>        SYSCALL_FSTAT =&gt; <span class="hljs-title function_ invoke__">sys_fstat</span>(args[<span class="hljs-number">0</span>], args[<span class="hljs-number">1</span>]),<br>        SYSCALL_GETCWD =&gt; <span class="hljs-title function_ invoke__">sys_getcwd</span>(args[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>, args[<span class="hljs-number">1</span>]),<br>        <span class="hljs-comment">// ...</span><br>        _ =&gt; <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Unsupported syscall_id: &#123;&#125;&quot;</span>, syscall_id),<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>syscall</code>é€šè¿‡<code>ecall</code>å‘èµ·<code>UserEnvCall</code>ï¼Œä¼ é€’å‡½æ•°å(æšä¸¾)å’Œå‚æ•°ï¼Œæ‰¾åˆ°å¹¶æ‰§è¡Œå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚</p><blockquote><p>ecall</p><ol><li>ç³»ç»Ÿè°ƒç”¨æ¥å£</li></ol><p><code>ecall</code> æŒ‡ä»¤çš„ä¸»è¦ç”¨é€”æ˜¯å®ç°<strong>ç³»ç»Ÿè°ƒç”¨</strong>ï¼ˆSystem Callï¼‰ã€‚å½“ç”¨æˆ·ç¨‹åºéœ€è¦æ‰§è¡Œç‰¹æƒæ“ä½œï¼ˆå¦‚æ–‡ä»¶è¯»å†™ã€è¿›ç¨‹åˆ›å»ºã€å†…å­˜ç®¡ç†ç­‰ï¼‰æ—¶ï¼Œæ— æ³•ç›´æ¥è®¿é—®ç¡¬ä»¶èµ„æºï¼Œå¿…é¡»é€šè¿‡ <code>ecall</code> æŒ‡ä»¤è¯·æ±‚æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›æœåŠ¡ã€‚</p><ol start="2"><li>ç‰¹æƒçº§åˆ‡æ¢</li></ol><ul><li><strong>ç”¨æˆ·æ¨¡å¼ï¼ˆU-modeï¼‰</strong>ï¼šç”¨æˆ·ç¨‹åºè¿è¡Œåœ¨æ­¤æ¨¡å¼ï¼Œæƒé™å—é™ï¼Œæ— æ³•ç›´æ¥è®¿é—®ç¡¬ä»¶æˆ–æ‰§è¡Œç‰¹æƒæŒ‡ä»¤ã€‚</li><li><strong>ç›‘ç®¡è€…æ¨¡å¼ï¼ˆS-modeï¼‰</strong>ï¼šæ“ä½œç³»ç»Ÿå†…æ ¸è¿è¡Œåœ¨æ­¤æ¨¡å¼ï¼Œæ‹¥æœ‰å®Œæ•´çš„ç¡¬ä»¶è®¿é—®æƒé™ã€‚</li><li><strong><code>ecall</code> çš„ä½œç”¨</strong>ï¼šå°†å¤„ç†å™¨ä» U-mode åˆ‡æ¢åˆ° S-modeï¼Œå¹¶è·³è½¬åˆ°å†…æ ¸é¢„å…ˆè®¾ç½®çš„<strong>é™·é˜±å¤„ç†ç¨‹åº</strong>ï¼ˆTrap Handlerï¼‰ã€‚</li></ul></blockquote><h2 id="åœ°å€ç©ºé—´ç®¡ç†"><a href="#åœ°å€ç©ºé—´ç®¡ç†" class="headerlink" title="åœ°å€ç©ºé—´ç®¡ç†"></a>åœ°å€ç©ºé—´ç®¡ç†</h2><p>OSéœ€è¦æä¾›è™šæ‹Ÿåœ°å€ï¼Œéœ€è¦è¿›è¡Œç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€çš„è½¬æ¢ï¼Œéœ€è¦åŠ¨æ€åˆ†é…åœ°å€ç©ºé—´ã€‚</p><h3 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h3><p>åœ¨PotatOSä¸­ï¼Œå†…å­˜ä¸»è¦ç”±<code>page, page table, frame</code>ç®¡ç†ã€‚</p><ul><li><strong>page</strong>ï¼šè™šæ‹Ÿå†…å­˜çš„å•ä½ï¼Œé€šå¸¸ä¸º 4KiBã€‚æ“ä½œç³»ç»Ÿå°†è™šæ‹Ÿåœ°å€ç©ºé—´åˆ’åˆ†ä¸ºå¤šä¸ªé¡µé¢ï¼Œæ–¹ä¾¿è¿›è¡Œå†…å­˜ç®¡ç†å’Œä¿æŠ¤ã€‚</li><li><strong>frame</strong>ï¼šç‰©ç†å†…å­˜çš„å•ä½ï¼Œä¹Ÿé€šå¸¸ä¸º 4KiBã€‚ç‰©ç†å†…å­˜è¢«åˆ’åˆ†ä¸ºå¤šä¸ªå¸§ï¼Œç”¨äºå­˜å‚¨é¡µé¢çš„æ•°æ®ã€‚</li><li><strong>page_table</strong>ï¼šè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢è¡¨ã€‚é€šè¿‡é¡µè¡¨ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥å°†è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œå®ç°è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜çš„åˆ†ç¦»ã€‚</li></ul><h3 id="å†…å­˜ç®¡ç†è€…æ¨¡å‹"><a href="#å†…å­˜ç®¡ç†è€…æ¨¡å‹" class="headerlink" title="å†…å­˜ç®¡ç†è€…æ¨¡å‹"></a>å†…å­˜ç®¡ç†è€…æ¨¡å‹</h3><p>æˆ‘ä»¬é€šè¿‡å›ºå®šåˆ†é…çš„<strong>HEAP_ALLOCATOR</strong>ä½œä¸ºå†…æ ¸çš„å †å­˜å‚¨ç©ºé—´ï¼Œ<strong>FRAME_ALLOCATOR</strong>ä½œä¸ºåŠ¨æ€åˆ†é…çš„æ ˆç©ºé—´ã€‚ä»–ä»¬åˆ†åˆ«ä»åœ°å€ç©ºé—´çš„å¼€å§‹&#x2F;ç»“å°¾åˆ†é…å†…å­˜ã€‚</p><h5 id="HEAP-ALLOCATOR"><a href="#HEAP-ALLOCATOR" class="headerlink" title="HEAP-ALLOCATOR"></a>HEAP-ALLOCATOR</h5><p>ç®€å•åœ°ä½¿ç”¨ä¸€æ®µæ•°ç»„æ¥åˆ†é…æ•°æ®</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[global_allocator]</span><br><span class="hljs-keyword">static</span> HEAP_ALLOCATOR: LockedHeap = LockedHeap::<span class="hljs-title function_ invoke__">empty</span>();<br><br><span class="hljs-meta">#[alloc_error_handler]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle_alloc_error</span>(layout: core::alloc::Layout) <span class="hljs-punctuation">-&gt;</span> ! &#123;<br>    <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Heap allocation error, layout = &#123;:?&#125;&quot;</span>, layout);<br>&#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">mut</span> HEAP_SPACE: [<span class="hljs-type">u8</span>; KERNEL_HEAP_SIZE] = [<span class="hljs-number">0</span>; KERNEL_HEAP_SIZE];<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init_heap</span>() &#123;<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        HEAP_ALLOCATOR<br>            .<span class="hljs-title function_ invoke__">lock</span>()<br>            .<span class="hljs-title function_ invoke__">init</span>(HEAP_SPACE.<span class="hljs-title function_ invoke__">as_ptr</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, KERNEL_HEAP_SIZE);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li><code>HEAP_ALLOCATOR</code>ï¼šå…¨å±€å †åˆ†é…å™¨ï¼Œç”¨äºç®¡ç†å†…æ ¸çš„å †å†…å­˜ã€‚</li><li><code>handle_alloc_error</code>ï¼šå †åˆ†é…é”™è¯¯å¤„ç†å‡½æ•°ï¼Œå½“å †åˆ†é…å¤±è´¥æ—¶ä¼šè§¦å‘è¯¥å‡½æ•°ã€‚</li><li><code>HEAP_SPACE</code>ï¼šå †å†…å­˜ç©ºé—´ï¼Œæ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„æ•°ç»„ã€‚</li><li><code>init_heap</code>ï¼šåˆå§‹åŒ–å †åˆ†é…å™¨ï¼Œå°†å †å†…å­˜ç©ºé—´çš„èµ·å§‹åœ°å€å’Œå¤§å°ä¼ é€’ç»™å †åˆ†é…å™¨ã€‚</li></ul><h5 id="FRAME-ALLOCATOR"><a href="#FRAME-ALLOCATOR" class="headerlink" title="FRAME_ALLOCATOR"></a>FRAME_ALLOCATOR</h5><p>ä½¿ç”¨ç®€å•çš„<strong>åŒæŒ‡é’ˆæ ‡è®°</strong>ï¼Œé¡ºåºéå†æ¥åˆ†é…ç‰©ç†é¡µå¸§ã€‚è®¾ç½®äº†å…¨å±€é™æ€<code>FRAME_ALLOCATOR</code>æ¥åŒ…è£…å¹¶åˆ†é…ã€‚</p><p><strong>ekernel</strong>è¡¨ç¤ºæ•°æ®æ®µçš„ç»“å°¾ã€‚å°½ç®¡å½¢å¼ä¸Šæ˜¯è¿™æ ·çš„ï¼Œæˆ‘è¿˜æ˜¯å€¾å‘äºæ ˆç”±é«˜ä½å‘ä½ä½åˆ†é…ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">StackFrameAllocator</span> &#123;<br>    current: <span class="hljs-type">usize</span>,<br>    end: <span class="hljs-type">usize</span>,<br>    recycled: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">usize</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">StackFrameAllocator</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, l: PhysPageNum, r: PhysPageNum) &#123;<br>        <span class="hljs-keyword">self</span>.current = l.<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">self</span>.end = r.<span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">FrameAllocator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">StackFrameAllocator</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123;<br>            current: <span class="hljs-number">0</span>,<br>            end: <span class="hljs-number">0</span>,<br>            recycled: <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>(),<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">alloc</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;PhysPageNum&gt; &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(ppn) = <span class="hljs-keyword">self</span>.recycled.<span class="hljs-title function_ invoke__">pop</span>() &#123;<br>            <span class="hljs-title function_ invoke__">Some</span>(ppn.<span class="hljs-title function_ invoke__">into</span>())<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.current == <span class="hljs-keyword">self</span>.end &#123;<br>            <span class="hljs-literal">None</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">self</span>.current += <span class="hljs-number">1</span>;<br>            <span class="hljs-title function_ invoke__">Some</span>((<span class="hljs-keyword">self</span>.current - <span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">into</span>())<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">alloc_more</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, pages: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">Vec</span>&lt;PhysPageNum&gt;&gt; &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.current + pages &gt;= <span class="hljs-keyword">self</span>.end &#123;<br>            <span class="hljs-literal">None</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">self</span>.current += pages;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">arr</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">usize</span>&gt; = (<span class="hljs-number">1</span>..pages + <span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">collect</span>();<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">v</span> = arr.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">map</span>(|x| (<span class="hljs-keyword">self</span>.current - x).<span class="hljs-title function_ invoke__">into</span>()).<span class="hljs-title function_ invoke__">collect</span>();<br>            <span class="hljs-title function_ invoke__">Some</span>(v)<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">dealloc</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, ppn: PhysPageNum) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">ppn</span> = ppn.<span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// validity check</span><br>        <span class="hljs-keyword">if</span> ppn &gt;= <span class="hljs-keyword">self</span>.current || <span class="hljs-keyword">self</span>.recycled.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">any</span>(|&amp;v| v == ppn) &#123;<br>            <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Frame ppn=&#123;:#x&#125; has not been allocated!&quot;</span>, ppn);<br>        &#125;<br>        <span class="hljs-comment">// recycle</span><br>        <span class="hljs-keyword">self</span>.recycled.<span class="hljs-title function_ invoke__">push</span>(ppn);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">FrameAllocatorImpl</span> = StackFrameAllocator;<br><br>lazy_static! &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">ref</span> FRAME_ALLOCATOR: UPIntrFreeCell&lt;FrameAllocatorImpl&gt; =<br>        <span class="hljs-keyword">unsafe</span> &#123; UPIntrFreeCell::<span class="hljs-title function_ invoke__">new</span>(FrameAllocatorImpl::<span class="hljs-title function_ invoke__">new</span>()) &#125;;<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init_frame_allocator</span>() &#123;<br>    <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123;<br>        <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ekernel</span>();<br>    &#125;<br>    FRAME_ALLOCATOR.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">init</span>(<br>        PhysAddr::<span class="hljs-title function_ invoke__">from</span>(ekernel <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">ceil</span>(),<br>        PhysAddr::<span class="hljs-title function_ invoke__">from</span>(MEMORY_END).<span class="hljs-title function_ invoke__">floor</span>(),<br>    );<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">frame_alloc</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;FrameTracker&gt; &#123;<br>    FRAME_ALLOCATOR<br>        .<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>())<br>        .<span class="hljs-title function_ invoke__">alloc</span>()<br>        .<span class="hljs-title function_ invoke__">map</span>(FrameTracker::new)<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">frame_alloc_more</span>(num: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">Vec</span>&lt;FrameTracker&gt;&gt; &#123;<br>    FRAME_ALLOCATOR<br>        .<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>())<br>        .<span class="hljs-title function_ invoke__">alloc_more</span>(num)<br>        .<span class="hljs-title function_ invoke__">map</span>(|x| x.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">map</span>(|&amp;t| FrameTracker::<span class="hljs-title function_ invoke__">new</span>(t)).<span class="hljs-title function_ invoke__">collect</span>())<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">frame_dealloc</span>(ppn: PhysPageNum) &#123;<br>    FRAME_ALLOCATOR.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">dealloc</span>(ppn);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>StackFrameAllocator</code>ï¼šæ ˆå¸§åˆ†é…å™¨ï¼Œä½¿ç”¨åŒæŒ‡é’ˆæ ‡è®°å’Œå›æ”¶æœºåˆ¶æ¥ç®¡ç†ç‰©ç†é¡µå¸§ã€‚</li><li><code>init</code>ï¼šåˆå§‹åŒ–æ ˆå¸§åˆ†é…å™¨ï¼Œè®¾ç½®èµ·å§‹å’Œç»“æŸåœ°å€ã€‚</li><li><code>alloc</code>ï¼šåˆ†é…ä¸€ä¸ªç‰©ç†é¡µå¸§ã€‚å¦‚æœæœ‰å›æ”¶çš„é¡µå¸§ï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨ï¼›å¦åˆ™ï¼Œä»å½“å‰ä½ç½®åˆ†é…ä¸€ä¸ªæ–°çš„é¡µå¸§ã€‚</li><li><code>alloc_more</code>ï¼šåˆ†é…å¤šä¸ªç‰©ç†é¡µå¸§ã€‚</li><li><code>dealloc</code>ï¼šé‡Šæ”¾ä¸€ä¸ªç‰©ç†é¡µå¸§ï¼Œå¹¶å°†å…¶åŠ å…¥å›æ”¶åˆ—è¡¨ã€‚</li><li><code>FRAME_ALLOCATOR</code>ï¼šå…¨å±€å¸§åˆ†é…å™¨ï¼Œä½¿ç”¨ <code>lazy_static</code> è¿›è¡Œé™æ€åˆå§‹åŒ–ã€‚</li><li><code>init_frame_allocator</code>ï¼šåˆå§‹åŒ–å¸§åˆ†é…å™¨ï¼Œè®¾ç½®åˆ†é…èŒƒå›´ã€‚</li><li><code>frame_alloc</code>ï¼šåˆ†é…ä¸€ä¸ªå¸§ï¼Œå¹¶è¿”å›ä¸€ä¸ª <code>FrameTracker</code> å¯¹è±¡ã€‚</li><li><code>frame_alloc_more</code>ï¼šåˆ†é…å¤šä¸ªå¸§ï¼Œå¹¶è¿”å›ä¸€ä¸ª <code>FrameTracker</code> å¯¹è±¡çš„å‘é‡ã€‚</li><li><code>frame_dealloc</code>ï¼šé‡Šæ”¾ä¸€ä¸ªå¸§ã€‚</li></ul><h3 id="å¤šçº§é¡µè¡¨ç®¡ç†åœ°å€ç©ºé—´-SV39"><a href="#å¤šçº§é¡µè¡¨ç®¡ç†åœ°å€ç©ºé—´-SV39" class="headerlink" title="å¤šçº§é¡µè¡¨ç®¡ç†åœ°å€ç©ºé—´(SV39)"></a>å¤šçº§é¡µè¡¨ç®¡ç†åœ°å€ç©ºé—´(SV39)</h3><h4 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h4><p>æˆ‘ä»¬å¸Œæœ›å®ç°ç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€çš„è½¬æ¢å’Œåˆ†é¡µç®¡ç†åœ°å€ç©ºé—´ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæ ‡å‡†ã€‚åŸºäºSV39å®ç°çš„åœ°å€ç¬¦åˆä»¥ä¸‹è¦æ±‚ã€‚</p><p><strong>åœ°å€æ ¼å¼</strong></p><p><img src="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/sv39-va-pa.png" alt="..&#x2F;_images&#x2F;sv39-va-pa.png"></p><p><strong>é¡µè¡¨æ ¼å¼</strong></p><p><img src="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/sv39-pte.png" alt="..&#x2F;_images&#x2F;sv39-pte.png"></p><p>å¯ä»¥å‘ç°æˆ‘ä»¬åˆ’åˆ†äº† 4KiB å¤§å°çš„ page ç”¨äºå¯¹é½ã€‚SV39 æ˜¯ RISC-V æ¶æ„ä¸­çš„ä¸€ç§é¡µè¡¨æœºåˆ¶ï¼Œå®ƒå°† 39 ä½çš„è™šæ‹Ÿåœ°å€åˆ’åˆ†ä¸ºä¸‰ä¸ª 9 ä½çš„è™šæ‹Ÿé¡µå·å’Œ 12 ä½çš„é¡µå†…åç§»ï¼Œå°† 56 ä½çš„ç‰©ç†åœ°å€åˆ’åˆ†ä¸ºç‰©ç†é¡µå·å’Œé¡µå†…åç§»ã€‚é€šè¿‡å¤šçº§é¡µè¡¨çš„æ–¹å¼ï¼Œå®ç°è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢ã€‚</p><h4 id="Address"><a href="#Address" class="headerlink" title="Address"></a>Address</h4><p>æŒ‰ç…§æ ‡å‡†å®ç°äº†åœ°å€çš„åŒ…è£…ï¼ŒåŒ…æ‹¬åœ°å€ä¹‹é—´çš„è½¬æ¢ï¼Œpageå†…bitsçš„è¯»å–ç­‰ç­‰</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/mm/address.rs</span><br><span class="hljs-keyword">const</span> PA_WIDTH_SV39: <span class="hljs-type">usize</span> = <span class="hljs-number">56</span>;<br><span class="hljs-keyword">const</span> VA_WIDTH_SV39: <span class="hljs-type">usize</span> = <span class="hljs-number">39</span>;<br><span class="hljs-comment">/// PAGE_SIZE_BITS = 0x12(4KiB)</span><br><span class="hljs-keyword">const</span> PPN_WIDTH_SV39: <span class="hljs-type">usize</span> = PA_WIDTH_SV39 - PAGE_SIZE_BITS;<br><span class="hljs-keyword">const</span> VPN_WIDTH_SV39: <span class="hljs-type">usize</span> = VA_WIDTH_SV39 - PAGE_SIZE_BITS;<br><br><span class="hljs-comment">/// Definitions</span><br><span class="hljs-meta">#[repr(C)]</span><br><span class="hljs-meta">#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PhysAddr</span>(<span class="hljs-keyword">pub</span> <span class="hljs-type">usize</span>);<br><br><span class="hljs-meta">#[repr(C)]</span><br><span class="hljs-meta">#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VirtAddr</span>(<span class="hljs-keyword">pub</span> <span class="hljs-type">usize</span>);<br><br><span class="hljs-meta">#[repr(C)]</span><br><span class="hljs-meta">#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PhysPageNum</span>(<span class="hljs-keyword">pub</span> <span class="hljs-type">usize</span>);<br><br><span class="hljs-meta">#[repr(C)]</span><br><span class="hljs-meta">#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VirtPageNum</span>(<span class="hljs-keyword">pub</span> <span class="hljs-type">usize</span>);<br><br><span class="hljs-comment">/// Debugging</span><br><span class="hljs-comment">/// ...</span><br><br><span class="hljs-comment">/// T: &#123;PhysAddr, VirtAddr, PhysPageNum, VirtPageNum&#125;</span><br><span class="hljs-comment">/// T -&gt; usize: T.0</span><br><span class="hljs-comment">/// usize -&gt; T: usize.into()</span><br><br><span class="hljs-comment">/// transformations of addresses</span><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">usize</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">PhysAddr</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Self</span>(v &amp; ((<span class="hljs-number">1</span> &lt;&lt; PA_WIDTH_SV39) - <span class="hljs-number">1</span>))<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">usize</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">PhysPageNum</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Self</span>(v &amp; ((<span class="hljs-number">1</span> &lt;&lt; PPN_WIDTH_SV39) - <span class="hljs-number">1</span>))<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">usize</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">VirtAddr</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Self</span>(v &amp; ((<span class="hljs-number">1</span> &lt;&lt; VA_WIDTH_SV39) - <span class="hljs-number">1</span>))<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;<span class="hljs-type">usize</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">VirtPageNum</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Self</span>(v &amp; ((<span class="hljs-number">1</span> &lt;&lt; VPN_WIDTH_SV39) - <span class="hljs-number">1</span>))<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;PhysAddr&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">usize</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: PhysAddr) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        v.<span class="hljs-number">0</span><br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;PhysPageNum&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">usize</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: PhysPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        v.<span class="hljs-number">0</span><br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;VirtAddr&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">usize</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: VirtAddr) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">if</span> v.<span class="hljs-number">0</span> &gt;= (<span class="hljs-number">1</span> &lt;&lt; (VA_WIDTH_SV39 - <span class="hljs-number">1</span>)) &#123;<br>            v.<span class="hljs-number">0</span> | (!((<span class="hljs-number">1</span> &lt;&lt; VA_WIDTH_SV39) - <span class="hljs-number">1</span>))<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            v.<span class="hljs-number">0</span><br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;VirtPageNum&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">usize</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: VirtPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        v.<span class="hljs-number">0</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/// get page num by address</span><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">VirtAddr</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">floor</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> VirtPageNum &#123;<br>        <span class="hljs-title function_ invoke__">VirtPageNum</span>(<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> / PAGE_SIZE)<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ceil</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> VirtPageNum &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-title function_ invoke__">VirtPageNum</span>(<span class="hljs-number">0</span>)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-title function_ invoke__">VirtPageNum</span>((<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> - <span class="hljs-number">1</span> + PAGE_SIZE) / PAGE_SIZE)<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">page_offset</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> &amp; (PAGE_SIZE - <span class="hljs-number">1</span>)<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">aligned</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span> &#123;<br>        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">page_offset</span>() == <span class="hljs-number">0</span><br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;VirtAddr&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">VirtPageNum</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: VirtAddr) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-built_in">assert_eq!</span>(v.<span class="hljs-title function_ invoke__">page_offset</span>(), <span class="hljs-number">0</span>);<br>        v.<span class="hljs-title function_ invoke__">floor</span>()<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;VirtPageNum&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">VirtAddr</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: VirtPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Self</span>(v.<span class="hljs-number">0</span> &lt;&lt; PAGE_SIZE_BITS)<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">PhysAddr</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">floor</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> PhysPageNum &#123;<br>        <span class="hljs-title function_ invoke__">PhysPageNum</span>(<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> / PAGE_SIZE)<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ceil</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> PhysPageNum &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-title function_ invoke__">PhysPageNum</span>(<span class="hljs-number">0</span>)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-title function_ invoke__">PhysPageNum</span>((<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> - <span class="hljs-number">1</span> + PAGE_SIZE) / PAGE_SIZE)<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">page_offset</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> &amp; (PAGE_SIZE - <span class="hljs-number">1</span>)<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">aligned</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span> &#123;<br>        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">page_offset</span>() == <span class="hljs-number">0</span><br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;PhysAddr&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">PhysPageNum</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: PhysAddr) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-built_in">assert_eq!</span>(v.<span class="hljs-title function_ invoke__">page_offset</span>(), <span class="hljs-number">0</span>);<br>        v.<span class="hljs-title function_ invoke__">floor</span>()<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">From</span>&lt;PhysPageNum&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">PhysAddr</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from</span>(v: PhysPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-title function_ invoke__">Self</span>(v.<span class="hljs-number">0</span> &lt;&lt; PAGE_SIZE_BITS)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">VirtPageNum</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">indexes</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> [<span class="hljs-type">usize</span>; <span class="hljs-number">3</span>] &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">vpn</span> = <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">idx</span> = [<span class="hljs-number">0usize</span>; <span class="hljs-number">3</span>];<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> (<span class="hljs-number">0</span>..<span class="hljs-number">3</span>).<span class="hljs-title function_ invoke__">rev</span>() &#123;<br>            idx[i] = vpn &amp; <span class="hljs-number">511</span>;<br>            vpn &gt;&gt;= <span class="hljs-number">9</span>;<br>        &#125;<br>        idx<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">PhysAddr</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_ref</span>&lt;T&gt;(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> T &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123; (<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> T).<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>() &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_mut</span>&lt;T&gt;(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> T &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123; (<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> T).<span class="hljs-title function_ invoke__">as_mut</span>().<span class="hljs-title function_ invoke__">unwrap</span>() &#125;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">PhysPageNum</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_pte_array</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> [PageTableEntry] &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pa</span>: PhysAddr = (*<span class="hljs-keyword">self</span>).<span class="hljs-title function_ invoke__">into</span>();<br>        <span class="hljs-keyword">unsafe</span> &#123; core::slice::<span class="hljs-title function_ invoke__">from_raw_parts_mut</span>(pa.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> PageTableEntry, <span class="hljs-number">512</span>) &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_bytes_array</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>] &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pa</span>: PhysAddr = (*<span class="hljs-keyword">self</span>).<span class="hljs-title function_ invoke__">into</span>();<br>        <span class="hljs-keyword">unsafe</span> &#123; core::slice::<span class="hljs-title function_ invoke__">from_raw_parts_mut</span>(pa.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>, <span class="hljs-number">4096</span>) &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_mut</span>&lt;T&gt;(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> T &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pa</span>: PhysAddr = (*<span class="hljs-keyword">self</span>).<span class="hljs-title function_ invoke__">into</span>();<br>        pa.<span class="hljs-title function_ invoke__">get_mut</span>()<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>PhysAddr</code>ï¼šç‰©ç†åœ°å€ç»“æ„ä½“ï¼ŒåŒ…è£…äº†ä¸€ä¸ª <code>usize</code> ç±»å‹çš„ç‰©ç†åœ°å€ã€‚</li><li><code>VirtAddr</code>ï¼šè™šæ‹Ÿåœ°å€ç»“æ„ä½“ï¼ŒåŒ…è£…äº†ä¸€ä¸ª <code>usize</code> ç±»å‹çš„è™šæ‹Ÿåœ°å€ã€‚</li><li><code>PhysPageNum</code>ï¼šç‰©ç†é¡µå·ç»“æ„ä½“ï¼ŒåŒ…è£…äº†ä¸€ä¸ª <code>usize</code> ç±»å‹çš„ç‰©ç†é¡µå·ã€‚</li><li><code>VirtPageNum</code>ï¼šè™šæ‹Ÿé¡µå·ç»“æ„ä½“ï¼ŒåŒ…è£…äº†ä¸€ä¸ª <code>usize</code> ç±»å‹çš„è™šæ‹Ÿé¡µå·ã€‚</li><li><code>From</code> å®ç°ï¼šæä¾›äº†ä» <code>usize</code> ç±»å‹åˆ°å„ç§åœ°å€å’Œé¡µå·ç±»å‹çš„è½¬æ¢ã€‚</li><li><code>From</code>ã€<code>From</code>ã€<code>From</code>ã€<code>From</code> å®ç°ï¼šæä¾›äº†ä»å„ç§åœ°å€å’Œé¡µå·ç±»å‹åˆ° <code>usize</code> ç±»å‹çš„è½¬æ¢ã€‚</li><li><code>VirtAddr</code> å’Œ <code>PhysAddr</code> çš„æ–¹æ³•ï¼šæä¾›äº†è·å–é¡µå·ã€é¡µå†…åç§»ã€åˆ¤æ–­å¯¹é½ç­‰åŠŸèƒ½ã€‚</li><li><code>VirtPageNum</code> çš„ <code>indexes</code> æ–¹æ³•ï¼šå°†è™šæ‹Ÿé¡µå·æ‹†åˆ†ä¸ºä¸‰ä¸ª 9 ä½çš„ç´¢å¼•ã€‚</li><li><code>PhysAddr</code> å’Œ <code>PhysPageNum</code> çš„æ–¹æ³•ï¼šæä¾›äº†è·å–å¼•ç”¨ã€ä¿®æ”¹å¼•ç”¨ã€è·å–é¡µè¡¨é¡¹æ•°ç»„ç­‰åŠŸèƒ½ã€‚</li></ul><h4 id="PageTable"><a href="#PageTable" class="headerlink" title="PageTable"></a>PageTable</h4><h5 id="æ¦‚å¿µ-1"><a href="#æ¦‚å¿µ-1" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h5><p><strong>PageTable</strong>ä¸»è¦è´Ÿè´£è½¬æ¢è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ã€‚SV39æœ‰ä¸‰çº§é¡µè¡¨æœºåˆ¶ï¼Œéœ€è¦ç®€å•çš„å¾ªç¯å’Œæ ‡è®°ä½éªŒè¯è§£å†³é—®é¢˜ã€‚ä»¥ä¸‹ä¸º<strong>xv6</strong>é¡µè¡¨å˜æ¢ç¤ºæ„å›¾ï¼ŒåŒç†ã€‚</p><p><img src="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/sv39-full.png" alt="..&#x2F;_images&#x2F;sv39-full.png"></p><p>åœ¨ SV39 æ¨¡å¼ä¸­æˆ‘ä»¬é‡‡ç”¨ä¸‰çº§é¡µè¡¨ï¼Œå³å°† 27 ä½çš„è™šæ‹Ÿé¡µå·åˆ†ä¸ºä¸‰ä¸ªç­‰é•¿çš„éƒ¨åˆ†ï¼Œç¬¬ 26-18 ä½ä¸ºä¸€çº§é¡µç´¢å¼• <strong>VPN0</strong> ï¼Œç¬¬ 17-9 ä½ä¸ºäºŒçº§é¡µç´¢å¼• <strong>VPN1</strong> ï¼Œç¬¬ 8-0 ä½ä¸ºä¸‰çº§é¡µç´¢å¼• <strong>VPN2</strong> ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå°†é¡µè¡¨åˆ†ä¸ºä¸€çº§é¡µè¡¨ï¼ˆå¤šçº§é¡µè¡¨çš„æ ¹èŠ‚ç‚¹ï¼‰ï¼ŒäºŒçº§é¡µè¡¨ï¼Œä¸‰çº§é¡µè¡¨ï¼ˆå¤šçº§é¡µè¡¨çš„å¶èŠ‚ç‚¹ï¼‰ã€‚æ¯ä¸ªé¡µè¡¨éƒ½ç”¨ 9 ä½ç´¢å¼•ï¼Œå› æ­¤æœ‰ 29&#x3D;512 ä¸ªé¡µè¡¨é¡¹ï¼Œè€Œæ¯ä¸ªé¡µè¡¨é¡¹éƒ½æ˜¯ 8 å­—èŠ‚ï¼Œå› æ­¤æ¯ä¸ªé¡µè¡¨å¤§å°éƒ½ä¸º 512Ã—8&#x3D;4KiB ã€‚æ­£å¥½æ˜¯ä¸€ä¸ªç‰©ç†é¡µçš„å¤§å°ã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¸€ä¸ªé¡µè¡¨æ”¾åˆ°ä¸€ä¸ªç‰©ç†é¡µä¸­ï¼Œå¹¶ç”¨ä¸€ä¸ªç‰©ç†é¡µå·æ¥æè¿°å®ƒã€‚äº‹å®ä¸Šï¼Œä¸€çº§é¡µè¡¨çš„æ¯ä¸ªé¡µè¡¨é¡¹ä¸­çš„ç‰©ç†é¡µå·å¯æè¿°ä¸€ä¸ªäºŒçº§é¡µè¡¨ï¼›äºŒçº§é¡µè¡¨çš„æ¯ä¸ªé¡µè¡¨é¡¹ä¸­çš„ç‰©ç†é¡µå·å¯æè¿°ä¸€ä¸ªä¸‰çº§é¡µè¡¨ï¼›ä¸‰çº§é¡µè¡¨ä¸­çš„é¡µè¡¨é¡¹å†…å®¹åˆ™å’Œæˆ‘ä»¬åˆšæ‰æåˆ°çš„é¡µè¡¨é¡¹ä¸€æ ·ï¼Œå…¶å†…å®¹åŒ…å«ç‰©ç†é¡µå·ï¼Œå³æè¿°ä¸€ä¸ªè¦æ˜ å°„åˆ°çš„ç‰©ç†é¡µã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œå‡è®¾æˆ‘ä»¬æœ‰è™šæ‹Ÿåœ°å€ (VPN0,VPN1,VPN2,offset) ï¼š</p><ul><li>æˆ‘ä»¬é¦–å…ˆä¼šè®°å½•è£…è½½ã€Œå½“å‰æ‰€ç”¨çš„ä¸€çº§é¡µè¡¨çš„ç‰©ç†é¡µã€çš„é¡µå·åˆ° satp å¯„å­˜å™¨ä¸­ï¼›</li><li>æŠŠ VPN0 ä½œä¸ºåç§»åœ¨ä¸€çº§é¡µè¡¨çš„ç‰©ç†é¡µä¸­æ‰¾åˆ°äºŒçº§é¡µè¡¨çš„ç‰©ç†é¡µå·ï¼›</li><li>æŠŠ VPN1 ä½œä¸ºåç§»åœ¨äºŒçº§é¡µè¡¨çš„ç‰©ç†é¡µä¸­æ‰¾åˆ°ä¸‰çº§é¡µè¡¨çš„ç‰©ç†é¡µå·ï¼›</li><li>æŠŠ VPN2 ä½œä¸ºåç§»åœ¨ä¸‰çº§é¡µè¡¨çš„ç‰©ç†é¡µä¸­æ‰¾åˆ°è¦è®¿é—®ä½ç½®çš„ç‰©ç†é¡µå·ï¼›</li><li>ç‰©ç†é¡µå·å¯¹åº”çš„ç‰©ç†é¡µåŸºå€ï¼ˆå³ç‰©ç†é¡µå·å·¦ç§»12ä½ï¼‰åŠ ä¸Š offset å°±æ˜¯è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€ã€‚</li></ul><p>è¿™æ ·å¤„ç†å™¨é€šè¿‡è¿™ç§å¤šæ¬¡è½¬æ¢ï¼Œç»ˆäºä»è™šæ‹Ÿé¡µå·æ‰¾åˆ°äº†ä¸€çº§é¡µè¡¨é¡¹ï¼Œä»è€Œå¾—å‡ºäº†ç‰©ç†é¡µå·å’Œè™šæ‹Ÿåœ°å€æ‰€å¯¹åº”çš„ç‰©ç†åœ°å€ã€‚åˆšæ‰æˆ‘ä»¬æåˆ°è‹¥é¡µè¡¨é¡¹æ»¡è¶³ R,W,X éƒ½ä¸º 0ï¼Œè¡¨æ˜è¿™ä¸ªé¡µè¡¨é¡¹æŒ‡å‘ä¸‹ä¸€çº§é¡µè¡¨ã€‚åœ¨è¿™é‡Œä¸€çº§å’ŒäºŒçº§é¡µè¡¨é¡¹çš„ R,W,X ä¸º 0 åº”è¯¥æˆç«‹ï¼Œå› ä¸ºå®ƒä»¬æŒ‡å‘äº†ä¸‹ä¸€çº§é¡µè¡¨ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/mm/page_table.rs</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">find_pte_create</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, vpn: VirtPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;&amp;<span class="hljs-keyword">mut</span> PageTableEntry&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">idxs</span> = vpn.<span class="hljs-title function_ invoke__">indexes</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ppn</span> = <span class="hljs-keyword">self</span>.root_ppn;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">result</span>: <span class="hljs-type">Option</span>&lt;&amp;<span class="hljs-keyword">mut</span> PageTableEntry&gt; = <span class="hljs-literal">None</span>;<br>    <span class="hljs-keyword">for</span> (i, idx) <span class="hljs-keyword">in</span> idxs.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pte</span> = &amp;<span class="hljs-keyword">mut</span> ppn.<span class="hljs-title function_ invoke__">get_pte_array</span>()[*idx];<br>        <span class="hljs-keyword">if</span> i == <span class="hljs-number">2</span> &#123;<br>            result = <span class="hljs-title function_ invoke__">Some</span>(pte);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> !pte.<span class="hljs-title function_ invoke__">is_valid</span>() &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">frame</span> = <span class="hljs-title function_ invoke__">frame_alloc</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>            *pte = PageTableEntry::<span class="hljs-title function_ invoke__">new</span>(frame.ppn, PTEFlags::V);<br>            <span class="hljs-keyword">self</span>.frames.<span class="hljs-title function_ invoke__">push</span>(frame);<br>        &#125;<br>        ppn = pte.<span class="hljs-title function_ invoke__">ppn</span>();<br>    &#125;<br>    result<br>&#125;<br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">find_pte</span>(&amp;<span class="hljs-keyword">self</span>, vpn: VirtPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;&amp;<span class="hljs-keyword">mut</span> PageTableEntry&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">idxs</span> = vpn.<span class="hljs-title function_ invoke__">indexes</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ppn</span> = <span class="hljs-keyword">self</span>.root_ppn;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">result</span>: <span class="hljs-type">Option</span>&lt;&amp;<span class="hljs-keyword">mut</span> PageTableEntry&gt; = <span class="hljs-literal">None</span>;<br>    <span class="hljs-keyword">for</span> (i, idx) <span class="hljs-keyword">in</span> idxs.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pte</span> = &amp;<span class="hljs-keyword">mut</span> ppn.<span class="hljs-title function_ invoke__">get_pte_array</span>()[*idx];<br>        <span class="hljs-keyword">if</span> i == <span class="hljs-number">2</span> &#123;<br>            result = <span class="hljs-title function_ invoke__">Some</span>(pte);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> !pte.<span class="hljs-title function_ invoke__">is_valid</span>() &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>;<br>        &#125;<br>        ppn = pte.<span class="hljs-title function_ invoke__">ppn</span>();<br>    &#125;<br>    result<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>find_pte_create</code>ï¼šæŸ¥æ‰¾å¹¶åˆ›å»ºé¡µè¡¨é¡¹ã€‚å¦‚æœé¡µè¡¨é¡¹ä¸å­˜åœ¨ï¼Œåˆ™åˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†é¡µå¸§ï¼Œå¹¶åˆ›å»ºé¡µè¡¨é¡¹ã€‚</li><li><code>find_pte</code>ï¼šæŸ¥æ‰¾é¡µè¡¨é¡¹ã€‚å¦‚æœé¡µè¡¨é¡¹ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› <code>None</code>ã€‚</li></ul><h5 id="æ˜ å°„"><a href="#æ˜ å°„" class="headerlink" title="æ˜ å°„"></a>æ˜ å°„</h5><p>æ¯ä¸ªè¿›ç¨‹æœ‰è‡ªå·±çš„è™šæ‹Ÿåœ°å€ï¼Œæ˜ å°„åˆ°ä¸åŒçš„ç‰©ç†åœ°å€ä¸­ã€‚éœ€è¦ç”¨é¡µè¡¨è¿›è¡Œæ˜ å°„&#x2F;å–æ¶ˆæ˜ å°„å’Œç‰©ç†åœ°å€&#x2F;è™šæ‹Ÿåœ°å€çš„è½¬æ¢ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨æœ€ç®€å•çš„æ’ç­‰æ˜ å°„ï¼Œå³<code>ppn=vpn</code>çš„æ–¹å¼æ˜ å°„ã€‚</p><p>åŒæ—¶ï¼Œä¸ºäº†åŒºåˆ†æ¯ä¸ªè¿›ç¨‹çš„é¡µè¡¨ï¼Œä½¿ç”¨<code>Token</code>åˆ†è¾¨é¡µè¡¨ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/mm/page_table.rs</span><br><span class="hljs-meta">#[allow(unused)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">map</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, vpn: VirtPageNum, ppn: PhysPageNum, flags: PTEFlags) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pte</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">find_pte_create</span>(vpn).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-built_in">assert!</span>(!pte.<span class="hljs-title function_ invoke__">is_valid</span>(), <span class="hljs-string">&quot;vpn &#123;:?&#125; is mapped before mapping&quot;</span>, vpn);<br>    *pte = PageTableEntry::<span class="hljs-title function_ invoke__">new</span>(ppn, flags | PTEFlags::V);<br>&#125;<br><span class="hljs-meta">#[allow(unused)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">unmap</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, vpn: VirtPageNum) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pte</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">find_pte</span>(vpn).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-built_in">assert!</span>(pte.<span class="hljs-title function_ invoke__">is_valid</span>(), <span class="hljs-string">&quot;vpn &#123;:?&#125; is invalid before unmapping&quot;</span>, vpn);<br>    *pte = PageTableEntry::<span class="hljs-title function_ invoke__">empty</span>();<br>&#125;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">translate</span>(&amp;<span class="hljs-keyword">self</span>, vpn: VirtPageNum) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;PageTableEntry&gt; &#123;<br>    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">find_pte</span>(vpn).<span class="hljs-title function_ invoke__">map</span>(|pte| *pte)<br>&#125;<br><span class="hljs-comment">/// ppn + offset</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">translate_va</span>(&amp;<span class="hljs-keyword">self</span>, va: VirtAddr) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;PhysAddr&gt; &#123;<br>    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">find_pte</span>(va.<span class="hljs-title function_ invoke__">clone</span>().<span class="hljs-title function_ invoke__">floor</span>()).<span class="hljs-title function_ invoke__">map</span>(|pte| &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">aligned_pa</span>: PhysAddr = pte.<span class="hljs-title function_ invoke__">ppn</span>().<span class="hljs-title function_ invoke__">into</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">offset</span> = va.<span class="hljs-title function_ invoke__">page_offset</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">aligned_pa_usize</span>: <span class="hljs-type">usize</span> = aligned_pa.<span class="hljs-title function_ invoke__">into</span>();<br>        (aligned_pa_usize + offset).<span class="hljs-title function_ invoke__">into</span>()<br>    &#125;)<br>&#125;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">token</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>    <span class="hljs-number">8usize</span> &lt;&lt; <span class="hljs-number">60</span> | <span class="hljs-keyword">self</span>.root_ppn.<span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>map</code>ï¼šå°†è™šæ‹Ÿé¡µå·æ˜ å°„åˆ°ç‰©ç†é¡µå·ï¼Œå¹¶è®¾ç½®ç›¸åº”çš„æ ‡å¿—ä½ã€‚</li><li><code>unmap</code>ï¼šå–æ¶ˆè™šæ‹Ÿé¡µå·çš„æ˜ å°„ã€‚</li><li><code>translate</code>ï¼šå°†è™šæ‹Ÿé¡µå·è½¬æ¢ä¸ºé¡µè¡¨é¡¹ã€‚</li><li><code>translate_va</code>ï¼šå°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚</li><li><code>token</code>ï¼šç”Ÿæˆé¡µè¡¨çš„ tokenï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„é¡µè¡¨ã€‚</li></ul><h3 id="åœ°å€ç©ºé—´ç®¡ç†-1"><a href="#åœ°å€ç©ºé—´ç®¡ç†-1" class="headerlink" title="åœ°å€ç©ºé—´ç®¡ç†"></a>åœ°å€ç©ºé—´ç®¡ç†</h3><h4 id="é€»è¾‘æ®µ"><a href="#é€»è¾‘æ®µ" class="headerlink" title="é€»è¾‘æ®µ"></a>é€»è¾‘æ®µ</h4><p>å‰é¢æˆ‘ä»¬å®ç°äº†é¡µå¸§ç®¡ç†å’Œæ˜ å°„æœºåˆ¶ï¼Œä½†æ˜¯è¿™å¤ªé›¶æ•£äº†ã€‚æˆ‘ä»¬è¿˜éœ€è¦ä¸€å±‚æŠ½è±¡æ¥ç»„ç»‡é¡µå¸§ã€‚æ‰€ä»¥é€»è¾‘æ®µå°±æ˜¯è¿™æ ·çš„æŠ½è±¡ã€‚å®ƒç»„ç»‡äº†ä¸€æ®µ<strong>è¿ç»­ä¸”å¯ç”¨</strong>çš„è™šæ‹Ÿåœ°å€ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/mm/memory_set.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MapArea</span> &#123;<br>    vpn_range: VPNRange,<br>    data_frames: BTreeMap&lt;VirtPageNum, FrameTracker&gt;,<br>    map_type: MapType,<br>    map_perm: MapPermission,<br>&#125;<br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">map_one</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, page_table: &amp;<span class="hljs-keyword">mut</span> PageTable, vpn: VirtPageNum) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ppn</span>: PhysPageNum;<br>    <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.map_type &#123;<br>        MapType::Identical =&gt; &#123;<br>            ppn = <span class="hljs-title function_ invoke__">PhysPageNum</span>(vpn.<span class="hljs-number">0</span>);<br>        &#125;<br>        MapType::Framed =&gt; &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">frame</span> = <span class="hljs-title function_ invoke__">frame_alloc</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>            ppn = frame.ppn;<br>            <span class="hljs-keyword">self</span>.data_frames.<span class="hljs-title function_ invoke__">insert</span>(vpn, frame);<br>        &#125;<br>        MapType::<span class="hljs-title function_ invoke__">Linear</span>(pn_offset) =&gt; &#123;<br>            <span class="hljs-comment">// check for sv39</span><br>            <span class="hljs-built_in">assert!</span>(vpn.<span class="hljs-number">0</span> &lt; (<span class="hljs-number">1usize</span> &lt;&lt; <span class="hljs-number">27</span>));<br>            ppn = <span class="hljs-title function_ invoke__">PhysPageNum</span>((vpn.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> <span class="hljs-type">isize</span> + pn_offset) <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pte_flags</span> = PTEFlags::<span class="hljs-title function_ invoke__">from_bits</span>(<span class="hljs-keyword">self</span>.map_perm.bits).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    page_table.<span class="hljs-title function_ invoke__">map</span>(vpn, ppn, pte_flags);<br>&#125;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">unmap_one</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, page_table: &amp;<span class="hljs-keyword">mut</span> PageTable, vpn: VirtPageNum) &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.map_type == MapType::Framed &#123;<br>        <span class="hljs-keyword">self</span>.data_frames.<span class="hljs-title function_ invoke__">remove</span>(&amp;vpn);<br>    &#125;<br>    page_table.<span class="hljs-title function_ invoke__">unmap</span>(vpn);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>MapArea</code>ï¼šé€»è¾‘æ®µç»“æ„ä½“ï¼ŒåŒ…å«è™šæ‹Ÿé¡µå·èŒƒå›´ã€æ•°æ®å¸§æ˜ å°„ã€æ˜ å°„ç±»å‹å’Œæ˜ å°„æƒé™ã€‚</li><li><code>vpn_range</code>ï¼šä¸€æ®µå·¦å³é—­åˆçš„è™šæ‹Ÿåœ°å€èŒƒå›´ã€‚</li><li><code>data_frames</code>ï¼šç‰©ç†é¡µå¸§å’Œè™šæ‹Ÿåœ°å€çš„æ˜ å°„å…³ç³»ï¼Œä½¿ç”¨ <code>BTreeMap</code> å­˜å‚¨ã€‚</li><li><code>map_type</code>ï¼šå­˜åœ¨å‡ ç§æ˜ å°„æ–¹å¼ï¼ŒåŒ…æ‹¬ç›´æ¥æ˜ å°„ã€çº¿æ€§æ˜ å°„å’Œæ–°å»ºé¡µè¡¨éšæœºæ˜ å°„ã€‚<ul><li><strong>ç›´æ¥æ˜ å°„</strong>ï¼š<code>ppn = vpn</code>ï¼Œå³è™šæ‹Ÿé¡µå·å’Œç‰©ç†é¡µå·ç›¸åŒã€‚</li><li><strong>çº¿æ€§æ˜ å°„</strong>ï¼šé€šè¿‡ä¸€ä¸ªåç§»é‡æ¥è®¡ç®—ç‰©ç†é¡µå·ã€‚</li><li><strong>æ–°å»ºé¡µè¡¨éšæœºæ˜ å°„</strong>ï¼šåˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†é¡µå¸§ï¼Œå¹¶è¿›è¡Œæ˜ å°„ã€‚</li></ul></li><li><code>map_perm</code>ï¼šæ˜¯å¦å…è®¸æ˜ å°„ï¼ŒæŒ‡å®šäº†æ˜ å°„çš„æƒé™ï¼Œå¦‚è¯»ã€å†™ã€æ‰§è¡Œç­‰ã€‚</li><li><code>map_one</code>ï¼šæŒ‰é¡ºåºå–å¾— frame è¿›è¡Œæ˜ å°„ã€‚æ ¹æ®æ˜ å°„ç±»å‹é€‰æ‹©åˆé€‚çš„ç‰©ç†é¡µå·ï¼Œå¹¶è°ƒç”¨é¡µè¡¨çš„ <code>map</code> æ–¹æ³•è¿›è¡Œæ˜ å°„ã€‚</li><li><code>unmap_one</code>ï¼šåˆ é™¤å·²æ˜ å°„çš„ vpnã€‚å¦‚æœæ˜¯ <code>Framed</code> æ˜ å°„ç±»å‹ï¼Œè¿˜éœ€è¦ä» <code>data_frames</code> ä¸­ç§»é™¤ç›¸åº”çš„æ˜ å°„å…³ç³»ï¼Œå¹¶è°ƒç”¨é¡µè¡¨çš„ <code>unmap</code> æ–¹æ³•å–æ¶ˆæ˜ å°„ã€‚</li></ul><h4 id="åœ°å€ç©ºé—´"><a href="#åœ°å€ç©ºé—´" class="headerlink" title="åœ°å€ç©ºé—´"></a>åœ°å€ç©ºé—´</h4><p>ç›¸å½“äºä¸ºè¿›ç¨‹ç»„ç»‡äº†ä¸€ç³»åˆ—é€»è¾‘æ®µï¼Œç»™æ¯ä¸ªè¿›ç¨‹åˆ†é…äº†ä¸€ä¸ª<code>PageTable</code>å’Œ<code>MapArea</code>æ¥ç»‘å®šè¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚è¿™æ ·æ¯ä¸ªè¿›ç¨‹å°±æœ‰äº†ç‹¬ç«‹çš„åœ°å€ç©ºé—´ã€‚éå¸¸å¥½çš„æƒ³æ³•ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MemorySet</span> &#123;<br>    page_table: PageTable,<br>    areas: <span class="hljs-type">Vec</span>&lt;MapArea&gt;,<br>&#125;<br></code></pre></td></tr></table></figure><p>åŸºæœ¬å°±æ˜¯æä¾›äº†é€»è¾‘æ®µçš„è°ƒç”¨æ¥å£ã€‚</p><h5 id="å†…æ ¸åœ°å€ç©ºé—´"><a href="#å†…æ ¸åœ°å€ç©ºé—´" class="headerlink" title="å†…æ ¸åœ°å€ç©ºé—´"></a>å†…æ ¸åœ°å€ç©ºé—´</h5><p>å†…æ ¸åœ°å€ç©ºé—´æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸æ‰€ä½¿ç”¨çš„åœ°å€ç©ºé—´ï¼Œé€šå¸¸åŒ…å«å†…æ ¸ä»£ç ã€æ•°æ®ã€æ ˆç­‰ã€‚å†…æ ¸åœ°å€ç©ºé—´æ˜¯æ‰€æœ‰è¿›ç¨‹å…±äº«çš„ï¼Œå®ƒæä¾›äº†å¯¹ç³»ç»Ÿèµ„æºçš„ç›´æ¥è®¿é—®ï¼Œå¦‚è®¾å¤‡é©±åŠ¨ã€ä¸­æ–­å¤„ç†ç­‰ã€‚åœ¨ PotatOS ä¸­ï¼Œå†…æ ¸åœ°å€ç©ºé—´çš„æ˜ å°„å’Œç®¡ç†æ˜¯é€šè¿‡ <code>PageTable</code> å’Œ <code>MapArea</code> æ¥å®ç°çš„ã€‚å†…æ ¸åœ°å€ç©ºé—´çš„æ˜ å°„é€šå¸¸æ˜¯é™æ€çš„ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å°±å·²ç»å®Œæˆã€‚</p><table><thead><tr><th>é«˜ä½å†…æ ¸æ ˆå¸ƒå±€</th><th>ä½ä½å†…æ ¸é€»è¾‘æ®µå¸ƒå±€</th></tr></thead><tbody><tr><td><img src="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/kernel-as-high.png" alt="å†…æ ¸æ ˆå¸ƒå±€"></td><td><img src="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/kernel-as-low.png" alt="å†…æ ¸é€»è¾‘æ®µå¸ƒå±€"></td></tr></tbody></table><p>å†…æ ¸åœ°å€çš„åˆ†å¸ƒï¼Œé«˜ä½æ˜¯åº”ç”¨çš„å†…æ ¸æ ˆï¼Œä½ä½æ˜¯å†…æ ¸åœ°å€ç©ºé—´çš„é€»è¾‘æ®µï¼ŒæŒ‰ç…§é¡ºåºæ’å…¥ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new_kernel</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">memory_set</span> = <span class="hljs-keyword">Self</span>::<span class="hljs-title function_ invoke__">new_bare</span>();<br>    <span class="hljs-comment">// map trampoline</span><br>    memory_set.<span class="hljs-title function_ invoke__">map_trampoline</span>();<br>    <span class="hljs-comment">// map kernel sections</span><br>    <span class="hljs-comment">// println!(&quot;mapping .text section&quot;);</span><br>    memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>        MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>            (stext <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            (etext <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            MapType::Identical,<br>            MapPermission::R | MapPermission::X,<br>        ),<br>        <span class="hljs-literal">None</span>,<br>    );<br>    <span class="hljs-comment">// println!(&quot;mapping .rodata section&quot;);</span><br>    memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>        MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>            (srodata <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            (erodata <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            MapType::Identical,<br>            MapPermission::R,<br>        ),<br>        <span class="hljs-literal">None</span>,<br>    );<br>    <span class="hljs-comment">// println!(&quot;mapping .data section&quot;);</span><br>    memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>        MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>            (sdata <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            (edata <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            MapType::Identical,<br>            MapPermission::R | MapPermission::W,<br>        ),<br>        <span class="hljs-literal">None</span>,<br>    );<br>    <span class="hljs-comment">// println!(&quot;mapping .bss section&quot;);</span><br>    memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>        MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>            (sbss_with_stack <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            (ebss <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            MapType::Identical,<br>            MapPermission::R | MapPermission::W,<br>        ),<br>        <span class="hljs-literal">None</span>,<br>    );<br>    <span class="hljs-comment">// println!(&quot;mapping physical memory&quot;);</span><br>    memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>        MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>            (ekernel <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            MEMORY_END.<span class="hljs-title function_ invoke__">into</span>(),<br>            MapType::Identical,<br>            MapPermission::R | MapPermission::W,<br>        ),<br>        <span class="hljs-literal">None</span>,<br>    );<br>    <span class="hljs-comment">//println!(&quot;mapping memory-mapped registers&quot;);</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">pair</span> <span class="hljs-keyword">in</span> MMIO &#123;<br>        memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>            MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>                (*pair).<span class="hljs-number">0</span>.<span class="hljs-title function_ invoke__">into</span>(),<br>                ((*pair).<span class="hljs-number">0</span> + (*pair).<span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>                MapType::Identical,<br>                MapPermission::R | MapPermission::W,<br>            ),<br>            <span class="hljs-literal">None</span>,<br>        );<br>    &#125;<br>    memory_set<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="åº”ç”¨åœ°å€ç©ºé—´"><a href="#åº”ç”¨åœ°å€ç©ºé—´" class="headerlink" title="åº”ç”¨åœ°å€ç©ºé—´"></a>åº”ç”¨åœ°å€ç©ºé—´</h5><p>åº”ç”¨åœ°å€ç©ºé—´æ˜¯æ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹æ‹¥æœ‰çš„åœ°å€ç©ºé—´ï¼Œç”¨äºå­˜å‚¨è¿›ç¨‹çš„ä»£ç ã€æ•°æ®ã€æ ˆç­‰ã€‚æ¯ä¸ªè¿›ç¨‹çš„åº”ç”¨åœ°å€ç©ºé—´æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œä¸€ä¸ªè¿›ç¨‹æ— æ³•ç›´æ¥è®¿é—®å¦ä¸€ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œä»è€Œä¿è¯äº†ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚åœ¨ PotatOS ä¸­ï¼Œåº”ç”¨åœ°å€ç©ºé—´çš„æ˜ å°„å’Œç®¡ç†ä¹Ÿæ˜¯é€šè¿‡ <code>PageTable</code> å’Œ <code>MapArea</code> æ¥å®ç°çš„ã€‚å½“åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹æ—¶ï¼Œä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„é¡µè¡¨å’Œé€»è¾‘æ®µï¼Œç”¨äºç®¡ç†å…¶åº”ç”¨åœ°å€ç©ºé—´ã€‚</p><p><img src="https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/app-as-full.png" alt="..&#x2F;_images&#x2F;app-as-full.png"></p><p>å®ç°äº†ç”¨æˆ·ç©ºé—´çš„ç»Ÿä¸€åŒ–ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æŠŠåº”ç”¨é“¾æ¥åˆ°åŒä¸€ä¸ªè™šæ‹Ÿåœ°å€ä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs assembly">OUTPUT_ARCH(riscv)<br>ENTRY(_start)<br><br>BASE_ADDRESS = 0x10000;<br><br>SECTIONS<br>&#123;<br>    . = BASE_ADDRESS;<br>    .text : &#123;<br>        *(.text.entry)<br>        *(.text .text.*)<br>    &#125;<br>    . = ALIGN(4K);<br>    .rodata : &#123;<br>        *(.rodata .rodata.*)<br>        *(.srodata .srodata.*)<br>    &#125;<br>    . = ALIGN(4K);<br>    .data : &#123;<br>        *(.data .data.*)<br>        *(.sdata .sdata.*)<br>    &#125;<br>    .bss : &#123;<br>        *(.bss .bss.*)<br>        *(.sbss .sbss.*)<br>    &#125;<br>    /DISCARD/ : &#123;<br>        *(.eh_frame)<br>        *(.debug*)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="è¿›ç¨‹"><a href="#è¿›ç¨‹" class="headerlink" title="è¿›ç¨‹"></a>è¿›ç¨‹</h2><p>è¿›ç¨‹å¯ä»¥ç®€å•ç†è§£ä¸º<strong>æ“ä½œç³»ç»Ÿå¯¹ç¨‹åºè¿›è¡Œä¸€æ¬¡æ‰§è¡Œçš„è¿‡ç¨‹</strong></p><p>åœ¨<strong>rCore</strong>ä¸­ï¼Œè¿›ç¨‹è¢«åˆ†ç¦»æˆäº†<code>task</code>å’Œ<code>process</code>ã€‚processä¸»è¦æŒ‡ä»£è¿›ç¨‹ï¼Œtaskä¸»è¦æŒ‡ä»£å…·ä½“æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¯ä»¥ç†è§£ä¸ºçº¿ç¨‹ã€‚</p><h3 id="ä»»åŠ¡æ¨¡å‹-Task"><a href="#ä»»åŠ¡æ¨¡å‹-Task" class="headerlink" title="ä»»åŠ¡æ¨¡å‹(Task)"></a>ä»»åŠ¡æ¨¡å‹(Task)</h3><p>ä»»åŠ¡æ˜¯æ“ä½œç³»ç»Ÿä¸­æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªçº¿ç¨‹æˆ–è€…ä¸€ä¸ªè¿›ç¨‹ä¸­çš„ä¸€éƒ¨åˆ†ã€‚ä»»åŠ¡é€šå¸¸å…·æœ‰è‡ªå·±çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬å¯„å­˜å™¨çŠ¶æ€ã€æ ˆæŒ‡é’ˆç­‰ã€‚åœ¨ PotatOS ä¸­ï¼Œä»»åŠ¡çš„è°ƒåº¦å’Œç®¡ç†æ˜¯æ“ä½œç³»ç»Ÿçš„é‡è¦åŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒè´Ÿè´£å†³å®šå“ªä¸ªä»»åŠ¡åœ¨ä½•æ—¶æ‰§è¡Œï¼Œä»¥æé«˜ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å’Œèµ„æºåˆ©ç”¨ç‡ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TaskControlBlock</span> &#123;<br>    <span class="hljs-keyword">pub</span> pid: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> ppid: <span class="hljs-type">usize</span>,<br>    <span class="hljs-comment">// immutable</span><br>    <span class="hljs-keyword">pub</span> process: Weak&lt;ProcessControlBlock&gt;,<br>    <span class="hljs-keyword">pub</span> kstack: KernelStack,<br>    <span class="hljs-comment">// mutable</span><br>    <span class="hljs-keyword">pub</span> inner: UPIntrFreeCell&lt;TaskControlBlockInner&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TaskControlBlockInner</span> &#123;<br>    <span class="hljs-keyword">pub</span> res: <span class="hljs-type">Option</span>&lt;TaskUserRes&gt;,<br>    <span class="hljs-keyword">pub</span> trap_cx_ppn: PhysPageNum,<br>    <span class="hljs-keyword">pub</span> task_cx: TaskContext,<br>    <span class="hljs-keyword">pub</span> task_status: TaskStatus,<br>    <span class="hljs-keyword">pub</span> exit_code: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">i32</span>&gt;,<br><br>    <span class="hljs-keyword">pub</span> user_time: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> kernel_time: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> time_created: <span class="hljs-type">usize</span>,    <br>    <span class="hljs-keyword">pub</span> first_time: <span class="hljs-type">usize</span>,<br>    <span class="hljs-keyword">pub</span> stop_watch: <span class="hljs-type">usize</span>,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>TCB</code>ï¼šä»»åŠ¡çš„æ§åˆ¶å—ï¼ŒåŒ…å«ä»»åŠ¡åŸºæœ¬ä¿¡æ¯<ul><li><code>pid</code>ï¼šä»»åŠ¡æ‰€å±è¿›ç¨‹id</li><li><code>ppid</code>ï¼šåŒç†ï¼Œçˆ¶è¿›ç¨‹id</li></ul></li><li><code>TCBInner</code>ï¼šä»»åŠ¡å†…éƒ¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¾ˆå¤šä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡äº’æ–¥è®¿é—®å¾—åˆ°<ul><li><code>res</code>ï¼šè¿”å›çŠ¶æ€</li><li><code>cx</code>ï¼šä»»åŠ¡çš„ä¸Šä¸‹æ–‡ï¼Œä¸»è¦åŒ…æ‹¬è¿”å›åœ°å€ï¼Œæ ˆé¡¶ä½ç½®å’Œè¢«è°ƒç”¨è€…å¯„å­˜å™¨</li><li><code>time</code>ï¼šä»»åŠ¡çš„å„ç§æ—¶é—´è®°å½•</li></ul></li></ul><p><strong>é‡è¦æ–¹æ³•</strong>ï¼š</p><p>ä¸»è¦æ˜¯å„ç§æ—¶é—´çŠ¶æ€çš„è®¾ç½®ï¼Œæ¯”å¦‚åœ¨trapæ—¶å¼€å¯è®¡æ—¶ï¼Œä¸‹ä¸€ä¸ªtrapæ—¶åœæ­¢å½“è®¡æ—¶ï¼›</p><p>ä»¥åŠä»»åŠ¡çš„è°ƒåº¦ã€‚ä¼šåœ¨ä¸‹é¢ç»Ÿä¸€è®²è¿°ã€‚</p><h3 id="è¿›ç¨‹æ¨¡å‹-Process"><a href="#è¿›ç¨‹æ¨¡å‹-Process" class="headerlink" title="è¿›ç¨‹æ¨¡å‹(Process)"></a>è¿›ç¨‹æ¨¡å‹(Process)</h3><p>ä¸»è¦ç”±<code>PCB</code>æ„æˆ</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ProcessControlBlock</span> &#123;<br>    <span class="hljs-comment">// immutable</span><br>    <span class="hljs-keyword">pub</span> pid: PidHandle,<br>    <span class="hljs-comment">// mutable</span><br>    inner: UPIntrFreeCell&lt;ProcessControlBlockInner&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ProcessControlBlockInner</span> &#123;<br>    <span class="hljs-keyword">pub</span> is_zombie: <span class="hljs-type">bool</span>,<br>    <span class="hljs-keyword">pub</span> memory_set: MemorySet,<br>    <span class="hljs-keyword">pub</span> parent: <span class="hljs-type">Option</span>&lt;Weak&lt;ProcessControlBlock&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> children: <span class="hljs-type">Vec</span>&lt;Arc&lt;ProcessControlBlock&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> exit_code: <span class="hljs-type">i32</span>,<br>    <span class="hljs-keyword">pub</span> fd_table: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Option</span>&lt;Arc&lt;<span class="hljs-keyword">dyn</span> File + <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span>&gt;&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> signals: SignalFlags,<br>    <span class="hljs-keyword">pub</span> tasks: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Option</span>&lt;Arc&lt;TaskControlBlock&gt;&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> task_res_allocator: RecycleAllocator,<br>    <span class="hljs-keyword">pub</span> mutex_list: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Option</span>&lt;Arc&lt;<span class="hljs-keyword">dyn</span> Mutex&gt;&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> semaphore_list: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Option</span>&lt;Arc&lt;Semaphore&gt;&gt;&gt;,<br>    <span class="hljs-keyword">pub</span> condvar_list: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Option</span>&lt;Arc&lt;Condvar&gt;&gt;&gt;,<br><br>    <span class="hljs-keyword">pub</span> cwd: Arc&lt;Inode&gt;,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>ProcessControlBlock</code>ï¼šè¿›ç¨‹æ§åˆ¶å—ç»“æ„ä½“ï¼ŒåŒ…å«è¿›ç¨‹çš„åŸºæœ¬ä¿¡æ¯å’Œå¯å˜éƒ¨åˆ†ã€‚<ul><li><code>pid</code>ï¼šè¿›ç¨‹æ ‡è¯†ç¬¦ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªè¿›ç¨‹ã€‚</li><li><code>inner</code>ï¼šå¯å˜éƒ¨åˆ†ï¼Œä½¿ç”¨ <code>UPIntrFreeCell</code> è¿›è¡Œå°è£…ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚</li></ul></li><li><code>ProcessControlBlockInner</code>ï¼šè¿›ç¨‹æ§åˆ¶å—çš„å¯å˜éƒ¨åˆ†ï¼ŒåŒ…å«äº†è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯ã€‚<ul><li><code>is_zombie</code>ï¼šè¡¨ç¤ºè¿›ç¨‹æ˜¯å¦ä¸ºåƒµå°¸è¿›ç¨‹ã€‚åƒµå°¸è¿›ç¨‹æ˜¯æŒ‡å·²ç»ç»“æŸä½†å°šæœªè¢«çˆ¶è¿›ç¨‹å›æ”¶çš„è¿›ç¨‹ã€‚</li><li><code>memory_set</code>ï¼šè¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼ŒåŒ…å«äº†è¿›ç¨‹çš„é¡µè¡¨å’Œé€»è¾‘æ®µã€‚</li><li><code>parent</code>ï¼šçˆ¶è¿›ç¨‹çš„å¼±å¼•ç”¨ï¼Œç”¨äºè¡¨ç¤ºè¿›ç¨‹ä¹‹é—´çš„çˆ¶å­å…³ç³»ã€‚</li><li><code>children</code>ï¼šå­è¿›ç¨‹çš„å¼ºå¼•ç”¨åˆ—è¡¨ï¼Œå­˜å‚¨äº†è¯¥è¿›ç¨‹çš„æ‰€æœ‰å­è¿›ç¨‹ã€‚</li><li><code>exit_code</code>ï¼šè¿›ç¨‹çš„é€€å‡ºç ï¼Œç”¨äºè¡¨ç¤ºè¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ã€‚</li><li><code>fd_table</code>ï¼šæ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œå­˜å‚¨äº†è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶çš„å¼•ç”¨ã€‚</li><li><code>signals</code>ï¼šä¿¡å·æ ‡å¿—ï¼Œç”¨äºå¤„ç†è¿›ç¨‹æ¥æ”¶åˆ°çš„ä¿¡å·ã€‚</li><li><code>tasks</code>ï¼šä»»åŠ¡åˆ—è¡¨ï¼Œå­˜å‚¨äº†è¿›ç¨‹ä¸­çš„æ‰€æœ‰ä»»åŠ¡ã€‚</li><li><code>task_res_allocator</code>ï¼šä»»åŠ¡èµ„æºåˆ†é…å™¨ï¼Œç”¨äºåˆ†é…å’Œå›æ”¶ä»»åŠ¡çš„èµ„æºã€‚</li><li><code>mutex_list</code>ï¼šäº’æ–¥é”åˆ—è¡¨ï¼Œç”¨äºå®ç°è¿›ç¨‹å†…çš„äº’æ–¥è®¿é—®ã€‚</li><li><code>semaphore_list</code>ï¼šä¿¡å·é‡åˆ—è¡¨ï¼Œç”¨äºå®ç°è¿›ç¨‹é—´çš„åŒæ­¥å’Œäº’æ–¥ã€‚</li><li><code>condvar_list</code>ï¼šæ¡ä»¶å˜é‡åˆ—è¡¨ï¼Œç”¨äºå®ç°è¿›ç¨‹é—´çš„åŒæ­¥å’Œé€šä¿¡ã€‚</li><li><code>cwd</code>ï¼šå½“å‰å·¥ä½œç›®å½•çš„ç´¢å¼•èŠ‚ç‚¹ï¼Œç”¨äºæŒ‡å®šè¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•ã€‚</li></ul></li></ul><p><strong>é‡è¦æ–¹æ³•</strong>ï¼š</p><ul><li><code>fork</code>ï¼šé™¤äº†åˆå§‹è¿›ç¨‹å¤–ï¼Œé€šç”¨çš„è¿›ç¨‹äº§ç”Ÿæ–¹æ³•ã€‚é™¤äº† pid å¤–ï¼Œchild ç»§æ‰¿ parent å¤§éƒ¨åˆ†ä¿¡æ¯ã€‚<code>fork</code> ç³»ç»Ÿè°ƒç”¨ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹æ˜¯è°ƒç”¨è¿›ç¨‹çš„å‰¯æœ¬ï¼Œæ‹¥æœ‰ç›¸åŒçš„ä»£ç ã€æ•°æ®å’Œæ–‡ä»¶æè¿°ç¬¦ç­‰ã€‚æ–°è¿›ç¨‹çš„ pid æ˜¯å”¯ä¸€çš„ï¼Œä¸çˆ¶è¿›ç¨‹ä¸åŒã€‚</li><li><code>exec</code>ï¼šå°†å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´æ¸…ç©ºå¹¶åŠ è½½ä¸€ä¸ªç‰¹å®šçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿”å›ç”¨æˆ·æ€åå¼€å§‹å®ƒçš„æ‰§è¡Œã€‚<code>exec</code> ç³»ç»Ÿè°ƒç”¨ä¼šç”¨æ–°çš„å¯æ‰§è¡Œæ–‡ä»¶æ›¿æ¢å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œä»è€Œä½¿è¿›ç¨‹æ‰§è¡Œæ–°çš„ç¨‹åºã€‚</li><li><code>waitpid</code>ï¼šå½“å‰è¿›ç¨‹ç­‰å¾…ä¸€ä¸ªå­è¿›ç¨‹å˜ä¸ºåƒµå°¸è¿›ç¨‹ï¼Œå›æ”¶å…¶å…¨éƒ¨èµ„æºå¹¶æ”¶é›†å…¶è¿”å›å€¼ã€‚<code>waitpid</code> ç³»ç»Ÿè°ƒç”¨ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œç›´åˆ°æŒ‡å®šçš„å­è¿›ç¨‹ç»“æŸå¹¶å˜ä¸ºåƒµå°¸è¿›ç¨‹ï¼Œç„¶åå›æ”¶å­è¿›ç¨‹çš„èµ„æºï¼Œå¹¶è·å–å…¶é€€å‡ºç ã€‚</li></ul><h4 id="initproc"><a href="#initproc" class="headerlink" title="initproc"></a>initproc</h4><p>åˆå§‹è¿›ç¨‹ï¼Œæ‰€æœ‰è¿›ç¨‹éƒ½ä»å®ƒ fork å‡ºæ¥ã€‚è¿™é‡Œçš„å®ç°æ˜¯ç›´æ¥ fork å‡ºä¸€ä¸ª<strong>user_shell</strong>è¿›ç¨‹ã€‚<code>initproc</code> æ˜¯æ“ä½œç³»ç»Ÿå¯åŠ¨åçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒè´Ÿè´£åˆ›å»ºå…¶ä»–è¿›ç¨‹å’Œåˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒã€‚åœ¨ PotatOS ä¸­ï¼Œ<code>initproc</code> ä¼š fork å‡ºä¸€ä¸ª <code>user_shell</code> è¿›ç¨‹ï¼Œç”¨äºæä¾›ç”¨æˆ·äº¤äº’ç•Œé¢ã€‚</p><h4 id="user-shell"><a href="#user-shell" class="headerlink" title="user_shell"></a>user_shell</h4><p>ä¸€ä¸ªç®€å•çš„ shell ç¨‹åºï¼Œè´Ÿè´£æ‰§è¡Œå†…éƒ¨å‘½ä»¤å’Œå¤–éƒ¨å‘½ä»¤ã€‚</p><ul><li><strong>å†…éƒ¨å‘½ä»¤</strong>ï¼šå…³ç³»åˆ°å½“å‰ä¸»è¿›ç¨‹ï¼Œéœ€è¦æ”¹å˜å…¶çŠ¶æ€çš„å‘½ä»¤ã€‚æ¯”å¦‚<code>pwd</code>ï¼Œ<code>chdir</code>ç­‰ç­‰ã€‚å†…éƒ¨å‘½ä»¤é€šå¸¸æ˜¯ç”± shell æœ¬èº«å®ç°çš„ï¼Œä¸éœ€è¦åˆ›å»ºæ–°çš„è¿›ç¨‹æ¥æ‰§è¡Œã€‚</li><li><strong>å¤–éƒ¨å‘½ä»¤</strong>ï¼šæ‰§è¡Œç³»ç»Ÿå¤–éƒ¨çš„ç¨‹åºï¼Œç®€å•åœ° fork å execã€‚å¤–éƒ¨å‘½ä»¤æ˜¯æŒ‡éœ€è¦æ‰§è¡Œç³»ç»Ÿä¸­å…¶ä»–å¯æ‰§è¡Œæ–‡ä»¶çš„å‘½ä»¤ï¼Œshell ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹æ¥æ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚</li></ul><h3 id="è¿›ç¨‹æ‰§è¡Œ"><a href="#è¿›ç¨‹æ‰§è¡Œ" class="headerlink" title="è¿›ç¨‹æ‰§è¡Œ"></a>è¿›ç¨‹æ‰§è¡Œ</h3><h4 id="åº”ç”¨çš„é“¾æ¥ä¸åŠ è½½"><a href="#åº”ç”¨çš„é“¾æ¥ä¸åŠ è½½" class="headerlink" title="åº”ç”¨çš„é“¾æ¥ä¸åŠ è½½"></a>åº”ç”¨çš„é“¾æ¥ä¸åŠ è½½</h4><p>åœ¨<code>Make</code>å¯åŠ¨ Qemu æ—¶ï¼Œuser&#x2F;src&#x2F;bin&#x2F; å†…çš„ç¨‹åºä¼šé€šè¿‡<strong>efs-fuse</strong>è¢«é¢„åŠ è½½åˆ° fs.img ä¸­ã€‚è¯¦è§ä¸‹æ–‡ã€‚å¦‚æœä¸ä½¿ç”¨ efs-fuseï¼Œåˆ™éœ€è¦ä½¿ç”¨<strong>link_app.S</strong>æŠŠç¼–è¯‘åçš„æ–‡ä»¶ä¸€ä¸ªä¸ªåŠ è½½åˆ°å†…å­˜çš„åœ°å€ä¸­ã€‚è¿™ç§ç¡¬ç¼–ç çš„å½¢å¼ä»¤äººéš¾å—ã€‚</p><p><code>efs-fuse</code> æ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒå¯ä»¥å°† user&#x2F;src&#x2F;bin&#x2F; ç›®å½•ä¸‹çš„æ‰€æœ‰ç¨‹åºäºŒè¿›åˆ¶æ ¼å¼æ‰“åŒ…ï¼Œå¹¶åŠ è½½åˆ°é¢„å…ˆå‡†å¤‡å¥½çš„ fs.img ä¸­ã€‚è¿™æ ·ï¼Œåœ¨å¯åŠ¨ Qemu æ—¶ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥ç›´æ¥ä» fs.img ä¸­è¯»å–è¿™äº›ç¨‹åºï¼Œå¹¶åŠ è½½åˆ°å†…å­˜ä¸­æ‰§è¡Œã€‚è€Œä½¿ç”¨ <code>link_app.S</code> åˆ™éœ€è¦æ‰‹åŠ¨å°†ç¼–è¯‘åçš„æ–‡ä»¶åŠ è½½åˆ°å†…å­˜çš„æŒ‡å®šåœ°å€ï¼Œè¿™ç§æ–¹å¼æ¯”è¾ƒç¹çï¼Œè€Œä¸”å®¹æ˜“å‡ºé”™ã€‚</p><h3 id="ä»»åŠ¡è°ƒåº¦"><a href="#ä»»åŠ¡è°ƒåº¦" class="headerlink" title="ä»»åŠ¡è°ƒåº¦"></a>ä»»åŠ¡è°ƒåº¦</h3><p>è¿›ç¨‹çš„è°ƒåº¦åŸºäº<strong>ä»»åŠ¡è°ƒåº¦</strong>ã€‚ä»»åŠ¡è°ƒåº¦æ˜¯æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒè´Ÿè´£å†³å®šå“ªä¸ªä»»åŠ¡åœ¨ä½•æ—¶æ‰§è¡Œï¼Œä»¥æé«˜ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å’Œèµ„æºåˆ©ç”¨ç‡ã€‚åœ¨PotatOSä¸­ï¼Œä»»åŠ¡è°ƒåº¦ä½¿ç”¨ç®€å•çš„RRæ—¶é—´ç‰‡æ–¹æ³•ã€‚</p><h4 id="è°ƒåº¦æ–¹æ³•"><a href="#è°ƒåº¦æ–¹æ³•" class="headerlink" title="è°ƒåº¦æ–¹æ³•"></a>è°ƒåº¦æ–¹æ³•</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/task/manager.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TaskManager</span> &#123;<br>    ready_queue: VecDeque&lt;Arc&lt;TaskControlBlock&gt;&gt;,<br>&#125;<br><br><span class="hljs-comment">/// A simple FIFO scheduler.</span><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">TaskManager</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123;<br>            ready_queue: VecDeque::<span class="hljs-title function_ invoke__">new</span>(),<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, task: Arc&lt;TaskControlBlock&gt;) &#123;<br>        <span class="hljs-keyword">self</span>.ready_queue.<span class="hljs-title function_ invoke__">push_back</span>(task);<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">fetch</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Arc&lt;TaskControlBlock&gt;&gt; &#123;<br>        <span class="hljs-keyword">self</span>.ready_queue.<span class="hljs-title function_ invoke__">pop_front</span>()<br>    &#125;<br>&#125;<br><br>lazy_static! &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">ref</span> TASK_MANAGER: UPIntrFreeCell&lt;TaskManager&gt; =<br>        <span class="hljs-keyword">unsafe</span> &#123; UPIntrFreeCell::<span class="hljs-title function_ invoke__">new</span>(TaskManager::<span class="hljs-title function_ invoke__">new</span>()) &#125;;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">ref</span> PID2PCB: UPIntrFreeCell&lt;BTreeMap&lt;<span class="hljs-type">usize</span>, Arc&lt;ProcessControlBlock&gt;&gt;&gt; =<br>        <span class="hljs-keyword">unsafe</span> &#123; UPIntrFreeCell::<span class="hljs-title function_ invoke__">new</span>(BTreeMap::<span class="hljs-title function_ invoke__">new</span>()) &#125;;<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_task</span>(task: Arc&lt;TaskControlBlock&gt;) &#123;<br>    TASK_MANAGER.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">add</span>(task);<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">wakeup_task</span>(task: Arc&lt;TaskControlBlock&gt;) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">task_inner</span> = task.<span class="hljs-title function_ invoke__">inner_exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>    task_inner.task_status = TaskStatus::Ready;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">task_info</span> = TaskInfo &#123;<br>        pid: task.<span class="hljs-title function_ invoke__">get_pid</span>(),<br>        ppid: task.<span class="hljs-title function_ invoke__">get_ppid</span>(), <br>        status: task_inner.task_status,<br>        user_time: task_inner.user_time,<br>        kernel_time: task_inner.kernel_time,<br>        time_created: task_inner.time_created,<br>        first_time: task_inner.first_time,<br>    &#125;;<br>    <br>    <span class="hljs-title function_ invoke__">drop</span>(task_inner);<br>    <span class="hljs-title function_ invoke__">add_task</span>(task);<br>    <br>    <span class="hljs-title function_ invoke__">write_proc</span>(task_info);<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">fetch_task</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Arc&lt;TaskControlBlock&gt;&gt; &#123;<br>    TASK_MANAGER.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">fetch</span>()<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»»åŠ¡çš„è°ƒåº¦ç”±ç®€å•çš„<strong>FIFOé˜Ÿåˆ—</strong>å®ç°ã€‚ä¸»è¦åŒ…æ‹¬ä¸€ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>add_task</code>ï¼šç›´æ¥å¾€é˜Ÿåˆ—é‡ŒåŠ å…¥task</li><li><code>wakeup_task</code>ï¼šæŠŠä¸€ä¸ªæ–°çš„taskå”¤é†’ï¼Œç„¶åæ’å…¥åˆ°procesé˜Ÿåˆ—é‡Œ</li><li><code>fetch_task</code>ï¼šå–å¾—ä¸€ä¸ªtask</li></ul><h4 id="RR"><a href="#RR" class="headerlink" title="RR"></a>RR</h4><p>åœ¨å†…æ ¸é‡Œï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªtimerç±»ï¼Œç”¨äºæ—¶é—´ç‰‡è½®è½¬æ–¹æ³•ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/timer.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_time</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>    time::<span class="hljs-title function_ invoke__">read</span>()<br>&#125;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_time_ms</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>    time::<span class="hljs-title function_ invoke__">read</span>() / (CLOCK_FREQ / MSEC_PER_SEC)<br>&#125;<br><span class="hljs-comment">/// set time slice for current task</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">set_next_trigger</span>() &#123;<br>    <span class="hljs-title function_ invoke__">set_timer</span>(<span class="hljs-title function_ invoke__">get_time</span>() + CLOCK_FREQ / TICKS_PER_SEC);<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_timer</span>(expire_ms: <span class="hljs-type">usize</span>, task: Arc&lt;TaskControlBlock&gt;) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">timers</span> = TIMERS.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>    timers.<span class="hljs-title function_ invoke__">push</span>(TimerCondVar &#123; expire_ms, task &#125;);<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">check_timer</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">current_ms</span> = <span class="hljs-title function_ invoke__">get_time_ms</span>();<br>    TIMERS.<span class="hljs-title function_ invoke__">exclusive_session</span>(|timers| &#123;<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(timer) = timers.<span class="hljs-title function_ invoke__">peek</span>() &#123;<br>            <span class="hljs-keyword">if</span> timer.expire_ms &lt;= current_ms &#123;<br>                <span class="hljs-title function_ invoke__">wakeup_task</span>(Arc::<span class="hljs-title function_ invoke__">clone</span>(&amp;timer.task));<br>                timers.<span class="hljs-title function_ invoke__">pop</span>();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;);<br>&#125;<br><br><span class="hljs-comment">// os/src/sbi.rs</span><br><span class="hljs-comment">/// use sbi call to set timer</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">set_timer</span>(timer: <span class="hljs-type">usize</span>) &#123;<br>    sbi_rt::<span class="hljs-title function_ invoke__">set_timer</span>(timer <span class="hljs-keyword">as</span> _);<br>&#125;<br><br><span class="hljs-comment">// os/src/trap/mod.rs</span><br>Trap::<span class="hljs-title function_ invoke__">Interrupt</span>(Interrupt::SupervisorTimer) =&gt; &#123;<br>    <span class="hljs-title function_ invoke__">set_next_trigger</span>();<br>    <span class="hljs-title function_ invoke__">check_timer</span>();<br>    <span class="hljs-comment">// do not schedule now</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„å…³é”®å°±æ˜¯é€šè¿‡<code>set_timer</code>å¯ä»¥ä¸º<strong>RISC-V</strong>è®¾ç½®ä¸€ä¸ªå®šæ—¶çš„ä¸­æ–­ï¼Œè§¦å‘åè¿›å…¥æ—¶é’Ÿçš„ä¸­æ–­å¤„ç†ã€‚</p><p>ä¸­æ–­å¤„ç†å°±æ˜¯ç®€å•åœ°å¯¹æ—¶é’Ÿé˜Ÿåˆ—è¿›è¡Œè°ƒåº¦å¹¶è®¾ç½®ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡ã€‚</p><h3 id="è¿›ç¨‹è°ƒåº¦"><a href="#è¿›ç¨‹è°ƒåº¦" class="headerlink" title="è¿›ç¨‹è°ƒåº¦"></a>è¿›ç¨‹è°ƒåº¦</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// os/src/task/processor.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Processor</span> &#123;<br>    current: <span class="hljs-type">Option</span>&lt;Arc&lt;TaskControlBlock&gt;&gt;,<br>    idle_task_cx: TaskContext,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Processor</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123;<br>            current: <span class="hljs-literal">None</span>,<br>            idle_task_cx: TaskContext::<span class="hljs-title function_ invoke__">zero_init</span>(),<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_idle_task_cx_ptr</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> *<span class="hljs-keyword">mut</span> TaskContext &#123;<br>        &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.idle_task_cx <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">take_current</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Arc&lt;TaskControlBlock&gt;&gt; &#123;<br>        <span class="hljs-keyword">self</span>.current.<span class="hljs-title function_ invoke__">take</span>()<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">current</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Arc&lt;TaskControlBlock&gt;&gt; &#123;<br>        <span class="hljs-keyword">self</span>.current.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">map</span>(Arc::clone)<br>    &#125;<br>&#125;<br><br>lazy_static! &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">ref</span> PROCESSOR: UPIntrFreeCell&lt;Processor&gt; =<br>        <span class="hljs-keyword">unsafe</span> &#123; UPIntrFreeCell::<span class="hljs-title function_ invoke__">new</span>(Processor::<span class="hljs-title function_ invoke__">new</span>()) &#125;;<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">run_tasks</span>() &#123;<br>    <span class="hljs-keyword">loop</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">processor</span> = PROCESSOR.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(task) = <span class="hljs-title function_ invoke__">fetch_task</span>() &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">idle_task_cx_ptr</span> = processor.<span class="hljs-title function_ invoke__">get_idle_task_cx_ptr</span>();<br>            <span class="hljs-comment">// access coming task TCB exclusively</span><br>            <span class="hljs-keyword">let</span> (next_task_cx_ptr, task_info) = task.inner.<span class="hljs-title function_ invoke__">exclusive_session</span>(|task_inner| &#123;<br>                task_inner.task_status = TaskStatus::Running;<br>                task_inner.first_time = <span class="hljs-title function_ invoke__">get_time_ms</span>();<br>                task_inner.<span class="hljs-title function_ invoke__">refresh_watch</span>();<br>                (&amp;task_inner.task_cx <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> TaskContext, <br>                TaskInfo &#123;<br>                    pid: task.<span class="hljs-title function_ invoke__">get_pid</span>(),<br>                    ppid: task.<span class="hljs-title function_ invoke__">get_ppid</span>(),<br>                    status: task_inner.task_status,<br>                    user_time: task_inner.user_time,<br>                    kernel_time: task_inner.kernel_time,<br>                    time_created: task_inner.time_created,<br>                    first_time: task_inner.first_time,<br>                &#125;)<br>            &#125;);<br>            processor.current = <span class="hljs-title function_ invoke__">Some</span>(task);<br>            <span class="hljs-comment">// release processor manually</span><br>            <span class="hljs-title function_ invoke__">drop</span>(processor);<br>            <span class="hljs-title function_ invoke__">write_proc</span>(task_info);<br>            <span class="hljs-keyword">unsafe</span> &#123;<br>                __switch(idle_task_cx_ptr, next_task_cx_ptr);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;no tasks available in run_tasks&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">take_current_task</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Arc&lt;TaskControlBlock&gt;&gt; &#123;<br>    PROCESSOR.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">take_current</span>()<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">current_task</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Arc&lt;TaskControlBlock&gt;&gt; &#123;<br>    PROCESSOR.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">current</span>()<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">current_process</span>() <span class="hljs-punctuation">-&gt;</span> Arc&lt;ProcessControlBlock&gt; &#123;<br>    <span class="hljs-title function_ invoke__">current_task</span>().<span class="hljs-title function_ invoke__">unwrap</span>().process.<span class="hljs-title function_ invoke__">upgrade</span>().<span class="hljs-title function_ invoke__">unwrap</span>()<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">current_user_token</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">task</span> = <span class="hljs-title function_ invoke__">current_task</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    task.<span class="hljs-title function_ invoke__">get_user_token</span>()<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">current_trap_cx</span>() <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> TrapContext &#123;<br>    <span class="hljs-title function_ invoke__">current_task</span>()<br>        .<span class="hljs-title function_ invoke__">unwrap</span>()<br>        .<span class="hljs-title function_ invoke__">inner_exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>())<br>        .<span class="hljs-title function_ invoke__">get_trap_cx</span>()<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">current_trap_cx_user_va</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>    <span class="hljs-title function_ invoke__">current_task</span>()<br>        .<span class="hljs-title function_ invoke__">unwrap</span>()<br>        .<span class="hljs-title function_ invoke__">inner_exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>())<br>        .res<br>        .<span class="hljs-title function_ invoke__">as_ref</span>()<br>        .<span class="hljs-title function_ invoke__">unwrap</span>()<br>        .<span class="hljs-title function_ invoke__">trap_cx_user_va</span>()<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">current_kstack_top</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>    <span class="hljs-title function_ invoke__">current_task</span>().<span class="hljs-title function_ invoke__">unwrap</span>().kstack.<span class="hljs-title function_ invoke__">get_top</span>()<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">schedule</span>(switched_task_cx_ptr: *<span class="hljs-keyword">mut</span> TaskContext) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">idle_task_cx_ptr</span> =<br>        PROCESSOR.<span class="hljs-title function_ invoke__">exclusive_session</span>(|processor| processor.<span class="hljs-title function_ invoke__">get_idle_task_cx_ptr</span>());<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        __switch(switched_task_cx_ptr, idle_task_cx_ptr);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è°ƒåº¦æ–¹å¼å°±æ˜¯ä»<strong>FIFOå°±ç»ªé˜Ÿåˆ—</strong>é‡Œè·å¾—æœ€æ–°çš„è¿›ç¨‹ï¼Œè¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢æ‰§è¡Œ</p><h3 id="è¿›ç¨‹åŒæ­¥æœºåˆ¶"><a href="#è¿›ç¨‹åŒæ­¥æœºåˆ¶" class="headerlink" title="è¿›ç¨‹åŒæ­¥æœºåˆ¶"></a>è¿›ç¨‹åŒæ­¥æœºåˆ¶</h3><p>è¿›ç¨‹åŒæ­¥æœºåˆ¶å®é™…ä¸Šæ˜¯è¿›ç¨‹å¯¹<strong>Critical Section</strong>çš„<strong>å—é™è®¿é—®</strong>ï¼Œå› æ­¤å¡åˆ°è¿›ç¨‹ä¸€æ ã€‚</p><h4 id="Mutex"><a href="#Mutex" class="headerlink" title="Mutex"></a>Mutex</h4><p>mutexåŒ…æ‹¬äº†<strong>è‡ªæ—‹é”</strong>å’Œ<strong>é˜»å¡é”</strong>ï¼Œå®ç°å¦‚ä¸‹</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">Mutex</span>: <span class="hljs-built_in">Sync</span> + <span class="hljs-built_in">Send</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">lock</span>(&amp;<span class="hljs-keyword">self</span>);<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">unlock</span>(&amp;<span class="hljs-keyword">self</span>);<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MutexSpin</span> &#123;<br>    locked: UPIntrFreeCell&lt;<span class="hljs-type">bool</span>&gt;,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">MutexSpin</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123;<br>            locked: <span class="hljs-keyword">unsafe</span> &#123; UPIntrFreeCell::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-literal">false</span>) &#125;,<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Mutex</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">MutexSpin</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">lock</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">loop</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">locked</span> = <span class="hljs-keyword">self</span>.locked.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>            <span class="hljs-keyword">if</span> *locked &#123;<br>                <span class="hljs-title function_ invoke__">drop</span>(locked);<br>                <span class="hljs-title function_ invoke__">suspend_current_and_run_next</span>();<br>                <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                *locked = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">unlock</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">locked</span> = <span class="hljs-keyword">self</span>.locked.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>        *locked = <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MutexBlocking</span> &#123;<br>    inner: UPIntrFreeCell&lt;MutexBlockingInner&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MutexBlockingInner</span> &#123;<br>    locked: <span class="hljs-type">bool</span>,<br>    wait_queue: VecDeque&lt;Arc&lt;TaskControlBlock&gt;&gt;,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">MutexBlocking</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123;<br>            inner: <span class="hljs-keyword">unsafe</span> &#123;<br>                UPIntrFreeCell::<span class="hljs-title function_ invoke__">new</span>(MutexBlockingInner &#123;<br>                    locked: <span class="hljs-literal">false</span>,<br>                    wait_queue: VecDeque::<span class="hljs-title function_ invoke__">new</span>(),<br>                &#125;)<br>            &#125;,<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Mutex</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">MutexBlocking</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">lock</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">mutex_inner</span> = <span class="hljs-keyword">self</span>.inner.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>        <span class="hljs-keyword">if</span> mutex_inner.locked &#123;<br>            mutex_inner.wait_queue.<span class="hljs-title function_ invoke__">push_back</span>(<span class="hljs-title function_ invoke__">current_task</span>().<span class="hljs-title function_ invoke__">unwrap</span>());<br>            <span class="hljs-title function_ invoke__">drop</span>(mutex_inner);<br>            <span class="hljs-title function_ invoke__">block_current_and_run_next</span>();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            mutex_inner.locked = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">unlock</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">mutex_inner</span> = <span class="hljs-keyword">self</span>.inner.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>        <span class="hljs-built_in">assert!</span>(mutex_inner.locked);<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(waking_task) = mutex_inner.wait_queue.<span class="hljs-title function_ invoke__">pop_front</span>() &#123;<br>            <span class="hljs-title function_ invoke__">wakeup_task</span>(waking_task);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            mutex_inner.locked = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è‡ªæ—‹é”ä¸»è¦æ˜¯ä½¿ç”¨äº†ä¸€å—äº’æ–¥è®¿é—®çš„BoolåŒºåŸŸï¼Œç”¨äºä¸Šé”</p><p>é˜»å¡ç±»å‹çš„é”ä¸<strong>è¿›ç¨‹</strong>ç»“åˆï¼Œå®ç°äº†ç®€å•çš„é˜»å¡é˜Ÿåˆ—</p><h4 id="æ¡ä»¶å˜é‡"><a href="#æ¡ä»¶å˜é‡" class="headerlink" title="æ¡ä»¶å˜é‡"></a>æ¡ä»¶å˜é‡</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Condvar</span> &#123;<br>    <span class="hljs-keyword">pub</span> inner: UPIntrFreeCell&lt;CondvarInner&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">CondvarInner</span> &#123;<br>    <span class="hljs-keyword">pub</span> wait_queue: VecDeque&lt;Arc&lt;TaskControlBlock&gt;&gt;,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Condvar</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123;<br>            inner: <span class="hljs-keyword">unsafe</span> &#123;<br>                UPIntrFreeCell::<span class="hljs-title function_ invoke__">new</span>(CondvarInner &#123;<br>                    wait_queue: VecDeque::<span class="hljs-title function_ invoke__">new</span>(),<br>                &#125;)<br>            &#125;,<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">signal</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">inner</span> = <span class="hljs-keyword">self</span>.inner.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(task) = inner.wait_queue.<span class="hljs-title function_ invoke__">pop_front</span>() &#123;<br>            <span class="hljs-title function_ invoke__">wakeup_task</span>(task);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">wait_no_sched</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> *<span class="hljs-keyword">mut</span> TaskContext &#123;<br>        <span class="hljs-keyword">self</span>.inner.<span class="hljs-title function_ invoke__">exclusive_session</span>(|inner| &#123;<br>            inner.wait_queue.<span class="hljs-title function_ invoke__">push_back</span>(<span class="hljs-title function_ invoke__">current_task</span>().<span class="hljs-title function_ invoke__">unwrap</span>());<br>        &#125;);<br>        <span class="hljs-title function_ invoke__">block_current_task</span>()<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">wait_with_mutex</span>(&amp;<span class="hljs-keyword">self</span>, mutex: Arc&lt;<span class="hljs-keyword">dyn</span> Mutex&gt;) &#123;<br>        mutex.<span class="hljs-title function_ invoke__">unlock</span>();<br>        <span class="hljs-keyword">self</span>.inner.<span class="hljs-title function_ invoke__">exclusive_session</span>(|inner| &#123;<br>            inner.wait_queue.<span class="hljs-title function_ invoke__">push_back</span>(<span class="hljs-title function_ invoke__">current_task</span>().<span class="hljs-title function_ invoke__">unwrap</span>());<br>        &#125;);<br>        <span class="hljs-title function_ invoke__">block_current_and_run_next</span>();<br>        mutex.<span class="hljs-title function_ invoke__">lock</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¡ä»¶å˜é‡ä¸»è¦æ˜¯<strong>ä¸Šé”</strong>å’Œ<strong>å”¤é†’</strong>ã€‚</p><h4 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Semaphore</span> &#123;<br>    <span class="hljs-keyword">pub</span> inner: UPIntrFreeCell&lt;SemaphoreInner&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SemaphoreInner</span> &#123;<br>    <span class="hljs-keyword">pub</span> count: <span class="hljs-type">isize</span>,<br>    <span class="hljs-keyword">pub</span> wait_queue: VecDeque&lt;Arc&lt;TaskControlBlock&gt;&gt;,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Semaphore</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(res_count: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123;<br>            inner: <span class="hljs-keyword">unsafe</span> &#123;<br>                UPIntrFreeCell::<span class="hljs-title function_ invoke__">new</span>(SemaphoreInner &#123;<br>                    count: res_count <span class="hljs-keyword">as</span> <span class="hljs-type">isize</span>,<br>                    wait_queue: VecDeque::<span class="hljs-title function_ invoke__">new</span>(),<br>                &#125;)<br>            &#125;,<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">up</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">inner</span> = <span class="hljs-keyword">self</span>.inner.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>        inner.count += <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> inner.count &lt;= <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(task) = inner.wait_queue.<span class="hljs-title function_ invoke__">pop_front</span>() &#123;<br>                <span class="hljs-title function_ invoke__">wakeup_task</span>(task);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">down</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">inner</span> = <span class="hljs-keyword">self</span>.inner.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>        inner.count -= <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> inner.count &lt; <span class="hljs-number">0</span> &#123;<br>            inner.wait_queue.<span class="hljs-title function_ invoke__">push_back</span>(<span class="hljs-title function_ invoke__">current_task</span>().<span class="hljs-title function_ invoke__">unwrap</span>());<br>            <span class="hljs-title function_ invoke__">drop</span>(inner);<br>            <span class="hljs-title function_ invoke__">block_current_and_run_next</span>();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¿¡å·é‡ç›¸å½“äº<em>èµ„æºæ± </em>ï¼Œé™åˆ¶äº†è¿›ç¨‹çš„å¹¶å‘é‡ã€‚</p><p>å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ã€‚</p><h2 id="æ–‡ä»¶ç³»ç»Ÿ"><a href="#æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿ"></a>æ–‡ä»¶ç³»ç»Ÿ</h2><p>æœ¬ç³»ç»Ÿæ¨¡ä»¿ä½¿ç”¨äº†<strong>easyfs</strong>ï¼Œä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬çš„æ–‡ä»¶ç³»ç»Ÿã€‚ä¸ºäº†é™ä½è€¦åˆæ€§ï¼Œæ•´ä½“å¯ä»¥åˆ†ä¸ºäº”å±‚ï¼š</p><ol><li><strong>ç£ç›˜å—æ¥å£å±‚</strong>ï¼šæŠ½è±¡å°è£…ç£ç›˜å—ï¼Œå®ç°å¯¹å¤–æ¥å£ã€‚è¯¥å±‚æä¾›äº†å¯¹ç£ç›˜å—çš„åŸºæœ¬è¯»å†™æ“ä½œï¼Œæ˜¯æ–‡ä»¶ç³»ç»Ÿä¸ç£ç›˜è®¾å¤‡ä¹‹é—´çš„æ¥å£ã€‚</li><li><strong>å—ç¼“å­˜å±‚</strong>ï¼šå®ç°å—ç¼“å­˜åŠŸèƒ½ï¼Œæä¾›å¯¹å¤–è¯»å†™æ¥å£ã€‚ä¸ºäº†æé«˜æ–‡ä»¶ç³»ç»Ÿçš„è¯»å†™æ€§èƒ½ï¼Œè¯¥å±‚å¼•å…¥äº†å—ç¼“å­˜æœºåˆ¶ï¼Œå°†ç»å¸¸è®¿é—®çš„ç£ç›˜å—ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œå‡å°‘äº†ç£ç›˜çš„è¯»å†™æ¬¡æ•°ã€‚</li><li><strong>ç£ç›˜å—æ•°æ®ç»“æ„å±‚</strong>ï¼šå®ç° superblockï¼Œdatablockï¼Œinode ç­‰ç­‰ã€‚è¯¥å±‚å®šä¹‰äº†æ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬æ•°æ®ç»“æ„ï¼Œå¦‚è¶…çº§å—ã€æ•°æ®å—ã€ç´¢å¼•èŠ‚ç‚¹ç­‰ï¼Œç”¨äºç®¡ç†æ–‡ä»¶å’Œç›®å½•çš„å­˜å‚¨ã€‚</li><li><strong>ç£ç›˜å—ç®¡ç†å±‚</strong>ï¼šeasyfs çš„ä¸»è¦éƒ¨åˆ†ï¼Œè¿›è¡Œå—çš„ç®¡ç†ã€‚è¯¥å±‚è´Ÿè´£ç£ç›˜å—çš„åˆ†é…å’Œå›æ”¶ï¼Œç¡®ä¿æ–‡ä»¶ç³»ç»Ÿèƒ½å¤Ÿé«˜æ•ˆåœ°åˆ©ç”¨ç£ç›˜ç©ºé—´ã€‚</li><li><strong>ç´¢å¼•èŠ‚ç‚¹å±‚</strong>ï¼šinode å®ç°æ–‡ä»¶è¯»å†™ç®¡ç†åŠŸèƒ½ï¼Œå°è£…åå¯ä»¥æä¾›å¯¹å¤–æ¥å£è¯»å†™ã€‚è¯¥å±‚é€šè¿‡ç´¢å¼•èŠ‚ç‚¹æ¥ç®¡ç†æ–‡ä»¶å’Œç›®å½•çš„è¯»å†™æ“ä½œï¼Œä¸ºä¸Šå±‚çš„æ“ä½œç³»ç»Ÿæä¾›äº†ç»Ÿä¸€çš„æ–‡ä»¶è®¿é—®æ¥å£ã€‚</li></ol><p>é€šè¿‡ VFS å’Œ File trait å°è£…æ•´ä¸ª easyfs çš„ inodeï¼Œä¸ºä¸Šå±‚çš„ OS æä¾›æ¥å£ã€‚æœ€åé€šè¿‡ VirtIO æ¨¡æ‹Ÿå—è®¾å¤‡é©±åŠ¨ï¼Œæ­è½½åˆ° qemu æ¨¡æ‹Ÿå™¨ä¸Šé¢ã€‚</p><h3 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h3><h4 id="å—è®¾å¤‡æ¥å£å±‚"><a href="#å—è®¾å¤‡æ¥å£å±‚" class="headerlink" title="å—è®¾å¤‡æ¥å£å±‚"></a>å—è®¾å¤‡æ¥å£å±‚</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">BlockDevice</span>: <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span> + Any &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_block</span>(&amp;<span class="hljs-keyword">self</span>, block_id: <span class="hljs-type">usize</span>, buf: &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>]);<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_block</span>(&amp;<span class="hljs-keyword">self</span>, block_id: <span class="hljs-type">usize</span>, buf: &amp;[<span class="hljs-type">u8</span>]);<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle_irq</span>(&amp;<span class="hljs-keyword">self</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ç°äº†è¯»å†™å—å’Œå¤„ç†ä¸­æ–­çš„åŠŸèƒ½ã€‚è¯¥æ¥å£å®šä¹‰äº†å—è®¾å¤‡çš„åŸºæœ¬æ“ä½œï¼ŒåŒ…æ‹¬è¯»å–ç£ç›˜å—ã€å†™å…¥ç£ç›˜å—å’Œå¤„ç†ä¸­æ–­ã€‚ä»»ä½•å®ç°äº†è¯¥æ¥å£çš„ç±»å‹éƒ½å¯ä»¥ä½œä¸ºå—è®¾å¤‡ä½¿ç”¨ã€‚</p><h4 id="å—ç¼“å­˜å±‚"><a href="#å—ç¼“å­˜å±‚" class="headerlink" title="å—ç¼“å­˜å±‚"></a>å—ç¼“å­˜å±‚</h4><p>ä¸ºäº†åº”å¯¹é¢‘ç¹çš„è¯»å†™é‡‡ç”¨ç¼“å­˜åŠ é€Ÿã€‚</p><p><strong>å—ç¼“å­˜</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">BlockCache</span> &#123;<br>    cache: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;,<br>    block_id: <span class="hljs-type">usize</span>,<br>    block_device: Arc&lt;<span class="hljs-keyword">dyn</span> BlockDevice&gt;,<br>    modified: <span class="hljs-type">bool</span>,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>cache</code>ï¼šç¼“å­˜å­—èŠ‚è®°å½•ï¼Œç”¨äºå­˜å‚¨ç£ç›˜å—çš„å†…å®¹ã€‚</li><li><code>block_id</code>ï¼Œ<code>block_device</code>ï¼šå—è®¾å¤‡ä»¥åŠå—åœ°å€ï¼Œç”¨äºæ ‡è¯†ç¼“å­˜çš„ç£ç›˜å—ã€‚</li><li><code>modified</code>ï¼šè„æ ‡è®°ï¼Œé‡‡ç”¨æ‡’æ›´æ–°æ–¹å¼åˆ·å…¥ç£ç›˜ã€‚å¦‚æœè¯¥æ ‡è®°ä¸º <code>true</code>ï¼Œè¡¨ç¤ºç¼“å­˜ä¸­çš„æ•°æ®å·²ç»è¢«ä¿®æ”¹ï¼Œéœ€è¦åœ¨é€‚å½“çš„æ—¶å€™å°†å…¶å†™å›ç£ç›˜ã€‚</li></ul><p>æä¾›äº†åŸºæœ¬çš„è¯»å†™å’ŒåŒæ­¥åˆ·ç›˜æ–¹æ³•ã€‚å¯é€šè¿‡<code>get_block_cache</code>å–å¾—ï¼Œé€šè¿‡ä¼ é€’ä¸€ä¸ªé—­åŒ…å®ç°å¯¹åº”çš„æ–¹æ³•å’Œè®¿é—®åŠŸèƒ½ã€‚å—ç¼“å­˜çš„è¯»å†™æ“ä½œä¼šå…ˆåœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœç¼“å­˜ä¸­å­˜åœ¨æ‰€éœ€çš„æ•°æ®ï¼Œåˆ™ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–ï¼›å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œåˆ™ä»ç£ç›˜ä¸­è¯»å–å¹¶æ›´æ–°ç¼“å­˜ã€‚åŒæ­¥åˆ·ç›˜æ–¹æ³•ä¼šå°†ç¼“å­˜ä¸­è¢«ä¿®æ”¹çš„æ•°æ®å†™å›ç£ç›˜ã€‚</p><p><strong>å—ç¼“å­˜ç®¡ç†</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">const</span> BLOCK_CACHE_SIZE: <span class="hljs-type">usize</span> = <span class="hljs-number">16</span>;<br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">BlockCacheManager</span> &#123;<br>    queue: VecDeque&lt;(<span class="hljs-type">usize</span>, Arc&lt;Mutex&lt;BlockCache&gt;&gt;)&gt;,<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ªç®€å•çš„ç¼“å­˜ç®¡ç†ç»“æ„ï¼Œå®ç°äº† LRUå‡ºå…¥é˜Ÿå’Œè¯»å†™ã€åŒæ­¥æ–¹æ³•ã€‚è¯¥ç®¡ç†å™¨ä½¿ç”¨ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—æ¥ç»´æŠ¤ç¼“å­˜å—çš„è®¿é—®é¡ºåºï¼Œæœ€è¿‘è®¿é—®çš„ç¼“å­˜å—ä¼šè¢«ç§»åŠ¨åˆ°é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œå½“ç¼“å­˜æ»¡æ—¶ï¼Œä¼šå°†é˜Ÿåˆ—å°¾éƒ¨çš„ç¼“å­˜å—æ·˜æ±°ã€‚</p><h3 id="EasyFS"><a href="#EasyFS" class="headerlink" title="EasyFS"></a>EasyFS</h3><h4 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h4><p>åŸºæœ¬ç»“æ„å¦‚å›¾æ‰€ç¤º</p><h4 id="è¶…çº§å—"><a href="#è¶…çº§å—" class="headerlink" title="è¶…çº§å—"></a>è¶…çº§å—</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SuperBlock</span> &#123;<br>    magic: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> total_blocks: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> inode_bitmap_blocks: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> inode_area_blocks: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> data_bitmap_blocks: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> data_area_blocks: <span class="hljs-type">u32</span>,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>magic</code>ï¼šæ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥çš„é­”æ•°ï¼Œç”¨äºæ ‡è¯†æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹ã€‚</li><li><code>total_blocks</code>ï¼šæ–‡ä»¶ç³»ç»Ÿçš„æ€»å—æ•°ï¼Œå³ç£ç›˜ä¸Šå¯ç”¨çš„æ€»å—æ•°ã€‚</li><li><code>****_blocks</code>ï¼šç»™å‡ºäº†å„ä¸ªåŒºåŸŸçš„å—æ•°ï¼ŒåŒ…æ‹¬ inode ä½å›¾å—æ•°ã€inode åŒºåŸŸå—æ•°ã€æ•°æ®ä½å›¾å—æ•°å’Œæ•°æ®åŒºåŸŸå—æ•°ã€‚</li></ul><p>è¶…çº§å—å®ç°äº†<code>debug</code>æ–¹æ³•ï¼Œå³æ£€æŸ¥å„éƒ¨åˆ†å—æ•°ï¼Œä»¥åŠæ–‡ä»¶ç³»ç»Ÿçš„æ£€æŸ¥ï¼Œåˆ¤å®šæ˜¯å¦ä¸ºEFS</p><h4 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">const</span> BLOCK_BITS: <span class="hljs-type">usize</span> = BLOCK_SZ * <span class="hljs-number">8</span>;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Bitmap</span> &#123;<br>    start_block_id: <span class="hljs-type">usize</span>,<br>    blocks: <span class="hljs-type">usize</span>,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>start_block_id</code>ï¼šå½“å‰ bitmap èµ·å§‹ä½ç½®ï¼Œå³ä½å›¾æ‰€ç®¡ç†çš„ç¬¬ä¸€ä¸ªç£ç›˜å—çš„ç¼–å·ã€‚</li><li><code>blocks</code>ï¼šbitmap ç®¡ç†äº†å¤šå°‘å—ï¼Œå³ä½å›¾æ‰€ç®¡ç†çš„ç£ç›˜å—çš„æ•°é‡ã€‚</li></ul><p>bitmap å®ç°äº†åŸºæœ¬çš„åˆ†é…åŠŸèƒ½ï¼ŒåŒ…æ‹¬åˆ†é…å’Œé‡Šæ”¾å—æ—¶ä½å›¾çš„æ”¹å˜ã€‚è¿™é‡Œé€šè¿‡ç®€å•çš„çº¿æ€§éå†è¿›è¡Œç©ºå—åˆ¤æ–­ã€‚å½“éœ€è¦åˆ†é…ä¸€ä¸ªç£ç›˜å—æ—¶ï¼Œä½å›¾ä¼šä»èµ·å§‹ä½ç½®å¼€å§‹çº¿æ€§éå†ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªè¢«ä½¿ç”¨çš„å—ï¼Œå¹¶å°†å…¶æ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼›å½“éœ€è¦é‡Šæ”¾ä¸€ä¸ªç£ç›˜å—æ—¶ï¼Œä½å›¾ä¼šå°†è¯¥å—æ ‡è®°ä¸ºæœªä½¿ç”¨ã€‚</p><h4 id="DiskInode"><a href="#DiskInode" class="headerlink" title="DiskInode"></a>DiskInode</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">const</span> INODE_DIRECT_COUNT: <span class="hljs-type">usize</span> = <span class="hljs-number">27</span>;<br><span class="hljs-keyword">const</span> INODE_INDIRECT1_COUNT: <span class="hljs-type">usize</span> = BLOCK_SZ / <span class="hljs-number">4</span>;<br><span class="hljs-keyword">const</span> INODE_INDIRECT2_COUNT: <span class="hljs-type">usize</span> = INODE_INDIRECT1_COUNT * INODE_INDIRECT1_COUNT;<br><span class="hljs-keyword">const</span> INODE_INDIRECT3_COUNT: <span class="hljs-type">usize</span> = INODE_INDIRECT2_COUNT * INODE_INDIRECT1_COUNT;<br><span class="hljs-keyword">const</span> DIRECT_BOUND: <span class="hljs-type">usize</span> = INODE_DIRECT_COUNT;<br><span class="hljs-keyword">const</span> INDIRECT1_BOUND: <span class="hljs-type">usize</span> = DIRECT_BOUND + INODE_INDIRECT1_COUNT;<br><span class="hljs-keyword">const</span> INDIRECT2_BOUND: <span class="hljs-type">usize</span> = INDIRECT1_BOUND + INODE_INDIRECT2_COUNT;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DiskInodeType</span> &#123;<br>    File,<br>    Directory,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">DiskInode</span> &#123;<br>    <span class="hljs-keyword">pub</span> size: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> direct: [<span class="hljs-type">u32</span>; INODE_DIRECT_COUNT],<br>    <span class="hljs-keyword">pub</span> indirect1: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> indirect2: <span class="hljs-type">u32</span>,<br>    <span class="hljs-keyword">pub</span> indirect3: <span class="hljs-type">u32</span>,<br>    type_: DiskInodeType,<br>    <span class="hljs-keyword">pub</span> nlink: <span class="hljs-type">u32</span>,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>size</code>ï¼šå½“å‰å æ®çš„å—å¤§å°ï¼Œå³æ–‡ä»¶æˆ–ç›®å½•æ‰€å ç”¨çš„ç£ç›˜å—æ•°ã€‚</li><li><code>direct...</code>ï¼šç›´æ¥ç´¢å¼•å’Œä¸‰çº§é—´æ¥ç´¢å¼•ï¼Œç”¨äºç®¡ç†æ–‡ä»¶æˆ–ç›®å½•çš„æ•°æ®å—ã€‚ç›´æ¥ç´¢å¼•å¯ä»¥ç›´æ¥æŒ‡å‘æ•°æ®å—ï¼Œè€Œé—´æ¥ç´¢å¼•åˆ™é€šè¿‡ç´¢å¼•å—æ¥æŒ‡å‘æ•°æ®å—ã€‚</li><li><code>type_</code>ï¼šç´¢å¼•èŠ‚ç‚¹ç±»å‹ï¼Œåˆ†ä¸ºæ–‡ä»¶å’Œç›®å½•ä¸¤ç§ç±»å‹ã€‚</li><li><code>nlink</code>ï¼šç¡¬é“¾æ¥æ•°é‡ï¼Œå³æŒ‡å‘è¯¥ç´¢å¼•èŠ‚ç‚¹çš„ç¡¬é“¾æ¥çš„æ•°é‡ã€‚</li></ul><p><strong>DiskInode</strong>æ˜¯ç£ç›˜ä¸Šæ–‡ä»¶ï¼ˆFile or Directoryï¼‰å­˜å‚¨çš„åŸºæœ¬å½¢å¼ã€‚é€šè¿‡ç›´æ¥+é—´æ¥ç´¢å¼•çš„å½¢å¼ç®¡ç†æ–‡ä»¶æ•°æ®ã€‚åœ¨å—è·å–ï¼Œç©ºé—´ç®¡ç†æ–¹é¢æ ¹æ®ç´¢å¼•å®ç°ã€‚æœ‰å¦‚ä¸‹é‡è¦æ–¹æ³•ï¼š</p><ul><li><code>is_file</code> å’Œ <code>is_dir</code>ï¼šç±»å‹åˆ¤æ–­</li><li><code>increase_size</code>å’Œ<code>build_tree</code>ï¼šDiskInodeç©ºé—´å¢é•¿å’Œè¾…åŠ©å‡½æ•°ã€‚ä¸»è¦æ˜¯å¤šçº§ç´¢å¼•çš„é€’å½’åˆ†é…</li><li><code>clear_size</code>å’Œ<code>collect_tree_blocks</code>ï¼šé‡Šæ”¾DiskInodeçš„æ–¹æ³•å’Œå¯¹åº”çš„å¤šçº§ç´¢å¼•é€’å½’é‡Šæ”¾</li><li><code>read_at</code>å’Œ<code>write_at</code>å’Œ<code>get_block_id</code>ï¼šè¯»å†™æ–¹æ³•å’Œå¤šçº§ç´¢å¼•è·å–å—IDæ–¹æ³•</li></ul><h4 id="DitEntryï¼ˆDEntryï¼‰"><a href="#DitEntryï¼ˆDEntryï¼‰" class="headerlink" title="DitEntryï¼ˆDEntryï¼‰"></a>DitEntryï¼ˆDEntryï¼‰</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">DirEntry</span> &#123;<br>    name: [<span class="hljs-type">u8</span>; NAME_LENGTH_LIMIT + <span class="hljs-number">1</span>],<br>    inode_number: <span class="hljs-type">u32</span>,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>name</code>ï¼šInode Nameï¼Œå³æ–‡ä»¶æˆ–ç›®å½•çš„åç§°ã€‚</li><li><code>inode_number</code>ï¼šinode å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªç´¢å¼•èŠ‚ç‚¹ã€‚</li></ul><p>DirEntry æ˜¯ Inode åœ¨ DiskInode ä¸­å­˜å‚¨çš„åŸºæœ¬å•ä½ã€‚å›ºå®šä¸º 32B ä¾¿äºç®¡ç†ã€‚å®ç°äº†ç®€å•çš„å–å€¼æ–¹æ³•ã€‚ä¸»è¦èŒèƒ½æ˜¯ä» inode block æŒ‡å‘ data blockã€‚é€šè¿‡ç›®å½•é¡¹ï¼Œå¯ä»¥å°†ç›®å½•å’Œæ–‡ä»¶å…³è”èµ·æ¥ï¼Œå®ç°æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„ã€‚</p><h4 id="EFSç®¡ç†å™¨"><a href="#EFSç®¡ç†å™¨" class="headerlink" title="EFSç®¡ç†å™¨"></a>EFSç®¡ç†å™¨</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">EasyFileSystem</span> &#123;<br>    <span class="hljs-keyword">pub</span> block_device: Arc&lt;<span class="hljs-keyword">dyn</span> BlockDevice&gt;,<br>    <span class="hljs-keyword">pub</span> inode_bitmap: Bitmap,<br>    <span class="hljs-keyword">pub</span> data_bitmap: Bitmap,<br>    inode_area_start_block: <span class="hljs-type">u32</span>,<br>    data_area_start_block: <span class="hljs-type">u32</span>,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>block_device</code>ï¼šç®¡ç†å—çš„å—è®¾å¤‡ï¼Œç”¨äºè¯»å†™ç£ç›˜å—ã€‚</li><li><code>inode_bitmap</code>ï¼šç®¡ç† inode åˆ†é…çš„ bitmapï¼Œç”¨äºè®°å½• inode çš„ä½¿ç”¨æƒ…å†µã€‚</li><li><code>data_bitmap</code>ï¼šç®¡ç†æ•°æ®å—åˆ†é…çš„ bitmapï¼Œç”¨äºè®°å½•æ•°æ®å—çš„ä½¿ç”¨æƒ…å†µã€‚</li><li><code>inode_area_start_block</code>ï¼šinode åŒºåŸŸçš„èµ·å§‹å—ç¼–å·ã€‚</li><li><code>data_area_start_block</code>ï¼šæ•°æ®åŒºåŸŸçš„èµ·å§‹å—ç¼–å·ã€‚</li></ul><p>EFS ä½œä¸ºæ•´ä½“çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¯¹æ¥çš„æ˜¯ç£ç›˜ç®¡ç†å’Œ VFSï¼Œä¸ºä»–ä»¬æä¾›æ¥å£ã€‚å®ç°æ–¹æ³•ï¼š</p><ul><li><code>create</code>ï¼šåœ¨å—è®¾å¤‡ä¸Šåˆ›å»º EFSï¼Œåˆå§‹åŒ–æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—ã€ä½å›¾å’Œç´¢å¼•èŠ‚ç‚¹ç­‰ã€‚</li><li><code>open</code>ï¼šæ‰“å¼€å—è®¾å¤‡ï¼Œè¯»å–æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—å’Œä½å›¾ç­‰ä¿¡æ¯ï¼ŒéªŒè¯æ–‡ä»¶ç³»ç»Ÿçš„å®Œæ•´æ€§ã€‚</li><li><code>root_inode</code>ï¼šè·å–æ ¹èŠ‚ç‚¹ï¼Œè¿”å›æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç´¢å¼•èŠ‚ç‚¹ã€‚</li><li><code>alloc_data</code>å’Œ<code>dealloc_data</code>ï¼šå¯¹æ¥ bitmap çš„æ¥å£ï¼Œç”¨äºåˆ†é…å’Œé‡Šæ”¾æ•°æ®å—ã€‚</li></ul><h4 id="easy-fs-fuse"><a href="#easy-fs-fuse" class="headerlink" title="easy-fs-fuse"></a>easy-fs-fuse</h4><p>ä½œç”¨æ˜¯èƒ½æŠŠ user&#x2F;src&#x2F;bin&#x2F; å†…çš„æ‰€æœ‰ç¨‹åºäºŒè¿›åˆ¶æ ¼å¼æ‰“åŒ…ï¼ŒåŠ è½½åˆ°é¢„å…ˆå‡†å¤‡å¥½çš„ fs.img ä¸­ã€‚è¿™æ ·å°±ä¸éœ€è¦ä¸€ä¸ªä¸ªé“¾æ¥è¿›å»äº†ã€‚<code>easy-fs-fuse</code> æ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒå¯ä»¥å°† user&#x2F;src&#x2F;bin&#x2F; ç›®å½•ä¸‹çš„æ‰€æœ‰ç¨‹åºäºŒè¿›åˆ¶æ ¼å¼æ‰“åŒ…ï¼Œå¹¶åŠ è½½åˆ°é¢„å…ˆå‡†å¤‡å¥½çš„ fs.img ä¸­ã€‚è¿™æ ·ï¼Œåœ¨å¯åŠ¨ Qemu æ—¶ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥ç›´æ¥ä» fs.img ä¸­è¯»å–è¿™äº›ç¨‹åºï¼Œå¹¶åŠ è½½åˆ°å†…å­˜ä¸­æ‰§è¡Œã€‚</p><h3 id="VFS"><a href="#VFS" class="headerlink" title="VFS"></a>VFS</h3><h4 id="æ¦‚è¿°-1"><a href="#æ¦‚è¿°-1" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h4><p>è¿æ¥ EFS å’Œ OS å†…æ ¸çš„æŠ½è±¡å±‚ï¼Œä¸ºä»–ä»¬æä¾›æ¥å£ï¼Œå¹¶è‡´åŠ›äºå®ç°é€æ˜åŒ–ã€‚VFSæ˜¯ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå±‚ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ï¼Œä½¿å¾—æ“ä½œç³»ç»Ÿå†…æ ¸å¯ä»¥é€šè¿‡ç›¸åŒçš„æ–¹å¼è®¿é—®ä¸åŒç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿã€‚åœ¨ PotatOS ä¸­ï¼ŒVFS å±‚å°† EasyFS å’Œæ“ä½œç³»ç»Ÿå†…æ ¸è¿æ¥èµ·æ¥ï¼Œä¸ºå†…æ ¸æä¾›äº†ç»Ÿä¸€çš„æ–‡ä»¶è®¿é—®æ¥å£ï¼Œä½¿å¾—å†…æ ¸å¯ä»¥æ–¹ä¾¿åœ°æ“ä½œ EasyFS æ–‡ä»¶ç³»ç»Ÿã€‚</p><h4 id="Inode"><a href="#Inode" class="headerlink" title="Inode"></a>Inode</h4><p>VFSå±‚ä¸»è¦å°±æ˜¯ä¸ºæ“ä½œInodeæä¾›æ¥å£</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Inode</span> &#123;<br>    name: <span class="hljs-type">String</span>,<br>    block_id: <span class="hljs-type">usize</span>,<br>    block_offset: <span class="hljs-type">usize</span>,<br>    fs: Arc&lt;Mutex&lt;EasyFileSystem&gt;&gt;,<br>    block_device: Arc&lt;<span class="hljs-keyword">dyn</span> BlockDevice&gt;,<br>    inode_id: <span class="hljs-type">u32</span>,<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>name</code>ï¼šæ–‡ä»¶åï¼Œå³æ–‡ä»¶æˆ–ç›®å½•çš„åç§°ã€‚</li><li><code>block_id</code>ï¼Œ<code>block_offset</code>ï¼šInode åœ¨å“ªä¸ªå—ï¼Œå—å†…åç§»ã€‚å¯ç”¨äºå®šä½ï¼Œé€šè¿‡å—ç¼–å·å’Œå—å†…åç§»ï¼Œå¯ä»¥å‡†ç¡®åœ°æ‰¾åˆ° Inode åœ¨ç£ç›˜ä¸Šçš„ä½ç½®ã€‚</li><li><code>fs</code>ï¼Œ<code>block_device</code>ï¼šå½“å‰æ–‡ä»¶ç³»ç»Ÿå’Œå—è®¾å¤‡ï¼Œç”¨äºè®¿é—®æ–‡ä»¶ç³»ç»Ÿå’Œç£ç›˜å—ã€‚</li><li><code>inode_id</code>ï¼šinode æ ‡è¯†ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªç´¢å¼•èŠ‚ç‚¹ã€‚</li></ul><p>Inode éƒ¨åˆ†ä¸º OS å®ç°äº†æ“ä½œå—çš„æ¥å£ã€‚å¯ä»¥ç®€å•æŠŠ Inode çœ‹ä½œæ–‡ä»¶ &#x2F; ç›®å½•ã€‚</p><ul><li><code>read_disk_inode</code>å’Œ<code>modify_disk_inode</code>ï¼šæ“ä½œ DiskInodeï¼Œç”¨äºè¯»å–å’Œä¿®æ”¹ç£ç›˜ä¸Šçš„ç´¢å¼•èŠ‚ç‚¹ä¿¡æ¯ã€‚</li><li><code>increase_size</code>ï¼šä¸€äº›æ“ä½œ DiskInode çš„æ¥å£ï¼Œç”¨äºæ‰©å±•æ–‡ä»¶æˆ–ç›®å½•çš„ç©ºé—´ã€‚</li><li><code>create_file</code>å’Œ<code>create_dir</code>ï¼šåˆ›å»ºæ–‡ä»¶ &#x2F; ç›®å½•ï¼Œç”¨äºåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºæ–°çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚</li><li><code>linkat</code>å’Œ<code>unlinkat</code>ï¼šè¿›è¡Œç¡¬é“¾æ¥å’Œä½œä¸ºåˆ é™¤è¾…åŠ©å‡½æ•°ï¼Œç”¨äºåˆ›å»ºå’Œåˆ é™¤ç¡¬é“¾æ¥ã€‚</li><li>ä¸€äº›è®¿é—®ç»“æ„çš„å‡½æ•°ï¼Œç”¨äºè·å– Inode çš„ç›¸å…³ä¿¡æ¯ã€‚</li></ul><h3 id="File-Trait-File-System"><a href="#File-Trait-File-System" class="headerlink" title="File Trait &amp; File System"></a>File Trait &amp; File System</h3><h4 id="File"><a href="#File" class="headerlink" title="File"></a>File</h4><ul><li><code>write</code>å’Œ<code>read</code>ï¼šè¯»å†™æ–‡ä»¶</li><li><code>stat</code>ï¼šæ–‡ä»¶çŠ¶æ€ï¼ŒåŒ…æ‹¬è®¾å¤‡å·ã€inode_idã€æ–‡ä»¶ç±»å‹ã€ç¡¬è¿æ¥æ•°å’Œpadding</li></ul><h4 id="File-System"><a href="#File-System" class="headerlink" title="File System"></a>File System</h4><p>ç³»ç»Ÿè°ƒç”¨ï¼š</p><ul><li><p><code>sys_write</code>ï¼Œ<code>sys_read</code>ï¼Œ<code>sys_open</code>ï¼Œ<code>sys_close</code>ï¼šè¯»å†™ï¼Œæ‰“å¼€å…³é—­æ–‡ä»¶</p></li><li><p><code>sys_getcwd</code>ï¼Œ<code>sys_fstat</code>ï¼šè·å–current work directoryï¼Œè·å–fstat</p></li><li><p><code>sys_mkdir</code>ï¼Œ<code>sys_remove</code>ï¼Œ<code>remove_dir</code>ï¼šç›®å½•åˆ›å»ºå’Œåˆ é™¤çš„æ–¹æ³•ä»¥åŠè¾…åŠ©å‡½æ•°</p></li></ul><h2 id="IOè®¾å¤‡ç®¡ç†"><a href="#IOè®¾å¤‡ç®¡ç†" class="headerlink" title="IOè®¾å¤‡ç®¡ç†"></a>IOè®¾å¤‡ç®¡ç†</h2><p>ä¸€ä¸ªè®¾å¤‡éœ€è¦è®¾å¤‡é©±åŠ¨è¿›è¡Œç®¡ç†ã€‚è€Œä¸€ä¸ªè®¾å¤‡é©±åŠ¨éœ€è¦ä»¥ä¸‹çš„åŠŸèƒ½ï¼š</p><ol><li><strong>è®¾å¤‡çš„æ‰«æ &#x2F; å‘ç°</strong>ï¼šæ£€æµ‹ç³»ç»Ÿä¸­å­˜åœ¨çš„è®¾å¤‡ï¼Œå¹¶è¯†åˆ«å…¶ç±»å‹å’Œç‰¹æ€§ã€‚</li><li><strong>è®¾å¤‡åˆå§‹åŒ–</strong>ï¼šå¯¹è®¾å¤‡è¿›è¡Œåˆå§‹åŒ–ï¼Œé…ç½®è®¾å¤‡çš„å¯„å­˜å™¨å’Œå‚æ•°ï¼Œä½¿å…¶å¤„äºå¯ç”¨çŠ¶æ€ã€‚</li><li><strong>å‡†å¤‡å‘é€ç»™è®¾å¤‡çš„å‘½ä»¤</strong>ï¼šæ ¹æ®ç”¨æˆ·çš„è¯·æ±‚ï¼Œç”Ÿæˆç›¸åº”çš„å‘½ä»¤ï¼Œå¹¶å‡†å¤‡å‘é€ç»™è®¾å¤‡ã€‚</li><li><strong>é€šçŸ¥è®¾å¤‡</strong>ï¼šå°†å‡†å¤‡å¥½çš„å‘½ä»¤å‘é€ç»™è®¾å¤‡ï¼Œè§¦å‘è®¾å¤‡çš„æ“ä½œã€‚</li><li><strong>æ¥å—è®¾å¤‡é€šçŸ¥</strong>ï¼šæ¥æ”¶è®¾å¤‡çš„å“åº”å’Œé€šçŸ¥ï¼Œå¤„ç†è®¾å¤‡çš„ä¸­æ–­å’ŒçŠ¶æ€å˜åŒ–ã€‚</li><li><strong>å¸è½½è®¾å¤‡çš„åŒæ—¶å›æ”¶è®¾å¤‡èµ„æº</strong>ï¼šå½“è®¾å¤‡ä¸å†ä½¿ç”¨æ—¶ï¼Œå¸è½½è®¾å¤‡é©±åŠ¨ï¼Œå¹¶å›æ”¶è®¾å¤‡æ‰€å ç”¨çš„èµ„æºã€‚</li></ol><p>è¿™é‡Œä¸»è¦å®ç°äº†ä¸¤ç§è®¾å¤‡ï¼š</p><ul><li><strong>çœŸå®çš„ç‰©ç†è®¾å¤‡</strong>ï¼šå¦‚<code>URAT</code>ï¼Œç”¨äºå®ç°å­—ç¬¦è¾“å…¥å’Œè¾“å‡ºã€‚</li><li><strong>è™šæ‹Ÿè®¾å¤‡</strong>ï¼šå¦‚å„ç§<code>Virtio</code>è®¾å¤‡ï¼Œç”¨äºæ¨¡æ‹Ÿç¡¬ä»¶è®¾å¤‡çš„åŠŸèƒ½ï¼Œæé«˜ç³»ç»Ÿçš„å¯ç§»æ¤æ€§å’Œå…¼å®¹æ€§ã€‚</li></ul><p><strong>qemuç‰¹åŒ–</strong></p><p>æœ¬é¡¹ç›®åœ¨ qemu æ¨¡æ‹Ÿå™¨ä¸Šè¿è¡Œï¼Œå› æ­¤è¦åŸºäº qemu è¿›è¡Œè®¾å¤‡ç®¡ç†çš„ç‰¹åŒ–ã€‚</p><p>åœ¨ qemu é‡Œï¼ŒIO è®¾å¤‡çš„äº¤äº’ä»¥ä¸­æ–­ä¸ºä¸»ï¼Œè½®è¯¢ä¸ºè¾…ã€‚é€šè¿‡<code>PLIC å¹³å°çº§ä¸­æ–­æ§åˆ¶å™¨</code>è¿›è¡Œã€‚</p><p><strong>ç¡®å®šè®¾å¤‡å†…å­˜æ˜ å°„</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">const</span> MMIO: &amp;[(<span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>)] = &amp;[<br>    (<span class="hljs-number">0x0010_0000</span>, <span class="hljs-number">0x00_2000</span>), <span class="hljs-comment">// VIRT_TEST/RTC  in virt machine</span><br>    (<span class="hljs-number">0x2000000</span>, <span class="hljs-number">0x10000</span>),<br>    (<span class="hljs-number">0xc000000</span>, <span class="hljs-number">0x210000</span>), <span class="hljs-comment">// VIRT_PLIC in virt machine</span><br>    (<span class="hljs-number">0x10000000</span>, <span class="hljs-number">0x9000</span>),  <span class="hljs-comment">// VIRT_UART0 with GPU  in virt machine</span><br>];<br></code></pre></td></tr></table></figure><p><code>MMIO</code>ç¡®å®šäº†å„ä¸ªè®¾å¤‡åœ¨qemué‡Œçš„åœ°å€ã€‚é€šè¿‡è¿™äº›åœ°å€æ“ä½œç³»ç»Ÿå¯ä»¥ç›´æ¥è¯»å†™è®¾å¤‡å¯„å­˜å™¨è¿›è¡Œäº¤äº’</p><p><strong>è®¾å¤‡åˆå§‹åŒ–</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">device_init</span>() &#123;<br>    <span class="hljs-keyword">use</span> riscv::register::sie;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">plic</span> = <span class="hljs-keyword">unsafe</span> &#123; PLIC::<span class="hljs-title function_ invoke__">new</span>(VIRT_PLIC) &#125;;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">hart_id</span>: <span class="hljs-type">usize</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">supervisor</span> = IntrTargetPriority::Supervisor;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">machine</span> = IntrTargetPriority::Machine;<br>    plic.<span class="hljs-title function_ invoke__">set_threshold</span>(hart_id, supervisor, <span class="hljs-number">0</span>);<br>    plic.<span class="hljs-title function_ invoke__">set_threshold</span>(hart_id, machine, <span class="hljs-number">1</span>);<br>    <span class="hljs-comment">//irq nums: 5 keyboard, 6 mouse, 8 block, 10 uart</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">intr_src_id</span> <span class="hljs-keyword">in</span> [<span class="hljs-number">5usize</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>] &#123;<br>        plic.<span class="hljs-title function_ invoke__">enable</span>(hart_id, supervisor, intr_src_id);<br>        plic.<span class="hljs-title function_ invoke__">set_priority</span>(intr_src_id, <span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        sie::<span class="hljs-title function_ invoke__">set_sext</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è®¾å¤‡åˆå§‹åŒ–ï¼Œä¹Ÿæ˜¯ä¸­æ–­åˆå§‹åŒ–ï¼Œç»™æ¯ä¸ªè®¾å¤‡å¯åŠ¨ä¸­æ–­åŠŸèƒ½ã€‚å½“ä¸­æ–­å‘ç”Ÿæ—¶å¯ä»¥è°ƒç”¨å¯¹åº”è®¾å¤‡çš„ä¸­æ–­å“åº”å‡½æ•°ã€‚åœ¨è®¾å¤‡åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šå¯¹ PLICï¼ˆPlatform-Level Interrupt Controllerï¼‰è¿›è¡Œé…ç½®ï¼Œè®¾ç½®ä¸­æ–­é˜ˆå€¼å’Œä¼˜å…ˆçº§ï¼Œå¹¶ä½¿èƒ½ç›¸åº”çš„ä¸­æ–­æºã€‚åŒæ—¶ï¼Œä¼šå¼€å¯å¤–éƒ¨ä¸­æ–­ä½¿èƒ½ä½ï¼Œå…è®¸ç³»ç»Ÿæ¥æ”¶å¤–éƒ¨è®¾å¤‡çš„ä¸­æ–­è¯·æ±‚ã€‚</p><h4 id="ä¸­æ–­å¤„ç†"><a href="#ä¸­æ–­å¤„ç†" class="headerlink" title="ä¸­æ–­å¤„ç†"></a>ä¸­æ–­å¤„ç†</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">irq_handler</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">plic</span> = <span class="hljs-keyword">unsafe</span> &#123; PLIC::<span class="hljs-title function_ invoke__">new</span>(VIRT_PLIC) &#125;;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">intr_src_id</span> = plic.<span class="hljs-title function_ invoke__">claim</span>(<span class="hljs-number">0</span>, IntrTargetPriority::Supervisor);<br>    <span class="hljs-keyword">match</span> intr_src_id &#123;<br>        <span class="hljs-number">5</span> =&gt; KEYBOARD_DEVICE.<span class="hljs-title function_ invoke__">handle_irq</span>(),<br>        <span class="hljs-number">6</span> =&gt; MOUSE_DEVICE.<span class="hljs-title function_ invoke__">handle_irq</span>(),<br>        <span class="hljs-number">8</span> =&gt; BLOCK_DEVICE.<span class="hljs-title function_ invoke__">handle_irq</span>(),<br>        <span class="hljs-number">10</span> =&gt; UART.<span class="hljs-title function_ invoke__">handle_irq</span>(),<br>        _ =&gt; <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;unsupported IRQ &#123;&#125;&quot;</span>, intr_src_id),<br>    &#125;<br>    plic.<span class="hljs-title function_ invoke__">complete</span>(<span class="hljs-number">0</span>, IntrTargetPriority::Supervisor, intr_src_id);<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“å‘ç”Ÿä¸­æ–­æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šè°ƒç”¨ <code>irq_handler</code> å‡½æ•°è¿›è¡Œå¤„ç†ã€‚è¯¥å‡½æ•°ä¼šä» PLIC ä¸­è·å–ä¸­æ–­æºçš„ç¼–å·ï¼Œå¹¶æ ¹æ®ç¼–å·è°ƒç”¨ç›¸åº”è®¾å¤‡çš„ä¸­æ–­å¤„ç†å‡½æ•°ã€‚å¤„ç†å®Œä¸­æ–­åï¼Œä¼šé€šçŸ¥ PLIC ä¸­æ–­å¤„ç†å®Œæˆã€‚</p><h4 id="trap-å“åº”"><a href="#trap-å“åº”" class="headerlink" title="trap å“åº”"></a>trap å“åº”</h4><p>å†™å…¥<code>scause</code>ä¸ºå¤–éƒ¨ä¸­æ–­ï¼Œç”±qemuä¸­æ–­å¤„ç†</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// trap/mod.rs</span><br><span class="hljs-comment">// ...</span><br>Trap::<span class="hljs-title function_ invoke__">Interrupt</span>(Interrupt::SupervisorExternal) =&gt; &#123;<br>    crate::board::<span class="hljs-title function_ invoke__">irq_handler</span>();<br>&#125;<br><span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure><p>å½“å‘ç”Ÿè¶…çº§ç”¨æˆ·å¤–éƒ¨ä¸­æ–­æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šè°ƒç”¨ <code>irq_handler</code> å‡½æ•°è¿›è¡Œå¤„ç†ã€‚è¿™æ ·ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥åŠæ—¶å“åº”å¤–éƒ¨è®¾å¤‡çš„ä¸­æ–­è¯·æ±‚ï¼Œå¤„ç†è®¾å¤‡çš„è¾“å…¥å’Œè¾“å‡ºã€‚</p><h3 id="ä¸²å£é©±åŠ¨ç¨‹åºUART"><a href="#ä¸²å£é©±åŠ¨ç¨‹åºUART" class="headerlink" title="ä¸²å£é©±åŠ¨ç¨‹åºUART"></a>ä¸²å£é©±åŠ¨ç¨‹åºUART</h3><p><strong>ç›®çš„</strong></p><p>æŠŠå­—ç¬¦è¾“å…¥åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸é‡Œã€‚UARTï¼ˆUniversal Asynchronous Receiver&#x2F;Transmitterï¼‰æ˜¯ä¸€ç§é€šç”¨çš„å¼‚æ­¥æ”¶å‘ä¼ è¾“å™¨ï¼Œç”¨äºå®ç°å­—ç¬¦çš„è¾“å…¥å’Œè¾“å‡ºã€‚åœ¨ PotatOS ä¸­ï¼ŒUART é©±åŠ¨ç¨‹åºè´Ÿè´£å°†ç”¨æˆ·è¾“å…¥çš„å­—ç¬¦ä¼ è¾“åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå¹¶å°†å†…æ ¸è¾“å‡ºçš„å­—ç¬¦å‘é€åˆ°ç»ˆç«¯è®¾å¤‡ã€‚</p><h4 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><p><strong>ns16550a</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">NS16550aRaw</span> &#123;<br>    base_addr: <span class="hljs-type">usize</span>,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">NS16550aRaw</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_end</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> ReadWithoutDLAB &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123; &amp;<span class="hljs-keyword">mut</span> *(<span class="hljs-keyword">self</span>.base_addr <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> ReadWithoutDLAB) &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_end</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> WriteWithoutDLAB &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123; &amp;<span class="hljs-keyword">mut</span> *(<span class="hljs-keyword">self</span>.base_addr <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> WriteWithoutDLAB) &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(base_addr: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">Self</span> &#123; base_addr &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">read_end</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">read_end</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">mcr</span> = MCR::<span class="hljs-title function_ invoke__">empty</span>();<br>        mcr |= MCR::DATA_TERMINAL_READY;<br>        mcr |= MCR::REQUEST_TO_SEND;<br>        mcr |= MCR::AUX_OUTPUT2;<br>        read_end.mcr.<span class="hljs-title function_ invoke__">write</span>(mcr);<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">ier</span> = IER::RX_AVAILABLE;<br>        read_end.ier.<span class="hljs-title function_ invoke__">write</span>(ier);<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">read</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">u8</span>&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">read_end</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">read_end</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">lsr</span> = read_end.lsr.<span class="hljs-title function_ invoke__">read</span>();<br>        <span class="hljs-keyword">if</span> lsr.<span class="hljs-title function_ invoke__">contains</span>(LSR::DATA_AVAILABLE) &#123;<br>            <span class="hljs-title function_ invoke__">Some</span>(read_end.rbr.<span class="hljs-title function_ invoke__">read</span>())<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-literal">None</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, ch: <span class="hljs-type">u8</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">write_end</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">write_end</span>();<br>        <span class="hljs-keyword">loop</span> &#123;<br>            <span class="hljs-keyword">if</span> write_end.lsr.<span class="hljs-title function_ invoke__">read</span>().<span class="hljs-title function_ invoke__">contains</span>(LSR::THR_EMPTY) &#123;<br>                write_end.thr.<span class="hljs-title function_ invoke__">write</span>(ch);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡<code>MMIO</code>è¿›è¡Œé€šä¿¡ï¼Œè¯»å†™ã€‚å†…éƒ¨æ˜¯ä¸€å †å¯„å­˜å™¨ã€‚<code>NS16550aRaw</code> æ˜¯ä¸€ä¸ªåŸå§‹çš„ UART è®¾å¤‡ç»“æ„ä½“ï¼Œå®ƒé€šè¿‡å†…å­˜æ˜ å°„è¾“å…¥è¾“å‡ºï¼ˆMMIOï¼‰çš„æ–¹å¼ä¸ UART è®¾å¤‡è¿›è¡Œé€šä¿¡ã€‚åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šé…ç½® UART è®¾å¤‡çš„å¯„å­˜å™¨ï¼Œä½¿èƒ½æ¥æ”¶ä¸­æ–­ï¼Œå¹¶è®¾ç½®ç›¸åº”çš„æ§åˆ¶ä½ã€‚<code>read</code> æ–¹æ³•ç”¨äºä» UART è®¾å¤‡è¯»å–ä¸€ä¸ªå­—ç¬¦ï¼Œ<code>write</code> æ–¹æ³•ç”¨äºå‘ UART è®¾å¤‡å†™å…¥ä¸€ä¸ªå­—ç¬¦ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ReadWithoutDLAB</span> &#123;<br>    <span class="hljs-comment">/// receiver buffer register</span><br>    <span class="hljs-keyword">pub</span> rbr: ReadOnly&lt;<span class="hljs-type">u8</span>&gt;,<br>    <span class="hljs-comment">/// interrupt enable register</span><br>    <span class="hljs-keyword">pub</span> ier: Volatile&lt;IER&gt;,<br>    <span class="hljs-comment">/// interrupt identification register</span><br>    <span class="hljs-keyword">pub</span> iir: ReadOnly&lt;<span class="hljs-type">u8</span>&gt;,<br>    <span class="hljs-comment">/// line control register</span><br>    <span class="hljs-keyword">pub</span> lcr: Volatile&lt;<span class="hljs-type">u8</span>&gt;,<br>    <span class="hljs-comment">/// model control register</span><br>    <span class="hljs-keyword">pub</span> mcr: Volatile&lt;MCR&gt;,<br>    <span class="hljs-comment">/// line status register</span><br>    <span class="hljs-keyword">pub</span> lsr: ReadOnly&lt;LSR&gt;,<br>    <span class="hljs-comment">/// ignore MSR</span><br>    _padding1: ReadOnly&lt;<span class="hljs-type">u8</span>&gt;,<br>    <span class="hljs-comment">/// ignore SCR</span><br>    _padding2: ReadOnly&lt;<span class="hljs-type">u8</span>&gt;,<br>&#125;<br></code></pre></td></tr></table></figure><p><code>ReadWithoutDLAB</code> ç»“æ„ä½“å®šä¹‰äº† UART è®¾å¤‡çš„å¯„å­˜å™¨å¸ƒå±€ï¼ŒåŒ…æ‹¬æ¥æ”¶ç¼“å†²åŒºå¯„å­˜å™¨ã€ä¸­æ–­ä½¿èƒ½å¯„å­˜å™¨ã€ä¸­æ–­æ ‡è¯†å¯„å­˜å™¨ç­‰ã€‚é€šè¿‡è®¿é—®è¿™äº›å¯„å­˜å™¨ï¼Œå¯ä»¥å®ç°å¯¹ UART è®¾å¤‡çš„æ§åˆ¶å’Œæ•°æ®ä¼ è¾“ã€‚</p><h4 id="ä¸­æ–­å¤„ç†-1"><a href="#ä¸­æ–­å¤„ç†-1" class="headerlink" title="ä¸­æ–­å¤„ç†"></a>ä¸­æ–­å¤„ç†</h4><p>è®¾å¤‡åŒ…è£…æˆ<code>u8å­—èŠ‚ä¸²</code>ä¸å†…æ ¸è¿›è¡Œä¸­æ–­äº¤äº’</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">NS16550a</span>&lt;<span class="hljs-keyword">const</span> BASE_ADDR: <span class="hljs-type">usize</span>&gt; &#123;<br>    inner: UPIntrFreeCell&lt;NS16550aInner&gt;,<br>    condvar: Condvar,<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¿¡å·é‡<code>condvar</code>å®ç°å†…æ ¸éƒ¨åˆ†çš„ä¿¡å·é©±åŠ¨ IOã€‚å½“ UART è®¾å¤‡æ¥æ”¶åˆ°å­—ç¬¦æ—¶ï¼Œä¼šè§¦å‘ä¸­æ–­ï¼Œä¸­æ–­å¤„ç†å‡½æ•°ä¼šå°†æ¥æ”¶åˆ°çš„å­—ç¬¦å­˜å‚¨åˆ°ç¼“å†²åŒºä¸­ï¼Œå¹¶é€šè¿‡ä¿¡å·é‡é€šçŸ¥å†…æ ¸æœ‰æ–°çš„å­—ç¬¦å¯ç”¨ã€‚å†…æ ¸å¯ä»¥é€šè¿‡ç­‰å¾…ä¿¡å·é‡æ¥è·å–æ–°çš„å­—ç¬¦ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle_irq</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">count</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">self</span>.inner.<span class="hljs-title function_ invoke__">exclusive_session</span>(|inner| &#123;<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(ch) = inner.ns16550a.<span class="hljs-title function_ invoke__">read</span>() &#123;<br>            count += <span class="hljs-number">1</span>;<br>            inner.read_buffer.<span class="hljs-title function_ invoke__">push_back</span>(ch);<br>        &#125;<br>    &#125;);<br>    <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">self</span>.condvar.<span class="hljs-title function_ invoke__">signal</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä¸­æ–­å¤„ç†å‡½æ•°ä¸­ï¼Œä¼šä¸æ–­ä» UART è®¾å¤‡è¯»å–å­—ç¬¦ï¼Œå¹¶å°†å…¶å­˜å‚¨åˆ°ç¼“å†²åŒºä¸­ã€‚å¦‚æœè¯»å–åˆ°äº†å­—ç¬¦ï¼Œåˆ™é€šè¿‡ä¿¡å·é‡é€šçŸ¥å†…æ ¸ã€‚è¿™æ ·ï¼Œå†…æ ¸å¯ä»¥åœ¨æœ‰æ–°çš„å­—ç¬¦å¯ç”¨æ—¶è¢«å”¤é†’ï¼Œæé«˜äº†ç³»ç»Ÿçš„å“åº”æ€§èƒ½ã€‚</p><h4 id="å†…æ ¸é€šä¿¡"><a href="#å†…æ ¸é€šä¿¡" class="headerlink" title="å†…æ ¸é€šä¿¡"></a>å†…æ ¸é€šä¿¡</h4><p>UARTä½œä¸ºè¾“å…¥è®¾å¤‡è®¾ç«‹æˆ<code>stdin</code></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// stdio.rs</span><br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">File</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Stdin</span> &#123;<br><span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">read</span>(&amp;<span class="hljs-keyword">self</span>, <span class="hljs-keyword">mut</span> user_buf: UserBuffer) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        <span class="hljs-built_in">assert_eq!</span>(user_buf.<span class="hljs-title function_ invoke__">len</span>(), <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">//println!(&quot;before UART.read() in Stdin::read()&quot;);</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">ch</span> = UART.<span class="hljs-title function_ invoke__">read</span>();<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            user_buf.buffers[<span class="hljs-number">0</span>].<span class="hljs-title function_ invoke__">as_mut_ptr</span>().<span class="hljs-title function_ invoke__">write_volatile</span>(ch);<br>        &#125;<br>        <span class="hljs-number">1</span><br>    &#125;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿›ç¨‹åˆ›å»ºä¸­è‡ªåŠ¨è®¾ç½®<code>stdin</code>ï¼Œ<code>stdout</code>ï¼Œ<code>stderr</code>ã€‚UART è®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å…¥è®¾å¤‡ï¼ˆ<code>stdin</code>ï¼‰ï¼Œç”¨æˆ·ç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨ <code>Stdin</code> çš„ <code>read</code> æ–¹æ³•ä» UART è®¾å¤‡è¯»å–å­—ç¬¦ã€‚åœ¨è¿›ç¨‹åˆ›å»ºæ—¶ï¼Œä¼šè‡ªåŠ¨å°† <code>stdin</code>ã€<code>stdout</code> å’Œ <code>stderr</code> åˆ†åˆ«è®¾ç½®ä¸º UART è®¾å¤‡ï¼Œæ–¹ä¾¿ç”¨æˆ·ç¨‹åºè¿›è¡Œè¾“å…¥è¾“å‡ºæ“ä½œã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust">fd_table: <span class="hljs-built_in">vec!</span>[<br>    <span class="hljs-comment">// 0 -&gt; stdin</span><br>    <span class="hljs-title function_ invoke__">Some</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(Stdin)),<br>    <span class="hljs-comment">// 1 -&gt; stdout</span><br>    <span class="hljs-title function_ invoke__">Some</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(Stdout)),<br>    <span class="hljs-comment">// 2 -&gt; stderr</span><br>    <span class="hljs-title function_ invoke__">Some</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(Stdout)),<br>],<br></code></pre></td></tr></table></figure><p>æ­¤å¤„é”™è¯¯è¾“å‡ºè‡ªåŠ¨å¯¼å‘ç»ˆç«¯</p><h3 id="Virtio-Device"><a href="#Virtio-Device" class="headerlink" title="Virtio Device"></a>Virtio Device</h3><p>ä½œä¸ºä¸€ä¸ªè®¾å¤‡æ¥å£ï¼Œå…è®¸è™šæ‹Ÿæœºä¸Šè¿è¡Œçš„æ“ä½œç³»ç»Ÿ<strong>é€šè¿‡è®¿é—®virtioè®¾å¤‡ä½¿ç”¨ä¸»æœºè®¾å¤‡</strong>ã€‚è¿™é‡Œä¸»è¦æ˜¯åˆ©ç”¨å®ƒç®€å•åœ°å®ç°è™šæ‹Ÿè®¾å¤‡ã€‚</p><h3 id="Virtio-Block-Device"><a href="#Virtio-Block-Device" class="headerlink" title="Virtio Block Device"></a>Virtio Block Device</h3><p>æˆ‘ä»¬å¸Œæœ›é€šè¿‡æ“ä½œç³»ç»Ÿå†…æ ¸å¯¹è™šæ‹Ÿå—è®¾å¤‡è¿›è¡Œç®€å•çš„è¯»å†™ã€‚</p><h4 id="block-dev-trait"><a href="#block-dev-trait" class="headerlink" title="block-dev trait"></a>block-dev trait</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">BlockDevice</span>: <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span> + Any &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_block</span>(&amp;<span class="hljs-keyword">self</span>, block_id: <span class="hljs-type">usize</span>, buf: &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>]);<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">write_block</span>(&amp;<span class="hljs-keyword">self</span>, block_id: <span class="hljs-type">usize</span>, buf: &amp;[<span class="hljs-type">u8</span>]);<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle_irq</span>(&amp;<span class="hljs-keyword">self</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å—è®¾å¤‡éœ€è¦å®ç°çš„<code>trait</code>ï¼ŒåŒ…æ‹¬ç®€å•çš„è¯»å†™å’Œä¸­æ–­å¤„ç†ã€‚åœ¨<code>æ–‡ä»¶ç³»ç»Ÿ</code>ç« èŠ‚æœ‰æåŠã€‚</p><h4 id="virtio-block"><a href="#virtio-block" class="headerlink" title="virtio-block"></a>virtio-block</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VirtIOBlk</span>&lt;<span class="hljs-symbol">&#x27;a</span>, H: Hal&gt; &#123;<br>    header: &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> VirtIOHeader,<br>    queue: VirtQueue&lt;<span class="hljs-symbol">&#x27;a</span>, H&gt;,<br>    capacity: <span class="hljs-type">usize</span>,<br>&#125;<br><br><span class="hljs-comment">// drivers/block/virtio_blk.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VirtIOBlock</span> &#123;<br>    virtio_blk: UPIntrFreeCell&lt;VirtIOBlk&lt;<span class="hljs-symbol">&#x27;static</span>, VirtioHal&gt;&gt;,<br>    condvars: BTreeMap&lt;<span class="hljs-type">u16</span>, Condvar&gt;,<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒ…å«äº†è™šæ‹Ÿå—è®¾å¤‡çš„åŸºæœ¬ç»“æ„ï¼ŒåŒ…æ‹¬virtio-driverå’Œå¤šé€šé“é€šä¿¡ã€‚</p><p><code>condvars</code>ç”¨äºå®ç°IOè¯»å†™ã€‚äº‹å®ä¸Šï¼Œä¸€ä¸ª<code>condvar</code>å¯¹åº”ä¸€ä¸ª<code>virtio-queue</code>ã€‚virtio-queueæ˜¯è™šæ‹Ÿè®¾å¤‡ä¸­é€šè¿‡<strong>ä¸­æ–­é©±åŠ¨çš„IOé˜Ÿåˆ—ï¼Œæ”¯æŒè½®è¯¢</strong>ã€‚é€šè¿‡virtio-queueå¯ä»¥å®ç°è®¾å¤‡å’Œé©±åŠ¨ç¨‹åºçš„å„ç§æ•°æ®ä¼ è¾“å·¥ä½œã€‚</p><h4 id="æ“ä½œç³»ç»Ÿå¯¹æ¥å—è®¾å¤‡åˆå§‹åŒ–"><a href="#æ“ä½œç³»ç»Ÿå¯¹æ¥å—è®¾å¤‡åˆå§‹åŒ–" class="headerlink" title="æ“ä½œç³»ç»Ÿå¯¹æ¥å—è®¾å¤‡åˆå§‹åŒ–"></a>æ“ä½œç³»ç»Ÿå¯¹æ¥å—è®¾å¤‡åˆå§‹åŒ–</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">VirtIOBlock</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">virtio_blk</span> = <span class="hljs-keyword">unsafe</span> &#123;<br>            UPIntrFreeCell::<span class="hljs-title function_ invoke__">new</span>(<br>                VirtIOBlk::&lt;VirtioHal&gt;::<span class="hljs-title function_ invoke__">new</span>(&amp;<span class="hljs-keyword">mut</span> *(VIRTIO0 <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> VirtIOHeader)).<span class="hljs-title function_ invoke__">unwrap</span>(),<br>            )<br>        &#125;;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">condvars</span> = BTreeMap::<span class="hljs-title function_ invoke__">new</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">channels</span> = virtio_blk.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">virt_queue_size</span>();<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..channels &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">condvar</span> = Condvar::<span class="hljs-title function_ invoke__">new</span>();<br>            condvars.<span class="hljs-title function_ invoke__">insert</span>(i, condvar);<br>        &#125;<br>        <span class="hljs-keyword">Self</span> &#123;<br>            virtio_blk,<br>            condvars,<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆå§‹åŒ–<code>virtio-block</code>å’Œ<code>channels</code></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// qemu.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">BlockDeviceImpl</span> = crate::drivers::block::VirtIOBlock;<br><br><span class="hljs-comment">// drivers/block/mod.rs</span><br>lazy_static! &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">ref</span> BLOCK_DEVICE: Arc&lt;<span class="hljs-keyword">dyn</span> BlockDevice&gt; = Arc::<span class="hljs-title function_ invoke__">new</span>(BlockDeviceImpl::<span class="hljs-title function_ invoke__">new</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¨å±€åˆå§‹åŒ–å—è®¾å¤‡</p><h4 id="ä¸­æ–­å¤„ç†-2"><a href="#ä¸­æ–­å¤„ç†-2" class="headerlink" title="ä¸­æ–­å¤„ç†"></a>ä¸­æ–­å¤„ç†</h4><p>åŒä¸Šï¼Œé€šè¿‡ä¸­æ–­è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle_irq</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>    <span class="hljs-keyword">self</span>.virtio_blk.<span class="hljs-title function_ invoke__">exclusive_session</span>(|blk| &#123;<br>        <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Ok</span>(token) = blk.<span class="hljs-title function_ invoke__">pop_used</span>() &#123;<br>            <span class="hljs-keyword">self</span>.condvars.<span class="hljs-title function_ invoke__">get</span>(&amp;token).<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">signal</span>();<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»virtio-queueä¸­å–å‡ºå·²ä½¿ç”¨è¿‡çš„éƒ¨åˆ†è¿›è¡Œæ•°æ®ä¼ è¾“</p><h3 id="Virtio-GPU-Device"><a href="#Virtio-GPU-Device" class="headerlink" title="Virtio GPU Device"></a>Virtio GPU Device</h3><p>ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†<strong>è¿›ç¨‹è°ƒåº¦çš„å›¾å½¢åŒ–</strong>è€Œä½¿ç”¨qemuè™šæ‹Ÿç°å®è®¾å¤‡ã€‚ä¸»è¦çš„åŠŸèƒ½æ˜¯å¯¹æ˜¾ç¤ºè®¾å¤‡å†…å­˜è¿›è¡Œæ•°æ®è¯»å†™ã€‚é€šè¿‡è®¾ç½®<code>æ˜¾ç¤ºå±å°ºå¯¸</code>ï¼Œ<code>åƒç´ ç‚¹ä½ç½®</code>å’Œ<code>åƒç´ ç‚¹é¢œè‰²</code>å¯ä»¥å®ç°åŸºæœ¬çš„å›¾å½¢å±•ç¤ºã€‚åƒç´ ç‚¹çš„æ”¾ç½®ç”±<code>cursor</code>è¾…åŠ©å®ç°ã€‚</p><p><strong>ç®€å•çš„åŠ¨ç”»å®ç°</strong></p><p>ç®€å•åœ°è€ƒè™‘å°±æ˜¯ï¼šé¦–å…ˆç¨‹åºç»˜åˆ¶å½“å‰å¸§ï¼Œç„¶åå±å¹•åˆ·æ–°å¸§ã€‚</p><h4 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VirtIOGpu</span>&lt;<span class="hljs-symbol">&#x27;a</span>, H: Hal&gt; &#123;<br>    header: &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> VirtIOHeader,<br>    rect: Rect,<br>    <span class="hljs-comment">/// DMA area of frame buffer.</span><br>    frame_buffer_dma: <span class="hljs-type">Option</span>&lt;DMA&lt;H&gt;&gt;,<br>    <span class="hljs-comment">/// DMA area of cursor image buffer.</span><br>    cursor_buffer_dma: <span class="hljs-type">Option</span>&lt;DMA&lt;H&gt;&gt;,<br>    <span class="hljs-comment">/// Queue for sending control commands.</span><br>    control_queue: VirtQueue&lt;<span class="hljs-symbol">&#x27;a</span>, H&gt;,<br>    <span class="hljs-comment">/// Queue for sending cursor commands.</span><br>    cursor_queue: VirtQueue&lt;<span class="hljs-symbol">&#x27;a</span>, H&gt;,<br>    <span class="hljs-comment">/// Queue buffer DMA</span><br>    queue_buf_dma: DMA&lt;H&gt;,<br>    <span class="hljs-comment">/// Send buffer for queue.</span><br>    queue_buf_send: &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>],<br>    <span class="hljs-comment">/// Recv buffer for queue.</span><br>    queue_buf_recv: &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>],<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºäº†æé«˜ç³»ç»Ÿæ‰§è¡Œæ•ˆç‡ï¼Œ<code>åƒç´ å†…å­˜</code>å’Œ<code>å…‰æ ‡æ˜¾ç¤ºå†…å­˜</code>ç”±<strong>DMA</strong>ç®¡ç†å¹¶è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</p><p>è¿™é‡Œçš„DMAä½¿ç”¨å‰æ–‡<code>å†…å­˜ç®¡ç†</code>æåˆ°çš„å‡½æ•°æ–¹æ³•ç›´æ¥è®¿é—®ç‰©ç†&#x2F;è™šæ‹Ÿå†…å­˜ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Debug)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">DMA</span>&lt;H: Hal&gt; &#123;<br>    paddr: <span class="hljs-type">usize</span>,<br>    pages: <span class="hljs-type">usize</span>,<br>    _phantom: PhantomData&lt;H&gt;,<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;H: Hal&gt; DMA&lt;H&gt; &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(pages: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-keyword">Self</span>&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">paddr</span> = H::<span class="hljs-title function_ invoke__">dma_alloc</span>(pages);<br>        <span class="hljs-keyword">if</span> paddr == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(Error::DmaError);<br>        &#125;<br>        <span class="hljs-title function_ invoke__">Ok</span>(DMA &#123;<br>            paddr,<br>            pages,<br>            _phantom: PhantomData::<span class="hljs-title function_ invoke__">default</span>(),<br>        &#125;)<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">paddr</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        <span class="hljs-keyword">self</span>.paddr<br>    &#125;<br><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">vaddr</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        H::<span class="hljs-title function_ invoke__">phys_to_virt</span>(<span class="hljs-keyword">self</span>.paddr)<br>    &#125;<br><br>    <span class="hljs-comment">/// Returns the physical page frame number.</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">pfn</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> &#123;<br>        (<span class="hljs-keyword">self</span>.paddr &gt;&gt; <span class="hljs-number">12</span>) <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span><br>    &#125;<br><br>    <span class="hljs-comment">/// Convert to a buffer</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">as_buf</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>] &#123;<br>        core::slice::<span class="hljs-title function_ invoke__">from_raw_parts_mut</span>(<span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">vaddr</span>() <span class="hljs-keyword">as</span> _, PAGE_SIZE * <span class="hljs-keyword">self</span>.pages <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;H: Hal&gt; <span class="hljs-built_in">Drop</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">DMA</span>&lt;H&gt; &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">drop</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">err</span> = H::<span class="hljs-title function_ invoke__">dma_dealloc</span>(<span class="hljs-keyword">self</span>.paddr <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, <span class="hljs-keyword">self</span>.pages <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>);<br>        <span class="hljs-built_in">assert_eq!</span>(err, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;failed to deallocate DMA&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/// The interface which a particular hardware implementation must implement.</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">Hal</span> &#123;<br>    <span class="hljs-comment">/// Allocates the given number of contiguous physical pages of DMA memory for virtio use.</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">dma_alloc</span>(pages: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> PhysAddr;<br>    <span class="hljs-comment">/// Deallocates the given contiguous physical DMA memory pages.</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">dma_dealloc</span>(paddr: PhysAddr, pages: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span>;<br>    <span class="hljs-comment">/// Converts a physical address used for virtio to a virtual address which the program can</span><br>    <span class="hljs-comment">/// access.</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">phys_to_virt</span>(paddr: PhysAddr) <span class="hljs-punctuation">-&gt;</span> VirtAddr;<br>    <span class="hljs-comment">/// Converts a virtual address which the program can access to the corresponding physical</span><br>    <span class="hljs-comment">/// address to use for virtio.</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">virt_to_phys</span>(vaddr: VirtAddr) <span class="hljs-punctuation">-&gt;</span> PhysAddr;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>trait Hal</code>ç›´æ¥ç”³è¯·ç‰©ç†é¡µè¡¨å’Œç‰©ç†åœ°å€ï¼Œä»è€Œä¸ä½¿ç”¨ä¸­æ–­ç›´æ¥è®¿é—®åœ°å€ç©ºé—´ã€‚è¿™æ ·å¯ä»¥åŠ é€Ÿç³»ç»Ÿæ‰§è¡Œæ•ˆç‡</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Hal</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">VirtioHal</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">dma_alloc</span>(pages: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">trakcers</span> = <span class="hljs-title function_ invoke__">frame_alloc_more</span>(pages);<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">ppn_base</span> = trakcers.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">last</span>().<span class="hljs-title function_ invoke__">unwrap</span>().ppn;<br>        QUEUE_FRAMES<br>            .<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>())<br>            .<span class="hljs-title function_ invoke__">append</span>(&amp;<span class="hljs-keyword">mut</span> trakcers.<span class="hljs-title function_ invoke__">unwrap</span>());<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pa</span>: PhysAddr = ppn_base.<span class="hljs-title function_ invoke__">into</span>();<br>        pa.<span class="hljs-number">0</span><br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">dma_dealloc</span>(pa: <span class="hljs-type">usize</span>, pages: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">pa</span> = PhysAddr::<span class="hljs-title function_ invoke__">from</span>(pa);<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">ppn_base</span>: PhysPageNum = pa.<span class="hljs-title function_ invoke__">into</span>();<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..pages &#123;<br>            <span class="hljs-title function_ invoke__">frame_dealloc</span>(ppn_base);<br>            ppn_base.<span class="hljs-title function_ invoke__">step</span>();<br>        &#125;<br>        <span class="hljs-number">0</span><br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">phys_to_virt</span>(addr: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        addr<br>    &#125;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">virt_to_phys</span>(vaddr: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>        PageTable::<span class="hljs-title function_ invoke__">from_token</span>(<span class="hljs-title function_ invoke__">kernel_token</span>())<br>            .<span class="hljs-title function_ invoke__">translate_va</span>(VirtAddr::<span class="hljs-title function_ invoke__">from</span>(vaddr))<br>            .<span class="hljs-title function_ invoke__">unwrap</span>()<br>            .<span class="hljs-number">0</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="åˆå§‹åŒ–è™šæ‹ŸGPUè®¾å¤‡"><a href="#åˆå§‹åŒ–è™šæ‹ŸGPUè®¾å¤‡" class="headerlink" title="åˆå§‹åŒ–è™šæ‹ŸGPUè®¾å¤‡"></a>åˆå§‹åŒ–è™šæ‹ŸGPUè®¾å¤‡</h4><p>è¿™ä¸€æ­¥å°±æ˜¯è¿”å›ä¸€ä¸ªåˆå§‹åŒ–åçš„GPUè®¾å¤‡</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(header: &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> VirtIOHeader) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-keyword">Self</span>&gt; &#123;<br>        header.<span class="hljs-title function_ invoke__">begin_init</span>(|features| &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">features</span> = Features::<span class="hljs-title function_ invoke__">from_bits_truncate</span>(features);<br>            info!(<span class="hljs-string">&quot;Device features &#123;:?&#125;&quot;</span>, features);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">supported_features</span> = Features::<span class="hljs-title function_ invoke__">empty</span>();<br>            (features &amp; supported_features).<span class="hljs-title function_ invoke__">bits</span>()<br>        &#125;);<br><br>        <span class="hljs-comment">// read configuration space</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">config</span> = <span class="hljs-keyword">unsafe</span> &#123; &amp;<span class="hljs-keyword">mut</span> *(header.<span class="hljs-title function_ invoke__">config_space</span>() <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> Config) &#125;;<br>        info!(<span class="hljs-string">&quot;Config: &#123;:?&#125;&quot;</span>, config);<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">control_queue</span> = VirtQueue::<span class="hljs-title function_ invoke__">new</span>(header, QUEUE_TRANSMIT, <span class="hljs-number">2</span>)?;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">cursor_queue</span> = VirtQueue::<span class="hljs-title function_ invoke__">new</span>(header, QUEUE_CURSOR, <span class="hljs-number">2</span>)?;<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">queue_buf_dma</span> = DMA::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">2</span>)?;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">queue_buf_send</span> = <span class="hljs-keyword">unsafe</span> &#123; &amp;<span class="hljs-keyword">mut</span> queue_buf_dma.<span class="hljs-title function_ invoke__">as_buf</span>()[..PAGE_SIZE] &#125;;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">queue_buf_recv</span> = <span class="hljs-keyword">unsafe</span> &#123; &amp;<span class="hljs-keyword">mut</span> queue_buf_dma.<span class="hljs-title function_ invoke__">as_buf</span>()[PAGE_SIZE..] &#125;;<br><br>        header.<span class="hljs-title function_ invoke__">finish_init</span>();<br><br>        <span class="hljs-title function_ invoke__">Ok</span>(VirtIOGpu &#123;<br>            header,<br>            frame_buffer_dma: <span class="hljs-literal">None</span>,<br>            cursor_buffer_dma: <span class="hljs-literal">None</span>,<br>            rect: Rect::<span class="hljs-title function_ invoke__">default</span>(),<br>            control_queue,<br>            cursor_queue,<br>            queue_buf_dma,<br>            queue_buf_send,<br>            queue_buf_recv,<br>        &#125;)<br>    &#125;<br></code></pre></td></tr></table></figure><p>ä¸ºäº†èƒ½å¤Ÿå®ç°å›¾å½¢åŒ–ï¼Œè¿˜éœ€è¦å»ºç«‹<strong>æ˜¾ç¤ºåŒºåŸŸ</strong>ï¼Œå³<strong>æ¸²æŸ“å¸§</strong>å’Œ<strong>åˆ·æ–°å¸§</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">setup_framebuffer</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;&amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>]&gt; &#123;<br>        <span class="hljs-comment">// get display info</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">display_info</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">get_display_info</span>()?;<br>        info!(<span class="hljs-string">&quot;=&gt; &#123;:?&#125;&quot;</span>, display_info);<br>        <span class="hljs-keyword">self</span>.rect = display_info.rect;<br><br>        <span class="hljs-comment">// create resource 2d</span><br>        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">resource_create_2d</span>(<br>            RESOURCE_ID_FB,<br>            display_info.rect.width,<br>            display_info.rect.height,<br>        )?;<br><br>        <span class="hljs-comment">// alloc continuous pages for the frame buffer</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">size</span> = display_info.rect.width * display_info.rect.height * <span class="hljs-number">4</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">frame_buffer_dma</span> = DMA::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-title function_ invoke__">pages</span>(size <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>))?;<br><br>        <span class="hljs-comment">// resource_attach_backing</span><br>        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">resource_attach_backing</span>(RESOURCE_ID_FB, frame_buffer_dma.<span class="hljs-title function_ invoke__">paddr</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">u64</span>, size)?;<br><br>        <span class="hljs-comment">// map frame buffer to screen</span><br>        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">set_scanout</span>(display_info.rect, SCANOUT_ID, RESOURCE_ID_FB)?;<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">buf</span> = <span class="hljs-keyword">unsafe</span> &#123; frame_buffer_dma.<span class="hljs-title function_ invoke__">as_buf</span>() &#125;;<br>        <span class="hljs-keyword">self</span>.frame_buffer_dma = <span class="hljs-title function_ invoke__">Some</span>(frame_buffer_dma);<br>        <span class="hljs-title function_ invoke__">Ok</span>(buf)<br>    &#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥è®¾ç½®äº†<code>æ˜¾ç¤ºè®¾ç½®</code>ï¼Œå³è®¾å¤‡å°ºå¯¸å’Œåˆ†è¾¨ç‡ã€‚ä¸€ä¸ªåƒç´ å¤§å°<code>4å­—èŠ‚</code>ï¼Œç„¶åé“¾æ¥å¸§å’Œå±å¹•ã€‚</p><h4 id="è™šæ‹ŸGPUè®¾å¤‡IOæ“ä½œ"><a href="#è™šæ‹ŸGPUè®¾å¤‡IOæ“ä½œ" class="headerlink" title="è™šæ‹ŸGPUè®¾å¤‡IOæ“ä½œ"></a>è™šæ‹ŸGPUè®¾å¤‡IOæ“ä½œ</h4><p>å¦‚ä¸Šæ‰€è¨€ï¼ŒGPUè®¾å¤‡ä»…éœ€è¦ä¸¤æ­¥æ“ä½œï¼š</p><ol><li>æ¸²æŸ“å¸§ï¼šæŠŠåƒç´ æ•°æ®åˆ·å…¥æ˜¾å­˜å†…</li><li>åˆ·æ–°å¸§ï¼šæŠŠæ–°å¸§åˆ·åˆ°å±å¹•ä¸Š</li></ol><h4 id="è™šæ‹ŸGPUé©±åŠ¨"><a href="#è™šæ‹ŸGPUé©±åŠ¨" class="headerlink" title="è™šæ‹ŸGPUé©±åŠ¨"></a>è™šæ‹ŸGPUé©±åŠ¨</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">GpuDevice</span>: <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span> + Any &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_framebuffer</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>];<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">flush</span>(&amp;<span class="hljs-keyword">self</span>);<br>&#125;<br><br>lazy_static::lazy_static!(<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">ref</span> GPU_DEVICE: Arc&lt;<span class="hljs-keyword">dyn</span> GpuDevice&gt; = Arc::<span class="hljs-title function_ invoke__">new</span>(VirtIOGpuWrapper::<span class="hljs-title function_ invoke__">new</span>());<br>);<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">VirtIOGpuWrapper</span> &#123;<br>    gpu: UPIntrFreeCell&lt;VirtIOGpu&lt;<span class="hljs-symbol">&#x27;static</span>, VirtioHal&gt;&gt;,<br>    fb: &amp;<span class="hljs-symbol">&#x27;static</span> [<span class="hljs-type">u8</span>],<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">GpuDevice</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">VirtIOGpuWrapper</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">flush</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">self</span>.gpu.<span class="hljs-title function_ invoke__">exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>()).<span class="hljs-title function_ invoke__">flush</span>().<span class="hljs-title function_ invoke__">unwrap</span>();<br>    &#125;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_framebuffer</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>] &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">ptr</span> = <span class="hljs-keyword">self</span>.fb.<span class="hljs-title function_ invoke__">as_ptr</span>() <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> _ <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>;<br>            core::slice::<span class="hljs-title function_ invoke__">from_raw_parts_mut</span>(ptr, <span class="hljs-keyword">self</span>.fb.<span class="hljs-title function_ invoke__">len</span>())<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è™šæ‹ŸGPUè®¾å¤‡é‡‡ç”¨<code>DMA</code>ï¼Œå› æ­¤ä¸æ“ä½œç³»ç»Ÿçš„äº¤äº’ä¸éœ€è¦è¿›è¡Œåœ°å€å˜æ¢ï¼Œç›´æ¥è¿›è¡Œå­—èŠ‚è¯»å†™å³å¯ã€‚</p><p>ç°åœ¨<strong>å†…æ ¸æ€</strong>å¯ä»¥ç›´æ¥ä½¿ç”¨è™šæ‹ŸGPUè®¾å¤‡ã€‚ä½†æ˜¯æƒ³è¦åœ¨ç”¨æˆ·æ€ä½¿ç”¨(è®¾è®¡åº”ç”¨)è¿˜éœ€è¦ç³»ç»Ÿè°ƒç”¨ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">sys_framebuffer</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">fb</span> = GPU_DEVICE.<span class="hljs-title function_ invoke__">get_framebuffer</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">len</span> = fb.<span class="hljs-title function_ invoke__">len</span>();<br>    <span class="hljs-comment">// println!(&quot;[kernel] FrameBuffer: addr 0x&#123;:X&#125;, len &#123;&#125;&quot;, fb.as_ptr() as usize , len);</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">fb_start_pa</span> = PhysAddr::<span class="hljs-title function_ invoke__">from</span>(fb.<span class="hljs-title function_ invoke__">as_ptr</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>);<br>    <span class="hljs-built_in">assert!</span>(fb_start_pa.<span class="hljs-title function_ invoke__">aligned</span>());<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">fb_start_ppn</span> = fb_start_pa.<span class="hljs-title function_ invoke__">floor</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">fb_start_vpn</span> = VirtAddr::<span class="hljs-title function_ invoke__">from</span>(FB_VADDR).<span class="hljs-title function_ invoke__">floor</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pn_offset</span> = fb_start_ppn.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> <span class="hljs-type">isize</span> - fb_start_vpn.<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> <span class="hljs-type">isize</span>;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">current_process</span> = <span class="hljs-title function_ invoke__">current_process</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">inner</span> = current_process.<span class="hljs-title function_ invoke__">inner_exclusive_access</span>(<span class="hljs-built_in">file!</span>(), <span class="hljs-built_in">line!</span>());<br>    inner.memory_set.<span class="hljs-title function_ invoke__">push</span>(<br>        MapArea::<span class="hljs-title function_ invoke__">new</span>(<br>            (FB_VADDR <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            (FB_VADDR + len <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>).<span class="hljs-title function_ invoke__">into</span>(),<br>            MapType::<span class="hljs-title function_ invoke__">Linear</span>(pn_offset),<br>            MapPermission::R | MapPermission::W | MapPermission::U,<br>        ),<br>        <span class="hljs-literal">None</span>,<br>    );<br>    FB_VADDR <span class="hljs-keyword">as</span> <span class="hljs-type">isize</span><br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">sys_framebuffer_flush</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">isize</span> &#123;<br>    GPU_DEVICE.<span class="hljs-title function_ invoke__">flush</span>();<br>    <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨åˆ†åˆ«å¯¹åº”äº†ä¸¤ä¸ªæ­¥éª¤ï¼š<strong>è·å–å¸§åœ°å€å¹¶å°è¯•æ¸²æŸ“</strong>å’Œ<strong>åˆ·æ–°å¸§</strong></p><h4 id="ç§»æ¤å›¾å½¢åº“è¾…åŠ©å¼€å‘"><a href="#ç§»æ¤å›¾å½¢åº“è¾…åŠ©å¼€å‘" class="headerlink" title="ç§»æ¤å›¾å½¢åº“è¾…åŠ©å¼€å‘"></a>ç§»æ¤å›¾å½¢åº“è¾…åŠ©å¼€å‘</h4><p>å›¾å½¢åº“<strong>embedded-graphics</strong>ä¸ºå›¾å½¢åŒ–çš„å¼€å‘æä¾›å¾ˆå¤šä¾¿åˆ©ï¼Œä»…éœ€è¦å®ç°<code>trait Display</code>å³å¯æ–¹ä¾¿ä½œç”»</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Display</span> &#123;<br>    <span class="hljs-keyword">pub</span> size: Size,<br>    <span class="hljs-keyword">pub</span> fb: &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>],<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Display</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(size: Size) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">fb_ptr</span> = <span class="hljs-title function_ invoke__">framebuffer</span>() <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">fb</span> = <span class="hljs-keyword">unsafe</span> &#123; core::slice::<span class="hljs-title function_ invoke__">from_raw_parts_mut</span>(fb_ptr, VIRTGPU_LEN <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>) &#125;;<br>        <span class="hljs-keyword">Self</span> &#123; size, fb &#125;<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">framebuffer</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>] &#123;<br>        <span class="hljs-keyword">self</span>.fb<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">paint_on_framebuffer</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, p: <span class="hljs-keyword">impl</span> <span class="hljs-title class_">FnOnce</span>(&amp;<span class="hljs-keyword">mut</span> [<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> ()) &#123;<br>        <span class="hljs-title function_ invoke__">p</span>(<span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">framebuffer</span>());<br>    &#125;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">flush</span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-title function_ invoke__">framebuffer_flush</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">OriginDimensions</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Display</span> &#123;<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">size</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> Size &#123;<br>        <span class="hljs-keyword">self</span>.size<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">DrawTarget</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Display</span> &#123;<br>    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Color</span> = Rgb888;<br><br>    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Error</span> = core::convert::Infallible;<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">draw_iter</span>&lt;I&gt;(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, pixels: I) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), <span class="hljs-keyword">Self</span>::Error&gt;<br>    <span class="hljs-keyword">where</span><br>        I: <span class="hljs-built_in">IntoIterator</span>&lt;Item = embedded_graphics::Pixel&lt;<span class="hljs-keyword">Self</span>::Color&gt;&gt;,<br>    &#123;<br>        pixels.<span class="hljs-title function_ invoke__">into_iter</span>().for_each(|px| &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">idx</span> = (px.<span class="hljs-number">0</span>.y * VIRTGPU_XRES <span class="hljs-keyword">as</span> <span class="hljs-type">i32</span> + px.<span class="hljs-number">0</span>.x) <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> * <span class="hljs-number">4</span>;<br>            <span class="hljs-keyword">if</span> idx + <span class="hljs-number">2</span> &gt;= <span class="hljs-keyword">self</span>.fb.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">self</span>.fb[idx] = px.<span class="hljs-number">1</span>.<span class="hljs-title function_ invoke__">b</span>();<br>            <span class="hljs-keyword">self</span>.fb[idx + <span class="hljs-number">1</span>] = px.<span class="hljs-number">1</span>.<span class="hljs-title function_ invoke__">g</span>();<br>            <span class="hljs-keyword">self</span>.fb[idx + <span class="hljs-number">2</span>] = px.<span class="hljs-number">1</span>.<span class="hljs-title function_ invoke__">r</span>();<br>        &#125;);<br>        <span class="hljs-title function_ invoke__">Ok</span>(())<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå°±å¯ä»¥é€šè¿‡è¯¥å›¾å½¢åº“è¾…åŠ©å›¾å½¢åŒ–å¼€å‘ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><p><a href="https://rcore-os.cn/rCore-Tutorial-Book-v3/">https://rcore-os.cn/rCore-Tutorial-Book-v3/</a></p></li><li><p><a href="https://github.com/isrc-cas/riscv-isa-manual-cn">https://github.com/isrc-cas/riscv-isa-manual-cn</a></p></li><li><p><a href="https://rustmagazine.github.io/rust_magazine_2021/">https://rustmagazine.github.io/rust_magazine_2021/</a></p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
      <tag>è®¾è®¡æ–‡æ¡£</tag>
      
      <tag>è¯¾ç¨‹è®¾è®¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é¡¹ç›®</title>
    <link href="/2025/03/02/%E9%A1%B9%E7%9B%AE/"/>
    <url>/2025/03/02/%E9%A1%B9%E7%9B%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="é¡¹ç›®"><a href="#é¡¹ç›®" class="headerlink" title="é¡¹ç›®"></a>é¡¹ç›®</h1><h2 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a>Raft</h2><p>å¤šå‰¯æœ¬çŠ¶æ€æœºï¼Œè§£å†³<strong>å¼ºä¸€è‡´æ€§</strong>é—®é¢˜</p><h3 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><p><strong>æŒä¹…çŠ¶æ€ï¼ˆHard Stateï¼‰</strong></p><ul><li>currentTermï¼šåƒTSä¸€æ ·ç¡®å®šæ—¶é—´</li><li>votedForï¼š</li><li>log[]ï¼š</li></ul><p><strong>æ˜“å¤±æ€§çŠ¶æ€ï¼ˆSoft Stateï¼‰on All Server</strong></p><ul><li>commitIndexï¼šé›†ç¾¤å…±è¯†çš„æœ€æ–°commit index</li><li>lastAppliedï¼šæ¯ä¸ªèŠ‚ç‚¹åº”ç”¨äºè‡ªèº«çš„æœ€æ–°index</li></ul><p><em>é€šå¸¸æœ‰lastApplied &lt;&#x3D; commitIndex</em></p><p><strong>æ˜“å¤±æ€§çŠ¶æ€ on Leader</strong></p><p><em>Leaderç»™Followerç»´æŠ¤çš„å˜é‡</em></p><ul><li>nextIndex[]ï¼šä¸‹ä¸€ä¸ªè¦å‘é€çš„index</li><li>matchIndex[]ï¼šå·²æˆåŠŸå‘é€çš„index</li></ul><p><strong>AppendEntries RPC</strong></p><ul><li>termï¼šleaderå½“å‰RPCä»»æœŸ</li><li>leaderID</li><li>prevLogIndexï¼šç¡®è®¤indexå’Œtermä¸€è‡´ï¼Œæˆ–è€…å®šä½åˆ†æ­§ç‚¹ï¼ŒnextIndex - 1</li><li>prevLogTermï¼šå³followerä¸leaderä¸ä¸€è‡´çš„ç¬¬ä¸€å¤„</li><li>entries[]</li><li>leaderCommit</li></ul><p>return</p><ul><li>success</li><li>term</li></ul><p><strong>RequestVote RPC</strong></p><ul><li>term</li><li>candidateID</li><li>lastLogIndex</li><li>lastLogTerm</li></ul><p>return</p><ul><li>term</li><li>voteGrantedï¼šèµ¢å¾—é€‰ç¥¨</li></ul><h4 id="æ—¶é—´è¦æ±‚"><a href="#æ—¶é—´è¦æ±‚" class="headerlink" title="æ—¶é—´è¦æ±‚"></a>æ—¶é—´è¦æ±‚</h4><blockquote><p>stTimeï¼‰ &lt;&lt; é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆelectionTimeoutï¼‰ &lt;&lt; å¹³å‡æ•…éšœé—´éš”æ—¶é—´ï¼ˆMTBFï¼‰</p></blockquote><h3 id="Leader-Election-Heartbeats"><a href="#Leader-Election-Heartbeats" class="headerlink" title="Leader Election &amp; Heartbeats"></a>Leader Election &amp; Heartbeats</h3><h4 id="RequestVote"><a href="#RequestVote" class="headerlink" title="RequestVote"></a><strong>RequestVote</strong></h4><p>æ¥æ”¶è€…å®ç°ï¼š</p><ol><li>å¦‚æœ<code>term &lt; currentTerm</code>è¿”å› false ï¼ˆè€èŠ‚ç‚¹ï¼‰</li><li>å¦‚æœ votedFor ä¸ºç©ºæˆ–è€…ä¸º candidateIdï¼Œå¹¶ä¸”å€™é€‰äººçš„æ—¥å¿—è‡³å°‘å’Œè‡ªå·±ä¸€æ ·æ–°ï¼Œé‚£ä¹ˆå°±æŠ•ç¥¨ç»™ä»–ï¼ˆå¯æŠ•ç¥¨ï¼‰</li></ol><p><strong>æ‰€æœ‰æœåŠ¡å™¨éœ€éµå®ˆçš„è§„åˆ™</strong>ï¼š</p><p>æ‰€æœ‰æœåŠ¡å™¨ï¼š</p><ul><li>å¦‚æœ<code>commitIndex &gt; lastApplied</code>ï¼Œåˆ™ lastApplied é€’å¢ï¼Œå¹¶å°†<code>log[lastApplied]</code>åº”ç”¨åˆ°çŠ¶æ€æœºä¸­ï¼ˆçŠ¶æ€æ›´æ–°åˆ°æœ€æ–°ï¼‰</li><li>å¦‚æœæ¥æ”¶åˆ°çš„ RPC è¯·æ±‚æˆ–å“åº”ä¸­ï¼Œä»»æœŸå·<code>T &gt; currentTerm</code>ï¼Œåˆ™ä»¤ <code>currentTerm = T</code>ï¼Œå¹¶åˆ‡æ¢ä¸ºè·Ÿéšè€…çŠ¶æ€ï¼ˆé‡åˆ°æ–°èŠ‚ç‚¹ï¼Œæ›´æ–°çŠ¶æ€ï¼‰</li></ul><p>è·Ÿéšè€…ï¼ˆ5.2 èŠ‚ï¼‰ï¼š</p><ul><li>å“åº”æ¥è‡ªå€™é€‰äººå’Œé¢†å¯¼äººçš„è¯·æ±‚</li><li>å¦‚æœåœ¨è¶…è¿‡é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„æƒ…å†µä¹‹å‰æ²¡æœ‰æ”¶åˆ°<strong>å½“å‰é¢†å¯¼äºº</strong>ï¼ˆå³è¯¥é¢†å¯¼äººçš„ä»»æœŸéœ€ä¸è¿™ä¸ªè·Ÿéšè€…çš„å½“å‰ä»»æœŸç›¸åŒï¼‰çš„å¿ƒè·³&#x2F;é™„åŠ æ—¥å¿—ï¼Œæˆ–è€…æ˜¯ç»™æŸä¸ªå€™é€‰äººæŠ•äº†ç¥¨ï¼Œå°±è‡ªå·±å˜æˆå€™é€‰äºº</li></ul><p>å€™é€‰äººï¼ˆ5.2 èŠ‚ï¼‰ï¼š</p><ul><li>åœ¨è½¬å˜æˆå€™é€‰äººåå°±ç«‹å³å¼€å§‹é€‰ä¸¾è¿‡ç¨‹<ul><li>è‡ªå¢å½“å‰çš„ä»»æœŸå·ï¼ˆcurrentTermï¼‰</li><li>ç»™è‡ªå·±æŠ•ç¥¨</li><li>é‡ç½®é€‰ä¸¾è¶…æ—¶è®¡æ—¶å™¨</li><li>å‘é€è¯·æ±‚æŠ•ç¥¨çš„ RPC ç»™å…¶ä»–æ‰€æœ‰æœåŠ¡å™¨</li></ul></li><li>å¦‚æœæ¥æ”¶åˆ°å¤§å¤šæ•°æœåŠ¡å™¨çš„é€‰ç¥¨ï¼Œé‚£ä¹ˆå°±å˜æˆé¢†å¯¼äºº</li><li>å¦‚æœæ¥æ”¶åˆ°æ¥è‡ªæ–°çš„é¢†å¯¼äººçš„é™„åŠ æ—¥å¿—ï¼ˆAppendEntriesï¼‰RPCï¼Œåˆ™è½¬å˜æˆè·Ÿéšè€…</li><li>å¦‚æœé€‰ä¸¾è¿‡ç¨‹è¶…æ—¶ï¼Œåˆ™å†æ¬¡å‘èµ·ä¸€è½®é€‰ä¸¾</li></ul><p>é¢†å¯¼äººï¼š</p><ul><li><p>ä¸€æ—¦æˆä¸ºé¢†å¯¼äººï¼šå‘é€ç©ºçš„é™„åŠ æ—¥å¿—ï¼ˆAppendEntriesï¼‰RPCï¼ˆå¿ƒè·³ï¼‰ç»™å…¶ä»–æ‰€æœ‰çš„æœåŠ¡å™¨ï¼›åœ¨ä¸€å®šçš„ç©ºä½™æ—¶é—´ä¹‹åä¸åœçš„é‡å¤å‘é€ï¼Œä»¥é˜²æ­¢è·Ÿéšè€…è¶…æ—¶ï¼ˆ5.2 èŠ‚ï¼‰</p></li><li><p>å¦‚æœæ¥æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼šé™„åŠ æ¡ç›®åˆ°æœ¬åœ°æ—¥å¿—ä¸­ï¼Œåœ¨æ¡ç›®è¢«åº”ç”¨åˆ°çŠ¶æ€æœºåå“åº”å®¢æˆ·ç«¯ï¼ˆ5.3 èŠ‚ï¼‰</p></li><li><p>å¦‚æœå¯¹äºä¸€ä¸ªè·Ÿéšè€…ï¼Œæœ€åæ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼å¤§äºç­‰äº nextIndexï¼ˆ</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss">lastLogIndex â‰¥ <span class="hljs-built_in">nextIndex</span><br></code></pre></td></tr></table></figure><p>ï¼‰ï¼Œåˆ™å‘é€ä» nextIndex å¼€å§‹çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ï¼š</p><ul><li>å¦‚æœæˆåŠŸï¼šæ›´æ–°ç›¸åº”è·Ÿéšè€…çš„ nextIndex å’Œ matchIndex</li><li>å¦‚æœå› ä¸ºæ—¥å¿—ä¸ä¸€è‡´è€Œå¤±è´¥ï¼Œåˆ™ nextIndex é€’å‡å¹¶é‡è¯•</li></ul></li><li><p>å‡è®¾å­˜åœ¨ N æ»¡è¶³<code>N &gt; commitIndex</code>ï¼Œä½¿å¾—å¤§å¤šæ•°çš„ <code>matchIndex[i] â‰¥ N</code>ä»¥åŠ<code>log[N].term == currentTerm</code> æˆç«‹ï¼Œåˆ™ä»¤ <code>commitIndex = N</code>ï¼ˆ5.3 å’Œ 5.4 èŠ‚ï¼‰</p></li></ul><h4 id="AppendEntries"><a href="#AppendEntries" class="headerlink" title="AppendEntries"></a>AppendEntries</h4><p>æ¥æ”¶è€…çš„å®ç°ï¼š</p><ol><li>è¿”å›å‡ å¦‚æœé¢†å¯¼äººçš„ä»»æœŸå°äºæ¥æ”¶è€…çš„å½“å‰ä»»æœŸï¼ˆè¯‘è€…æ³¨ï¼šè¿™é‡Œçš„æ¥æ”¶è€…æ˜¯æŒ‡è·Ÿéšè€…æˆ–è€…å€™é€‰äººï¼‰ï¼ˆ5.1 èŠ‚ï¼‰</li><li>è¿”å›å‡ å¦‚æœæ¥æ”¶è€…æ—¥å¿—ä¸­æ²¡æœ‰åŒ…å«è¿™æ ·ä¸€ä¸ªæ¡ç›® å³è¯¥æ¡ç›®çš„ä»»æœŸåœ¨ prevLogIndex ä¸Šèƒ½å’Œ prevLogTerm åŒ¹é…ä¸Š ï¼ˆè¯‘è€…æ³¨ï¼šåœ¨æ¥æ”¶è€…æ—¥å¿—ä¸­ å¦‚æœèƒ½æ‰¾åˆ°ä¸€ä¸ªå’Œ prevLogIndex ä»¥åŠ prevLogTerm ä¸€æ ·çš„ç´¢å¼•å’Œä»»æœŸçš„æ—¥å¿—æ¡ç›® åˆ™ç»§ç»­æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤ å¦åˆ™è¿”å›å‡ï¼‰ï¼ˆ5.3 èŠ‚ï¼‰</li><li>å¦‚æœä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ¡ç›®å’Œæ–°æ¡ç›®ï¼ˆè¯‘è€…æ³¨ï¼šå³åˆšåˆšæ¥æ”¶åˆ°çš„æ—¥å¿—æ¡ç›®ï¼‰å‘ç”Ÿäº†å†²çªï¼ˆå› ä¸ºç´¢å¼•ç›¸åŒï¼Œä»»æœŸä¸åŒï¼‰ï¼Œé‚£ä¹ˆå°±åˆ é™¤è¿™ä¸ªå·²ç»å­˜åœ¨çš„æ¡ç›®ä»¥åŠå®ƒä¹‹åçš„æ‰€æœ‰æ¡ç›® ï¼ˆ5.3 èŠ‚ï¼‰</li><li>è¿½åŠ æ—¥å¿—ä¸­å°šæœªå­˜åœ¨çš„ä»»ä½•æ–°æ¡ç›®</li><li>å¦‚æœé¢†å¯¼äººçš„å·²çŸ¥å·²æäº¤çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å¤§äºæ¥æ”¶è€…çš„å·²çŸ¥å·²æäº¤æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆ<code>leaderCommit &gt; commitIndex</code>ï¼‰ï¼Œåˆ™æŠŠæ¥æ”¶è€…çš„å·²çŸ¥å·²ç»æäº¤çš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•commitIndex é‡ç½®ä¸º é¢†å¯¼äººçš„å·²çŸ¥å·²ç»æäº¤çš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼• leaderCommit æˆ–è€…æ˜¯ ä¸Šä¸€ä¸ªæ–°æ¡ç›®çš„ç´¢å¼• å–ä¸¤è€…çš„æœ€å°å€¼</li></ol><h4 id="ticker"><a href="#ticker" class="headerlink" title="ticker"></a>ticker</h4><p>è®¡æ—¶ç¡®ä¿é€‰ä¸¾å’Œå¿ƒè·³é¡ºåˆ©è¿›è¡Œ</p><h4 id="sendHeartbeat"><a href="#sendHeartbeat" class="headerlink" title="sendHeartbeat"></a>sendHeartbeat</h4><p>åŒæ­¥Followeræ—¥å¿—ï¼Œç‰¹æ®Šçš„AppendEntries</p><h3 id="Logæ—¥å¿—"><a href="#Logæ—¥å¿—" class="headerlink" title="Logæ—¥å¿—"></a>Logæ—¥å¿—</h3><blockquote><p>Life is Append-Only</p></blockquote><p>å¦‚ä½•è®¾ç½®ä¸€ä¸ªåç¨‹è§¦å‘AppendEntries?</p><h4 id="ApplyChannel-ApplyMsg"><a href="#ApplyChannel-ApplyMsg" class="headerlink" title="ApplyChannel &amp; ApplyMsg"></a>ApplyChannel &amp; ApplyMsg</h4><p>å®ç°äº†<strong>Raft</strong>å’Œ<strong>çŠ¶æ€æœº</strong>ä¹‹é—´çš„è§£è€¦ï¼Œè´Ÿè´£æ‰“åŒ…ä¼ é€’å¤åˆ¶çš„æ—¥å¿—ã€‚</p><p>å®é™…ä¸Šæœ¬ç¨‹åºä»…å®ç°äº†çŠ¶æ€æœºå†…éƒ¨çš„åŠŸèƒ½ï¼Œå¤–éƒ¨çš„æ¥å£å’Œè°ƒç”¨è¿˜éœ€è§‚å¯Ÿã€‚</p><p>å¤–éƒ¨é€šè¿‡<strong>applyCh</strong>è·å¾—æ›´æ–°çš„æ—¥å¿—ï¼Œå¹¶ä¸”æ£€æŸ¥ï¼Ÿ</p><p>å½“commitIndexæ›´æ–°æ—¶ï¼Œéœ€è¦è§£å¼€<strong>applyCond</strong>è¿›è¡ŒåŠæ—¶ä¼ é€’ã€‚</p><h3 id="æŒä¹…åŒ–"><a href="#æŒä¹…åŒ–" class="headerlink" title="æŒä¹…åŒ–"></a>æŒä¹…åŒ–</h3><h2 id="æ•°æ®åº“ä¼˜åŒ–"><a href="#æ•°æ®åº“ä¼˜åŒ–" class="headerlink" title="æ•°æ®åº“ä¼˜åŒ–"></a>æ•°æ®åº“ä¼˜åŒ–</h2><p>â€‹é¢è¯•æ€»ç»“ï¼šSREå²—ä½</p><h4 id="é¡¹ç›®èƒŒæ™¯"><a href="#é¡¹ç›®èƒŒæ™¯" class="headerlink" title="é¡¹ç›®èƒŒæ™¯"></a>é¡¹ç›®èƒŒæ™¯</h4><p>ä½œä¸ºä¸€åè®¡ç®—æœºç§‘å­¦ä¸“ä¸šçš„å­¦ç”Ÿï¼Œæˆ‘å‚ä¸äº†2024å¹´å…¨å›½å¤§å­¦ç”Ÿè®¡ç®—æœºç³»ç»Ÿèƒ½åŠ›å¤§èµ›PolarDBæ•°æ®åº“åˆ›æ–°è®¾è®¡èµ›ï¼ˆå¤©æ± æ¯ï¼‰ï¼Œè´Ÿè´£æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–å·¥ä½œã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯é€šè¿‡å¤šç§ä¼˜åŒ–ç­–ç•¥ï¼Œå°†PolarDBåœ¨TPC-HåŸºå‡†æµ‹è¯•ä¸­çš„æ€§èƒ½æå‡78.5%ã€‚ä»¥ä¸‹æ˜¯æˆ‘åœ¨é¡¹ç›®ä¸­çš„ä¸»è¦è´¡çŒ®å’Œç»éªŒæ€»ç»“ï¼Œä»¥åŠå¦‚ä½•å°†è¿™äº›ç»éªŒåº”ç”¨äºSREå²—ä½ã€‚</p><h4 id="é¡¹ç›®ç»éªŒä¸SREç›¸å…³æ€§"><a href="#é¡¹ç›®ç»éªŒä¸SREç›¸å…³æ€§" class="headerlink" title="é¡¹ç›®ç»éªŒä¸SREç›¸å…³æ€§"></a>é¡¹ç›®ç»éªŒä¸SREç›¸å…³æ€§</h4><ol><li><p><strong>ç³»ç»Ÿä¼˜åŒ–ä¸æ€§èƒ½æå‡</strong></p><ul><li><p><strong>å‚æ•°ä¼˜åŒ–ï¼š</strong> è°ƒæ•´æ•°æ®åº“é…ç½®å‚æ•°ï¼Œå¦‚å†…å­˜ä½¿ç”¨ã€å¹¶è¡Œè®¾ç½®ç­‰ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨é«˜è´Ÿè½½ä¸‹ç¨³å®šè¿è¡Œã€‚è¿™ä¸SREçš„æ ¸å¿ƒèŒè´£â€”â€”ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½å’Œå¯é æ€§â€”â€”é«˜åº¦å¥‘åˆã€‚</p></li><li><p><strong>ç¼–è¯‘ä¼˜åŒ–ï¼š</strong> é€šè¿‡å…³é—­è°ƒè¯•æ¨¡å¼å’Œé‡‡ç”¨O3ä¼˜åŒ–ï¼Œæ˜¾è‘—æå‡æŸ¥è¯¢é€Ÿåº¦ã€‚è¿™ä½“ç°äº†æˆ‘å¯¹ç³»ç»Ÿåº•å±‚ä¼˜åŒ–çš„ç†è§£ï¼Œæœ‰åŠ©äºåœ¨SREå²—ä½ä¸­ä¼˜åŒ–ç”Ÿäº§ç¯å¢ƒä¸­çš„ç³»ç»Ÿæ€§èƒ½ã€‚</p><blockquote><p>ç¼–è¯‘ä¼˜åŒ–ï¼šå¾ªç¯ä¼˜åŒ–ï¼Œå†…è”ï¼ŒSIMDï¼Œæ•°æ®å¯¹é½ï¼Œç¼“å­˜è¯»å–</p></blockquote></li><li><p><strong>æŸ¥è¯¢ä¼˜åŒ–ï¼š</strong> é‡å†™SQLè¯­å¥ï¼Œä½¿ç”¨CTEæ›¿ä»£å­æŸ¥è¯¢ï¼Œå‡å°‘èµ„æºæ¶ˆè€—ã€‚è¿™å±•ç¤ºäº†æˆ‘åœ¨æé«˜ç³»ç»Ÿæ•ˆç‡æ–¹é¢çš„æŠ€èƒ½ï¼Œå¯¹SREä¸­çš„æ€§èƒ½ä¼˜åŒ–å’Œåº”æ€¥å“åº”æœ‰ç›´æ¥å¸®åŠ©ã€‚</p></li></ul></li><li><p><strong>ç³»ç»Ÿç›‘æ§ä¸åˆ†æ</strong></p><ul><li><strong>æ€§èƒ½ç›‘æ§ï¼š</strong> ä½¿ç”¨æŒ‡æ ‡å¦‚æŸ¥è¯¢å“åº”æ—¶é—´ã€ç³»ç»Ÿèµ„æºåˆ©ç”¨ç‡ç­‰ï¼Œç›‘æ§ä¼˜åŒ–æ•ˆæœã€‚è¿™ä¸SREä¸­ä½¿ç”¨ç›‘æ§å·¥å…·ï¼ˆå¦‚Prometheusã€Grafanaï¼‰åˆ†æç³»ç»ŸçŠ¶æ€ç›¸ä¼¼ã€‚</li><li><strong>æ—¥å¿—åˆ†æï¼š</strong> é€šè¿‡åˆ†ææ—¥å¿—ï¼Œè¯†åˆ«æ€§èƒ½ç“¶é¢ˆå’Œæ½œåœ¨é—®é¢˜ã€‚è¿™ä¸SREä¸­é€šè¿‡æ—¥å¿—æ’æŸ¥ç³»ç»Ÿæ•…éšœçš„ç»éªŒä¸€è‡´ã€‚</li></ul></li><li><p><strong>è‡ªåŠ¨åŒ–ä¸å·¥å…·å¼€å‘</strong></p><ul><li><strong>è„šæœ¬ç¼–å†™ï¼š</strong> å¼€å‘è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆå¦‚<code>tpch_copy.sh</code>å’Œ<code>polardb_build.sh</code>ï¼‰ï¼Œç®€åŒ–æ•°æ®å¯¼å…¥å’Œæ•°æ®åº“åˆå§‹åŒ–æµç¨‹ã€‚è¿™ä½“ç°äº†æˆ‘åœ¨è‡ªåŠ¨åŒ–è¿ç»´æ–¹é¢çš„æŠ€èƒ½ï¼Œå¯¹SREä¸­çš„è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œç»´æŠ¤è‡³å…³é‡è¦ã€‚</li><li><strong>å·¥å…·é›†æˆï¼š</strong> å°è¯•é›†æˆDuckDBä¸PolarDBï¼Œè™½ç„¶æœªæˆåŠŸï¼Œä½†ç§¯ç´¯çš„ç»éªŒå¸®åŠ©æˆ‘ç†è§£ä¸åŒæ•°æ®åº“é—´çš„å…¼å®¹æ€§å’Œé›†æˆæŒ‘æˆ˜ã€‚è¿™å¯¹SREä¸­çš„å·¥å…·é“¾æ•´åˆå’Œä¼˜åŒ–æœ‰å‚è€ƒä»·å€¼ã€‚</li></ul></li><li><p><strong>æ•…éšœæ’é™¤ä¸åº”æ€¥å“åº”</strong></p><ul><li><strong>å¤±è´¥å°è¯•åˆ†æï¼š</strong> åœ¨å°è¯•å†…å­˜åˆ—å­˜å‚¨å’ŒDuckDBé›†æˆæ—¶é‡åˆ°é—®é¢˜ï¼Œé€šè¿‡åˆ†æå¤±è´¥åŸå› ï¼Œè°ƒæ•´ä¼˜åŒ–ç­–ç•¥ã€‚è¿™åŸ¹å…»äº†æˆ‘åœ¨é¢å¯¹ç³»ç»Ÿæ•…éšœæ—¶çš„åˆ†æå’Œè§£å†³é—®é¢˜çš„èƒ½åŠ›ï¼Œå¯¹SREä¸­çš„åº”æ€¥å“åº”å’Œæ•…éšœæ’é™¤æœ‰ç›´æ¥å¸®åŠ©ã€‚</li><li><strong>ç³»ç»Ÿå›æ»šï¼š</strong> åœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­ï¼Œç¡®ä¿èƒ½å¤Ÿå¿«é€Ÿå›æ»šåˆ°ç¨³å®šç‰ˆæœ¬ã€‚è¿™ä½“ç°äº†æˆ‘å¯¹ç³»ç»Ÿå˜æ›´çš„è°¨æ…æ€åº¦ï¼Œå¯¹SREä¸­çš„ç‰ˆæœ¬ç®¡ç†å’Œé£é™©æ§åˆ¶æœ‰å€Ÿé‰´æ„ä¹‰ã€‚</li></ul></li></ol><h4 id="å…·ä½“è´¡çŒ®ä¸ç»éªŒæ€»ç»“"><a href="#å…·ä½“è´¡çŒ®ä¸ç»éªŒæ€»ç»“" class="headerlink" title="å…·ä½“è´¡çŒ®ä¸ç»éªŒæ€»ç»“"></a>å…·ä½“è´¡çŒ®ä¸ç»éªŒæ€»ç»“</h4><ol><li><strong>å‚æ•°ä¼˜åŒ–</strong><ul><li><strong>è´¡çŒ®ï¼š</strong> è°ƒæ•´å†…å­˜ä½¿ç”¨ã€å¹¶è¡Œè®¾ç½®å’Œæ—¥å¿—é…ç½®ï¼Œä¼˜åŒ–ç³»ç»Ÿèµ„æºåˆ†é…ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ã€‚</li><li><strong>ç»éªŒï¼š</strong> å‚æ•°è°ƒæ•´éœ€è¦ç»¼åˆè€ƒè™‘ç³»ç»Ÿè´Ÿè½½ã€èµ„æºé™åˆ¶å’Œä¸šåŠ¡éœ€æ±‚ï¼Œé¿å…è¿‡åº¦ä¼˜åŒ–å¯¼è‡´çš„ä¸å¯é æ€§ã€‚</li></ul></li><li><strong>ç¼–è¯‘ä¼˜åŒ–</strong><ul><li><strong>è´¡çŒ®ï¼š</strong> å…³é—­è°ƒè¯•æ¨¡å¼ï¼Œé‡‡ç”¨O3ä¼˜åŒ–ï¼Œæå‡æŸ¥è¯¢é€Ÿåº¦ã€‚</li><li><strong>ç»éªŒï¼š</strong> ç¼–è¯‘ä¼˜åŒ–å¯¹ç³»ç»Ÿæ€§èƒ½æœ‰æ˜¾è‘—å½±å“ï¼Œä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦æƒè¡¡æ€§èƒ½å’Œè°ƒè¯•èƒ½åŠ›ã€‚</li></ul></li><li><strong>æŸ¥è¯¢ä¼˜åŒ–</strong><ul><li><strong>è´¡çŒ®ï¼š</strong> é‡å†™å¤æ‚æŸ¥è¯¢ï¼Œä½¿ç”¨CTEå’Œç‰©åŒ–è§†å›¾ï¼Œå‡å°‘ä¸­é—´ç»“æœé›†å¤§å°ï¼Œæå‡æŸ¥è¯¢æ•ˆç‡ã€‚</li><li><strong>ç»éªŒï¼š</strong> äº†è§£æ•°æ®åº“æ‰§è¡Œè®¡åˆ’å’Œä¼˜åŒ–å™¨è¡Œä¸ºæ˜¯æå‡æŸ¥è¯¢æ€§èƒ½çš„å…³é”®ã€‚</li></ul></li><li><strong>å†…æ ¸ä¼˜åŒ–</strong><ul><li><strong>è´¡çŒ®ï¼š</strong> å¼•å…¥åˆ—å­˜å‚¨å’Œåˆ†åŒºè¡¨ä¼˜åŒ–ï¼Œæå‡æ•°æ®è¯»å–æ•ˆç‡ã€‚</li><li><strong>ç»éªŒï¼š</strong> ç³»ç»Ÿå†…æ ¸ä¼˜åŒ–éœ€è¦æ·±å…¥äº†è§£æ•°æ®åº“å­˜å‚¨æœºåˆ¶å’ŒæŸ¥è¯¢æ‰§è¡Œæµç¨‹ã€‚</li></ul></li><li><strong>å¤±è´¥å°è¯•</strong><ul><li><strong>å†…å­˜åˆ—å­˜å‚¨ï¼š</strong> å°è¯•ä½¿ç”¨å†…å­˜åˆ—å­˜å‚¨åŠ é€ŸæŸ¥è¯¢ï¼Œä½†å› æ•°æ®åŠ è½½å’Œç³»ç»Ÿé‡å¯é—®é¢˜æ”¾å¼ƒã€‚</li><li><strong>ç»éªŒï¼š</strong> åœ¨é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆæ—¶ï¼Œéœ€è¯„ä¼°å…¶å¯¹ç³»ç»Ÿå¯é æ€§å’Œç»´æŠ¤æˆæœ¬çš„å½±å“ã€‚</li><li><strong>DuckDBé›†æˆï¼š</strong> å°è¯•å°†DuckDBä¸PolarDBé›†æˆï¼Œä½†å› å­˜å‚¨æ ¼å¼å’Œä¼˜åŒ–å™¨ä¸å…¼å®¹å¤±è´¥ã€‚</li><li><strong>ç»éªŒï¼š</strong> é›†æˆä¸åŒç³»ç»Ÿæ—¶ï¼Œéœ€å……åˆ†è€ƒè™‘å…¶åº•å±‚å®ç°å’Œå…¼å®¹æ€§é—®é¢˜ã€‚</li></ul></li></ol><h4 id="ä»é¡¹ç›®åˆ°SREçš„æŠ€èƒ½è¿ç§»"><a href="#ä»é¡¹ç›®åˆ°SREçš„æŠ€èƒ½è¿ç§»" class="headerlink" title="ä»é¡¹ç›®åˆ°SREçš„æŠ€èƒ½è¿ç§»"></a>ä»é¡¹ç›®åˆ°SREçš„æŠ€èƒ½è¿ç§»</h4><ol><li><strong>ç³»ç»Ÿä¼˜åŒ–ä¸æ€§èƒ½æå‡</strong><ul><li><strong>æŠ€èƒ½è¿ç§»ï¼š</strong> åœ¨SREå²—ä½ä¸­ï¼Œä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ä»¥æå‡å¯é æ€§æ˜¯æ ¸å¿ƒä»»åŠ¡ã€‚æˆ‘é€šè¿‡å‚æ•°å’ŒæŸ¥è¯¢ä¼˜åŒ–ç§¯ç´¯äº†ä¸°å¯Œçš„ç»éªŒï¼Œèƒ½å¤Ÿå¿«é€Ÿè¯†åˆ«å’Œè§£å†³ç”Ÿäº§ç¯å¢ƒä¸­çš„æ€§èƒ½ç“¶é¢ˆã€‚</li></ul></li><li><strong>è‡ªåŠ¨åŒ–è¿ç»´</strong><ul><li><strong>æŠ€èƒ½è¿ç§»ï¼š</strong> è‡ªåŠ¨åŒ–æ˜¯SREå·¥ä½œçš„åŸºçŸ³ã€‚æˆ‘å¼€å‘çš„è‡ªåŠ¨åŒ–è„šæœ¬åŸ¹å…»äº†æˆ‘ç¼–å†™é«˜æ•ˆè¿ç»´å·¥å…·çš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®ç°ä»»åŠ¡è‡ªåŠ¨åŒ–ï¼Œå‡å°‘äººä¸ºé”™è¯¯ã€‚</li></ul></li><li><strong>ç›‘æ§ä¸åˆ†æ</strong><ul><li><strong>æŠ€èƒ½è¿ç§»ï¼š</strong> ç†Ÿç»ƒä½¿ç”¨ç›‘æ§å·¥å…·åˆ†æç³»ç»ŸçŠ¶æ€ï¼Œå¿«é€Ÿå®šä½é—®é¢˜ã€‚æˆ‘é€šè¿‡æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—åˆ†æç§¯ç´¯äº†ä¸°å¯Œçš„ç»éªŒï¼Œèƒ½å¤Ÿæœ‰æ•ˆåº”å¯¹ç³»ç»Ÿæ•…éšœã€‚</li></ul></li><li><strong>æ•…éšœæ’é™¤ä¸åº”æ€¥å“åº”</strong><ul><li><strong>æŠ€èƒ½è¿ç§»ï¼š</strong> åœ¨é¡¹ç›®ä¸­å¤„ç†å¤±è´¥å°è¯•å’Œç³»ç»Ÿå›æ»šçš„ç»å†ï¼ŒåŸ¹å…»äº†æˆ‘å†·é™åˆ†æå’Œå¿«é€Ÿè§£å†³é—®é¢˜çš„èƒ½åŠ›ï¼Œè¿™å¯¹SREä¸­çš„åº”æ€¥å“åº”è‡³å…³é‡è¦ã€‚</li></ul></li></ol><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>é€šè¿‡å‚ä¸PolarDBæ•°æ®åº“ä¼˜åŒ–é¡¹ç›®ï¼Œæˆ‘ç§¯ç´¯äº†ä¸°å¯Œçš„ç³»ç»Ÿä¼˜åŒ–ã€ç›‘æ§ã€è‡ªåŠ¨åŒ–è¿ç»´å’Œæ•…éšœæ’é™¤ç»éªŒï¼Œè¿™äº›èƒ½åŠ›ä¸SREçš„æ ¸å¿ƒèŒè´£é«˜åº¦å¥‘åˆã€‚æˆ‘æœ‰ä¿¡å¿ƒå°†è¿™äº›ç»éªŒåº”ç”¨åˆ°å®é™…å·¥ä½œä¸­ï¼Œä¸ºå›¢é˜Ÿçš„ç³»ç»Ÿå¯é æ€§æå‡å’ŒæŒç»­æ”¹è¿›åšå‡ºè´¡çŒ®ã€‚</p><h2 id="CMU15445"><a href="#CMU15445" class="headerlink" title="CMU15445"></a>CMU15445</h2><h3 id="Buffer-Pool"><a href="#Buffer-Pool" class="headerlink" title="Buffer Pool"></a>Buffer Pool</h3><h4 id="LRU-K"><a href="#LRU-K" class="headerlink" title="LRU-K"></a>LRU-K</h4><p>å†·çƒ­æ•°æ®åˆ†ç¦»ï¼Œç»´æŠ¤ä¸€ä¸ªè®¿é—®å¤§äºç­‰äºKå’Œä¸€ä¸ªå°äºKçš„ä¼˜å…ˆé˜Ÿåˆ—ã€‚</p><p>è®¡æ•°å‹äº’æ–¥é”</p><h4 id="Disk-Scheduler"><a href="#Disk-Scheduler" class="headerlink" title="Disk Scheduler"></a>Disk Scheduler</h4><p>ç®€å•çš„é˜Ÿåˆ—</p><h4 id="Buffer-Pool-Manager"><a href="#Buffer-Pool-Manager" class="headerlink" title="Buffer Pool Manager"></a>Buffer Pool Manager</h4><ul><li><code>FetchPage(page_id_t page_id)</code>ï¼šç»™å®špageidè¿”å›ç‰©ç†é¡µã€‚å…ˆæŸ¥çœ‹ç¼“å­˜page tableï¼Œæ²¡æœ‰åˆ™è¿›å…¥ç£ç›˜è·å–ï¼Œé¡ºä¾¿åŠ å…¥ç¼“å­˜ã€‚å’ŒNewPageå¾ˆåƒã€‚</li><li><code>UnpinPage(page_id_t page_id, bool is_dirty)</code>ï¼šè®¡æ•°äº’æ–¥é”ï¼Œè®°å¾—è®¾ç½®Evictable</li><li><code>FlushPage(page_id_t page_id)</code>ï¼šå†™å…¥å¯¹åº”pageidçš„æ•°æ®</li><li><code>NewPage(page_id_t* page_id)</code>ï¼šåœ¨ç¼“å­˜æ± ä¸­åˆ›å»ºä¸€ä¸ªæ–°page</li><li><code>DeletePage(page_id_t page_id)</code>ï¼šæ³¨æ„ä¸Šé”ï¼Œé‡Šæ”¾pageå’Œå¯¹åº”frame</li><li><code>FlushAllPages()</code>ï¼šæŠŠç¼“å­˜çš„pageå…¨éƒ¨åˆ·å…¥ç£ç›˜</li></ul><h3 id="Extendible-Hash-Index"><a href="#Extendible-Hash-Index" class="headerlink" title="Extendible Hash Index"></a>Extendible Hash Index</h3><h4 id="R-W-Page-Guards"><a href="#R-W-Page-Guards" class="headerlink" title="R&#x2F;W Page Guards"></a>R&#x2F;W Page Guards</h4><p>RAII</p><h4 id="Extendible-Hash-Table-Pages"><a href="#Extendible-Hash-Table-Pages" class="headerlink" title="Extendible Hash Table Pages"></a>Extendible Hash Table Pages</h4><table><thead><tr><th>Variable Name</th><th>Size</th><th>Description</th></tr></thead><tbody><tr><td><code>max_depth_</code></td><td>4</td><td>The maximum depth the header page could handle</td></tr><tr><td><code>global_depth_</code></td><td>4</td><td>The current directory global depth</td></tr><tr><td><code>local_depths_</code></td><td>512</td><td>An array of bucket page local depths</td></tr><tr><td><code>bucket_page_ids_</code></td><td>2048</td><td>An array of bucket page ids</td></tr></tbody></table><p>éš¾ç‚¹åœ¨äº<strong>åˆ†è£‚</strong>ä¸<strong>åˆå¹¶</strong></p><ul><li>Global Depthï¼šç”¨å‡ ä½æ¥åˆ†ç±»ï¼Œè¿™å‡ ä½å¿…é¡»ä¸åŒ</li><li>Local Depthï¼šç›¸åŒçš„å‡ ä½å°†ä¼šè¢«åˆ†åœ¨åŒä¸€ä¸ªæ¡¶é‡Œ</li></ul><p>e.g. GD&#x3D;3ï¼ŒLD&#x3D;2ï¼Œåˆ™1000å’Œ1100è¢«åˆ†åˆ°åŒä¸€ä¸ªæ¡¶ï¼ŒLD&lt;&#x3D;GD</p><p>å¦‚æœæ‰©å®¹åˆ°LD&#x3D;3ï¼Œåˆ™æ–°çš„æ¡¶ä½ç½®idæ˜¯ï¼š0000å’Œ1000ï¼Œä¸€ä¸ªåŠ 0ï¼Œä¸€ä¸ªåŠ ä¸Š1&lt;&lt;(LD-1)å³å¯</p><h4 id="Extendible-Hashing-Implementation"><a href="#Extendible-Hashing-Implementation" class="headerlink" title="Extendible Hashing Implementation"></a>Extendible Hashing Implementation</h4><p>ä¸€ä¸ªExtendible Hash Tableéœ€è¦ä»€ä¹ˆï¼Ÿ</p><p>å±‚å±‚æ‰“å¼€çš„Hashç»“æ„ï¼Œæ³¨æ„å¯¹åº”çš„RWPageGuard</p><ul><li><p>Insertï¼šæ’å…¥æ–°çš„dirå’Œbucketã€‚åˆ¤æ–­æ‰©å®¹ï¼Œæ‰©å®¹æ—¶æ•°æ®çš„è¿ç§»</p><p>new dir?ä½¿ç”¨newpageç”³è¯·å¹¶å‡çº§</p></li><li><p>Removeï¼šå’Œinsertä¸€æ ·éƒ½æ˜¯åŸºäºbucketçš„å‡½æ•°æ“ä½œï¼Œä½†æ˜¯è¦æ³¨æ„shrinkæ¡ä»¶</p><p>bucketä¸ºç©ºï¼ŒLD&#x3D;&#x3D;GDï¼ˆè¿™ä¸ªbucketä¸è¢«éœ€è¦äº†ï¼‰ï¼Œé€’å½’è¿›è¡Œï¼š</p><p>DecLDï¼Œæ›´æ–°æ˜ å°„ dir-&gt;bucket ï¼Œç§»åŠ¨åŸbucket</p></li><li><p>SplitBucketï¼š</p></li></ul><h2 id="å°ç‹—å±åç«¯"><a href="#å°ç‹—å±åç«¯" class="headerlink" title="å°ç‹—å±åç«¯"></a>å°ç‹—å±åç«¯</h2>]]></content>
    
    
    
    <tags>
      
      <tag>é¡¹ç›®</tag>
      
      <tag>å…«è‚¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis</title>
    <link href="/2025/03/01/Redis/"/>
    <url>/2025/03/01/Redis/</url>
    
    <content type="html"><![CDATA[<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><h2 id="æŒä¹…åŒ–"><a href="#æŒä¹…åŒ–" class="headerlink" title="æŒä¹…åŒ–"></a>æŒä¹…åŒ–</h2><p>å®ç°æ–¹å¼ï¼š</p><ul><li>AOFæ—¥å¿—ï¼šAppend Only Fileï¼Œæ‰§è¡Œä¸€æ¡å†™ä¸€æ¡æ—¥å¿—ã€‚æ‰€ä»¥æ˜¯åœ¨å†™å®Œæ—¥å¿—ä¹‹åï¼Œè®°å½•åšè¿‡çš„äº‹ã€‚AOFä¸¢å¤±å°‘ï¼Œæ¢å¤æ…¢ã€‚</li><li>RDBå¿«ç…§ï¼šå…¨é‡å¿«ç…§ï¼Œå½±å“æ€§èƒ½ã€‚</li><li>æ··åˆæ–¹å¼ï¼šRDBè´Ÿè´£å‰åŠå…¨é‡æ•°æ®ï¼Œå‡å°‘èƒ½è€—ã€å¿«é€Ÿæ¢å¤ã€‚AOFè´Ÿè´£ååŠå¢é‡æ•°æ®ã€‚</li></ul><h3 id="è„‘è£‚"><a href="#è„‘è£‚" class="headerlink" title="è„‘è£‚"></a>è„‘è£‚</h3><p><em>ç”±äºç½‘ç»œé—®é¢˜äº§ç”Ÿå¤šä¸ªLeader</em>ï¼Œæ—§Leaderå†™å…¥æ•°æ®è¢«æ–°Leaderçš„åŒæ­¥æ¸…é™¤äº†</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong></p><p>åœ¨å¯èƒ½å‘ç”Ÿæ•…éšœæ—¶é™åˆ¶å†™å…¥</p><p>èŠ‚ç‚¹æ•°é‡&lt;N æˆ– é€šä¿¡æ—¶é•¿&gt;T</p><h4 id="Extra-Money"><a href="#Extra-Money" class="headerlink" title="Extra Money"></a>Extra Money</h4><p><strong>è·³è¡¨</strong></p><p>â€‹å¾ˆå¥½åœ°è§£é‡Šäº†ä»€ä¹ˆæ˜¯è·³è¡¨ï¼Œä¸€ä¸ªæ¯æ¬¡è·³è·ƒ2^nçš„äºŒç»´æ•°ç»„<img src="https://picx.zhimg.com/v2-be424e42c99fde208c835d565499c3d7_1440w.jpg" alt="img"></p><p>å’Œå¹³è¡¡äºŒå‰æ ‘ä¸åŒçš„æ˜¯ï¼Œè·³è¡¨ä½¿ç”¨æ¦‚ç‡è¾¾æˆå‡è¡¡ã€‚æ¯ä¸ªèŠ‚ç‚¹æœ‰1&#x2F;skipçš„æ¦‚ç‡æ·»åŠ è‡³ä¸Šä¸€å±‚ã€‚</p><p><strong>RedBlack Tree</strong></p><p><em>ä¸ºä»€ä¹ˆRedisä½¿ç”¨è·³è¡¨è€Œä¸æ˜¯çº¢é»‘æ ‘ï¼Ÿ</em></p><ul><li>å®ç°éš¾åº¦ï¼Œç»´æŠ¤æˆæœ¬</li><li>æŸ¥è¯¢é«˜æ•ˆ</li><li>å¹¶å‘æ‰©å±•</li><li>æ¦‚ç‡å¹³è¡¡&#x2F;ä¸¥æ ¼å¹³è¡¡</li></ul><h2 id="æ·˜æ±°ç­–ç•¥"><a href="#æ·˜æ±°ç­–ç•¥" class="headerlink" title="æ·˜æ±°ç­–ç•¥"></a>æ·˜æ±°ç­–ç•¥</h2><p><strong>è¿‡æœŸå­—å…¸</strong>ï¼šç»™è®¾ç½®è¿‡æœŸæ—¶é—´çš„Keyæ”¾åœ¨é‡Œé¢ï¼ŒæŸ¥è¯¢æ—¶ä¼˜å…ˆæŸ¥æ‰¾Expire Dictï¼Œæ¯”å¯¹è¿‡æœŸæ—¶é—´</p><p><strong>æƒ°æ€§åˆ é™¤+å®šæœŸåˆ é™¤</strong></p><p>â€‹è®¿é—®æ—¶è¿‡æœŸæ‰åˆ é™¤</p><p>â€‹éšæœºæŠ½å–ï¼Œçœ‹çœ‹è¿‡æœŸçš„å æ¯”ã€‚å¦‚æœå æ¯”è¿‡å¤šåˆ™é‡å¤åˆ é™¤ã€‚å¦åˆ™ä»…åˆ é™¤ä¸€è½®</p><p><strong>RDBæ·˜æ±°ç­–ç•¥</strong></p><ul><li>æ–°çš„RDBæ–‡ä»¶ç”Ÿæˆæ—¶ä¼šæ·˜æ±°</li><li>ä¸»æœåŠ¡å™¨æ·˜æ±°ã€‚ä»æœåŠ¡å™¨ä¸ä¸»åŠ¨æ·˜æ±°ï¼Œé™¤éä¸»æœåŠ¡å™¨åŒæ­¥æ¸…é™¤ï¼ˆDELæŒ‡ä»¤ï¼‰</li></ul><p><strong>AOFæ·˜æ±°ç­–ç•¥</strong></p><ul><li>å†™å…¥æ—¶ä¿ç•™è¿‡æœŸé”®ï¼Œç­‰å…¶è¢«åˆ é™¤å†è¿½åŠ DELæŒ‡ä»¤</li><li>é‡å†™æ—¶æ·˜æ±°è¿‡æœŸé”®</li></ul><p><strong>LRU LFU</strong></p><h2 id="ç¼“å­˜è®¾è®¡"><a href="#ç¼“å­˜è®¾è®¡" class="headerlink" title="ç¼“å­˜è®¾è®¡"></a>ç¼“å­˜è®¾è®¡</h2><h3 id="ç¼“å­˜ä¿æŠ¤"><a href="#ç¼“å­˜ä¿æŠ¤" class="headerlink" title="ç¼“å­˜ä¿æŠ¤"></a>ç¼“å­˜ä¿æŠ¤</h3><h4 id="ç¼“å­˜é›ªå´©"><a href="#ç¼“å­˜é›ªå´©" class="headerlink" title="ç¼“å­˜é›ªå´©"></a><strong>ç¼“å­˜é›ªå´©</strong></h4><p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨æŸä¸€æ—¶é—´æ®µå†…ï¼Œå¤§é‡ç¼“å­˜æ•°æ®<strong>åŒæ—¶å¤±æ•ˆ</strong>æˆ–<strong>ç¼“å­˜ç³»ç»Ÿå®•æœº</strong>ï¼Œå¯¼è‡´æ‰€æœ‰è¯·æ±‚ç›´æ¥æ¶Œå‘æ•°æ®åº“ï¼Œé€ æˆæ•°æ®åº“ç¬æ—¶å‹åŠ›æ¿€å¢ç”šè‡³å´©æºƒçš„ç°è±¡ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong></p><ol><li><strong>å¤±æ•ˆæ—¶é—´éšæœºåŒ–</strong>ï¼šåœ¨åŸºç¡€è¿‡æœŸæ—¶é—´ä¸Šå¢åŠ éšæœºåç§»å€¼ï¼ˆå¦‚ï¼šåŸºç¡€300ç§’Â±éšæœº120ç§’ï¼‰</li><li><strong>åˆ†çº§ç¼“å­˜æ¶æ„</strong>ï¼šé‡‡ç”¨L1&#x2F;L2ç¼“å­˜åˆ†çº§ï¼ŒL1è®¾ç½®çŸ­æ—¶é—´ï¼ŒL2è®¾ç½®é•¿æ—¶é—´</li><li><strong>çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ</strong>ï¼šé…åˆå¼‚æ­¥æ›´æ–°æœºåˆ¶ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§</li><li><strong>ç†”æ–­é™çº§æœºåˆ¶</strong>ï¼šä½¿ç”¨Hystrixæˆ–Sentinelå®ç°è¯·æ±‚é™æµ</li><li><strong>é›†ç¾¤é«˜å¯ç”¨</strong>ï¼šRedis Clusteræ¨¡å¼éƒ¨ç½²ï¼Œä¿è¯å•èŠ‚ç‚¹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡</li></ol><h4 id="ç¼“å­˜å‡»ç©¿"><a href="#ç¼“å­˜å‡»ç©¿" class="headerlink" title="ç¼“å­˜å‡»ç©¿"></a><strong>ç¼“å­˜å‡»ç©¿</strong></h4><p>æŸä¸ªè¶…é«˜çƒ­ç‚¹çš„ç¼“å­˜çªç„¶å¤±æ•ˆï¼Œå¯¼è‡´<strong>æµ·é‡è¯·æ±‚ç›´æ¥å†²å‡»æ•°æ®åº“</strong>ï¼Œå½¢æˆâ€å•ç‚¹çˆ†ç ´â€æ•ˆåº”ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong></p><ul><li><p><strong>äº’æ–¥é”ï¼ˆMutex Lockï¼‰</strong>ï¼šä»…å…è®¸ä¸€ä¸ªçº¿ç¨‹é€šè¿‡æŸ¥è¯¢é‡å»ºç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…åé‡è¯•ã€‚</p><p><em>äº’æ–¥é”ä»…é’ˆå¯¹æ•°æ®åº“è¯·æ±‚</em></p></li><li><p><strong>é€»è¾‘è¿‡æœŸ</strong>ï¼šç¼“å­˜æ°¸ä¸è¿‡æœŸï¼Œä½†å­˜å‚¨é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œç”±åå°çº¿ç¨‹å¼‚æ­¥æ›´æ–°ã€‚</p></li><li><p><strong>ç¼“å­˜é¢„çƒ­</strong>ï¼šåœ¨é«˜å³°å‰é¢„å…ˆåŠ è½½çƒ­ç‚¹æ•°æ®ã€‚</p></li></ul><h4 id="ç¼“å­˜ç©¿é€"><a href="#ç¼“å­˜ç©¿é€" class="headerlink" title="ç¼“å­˜ç©¿é€"></a><strong>ç¼“å­˜ç©¿é€</strong></h4><p>å¤§é‡è¯·æ±‚æŸ¥è¯¢<strong>æ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„æ•°æ®</strong>ï¼Œå¯¼è‡´ç¼“å­˜æ— æ³•å‘½ä¸­ï¼Œè¯·æ±‚ç›´æ¥ç©¿é€åˆ°æ•°æ®åº“ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong></p><ul><li><strong>ç©ºå€¼ç¼“å­˜</strong>ï¼šå¯¹æŸ¥è¯¢ç»“æœä¸ºnullçš„é”®ï¼Œç¼“å­˜çŸ­TTLçš„ç©ºå€¼ï¼ˆå¦‚ <code>redis.set(key, null, 60)</code>ï¼‰ã€‚</li><li><strong>å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰</strong>ï¼šåœ¨ç¼“å­˜å±‚å‰åŠ è¿‡æ»¤å™¨ï¼Œå¿«é€Ÿæ‹¦æˆªæ— æ•ˆè¯·æ±‚ã€‚</li><li><strong>å‚æ•°æ ¡éªŒ</strong>ï¼šå¯¹è¯·æ±‚å‚æ•°è¿›è¡Œæ ¼å¼ã€èŒƒå›´æ ¡éªŒï¼ˆå¦‚IDå¿…é¡»ä¸ºæ­£æ•´æ•°ï¼‰ã€‚</li></ul><h3 id="ç¼“å­˜æ›´æ–°ç­–ç•¥"><a href="#ç¼“å­˜æ›´æ–°ç­–ç•¥" class="headerlink" title="ç¼“å­˜æ›´æ–°ç­–ç•¥"></a>ç¼“å­˜æ›´æ–°ç­–ç•¥</h3><ul><li><p>Catch Asideï¼šä¼˜å…ˆæ”¹å˜æ•°æ®åº“ï¼Œç„¶åæ›´æ–°ç¼“å­˜</p><p><em><strong>ä¸ºä»€ä¹ˆå…ˆæ•°æ®åº“åç¼“å­˜ï¼Ÿ</strong></em></p><p>æºæ•°æ®ä¸æ›´æ”¹ï¼Œç¼“å­˜å§‹ç»ˆè·Ÿç€èµ°ã€‚è€Œä¸”æ›´æ–°ç¼“å­˜æ¯”æ•°æ®åº“å¿«å¤šäº†</p></li><li><p>R&#x2F;W Throughï¼šä»…å’Œç¼“å­˜äº¤äº’ã€‚å…¶ä½™äº¤ç»™ç¼“å­˜ç»„ä»¶ï¼ˆä¸å¸¸è§ï¼‰</p></li><li><p>Write Backï¼šæ‰¹é‡å¼‚æ­¥æ›´æ–°è„ç¼“å­˜ï¼Œå†™å¾—å¿«ï¼Œå®¹æ˜“ä¸¢æ•°æ®</p></li></ul><h2 id="å®æˆ˜ï¼ï¼ï¼"><a href="#å®æˆ˜ï¼ï¼ï¼" class="headerlink" title="å®æˆ˜ï¼ï¼ï¼"></a>å®æˆ˜ï¼ï¼ï¼</h2><h3 id="å¤§Keyé—®é¢˜"><a href="#å¤§Keyé—®é¢˜" class="headerlink" title="å¤§Keyé—®é¢˜"></a>å¤§Keyé—®é¢˜</h3><p><strong>Keyçš„Valueå¾ˆå¤§</strong></p><ul><li>å®¢æˆ·ç«¯è¶…æ—¶</li><li>ç½‘ç»œé˜»å¡</li><li>å·¥ä½œçº¿ç¨‹é˜»å¡</li><li>å†…å­˜åˆ†å¸ƒä¸å‡</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Redis</tag>
      
      <tag>é¢ç»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ•°æ®åº“çš„é”</title>
    <link href="/2025/02/27/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E9%94%81/"/>
    <url>/2025/02/27/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E9%94%81/</url>
    
    <content type="html"><![CDATA[<h1 id="é”"><a href="#é”" class="headerlink" title="é”"></a>é”</h1><h2 id="å…¨å±€é”"><a href="#å…¨å±€é”" class="headerlink" title="å…¨å±€é”"></a>å…¨å±€é”</h2><p>è®©æ•°æ®åº“å˜æˆread only</p><h2 id="è¡¨çº§é”"><a href="#è¡¨çº§é”" class="headerlink" title="è¡¨çº§é”"></a>è¡¨çº§é”</h2><ol><li>è¡¨é”ï¼šç»™è¡¨åŠ é”ï¼ŒåŒæ—¶æœ¬çº¿ç¨‹æ— æ³•è®¿é—®å…¶ä»–è¡¨</li><li>å…ƒæ•°æ®é”ï¼šå¯¹è¡¨æ“ä½œéšå¼ä½¿ç”¨</li><li>æ„å‘é”ï¼šè¡Œçº§é”ä¹‹å‰ï¼Œå¿«é€Ÿåˆ¤æ–­æœ‰æ— è®°å½•è¢«åŠ é”</li><li>AUTO-INCé”ï¼šç”¨äºè‡ªå¢ç±»å‹çš„åŠ é”ï¼Œä¸ç„¶å®¹æ˜“å‡ºé”™</li></ol><h2 id="è¡Œçº§é”"><a href="#è¡Œçº§é”" class="headerlink" title="è¡Œçº§é”"></a>è¡Œçº§é”</h2><ol><li>Record Lockï¼šé”è®°å½•</li><li>Gap Lockï¼šé”èŒƒå›´ï¼ˆå¼€åŒºé—´ï¼‰ã€‚é—´éš™é”ä¹‹é—´æ˜¯å…¼å®¹çš„çš„ï¼Œå¯ä»¥ç”±å¤šä¸ªäº‹åŠ¡æŒæœ‰é‡å¤åŒºé—´çš„é—´éš™é”ã€‚</li><li>Next-Key Lockï¼šè®°å½•é”+é—´éš™é”ï¼ˆä¸€å¼€ä¸€é—­ï¼‰ã€‚æ—¢ä¿æŠ¤äº†å½“å‰è®°å½•ï¼Œåˆé˜»æ­¢é—´éš™ä¹‹é—´æœ‰æ–°å€¼æ’å…¥ã€‚</li><li>æ’å…¥æ„å‘é”ï¼šç”¨äºæ’å…¥æ—¶å ç”¨é”ç­‰å¾…é˜Ÿåˆ—ã€‚</li></ol><h2 id="åˆ†å¸ƒå¼é”"><a href="#åˆ†å¸ƒå¼é”" class="headerlink" title="åˆ†å¸ƒå¼é”"></a>åˆ†å¸ƒå¼é”</h2><p>ä¸€è‡´æ€§ï¼Œæœ‰æ•ˆæ€§ï¼Œé˜²æ­¢è„‘è£‚-&gt;è¿‡åŠèŠ‚ç‚¹åŒæ„ã€‚</p><h3 id="åŸºäºRedis"><a href="#åŸºäºRedis" class="headerlink" title="åŸºäºRedis"></a>åŸºäºRedis</h3><p>è®¾ç½®ä¸€ä¸ªå…¬å…±çš„Keyå’Œå¯¹åº”è¿‡æœŸæ—¶é—´ã€‚Key&#x3D;0å¯ä»¥è·å¾—é”ï¼Œå¦åˆ™ä¸è¡Œã€‚</p><h2 id="åŠ é”æ—¶æœº"><a href="#åŠ é”æ—¶æœº" class="headerlink" title="åŠ é”æ—¶æœº"></a>åŠ é”æ—¶æœº</h2><p>select updateâ€¦</p><h2 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h2><p>ä¸¤ä¸ªäº‹åŠ¡è·å¾—äº†å…¬å…±çš„é—´éš™é”ï¼Œä½†æ˜¯æ’å…¥æ„å‘é”å’Œå¯¹æ–¹çš„é—´éš™é”èµ·äº†å†²çªã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong></p><ol><li>é™ä½éš”ç¦»çº§åˆ«ï¼ŒRCå°±ä¸ä¼šä½¿ç”¨gap lock</li><li>ä½¿ç”¨å”¯ä¸€ç´¢å¼•ï¼Œé¿å…å…¨è¡¨æ‰«æâ€¦</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>æ•°æ®åº“</tag>
      
      <tag>åˆ†å¸ƒå¼ç³»ç»Ÿ</tag>
      
      <tag>é¢ç»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å››ç§éš”ç¦»çº§åˆ«çš„æ€è€ƒ</title>
    <link href="/2025/02/26/Txn/"/>
    <url>/2025/02/26/Txn/</url>
    
    <content type="html"><![CDATA[<h1 id="äº‹åŠ¡éš”ç¦»çº§åˆ«"><a href="#äº‹åŠ¡éš”ç¦»çº§åˆ«" class="headerlink" title="äº‹åŠ¡éš”ç¦»çº§åˆ«"></a>äº‹åŠ¡éš”ç¦»çº§åˆ«</h1><p>æ•´ä½“åˆ†ä¸ºï¼š</p><ol><li>è¯»æœªæäº¤</li><li>è¯»å·²æäº¤</li><li>å¯é‡å¤è¯»</li><li>ä¸²è¡ŒåŒ–</li></ol><h2 id="å¯èƒ½äº§ç”Ÿçš„é—®é¢˜"><a href="#å¯èƒ½äº§ç”Ÿçš„é—®é¢˜" class="headerlink" title="å¯èƒ½äº§ç”Ÿçš„é—®é¢˜"></a>å¯èƒ½äº§ç”Ÿçš„é—®é¢˜</h2><ol><li>è„è¯»ï¼šè¯»åˆ°å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®ï¼Œå®¹æ˜“ç†è§£</li><li>ä¸å¯é‡å¤è¯»ï¼šå¤šæ¬¡è¯»åŒä¸€è¡Œå†…å®¹ä¸ä¸€è‡´</li><li>å¹»è¯»ï¼šå¤šæ¬¡è¯»æŸä¸ªèŒƒå›´çš„æ•°æ®ï¼ŒèŒƒå›´ä¸ä¸€è‡´ï¼ˆæœ‰æ’å…¥åˆ é™¤ï¼‰</li></ol><h3 id="åŒºåˆ«"><a href="#åŒºåˆ«" class="headerlink" title="åŒºåˆ«"></a>åŒºåˆ«</h3><p>è„è¯»å’Œä¸å¯é‡å¤åº¦ï¼šè„è¯»å¯ä»¥è®¤ä¸ºäº‹åŠ¡Bå•æ¬¡è¯»å–æ•°æ®ï¼Œè¯»åˆ°äº‹åŠ¡Aä¿®æ”¹ä½†æœªæäº¤çš„æ•°æ®ã€‚ä¸å¯é‡å¤è¯»å¯ä»¥çœ‹ä½œäº‹åŠ¡Båœ¨äº‹åŠ¡Aä¿®æ”¹å‰ååˆ†åˆ«è¯»äº†ä¸€æ¬¡ï¼Œå¾—åˆ°çš„æ•°æ®è‡ªç„¶ä¸åŒã€‚</p><p>ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ï¼šä¸å¯é‡å¤è¯»æŒ‰ç…§ä¸Šè¿°ï¼Œä¸»è¦å†²çªåœ¨ä¸€æ¬¡äº‹åŠ¡å†…è¯»åŒä¸€è¡Œä¸¤æ¬¡æ•°æ®ä¸åŒã€‚å¹»è¯»å¯ä»¥è®¤ä¸ºæ˜¯äº‹åŠ¡Bè¯»å–æŸä¸€èŒƒå›´çš„æ•°æ®ï¼Œè€Œäº‹åŠ¡Aåœ¨Bçš„ä¸¤æ¬¡è¯»å–ä¹‹é—´å¯¹è¯¥èŒƒå›´æ’å…¥æˆ–åˆ é™¤äº†æ•°æ®ã€‚äº§ç”Ÿä¸€æ¬¡è¯»2æ¡ï¼Œç¬¬äºŒæ¬¡è¯»3æ¡çš„é”™è¯¯ã€‚</p><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>é€šè¿‡äº§ç”Ÿçš„åŸå› å¯ä»¥æƒ³åˆ°å¯¹åº”è§£å†³åŠæ³•</p><h3 id="è„è¯»"><a href="#è„è¯»" class="headerlink" title="è„è¯»"></a>è„è¯»</h3><p>é€šè¿‡MVCCï¼ˆè¯»å¿«ç…§ï¼‰ï¼Œé¿å…è¯»åˆ°å…¶ä»–äº‹åŠ¡åšå‡ºçš„ä¿®æ”¹ã€‚</p><h3 id="ä¸å¯é‡å¤è¯»"><a href="#ä¸å¯é‡å¤è¯»" class="headerlink" title="ä¸å¯é‡å¤è¯»"></a>ä¸å¯é‡å¤è¯»</h3><p>MVCCç»™æ¯ä¸ªäº‹åŠ¡ç”Ÿæˆæœ€æ–°å¿«ç…§ï¼Œé¿å…äº‹åŠ¡ä¹‹é—´äº’ç›¸å½±å“ã€‚</p><h3 id="å¹»è¯»"><a href="#å¹»è¯»" class="headerlink" title="å¹»è¯»"></a>å¹»è¯»</h3><p>MVCCæ— æ³•æ‹¦ä½è¾¹è¯»è¾¹å†™çš„å¹»è¯»ã€‚å½“æ•°æ®å‡ºç°æ›´æ–°ï¼Œä¼šæ‚„æ‚„æŠŠæ›´æ–°æ•°æ®åŠ è¿›æ¥ã€‚å› æ­¤éœ€è¦é—´éš™é”æˆ–ä¸´é”®é”ã€‚</p><ol><li>é—´éš™é”ï¼šèŒƒå›´é”ï¼Œæ¯”å¦‚æŸ¥è¯¢age&gt;20ï¼Œä¼šé”ä½(20,+inf)é˜»éš”æ–°æ•°æ®åŠ å…¥&#x2F;æ—§æ•°æ®ä¿®æ”¹ã€‚</li><li>ä¸´é”®é”ï¼šèŒƒå›´+å½“å‰é”®ï¼Œæ¯”å¦‚age&gt;20ï¼Œå¯ä»¥å¾—åˆ°[20,+inf)</li></ol><h2 id="ä¸ºä»€ä¹ˆæœ‰å››ç§"><a href="#ä¸ºä»€ä¹ˆæœ‰å››ç§" class="headerlink" title="ä¸ºä»€ä¹ˆæœ‰å››ç§"></a>ä¸ºä»€ä¹ˆæœ‰å››ç§</h2><p><strong>ä¸ºä»€ä¹ˆæœ‰å››ç§éš”ç¦»çº§åˆ«ï¼Ÿæ—¢ç„¶ä½çº§åˆ«ä¼šäº§ç”Ÿé”™è¯¯ï¼Œç›´æ¥ä¸Šé«˜çº§åˆ«ä¸€åˆ€åˆ‡ä¸å°±å¥½äº†ï¼Ÿ</strong></p><p>æ•°æ®åº“æ€§èƒ½ä¸ä¸€è‡´æ€§çš„äº’ç›¸å¦¥åã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ•°æ®åº“</tag>
      
      <tag>é¢ç»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>raft</title>
    <link href="/2025/02/24/raft/"/>
    <url>/2025/02/24/raft/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•</title>
    <link href="/2025/02/24/%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA%E6%B5%8B%E8%AF%95/"/>
    <url>/2025/02/24/%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA%E6%B5%8B%E8%AF%95/</url>
    
    <content type="html"><![CDATA[<h1 id="è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•"><a href="#è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•" class="headerlink" title="è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•"></a>è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hello world\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ ‡é¢˜1"><a href="#æ ‡é¢˜1" class="headerlink" title="æ ‡é¢˜1"></a>æ ‡é¢˜1</h2><h3 id="æ ‡é¢˜2"><a href="#æ ‡é¢˜2" class="headerlink" title="æ ‡é¢˜2"></a>æ ‡é¢˜2</h3>]]></content>
    
    
    <categories>
      
      <category>æµ‹è¯•</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æµ‹è¯•1</tag>
      
      <tag>æµ‹è¯•2</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æµ‹è¯•</title>
    <link href="/2025/02/24/%E6%B5%8B%E8%AF%95/"/>
    <url>/2025/02/24/%E6%B5%8B%E8%AF%95/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2025/02/24/hello-world/"/>
    <url>/2025/02/24/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
